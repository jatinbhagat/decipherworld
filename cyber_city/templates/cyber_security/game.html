{% extends 'base.html' %}
{% load static %}

{% block title %}Password Fortress - Cyber City Protection Squad{% endblock %}

{% block extra_head %}
<!-- Background Music -->
<audio id="backgroundMusic" loop preload="auto" style="display: none;">
    <source src="{% static 'audio/cyber-ambient.mp3' %}" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<!-- Custom CSS for Password Fortress -->
<style>
    .mission-panel {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9));
        border: 1px solid rgba(56, 189, 248, 0.3);
        border-radius: 16px;
        backdrop-filter: blur(10px);
    }
    
    .challenge-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.9));
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 12px;
        backdrop-filter: blur(8px);
    }
    
    .option-btn {
        background: linear-gradient(135deg, rgba(51, 65, 85, 0.8), rgba(71, 85, 105, 0.6));
        border: 2px solid rgba(56, 189, 248, 0.2);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
    }
    
    .option-btn:hover {
        border-color: rgba(56, 189, 248, 0.5);
        background: linear-gradient(135deg, rgba(71, 85, 105, 0.9), rgba(100, 116, 139, 0.7));
        transform: translateY(-2px);
    }
    
    .cyber-btn {
        background: linear-gradient(45deg, #0ea5e9, #3b82f6);
        border: none;
        padding: 16px 32px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .cyber-btn:hover {
        background: linear-gradient(45deg, #0284c7, #2563eb);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
    }
    
    .progress-bar {
        background: rgba(30, 41, 59, 0.8);
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, #0ea5e9, #34d399);
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    .tessa-dialogue {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
        border-left: 4px solid #fbbf24;
        border-radius: 8px;
    }

    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    /* Ensure content is properly visible */
    .container {
        max-width: 100%;
        padding: 0 1rem;
    }
    
    @media (min-width: 768px) {
        .container {
            padding: 0 2rem;
        }
    }
</style>

<!-- Password Fortress Game Logic -->
<script src="{% static 'js/password-fortress.js' %}"></script>

<!-- Initialize game variables -->
<script>
    // Session variables for the game
    let sessionCode = '{{ session.session_code }}';
    let currentChallengeId = {{ current_challenge.id|default:"null" }};
    
    // Initialize Password Fortress with Django template variables
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Password Fortress initializing...');
        if (window.PasswordFortress) {
            PasswordFortress.init(sessionCode, currentChallengeId);
            PasswordFortress.initializeMusic();
            console.log('Password Fortress initialized successfully');
        } else {
            console.error('PasswordFortress not found - script may not have loaded');
            // Fallback - define minimal functions if external script fails
            window.startMission = function() { alert('Please refresh the page'); };
            window.selectOption = function() { alert('Please refresh the page'); };
            window.submitAnswer = function() { alert('Please refresh the page'); };
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen pt-16 pb-8" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);">
    <!-- Game Header -->
    <div class="mission-panel mx-4 mb-6">
        <div class="flex items-center justify-between p-6">
            <div>
                <h1 class="text-3xl font-bold text-cyan-400">üèôÔ∏è CYBER CITY PROTECTION SQUAD</h1>
                <p class="text-gray-200">Mission 1: Password Fortress</p>
            </div>
            
            {% if player %}
            <div class="flex items-center space-x-6">
                <!-- Player Info -->
                <div class="text-center">
                    <div class="text-2xl mb-1">
                        {% if player.suit_style == 'neon_knight' %}‚öîÔ∏è
                        {% elif player.suit_style == 'pixel_guard' %}üõ°Ô∏è
                        {% else %}üëæ{% endif %}
                    </div>
                    <div class="text-white font-bold">{{ player.hero_nickname }}</div>
                    <div class="text-gray-300 text-sm">{{ player.get_suit_style_display }}</div>
                </div>
                
                <!-- Progress -->
                <div class="text-center">
                    <div class="text-cyan-400 font-bold">Score</div>
                    <div class="text-2xl text-orange-400">{{ player.total_score }}</div>
                </div>
                
                <!-- City Security Level -->
                <div class="text-center">
                    <div class="text-cyan-400 font-bold text-sm">SECURITY</div>
                    <div class="text-xl text-orange-400">{{ session.city_security_level }}%</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        {% if session.mission_stage == 'intro' %}
        <!-- Mission Introduction -->
        <div class="max-w-4xl mx-auto">
            <div class="mission-panel p-8 text-center">
                <h2 class="text-4xl font-bold text-white mb-6">üèôÔ∏è WELCOME TO CYBER CITY</h2>
                
                <div class="tessa-dialogue p-6 mb-8">
                    <div class="text-lg text-gray-200" id="tessaDialogue">
                        <strong class="text-yellow-400">Captain Tessa:</strong> 
                        "Greetings, defender! Our city's digital infrastructure is under attack. 
                        The Password Fortress has been compromised, and we need your expertise to secure it. 
                        Are you ready to join the Cyber City Protection Squad?"
                    </div>
                    <div id="voiceIndicator" style="display: none;" class="mt-2">
                        <div class="flex items-center justify-center text-yellow-400">
                            <i class="fas fa-volume-up mr-2"></i>
                            <span class="text-sm">Captain Tessa speaking...</span>
                        </div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="challenge-card p-6">
                        <h3 class="text-cyan-400 font-bold mb-4">üéØ Mission Objectives</h3>
                        <ul class="text-cyan-300 space-y-2">
                            <li>‚Ä¢ Complete 5 cybersecurity challenges</li>
                            <li>‚Ä¢ Learn password security best practices</li>
                            <li>‚Ä¢ Earn cyber badges for achievements</li>
                            <li>‚Ä¢ Restore city security to 100%</li>
                        </ul>
                    </div>
                    
                    <div class="challenge-card p-6">
                        <h3 class="text-cyan-400 font-bold mb-4">üõ°Ô∏è Your Equipment</h3>
                        <ul class="text-cyan-300 space-y-2">
                            <li>‚Ä¢ {{ player.get_suit_style_display }} armor</li>
                            <li>‚Ä¢ AI-powered guidance system</li>
                            <li>‚Ä¢ Real-time threat analysis</li>
                            <li>‚Ä¢ Badge collection system</li>
                        </ul>
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="startMission()" class="cyber-btn">
                        ‚ö° START MISSION
                    </button>
                </div>
            </div>
        </div>
        
        {% elif session.mission_stage == 'in_progress' %}
        <!-- Active Mission -->
        <div class="max-w-6xl mx-auto">
            <!-- Progress Bar -->
            <div class="mission-panel p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-cyan-400">Mission Progress</h3>
                    <div class="text-cyan-300">Challenge {% if player.current_challenge and player.current_challenge > 5 %}5{% elif player.current_challenge %}{{ player.current_challenge }}{% else %}1{% endif %} of 5</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
                </div>
                <div class="flex justify-between text-sm text-cyan-500 mt-2">
                    <span>0%</span>
                    <span>{{ progress_percentage }}% Complete</span>
                    <span>100%</span>
                </div>
            </div>
            
            {% if current_challenge %}
            <!-- Current Challenge -->
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Challenge Panel -->
                <div class="lg:col-span-2 order-2 lg:order-1">
                    <div class="challenge-card p-8" id="gameArea">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-cyan-400">
                                üîê {{ current_challenge.title }}
                            </h2>
                            <div class="text-orange-400 font-bold">
                                Challenge {{ current_challenge.challenge_number }}
                            </div>
                        </div>
                        
                        <div class="text-cyan-300 text-lg mb-8 leading-relaxed">
                            {{ current_challenge.question_text }}
                        </div>
                        
                        <!-- Options -->
                        <div class="space-y-4 mb-8">
                            <div class="option-btn" onclick="selectOption('A')">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center font-bold">A</div>
                                    <div>{{ current_challenge.option_a }}</div>
                                </div>
                            </div>
                            
                            <div class="option-btn" onclick="selectOption('B')">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center font-bold">B</div>
                                    <div>{{ current_challenge.option_b }}</div>
                                </div>
                            </div>
                            
                            <div class="option-btn" onclick="selectOption('C')">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center font-bold">C</div>
                                    <div>{{ current_challenge.option_c }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="submitAnswer()" class="cyber-btn" id="submitBtn" disabled>
                                SUBMIT ANSWER
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Side Panel -->
                <div class="space-y-6 order-1 lg:order-2">
                    <!-- Captain Tessa -->
                    <div class="challenge-card p-6">
                        <h3 class="text-yellow-400 font-bold mb-4 flex items-center">
                            <span class="text-2xl mr-2">üë©‚Äç‚úàÔ∏è</span>
                            Captain Tessa
                        </h3>
                        <div class="tessa-dialogue p-4">
                            <div id="tessaDialogue" class="text-gray-200 text-sm">
                                "I'm here to guide you through this mission. Take your time to read each challenge carefully."
                            </div>
                        </div>
                        <div id="voiceIndicator" style="display: none;" class="mt-3">
                            <div class="flex items-center text-yellow-400 text-sm">
                                <i class="fas fa-volume-up mr-2"></i>
                                <span>Captain Tessa speaking...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Controls -->
                    <div class="challenge-card p-6">
                        <h3 class="text-cyan-400 font-bold mb-4">üéÆ Controls</h3>
                        <div class="space-y-3">
                            <button onclick="toggleMusic()" id="musicToggle" class="btn btn-outline btn-sm w-full">
                                <i class="fas fa-volume-up"></i> Toggle Music
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mission Status -->
                    <div class="challenge-card p-6">
                        <h3 class="text-green-400 font-bold mb-4">üìä Status</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Challenge:</span>
                                <span class="text-green-400">{{ current_challenge.challenge_number }}/5</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Score:</span>
                                <span class="text-green-400">{{ player.total_score }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Security:</span>
                                <span class="text-green-400">{{ session.city_security_level }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        {% elif session.mission_stage == 'complete' %}
        <!-- Mission Complete -->
        <div class="max-w-4xl mx-auto text-center">
            <div class="mission-panel p-8">
                <h2 class="text-4xl font-bold text-green-400 mb-6">üèÜ MISSION COMPLETE!</h2>
                <p class="text-xl text-gray-200 mb-8">Excellent work, {{ player.hero_nickname }}! You've successfully secured the Password Fortress.</p>
                
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="challenge-card p-6">
                        <div class="text-3xl text-blue-400 mb-2">5/5</div>
                        <div class="text-cyan-300">Challenges</div>
                    </div>
                    <div class="challenge-card p-6">
                        <div class="text-3xl text-green-400 mb-2">{{ player.total_score }}/5</div>
                        <div class="text-cyan-300">Score</div>
                    </div>
                    <div class="challenge-card p-6">
                        <div class="text-3xl text-orange-400 mb-2">100%</div>
                        <div class="text-cyan-300">Security</div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <a href="/cyber-city/" class="cyber-btn mr-4">
                        üèôÔ∏è Return to Cyber City
                    </a>
                    <a href="/games/" class="cyber-btn">
                        üéÆ More Games
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}