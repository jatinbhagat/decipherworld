{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberbully Crisis on Cyber Street - Mission 2</title>
    {% csrf_token %}
    
    <!-- Tailwind CSS with DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Background Music -->
    <audio id="backgroundMusic" loop preload="auto" style="display: none;">
        <source src="{% static 'audio/cyber-ambient.mp3' %}" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <style>
        body {
            background: #0a0a23;
            height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #00ffff;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        .cyber-street {
            background-image: 
                /* Cyber grid overlay */
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                /* Glowing spots */
                radial-gradient(circle at 20% 50%, rgba(0, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(139, 92, 246, 0.2) 0%, transparent 50%);
            background-size: 30px 30px, 30px 30px, 100% 100%, 100% 100%, 100% 100%;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            overflow: hidden;
            animation: gridPulse 4s ease-in-out infinite;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes gridPulse {
            0%, 100% { background-size: 30px 30px, 30px 30px, 100% 100%, 100% 100%, 100% 100%; }
            50% { background-size: 35px 35px, 35px 35px, 100% 100%, 100% 100%, 100% 100%; }
        }
        
        .neon-border {
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        .chat-bubble {
            background: rgba(15, 25, 45, 0.95) !important;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(0, 255, 255, 0.2);
            border-radius: 18px;
            padding: 16px 20px;
            margin: 8px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-height: 80px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInQuestion 0.8s ease forwards;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes fadeInQuestion {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .chat-bubble:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.15);
            border-color: rgba(0, 255, 255, 0.5) !important;
            background: rgba(15, 30, 50, 0.98) !important;
        }
        
        .friendly-bubble {
            border-left: 2px solid rgba(100, 200, 255, 0.3);
        }
        
        .friendly-bubble:hover {
            background: rgba(15, 30, 50, 0.98);
            border-left-color: rgba(100, 200, 255, 0.5);
        }
        
        .bully-bubble {
            border-left: 2px solid rgba(200, 150, 100, 0.3);
        }
        
        .chat-bubble.selected {
            border: 3px solid #00ffff !important;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6) !important;
            background: rgba(0, 255, 255, 0.1) !important;
            transform: scale(1.02) !important;
        }
        
        .bully-bubble.correct-selection {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.3) 0%, rgba(15, 25, 45, 0.95) 100%) !important;
            border: 3px solid #00ff00 !important;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.6) !important;
            animation: successGlow 1s ease;
        }
        
        .chat-bubble.wrong-answer {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.3) 0%, rgba(15, 25, 45, 0.95) 100%) !important;
            border: 3px solid #ff6b35 !important;
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.6) !important;
            animation: shake 0.5s ease;
        }
        
        .chat-bubble.correct-answer-shown {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.25) 0%, rgba(15, 25, 45, 0.95) 100%) !important;
            border: 3px solid #00ff00 !important;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.5) !important;
        }
        
        .mentor-float {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            animation: floating 3s ease-in-out infinite;
        }
        
        @media (max-width: 768px) {
            .mentor-float {
                right: 10px;
                top: 60%;
                transform: translateY(-50%) scale(0.8);
            }
        }
        
        .mentor-bubble {
            background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);
            color: #000;
            padding: 15px 20px;
            border-radius: 20px 20px 5px 20px;
            margin-left: 10px;
            position: relative;
            max-width: 250px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            border: 2px solid rgba(0, 255, 255, 0.3);
        }
        
        .citizens {
            position: absolute;
            bottom: 10vh;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.75rem;
            z-index: 5;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90vw;
        }
        
        @media (max-width: 768px) {
            .citizens {
                bottom: 5vh;
                gap: 0.5rem;
                max-width: 95vw;
            }
        }
        
        .citizen {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            animation: citizenHappy 2s ease infinite;
            border: 2px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .citizen {
                width: 2.5rem;
                height: 2.5rem;
                font-size: 1rem;
            }
        }
        
        .bully-bot {
            position: absolute;
            top: 15vh;
            right: 5%;
            width: 4rem;
            height: 4rem;
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            border: 2px solid #ff6b35;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            animation: bullyBotMean 1.5s ease infinite;
            box-shadow: 0 0 25px rgba(255, 107, 53, 0.5);
        }
        
        @media (max-width: 768px) {
            .bully-bot {
                top: 10vh;
                right: 2%;
                width: 3rem;
                height: 3rem;
                font-size: 1.25rem;
            }
        }
        
        .street-lamp {
            position: absolute;
            left: 8%;
            top: 8vh;
            width: 1rem;
            height: 12rem;
            background: linear-gradient(180deg, #374151 0%, #6b7280 100%);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }
        
        @media (max-width: 768px) {
            .street-lamp {
                left: 5%;
                top: 5vh;
                width: 0.75rem;
                height: 8rem;
            }
        }
        
        .street-lamp::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -10px;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #00ffff 0%, #0080ff 100%);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.8);
            animation: lampGlow 2s ease-in-out infinite alternate;
        }
        
        .coin-rain {
            position: fixed;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: #00ffff;
            animation: coinFall 2s ease-out forwards;
            z-index: 1000;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }
        
        .sparkle {
            position: absolute;
            font-size: 16px;
            color: #00ffff;
            animation: sparkle 1s ease-out forwards;
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.6);
        }
        
        .challenge-container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: calc(100vh - 2rem);
        }
        
        @media (max-width: 768px) {
            .challenge-container {
                padding: 0.5rem;
                height: calc(100vh - 1rem);
                max-width: 100%;
            }
        }
        
        .progress-container {
            background: rgba(0, 20, 40, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .progress-container {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .progress-container h1 {
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .progress-container h2 {
                font-size: 1.125rem !important;
                margin-bottom: 0.5rem !important;
            }
        }
        
        .cyber-heart {
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
            animation: heartPulse 2s ease-in-out infinite;
        }
        
        @keyframes heartPulse {
            0%, 100% { transform: scale(1); text-shadow: 0 0 10px rgba(0, 255, 255, 0.8); }
            50% { transform: scale(1.1); text-shadow: 0 0 20px rgba(0, 255, 255, 1); }
        }
        
        .music-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid #00ffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }
        
        .music-toggle:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
            transform: scale(1.1);
        }
        
        .music-toggle i {
            color: #00ffff;
            font-size: 18px;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(-50%) translateX(0px); }
            50% { transform: translateY(-50%) translateX(-10px); }
        }
        
        @keyframes citizenHappy {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes bullyBotMean {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(-2deg); }
            75% { transform: scale(1.05) rotate(2deg); }
        }
        
        @keyframes lampGlow {
            0% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.8); }
            100% { box-shadow: 0 0 60px rgba(0, 255, 255, 1); }
        }
        
        @keyframes coinFall {
            0% { transform: translateX(-50%) translateY(-50px) rotate(0deg); opacity: 1; }
            100% { transform: translateX(-50%) translateY(100px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes sparkle {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(180deg); opacity: 0; }
        }
        
        @keyframes cyanGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.6); }
        }
        
        @keyframes successGlow {
            0%, 100% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.6); }
            50% { box-shadow: 0 0 50px rgba(0, 255, 0, 0.8); }
        }
        
        @keyframes orangeGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 53, 0.2); }
            50% { box-shadow: 0 0 40px rgba(255, 107, 53, 0.6); }
        }
        
        @keyframes reportSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .voice-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #00ffff;
            border-radius: 50%;
            animation: voicePulse 0.5s ease-in-out infinite;
        }
        
        @keyframes voicePulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        
        /* Enhanced Challenge Cards */
        .challenge-card {
            background: rgba(0, 20, 40, 0.95) !important;
            backdrop-filter: blur(15px) !important;
            border: 1px solid rgba(0, 255, 255, 0.3) !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1) !important;
            color: #00ffff !important;
        }
        
        .challenge-card h3 {
            color: #00ffff !important;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .challenge-card p {
            color: #a0d8f1 !important;
        }
        
        /* Enhanced progress bar */
        #progressBar {
            background: linear-gradient(90deg, #00ffff 0%, #0080ff 100%) !important;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        /* Challenge content scrolling */
        #challengeContent {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 2rem;
        }
        
        @media (max-width: 768px) {
            #challengeContent {
                padding-bottom: 1rem;
            }
            
            .challenge-card {
                padding: 1rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .challenge-card h3 {
                font-size: 1.25rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .challenge-card p {
                font-size: 0.875rem !important;
                margin-bottom: 0.75rem !important;
            }
        }
    </style>
</head>
<body data-theme="dark" class="cyber-street">
    <!-- Music Toggle Button -->
    <div class="music-toggle" onclick="toggleMusic()" id="musicToggle" title="Toggle Background Music">
        <i class="fas fa-music" id="musicIcon"></i>
    </div>
    
    <!-- Background Elements -->
    <div class="street-lamp"></div>
    <div class="bully-bot" id="bullyBot">🤖</div>
    
    <!-- Citizens with Cyber Hearts -->
    <div class="citizens">
        <div class="citizen" style="background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);">
            <span class="cyber-heart">💖</span>
        </div>
        <div class="citizen" style="background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);">
            <span class="cyber-heart">💗</span>
        </div>
        <div class="citizen" style="background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);">
            <span class="cyber-heart">💙</span>
        </div>
        <div class="citizen" style="background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);">
            <span class="cyber-heart">💝</span>
        </div>
        <div class="citizen" style="background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);">
            <span class="cyber-heart">💚</span>
        </div>
    </div>
    
    <!-- Floating Mentor -->
    <div class="mentor-float">
        <div class="relative">
            <div class="w-16 h-16 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full flex items-center justify-center text-2xl border-2 border-cyan-400" style="box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);">
                🧙‍♂️
            </div>
            <div class="voice-indicator" id="voiceIndicator" style="display: none;"></div>
        </div>
        <div class="mentor-bubble" id="mentorBubble">
            Welcome to Cyber Street! Help me identify the mean messages to keep our community safe! <span class="cyber-heart">🛡️💖</span>
        </div>
    </div>
    
    <!-- Main Game Container -->
    <div class="challenge-container">
        <!-- Progress Section -->
        <div class="progress-container">
            <h1 class="text-3xl font-bold text-cyan-400 mb-4" style="text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
                Mission 2: Cyberbully Crisis on Cyber Street
            </h1>
            <h2 class="text-xl text-cyan-300 mb-4">Guardians of Kindness <span class="cyber-heart">💖</span></h2>
            
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-2 text-cyan-300">
                    <span>Progress</span>
                    <span id="progressText">{{ player.cyberbully_challenges_completed|default:0 }}/5</span>
                </div>
                <div class="bg-gray-800 rounded-full h-4 border border-cyan-400">
                    <div id="progressBar" class="bg-gradient-to-r from-cyan-400 to-blue-500 h-4 rounded-full transition-all duration-500" 
                         style="width: {% widthratio player.cyberbully_challenges_completed|default:0 5 100 %}%"></div>
                </div>
            </div>
            
            <!-- Score Display -->
            <div class="flex justify-center items-center space-x-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-cyan-400">
                        <i class="fas fa-trophy"></i>
                        <span id="scoreDisplay">{{ player.total_score|default:0 }}</span>
                    </div>
                    <div class="text-sm text-cyan-300">Total Score</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-cyan-400">
                        <i class="fas fa-shield-alt"></i>
                        <span id="correctAnswers">{{ player.correct_answers|default:0 }}</span>
                    </div>
                    <div class="text-sm text-cyan-300">Reports Made <span class="cyber-heart">💙</span></div>
                </div>
            </div>
        </div>
        
        <!-- Challenge Content -->
        <div id="challengeContent">
            {% if current_challenge %}
                <!-- Current Challenge -->
                <div class="challenge-card bg-white bg-opacity-95 backdrop-blur-lg rounded-2xl p-8 mb-6">
                    <div class="text-center mb-6">
                        <div class="bg-cyan-900/20 rounded-lg p-4 mb-4 border border-cyan-500/30">
                            <div class="text-cyan-400 text-sm mb-2">📱 Cyber Street Community Chat</div>
                            <h3 class="text-xl font-bold text-cyan-300 mb-2">{{ current_challenge.title }}</h3>
                            <p class="text-cyan-200 text-sm">{{ current_challenge.background_story }}</p>
                            <div class="text-xs text-cyan-400 mt-2 opacity-75">Click on messages that seem mean or hurtful</div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div class="space-y-4">
                        <div class="chat-bubble {{ current_challenge.option_a_type }}-bubble" 
                             onclick="selectAnswer('A')" data-option="A">
                            <div class="flex items-start space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full flex items-center justify-center border border-cyan-400">
                                    {% if current_challenge.option_a_type == 'bully' %}🤖{% else %}<span class="cyber-heart">💙</span>{% endif %}
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <div class="text-sm text-cyan-400">
                                            {% if current_challenge.option_a_type == 'bully' %}xXGamer2024Xx{% else %}SkylerB{% endif %}
                                        </div>
                                        <div class="text-xs text-cyan-600 opacity-60">2:34 PM</div>
                                    </div>
                                    <div class="text-cyan-100">{{ current_challenge.option_a }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-bubble {{ current_challenge.option_b_type }}-bubble" 
                             onclick="selectAnswer('B')" data-option="B">
                            <div class="flex items-start space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full flex items-center justify-center border border-cyan-400">
                                    {% if current_challenge.option_b_type == 'bully' %}🤖{% else %}<span class="cyber-heart">💚</span>{% endif %}
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <div class="text-sm text-cyan-400">
                                            {% if current_challenge.option_b_type == 'bully' %}TrollKing2023{% else %}Emma_Rose{% endif %}
                                        </div>
                                        <div class="text-xs text-cyan-600 opacity-60">2:35 PM</div>
                                    </div>
                                    <div class="text-cyan-100">{{ current_challenge.option_b }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-bubble {{ current_challenge.option_c_type }}-bubble" 
                             onclick="selectAnswer('C')" data-option="C">
                            <div class="flex items-start space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full flex items-center justify-center border border-cyan-400">
                                    {% if current_challenge.option_c_type == 'bully' %}🤖{% else %}<span class="cyber-heart">💖</span>{% endif %}
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <div class="text-sm text-cyan-400">
                                            {% if current_challenge.option_c_type == 'bully' %}DarkShadow99{% else %}Alex_M{% endif %}
                                        </div>
                                        <div class="text-xs text-cyan-600 opacity-60">2:36 PM</div>
                                    </div>
                                    <div class="text-cyan-100">{{ current_challenge.option_c }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Welcome Screen -->
                <div class="challenge-card bg-white bg-opacity-95 backdrop-blur-lg rounded-2xl p-8 mb-6 text-center">
                    <h2 class="text-3xl font-bold text-cyan-400 mb-6">
                        Welcome to Cyber Street! <span class="cyber-heart">💖</span>
                    </h2>
                    <p class="text-lg text-cyan-300 mb-8">
                        You're now a Guardian of Kindness! Your mission is to protect our digital community by identifying cyberbullying and helping keep Cyber Street safe and friendly for everyone.
                    </p>
                    <p class="text-cyan-400 mb-8">
                        Look for mean, hurtful, or inappropriate messages and click on them to report them. Remember, we're building a community of kindness! <span class="cyber-heart">🛡️💙</span>
                    </p>
                    <button onclick="startMission()" class="bg-gradient-to-r from-cyan-400 to-blue-500 text-black px-8 py-4 rounded-lg font-bold text-lg hover:from-cyan-300 hover:to-blue-400 transition-all duration-300 transform hover:scale-105" style="box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                        Start Your Guardian Mission <span class="cyber-heart">💖</span>
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Session and player data
        const sessionCode = '{{ session.session_code }}';
        let currentChallengeId = {% if current_challenge %}{{ current_challenge.id }}{% else %}null{% endif %};
        
        // Music control
        function toggleMusic() {
            const music = document.getElementById('backgroundMusic');
            const musicIcon = document.getElementById('musicIcon');
            
            if (music.paused) {
                music.play().catch(e => console.log('Music play failed:', e));
                musicIcon.className = 'fas fa-music';
            } else {
                music.pause();
                musicIcon.className = 'fas fa-music-slash';
            }
        }
        
        // Auto-play background music with user interaction
        document.addEventListener('click', function() {
            const music = document.getElementById('backgroundMusic');
            if (music.paused) {
                music.play().catch(e => console.log('Music play failed:', e));
            }
        }, { once: true });
        
        // Voice synthesis function
        function speakText(text) {
            if (speechSynthesis) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9; // Slightly slower for kids
                utterance.pitch = 1.1; // Slightly higher pitch for friendly tone
                utterance.volume = 0.8;
                
                // Try to use a kid-friendly voice
                const voices = speechSynthesis.getVoices();
                const kidFriendlyVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes('female') || 
                    voice.name.toLowerCase().includes('child') ||
                    voice.name.toLowerCase().includes('karen') ||
                    voice.name.toLowerCase().includes('zira')
                );
                
                if (kidFriendlyVoice) {
                    utterance.voice = kidFriendlyVoice;
                }
                
                // Show voice indicator
                const voiceIndicator = document.getElementById('voiceIndicator');
                voiceIndicator.style.display = 'block';
                
                utterance.onend = function() {
                    voiceIndicator.style.display = 'none';
                };
                
                speechSynthesis.speak(utterance);
            }
        }
        
        // Initialize voices
        speechSynthesis.onvoiceschanged = function() {
            // Voices are now loaded
        };
        
        // Start mission
        function startMission() {
            // Send mission start to server
            fetch(`/cyber-city/${sessionCode}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action_type: 'start_cyberbully_mission'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.action_result === 'mission_started') {
                    // Add fade out animation to current content
                    const challengeContent = document.getElementById('challengeContent');
                    challengeContent.style.transition = 'opacity 0.5s ease';
                    challengeContent.style.opacity = '0';
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else if (data.error) {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Connection error! Please try again.');
            });
        }
        
        // Answer selection with enhanced animations
        function selectAnswer(option) {
            const bubble = document.querySelector(`[data-option="${option}"]`);
            if (!bubble) {
                console.error('Bubble not found for option:', option);
                return;
            }
            
            // Remove previous selections
            document.querySelectorAll('.chat-bubble').forEach(b => {
                b.classList.remove('selected');
                b.style.pointerEvents = 'none';
            });
            
            // Mark this bubble as selected
            bubble.classList.add('selected');
            
            // Add selection pulse animation
            bubble.style.transform = 'scale(1.05)';
            bubble.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                bubble.style.transform = 'scale(1.02)';
            }, 200);
            
            // Send answer to server
            fetch(`/cyber-city/${sessionCode}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action_type: 'submit_cyberbully_answer',
                    challenge_id: currentChallengeId,
                    answer: option
                })
            })
            .then(response => response.json())
            .then(data => {
                handleAnswerResponse(data, option);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Connection error! Please try again.');
                // Re-enable bubbles if there's an error
                document.querySelectorAll('.chat-bubble').forEach(b => {
                    b.style.pointerEvents = 'auto';
                });
            });
        }
        
        // Handle answer response with enhanced effects
        function handleAnswerResponse(data, selectedOption) {
            const bubble = document.querySelector(`[data-option="${selectedOption}"]`);
            
            if (data.is_correct) {
                // Show success effects
                bubble.classList.remove('selected');
                bubble.classList.add('correct-selection');
                
                // Create sparkle effects
                createSparkles(bubble);
                
                // Coin rain effect
                createCoinRain();
                
                // Voice feedback
                if (data.mentor_voice_text) {
                    setTimeout(() => {
                        updateMentorBubble(data.mentor_voice_text);
                        speakText(data.mentor_voice_text);
                    }, 1000);
                }
                
                // Update score with animation
                updateScore(data.new_score);
                updateCorrectAnswers();
                
                // Check if mission is complete
                if (data.mission_complete) {
                    setTimeout(() => {
                        showGameCompletionScreen(data);
                    }, 3000);
                } else {
                    // Load next challenge after delay
                    setTimeout(() => {
                        loadNextChallenge();
                    }, 3000);
                }
                
            } else {
                // Show wrong answer feedback - keep selected state but add wrong styling
                bubble.classList.remove('selected');
                bubble.classList.add('wrong-answer');
                
                // Show explanation from mentor
                const explanation = data.explanation || "That's not quite right. Look for the message that might hurt someone's feelings.";
                const mentorTip = data.mentor_tip || "Try to identify messages that could make someone feel bad or scared. Remember, we're looking for mean or hurtful content.";
                const voiceText = data.mentor_voice_text || explanation;
                
                // Update mentor bubble with detailed explanation
                updateMentorBubble(`${explanation} ${mentorTip} 💖`);
                speakText(voiceText);
                
                // Show correct answer after explanation
                setTimeout(() => {
                    if (data.correct_answer) {
                        const correctBubble = document.querySelector(`[data-option="${data.correct_answer}"]`);
                        if (correctBubble) {
                            correctBubble.classList.add('correct-answer-shown');
                        }
                        
                        // Update mentor with correct answer explanation
                        updateMentorBubble(`The correct answer was option ${data.correct_answer}. This message was cyberbullying because it could hurt someone's feelings. Great learning! 💖`);
                    }
                    
                    // Allow user to continue manually or auto-progress
                    setTimeout(() => {
                        // Create continue button instead of auto-progression
                        createContinueButton();
                    }, 3000);
                }, 2000);
            }
        }
        
        // Create sparkle effects
        function createSparkles(element) {
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.innerHTML = '✨';
                    sparkle.style.left = (Math.random() * element.offsetWidth) + 'px';
                    sparkle.style.top = (Math.random() * element.offsetHeight) + 'px';
                    element.style.position = 'relative';
                    element.appendChild(sparkle);
                    
                    setTimeout(() => {
                        sparkle.remove();
                    }, 1000);
                }, i * 100);
            }
        }
        
        // Create continue button for wrong answers
        function createContinueButton() {
            const challengeContainer = document.querySelector('.challenge-container');
            
            // Check if button already exists
            if (document.getElementById('continueButton')) {
                return;
            }
            
            const continueBtn = document.createElement('div');
            continueBtn.id = 'continueButton';
            continueBtn.className = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50';
            continueBtn.innerHTML = `
                <button onclick="progressAfterWrongAnswer()" 
                        class="bg-gradient-to-r from-cyan-400 to-blue-500 text-black px-8 py-4 rounded-lg font-bold text-lg hover:from-cyan-300 hover:to-blue-400 transition-all duration-300 transform hover:scale-105 shadow-lg" 
                        style="box-shadow: 0 0 30px rgba(0, 255, 255, 0.5); border: 2px solid rgba(0, 255, 255, 0.3);">
                    Continue Learning <span class="cyber-heart">💖</span>
                </button>
            `;
            
            // Add to body for fixed positioning
            document.body.appendChild(continueBtn);
            
            // Add entrance animation
            continueBtn.style.opacity = '0';
            continueBtn.style.transform = 'translate(-50%, 20px)';
            setTimeout(() => {
                continueBtn.style.transition = 'all 0.5s ease';
                continueBtn.style.opacity = '1';
                continueBtn.style.transform = 'translate(-50%, 0)';
            }, 100);
        }
        
        // Progress after wrong answer with backend update
        function progressAfterWrongAnswer() {
            // Remove continue button
            const continueButton = document.getElementById('continueButton');
            if (continueButton) {
                continueButton.style.transition = 'all 0.3s ease';
                continueButton.style.opacity = '0';
                continueButton.style.transform = 'translate(-50%, 20px)';
                setTimeout(() => continueButton.remove(), 300);
            }
            
            // Update backend to progress the challenge
            fetch(`/cyber-city/${sessionCode}/action/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action_type: 'progress_after_wrong_answer',
                    challenge_id: currentChallengeId
                })
            })
            .then(response => response.json())
            .then(data => {
                // Reload to show next challenge
                loadNextChallenge();
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback: just reload anyway
                loadNextChallenge();
            });
        }

        // Create coin rain effect
        function createCoinRain() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const coin = document.createElement('div');
                    coin.className = 'coin-rain';
                    coin.innerHTML = '🏆';
                    coin.style.left = (40 + Math.random() * 20) + '%';
                    document.body.appendChild(coin);
                    
                    setTimeout(() => {
                        coin.remove();
                    }, 2000);
                }, i * 200);
            }
        }
        
        // Update score with animation
        function updateScore(newScore) {
            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.style.transform = 'scale(1.2)';
            scoreDisplay.style.color = '#00ffff';
            scoreDisplay.innerHTML = newScore;
            
            setTimeout(() => {
                scoreDisplay.style.transform = 'scale(1)';
            }, 500);
        }
        
        // Update correct answers count
        function updateCorrectAnswers() {
            const correctAnswers = document.getElementById('correctAnswers');
            const currentCount = parseInt(correctAnswers.textContent);
            correctAnswers.textContent = currentCount + 1;
            correctAnswers.style.animation = 'heartPulse 1s ease';
        }
        
        // Update mentor bubble
        function updateMentorBubble(message) {
            const mentorBubble = document.getElementById('mentorBubble');
            mentorBubble.style.animation = 'fadeOut 0.3s ease';
            
            setTimeout(() => {
                mentorBubble.innerHTML = message;
                mentorBubble.style.animation = 'fadeIn 0.5s ease';
            }, 300);
        }
        
        // Load next challenge with fade transition
        function loadNextChallenge() {
            const challengeContent = document.getElementById('challengeContent');
            challengeContent.style.opacity = '0';
            challengeContent.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        // Show game completion screen with CTA and learning summary
        function showGameCompletionScreen(data) {
            const challengeContent = document.getElementById('challengeContent');
            
            // Fade out current content
            challengeContent.style.transition = 'opacity 0.8s ease';
            challengeContent.style.opacity = '0';
            
            setTimeout(() => {
                // Update progress to 100%
                document.getElementById('progressText').textContent = '5/5';
                document.getElementById('progressBar').style.width = '100%';
                
                // Create completion screen HTML
                const completionHTML = `
                    <div class="game-completion-screen text-center">
                        <!-- Celebration Header -->
                        <div class="celebration-header mb-8">
                            <div class="text-8xl mb-4 animate-bounce">🏆</div>
                            <h2 class="text-4xl font-bold text-cyan-400 mb-4 animate-pulse">
                                MISSION ACCOMPLISHED!
                            </h2>
                            <div class="text-6xl mb-4">🛡️💖🦸‍♀️</div>
                            <p class="text-2xl text-cyan-300 mb-6">
                                You've successfully protected Cyber Street from cyberbullying!
                            </p>
                        </div>

                        <!-- Achievement Summary -->
                        <div class="achievement-summary bg-cyan-900/30 rounded-xl p-8 mb-8 border border-cyan-500/50">
                            <h3 class="text-2xl font-bold text-cyan-400 mb-6">🎯 Mission Summary</h3>
                            
                            <div class="grid md:grid-cols-2 gap-8">
                                <!-- Stats Column -->
                                <div class="stats-column">
                                    <h4 class="text-lg font-bold text-orange-400 mb-4">Your Performance</h4>
                                    <div class="space-y-3 text-cyan-300">
                                        <div class="flex justify-between items-center">
                                            <span>🎯 Challenges Completed:</span>
                                            <span class="font-bold text-cyan-400">5/5</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>🏆 Total Score:</span>
                                            <span class="font-bold text-cyan-400">${data.new_score || 0}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>💙 Reports Made:</span>
                                            <span class="font-bold text-cyan-400">${data.correct_answers || 0}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>🛡️ Streets Protected:</span>
                                            <span class="font-bold text-cyan-400">100%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Badges Column -->
                                <div class="badges-column">
                                    <h4 class="text-lg font-bold text-orange-400 mb-4">Badges Earned</h4>
                                    <div class="space-y-2 text-cyan-300">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">💖</span>
                                            <span>Kindness Guardian</span>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">🎯</span>
                                            <span>Perfect Reporter</span>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">🦸‍♀️</span>
                                            <span>Cyber Street Hero</span>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">🛡️</span>
                                            <span>Digital Defender</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Learning Summary -->
                        <div class="learning-summary bg-purple-900/30 rounded-xl p-8 mb-8 border border-purple-500/50">
                            <h3 class="text-2xl font-bold text-purple-400 mb-6">📚 What You Learned</h3>
                            <div class="text-left max-w-4xl mx-auto">
                                <div class="grid md:grid-cols-2 gap-6 text-cyan-300">
                                    <div>
                                        <h4 class="font-bold text-purple-300 mb-3">🔍 Cyberbully Detection:</h4>
                                        <ul class="space-y-2 text-sm">
                                            <li class="flex items-start space-x-2">
                                                <span class="text-green-400 mt-1">✓</span>
                                                <span>How to identify mean or hurtful messages online</span>
                                            </li>
                                            <li class="flex items-start space-x-2">
                                                <span class="text-green-400 mt-1">✓</span>
                                                <span>Recognizing threats and intimidation tactics</span>
                                            </li>
                                            <li class="flex items-start space-x-2">
                                                <span class="text-green-400 mt-1">✓</span>
                                                <span>Understanding the impact of cyberbullying on others</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-purple-300 mb-3">🛡️ Digital Safety Actions:</h4>
                                        <ul class="space-y-2 text-sm">
                                            <li class="flex items-start space-x-2">
                                                <span class="text-green-400 mt-1">✓</span>
                                                <span>When and how to report harmful content</span>
                                            </li>
                                            <li class="flex items-start space-x-2">
                                                <span class="text-green-400 mt-1">✓</span>
                                                <span>Importance of standing up for others online</span>
                                            </li>
                                            <li class="flex items-start space-x-2">
                                                <span class="text-green-400 mt-1">✓</span>
                                                <span>Creating a safer digital community for everyone</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mt-6 p-4 bg-cyan-900/20 rounded-lg border border-cyan-500/30">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <span class="text-2xl">🧙‍♂️</span>
                                        <span class="font-bold text-cyan-400">Final Words from Your Mentor</span>
                                    </div>
                                    <p class="text-cyan-300 text-sm italic">
                                        "You've shown incredible courage and compassion in protecting Cyber Street. Remember, every time you stand up against cyberbullying, you're making the digital world safer for everyone. Keep being a guardian of kindness! 💖🛡️"
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Call to Action -->
                        <div class="cta-section">
                            <h3 class="text-2xl font-bold text-cyan-400 mb-6">🚀 Continue Your Journey</h3>
                            <p class="text-cyan-300 mb-8 max-w-2xl mx-auto">
                                Ready for more cybersecurity adventures? Explore other missions and become the ultimate digital defender!
                            </p>
                            
                            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                <a href="/games/cyber-security/" 
                                   class="bg-gradient-to-r from-cyan-400 to-blue-500 text-black px-8 py-4 rounded-lg font-bold text-lg hover:from-cyan-300 hover:to-blue-400 transition-all duration-300 transform hover:scale-105 inline-flex items-center justify-center space-x-2"
                                   style="box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);">
                                    <span>🎮</span>
                                    <span>View More Cyber Games</span>
                                </a>
                                
                                <a href="/cyber-city/{{ session.session_code }}/" 
                                   class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-lg font-bold text-lg hover:from-purple-400 hover:to-pink-400 transition-all duration-300 transform hover:scale-105 inline-flex items-center justify-center space-x-2"
                                   style="box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);">
                                    <span>🏙️</span>
                                    <span>Mission Hub</span>
                                </a>
                                
                                <a href="/games/" 
                                   class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-lg font-bold text-lg hover:from-orange-400 hover:to-red-400 transition-all duration-300 transform hover:scale-105 inline-flex items-center justify-center space-x-2"
                                   style="box-shadow: 0 0 20px rgba(251, 146, 60, 0.3);">
                                    <span>🎯</span>
                                    <span>All Games</span>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                
                // Replace content with completion screen
                challengeContent.innerHTML = completionHTML;
                challengeContent.style.opacity = '1';
                
                // Add celebration animation
                createCelebrationEffects();
                
                // Update mentor bubble
                updateMentorBubble("Congratulations, Cyber Street Hero! You've completed the Cyberbully Crisis mission with flying colors! 🏆💖");
                speakText("Congratulations, Cyber Street Hero! You've completed the Cyberbully Crisis mission with flying colors!");
                
            }, 800);
        }

        // Create celebration effects for game completion
        function createCelebrationEffects() {
            // Create trophy rain
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const trophy = document.createElement('div');
                    trophy.className = 'celebration-item';
                    trophy.innerHTML = Math.random() > 0.5 ? '🏆' : '🎉';
                    trophy.style.cssText = `
                        position: fixed;
                        left: ${Math.random() * 100}%;
                        top: -50px;
                        font-size: 2rem;
                        z-index: 1000;
                        animation: celebrationFall 3s ease-out forwards;
                        pointer-events: none;
                    `;
                    document.body.appendChild(trophy);
                    
                    setTimeout(() => trophy.remove(), 3000);
                }, i * 150);
            }
            
            // Add celebration animation styles
            if (!document.getElementById('celebrationStyles')) {
                const celebrationStyle = document.createElement('style');
                celebrationStyle.id = 'celebrationStyles';
                celebrationStyle.textContent = `
                    @keyframes celebrationFall {
                        0% {
                            transform: translateY(-50px) rotate(0deg);
                            opacity: 1;
                        }
                        100% {
                            transform: translateY(calc(100vh + 50px)) rotate(360deg);
                            opacity: 0;
                        }
                    }
                    
                    .game-completion-screen {
                        animation: fadeInUp 1s ease-out;
                    }
                    
                    @keyframes fadeInUp {
                        0% {
                            opacity: 0;
                            transform: translateY(30px);
                        }
                        100% {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                `;
                document.head.appendChild(celebrationStyle);
            }
        }
        
        // Additional CSS animations via JavaScript
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
            @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }
            @keyframes shake { 
                0%, 100% { transform: translateX(0); } 
                25% { transform: translateX(-5px); } 
                75% { transform: translateX(5px); } 
            }
        `;
        document.head.appendChild(style);
        
        // Add staggered animation delays to chat bubbles
        document.addEventListener('DOMContentLoaded', function() {
            const bubbles = document.querySelectorAll('.chat-bubble');
            bubbles.forEach((bubble, index) => {
                bubble.style.animationDelay = (index * 0.2) + 's';
            });
        });
    </script>
</body>
</html>