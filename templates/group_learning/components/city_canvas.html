{% load group_learning_extras %}
<!-- Dynamic City Canvas with Immersive Background -->
<div class="city-canvas-wrapper absolute inset-0 overflow-hidden">
    <!-- Sky and Background Gradient -->
    <div class="absolute inset-0 bg-gradient-to-b from-blue-400 via-blue-200 to-green-100"></div>
    
    <!-- Animated Clouds -->
    <div class="absolute inset-0">
        <!-- Cloud 1 -->
        <div class="absolute top-10 left-10 text-white opacity-80 text-4xl animate-float-slow">â˜ï¸</div>
        <div class="absolute top-16 right-20 text-white opacity-60 text-3xl animate-float-slow-reverse" style="animation-delay: -2s;">â˜ï¸</div>
        <div class="absolute top-8 left-1/2 text-white opacity-70 text-2xl animate-float-medium" style="animation-delay: -4s;">â˜ï¸</div>
        
        <!-- Sun -->
        <div class="absolute top-6 right-6 text-5xl animate-twinkle">â˜€ï¸</div>
    </div>
    
    <!-- Background Mountains -->
    <div class="absolute bottom-0 left-0 right-0 h-32 opacity-30">
        <svg viewBox="0 0 1200 200" class="w-full h-full">
            <path d="M0,200 L0,120 L200,50 L400,80 L600,40 L800,70 L1000,30 L1200,60 L1200,200 Z" 
                  fill="url(#mountainGradient)" opacity="0.6"/>
            <path d="M0,200 L0,150 L150,90 L350,110 L550,80 L750,100 L950,70 L1200,90 L1200,200 Z" 
                  fill="url(#mountainGradient2)" opacity="0.4"/>
            <defs>
                <linearGradient id="mountainGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#6b46c1;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:0.3" />
                </linearGradient>
                <linearGradient id="mountainGradient2" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#6366f1;stop-opacity:0.2" />
                </linearGradient>
            </defs>
        </svg>
    </div>
    
    <!-- Dynamic City Buildings (Based on Team Score) -->
    <div class="absolute bottom-0 left-0 right-0 h-64">
        {% with population=team.total_score|mul:100|default:"2000" %}
        {% with building_count=population|div:500|add:3 %}
        
        <!-- Row 1: Background Buildings -->
        <div class="absolute bottom-0 left-0 right-0 flex items-end justify-center space-x-2 opacity-60">
            {% for i in "123456789"|slice:":5" %}
            <div class="bg-gradient-to-t from-gray-400 to-gray-300 border-l-4 border-r-4 border-gray-500 animate-pulse-delayed"
                 style="width: {% cycle '32' '40' '28' '36' '44' %}px; 
                        height: {% cycle '80' '100' '70' '90' '110' %}px;
                        animation-delay: {% cycle '0s' '0.5s' '1s' '1.5s' '2s' %};">
                <!-- Building windows -->
                <div class="grid grid-cols-2 gap-1 p-1 h-full">
                    <div class="bg-yellow-200 opacity-80 animate-twinkle" style="animation-delay: {% cycle '0s' '1s' '0.5s' '1.5s' %}"></div>
                    <div class="bg-yellow-200 opacity-60 animate-twinkle-delayed" style="animation-delay: {% cycle '0.5s' '1.5s' '1s' '0s' %}"></div>
                    <div class="bg-yellow-200 opacity-70 animate-twinkle" style="animation-delay: {% cycle '1s' '0s' '1.5s' '0.5s' %}"></div>
                    <div class="bg-yellow-200 opacity-90 animate-twinkle-delayed" style="animation-delay: {% cycle '1.5s' '0.5s' '0s' '1s' %}"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Row 2: Main Buildings (Score-based) -->
        <div class="absolute bottom-0 left-0 right-0 flex items-end justify-center space-x-1">
            {% for i in building_count|make_range %}
            <div class="bg-gradient-to-t border-l-4 border-r-4 transform transition-all duration-1000"
                 style="width: {% cycle '48' '56' '44' '52' '60' '40' %}px; 
                        height: {% if team.total_score > 50 %}{% cycle '120' '150' '110' '140' '160' '100' %}{% else %}{% cycle '80' '100' '70' '90' '110' '60' %}{% endif %}px;
                        {% if team.total_score > 80 %}
                        background: linear-gradient(to top, #3b82f6, #1d4ed8);
                        border-color: #1e40af;
                        {% elif team.total_score > 50 %}
                        background: linear-gradient(to top, #10b981, #059669);
                        border-color: #047857;
                        {% elif team.total_score > 20 %}
                        background: linear-gradient(to top, #f59e0b, #d97706);
                        border-color: #b45309;
                        {% else %}
                        background: linear-gradient(to top, #6b7280, #4b5563);
                        border-color: #374151;
                        {% endif %}">
                
                <!-- Building Details -->
                <div class="relative h-full p-1">
                    <!-- Windows Grid -->
                    <div class="grid grid-cols-2 gap-1 h-4/5">
                        {% for window in "123456"|slice:":4" %}
                        <div class="bg-yellow-200 opacity-{% cycle '90' '70' '80' '95' %} animate-twinkle{% if forloop.counter|divisibleby:2 %}-delayed{% endif %}" 
                             style="animation-delay: {% cycle '0s' '0.8s' '0.4s' '1.2s' %}s;"></div>
                        {% endfor %}
                    </div>
                    
                    <!-- Roof -->
                    <div class="absolute -top-2 left-0 right-0 h-3 bg-red-600 border-b-2 border-red-800 
                                {% if team.total_score > 60 %}animate-twinkle{% endif %}">
                        <!-- Antenna for high-scoring buildings -->
                        {% if team.total_score > 40 and forloop.counter|divisibleby:2 %}
                        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 w-0.5 h-4 bg-gray-600"></div>
                        <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-red-500 text-xs animate-pulse">ğŸ“¡</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Foreground Elements -->
        <div class="absolute bottom-0 left-0 right-0 h-16">
            <!-- Road -->
            <div class="absolute bottom-0 left-0 right-0 h-8 bg-gray-700 border-t-2 border-yellow-400">
                <!-- Road markings -->
                <div class="absolute top-3 left-0 right-0 h-0.5 bg-yellow-300 opacity-60"></div>
                <!-- Moving cars (if score > 30) -->
                {% if team.total_score > 30 %}
                <div class="absolute top-1 left-10 text-blue-500 animate-float-slow">ğŸš—</div>
                <div class="absolute top-1 right-20 text-red-500 animate-float-slow-reverse">ğŸš™</div>
                {% endif %}
            </div>
            
            <!-- Trees and Parks (if score > 20) -->
            {% if team.total_score > 20 %}
            <div class="absolute bottom-8 left-6 text-2xl animate-float-medium">ğŸŒ³</div>
            <div class="absolute bottom-8 right-12 text-xl animate-float-slow">ğŸŒ²</div>
            <div class="absolute bottom-8 left-1/3 text-lg animate-float-slow-reverse">ğŸŒ¿</div>
            {% endif %}
            
            <!-- Special landmarks for high scores -->
            {% if team.total_score > 70 %}
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-3xl animate-twinkle">ğŸ›ï¸</div>
            {% elif team.total_score > 50 %}
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-2xl animate-pulse">â›²</div>
            {% elif team.total_score > 30 %}
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-xl animate-bounce">ğŸ«</div>
            {% endif %}
        </div>
        
        {% endwith %}
        {% endwith %}
    </div>
    
    <!-- Population Counter Overlay -->
    {% if team.total_score > 10 %}
    <div class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm">
        <span class="animate-pulse">ğŸ‘¥ {{ team.total_score|mul:100|default:"2000" }}</span>
    </div>
    {% endif %}
    
    <!-- Weather effects (based on governance scores) -->
    {% if governance_scores.democracy > 7 %}
    <!-- Sunny weather for high democracy -->
    <div class="absolute inset-0 pointer-events-none">
        <div class="absolute top-20 right-10 text-yellow-300 text-sm animate-twinkle">âœ¨</div>
        <div class="absolute top-32 left-16 text-yellow-300 text-xs animate-twinkle-delayed">âœ¨</div>
        <div class="absolute top-24 right-1/3 text-yellow-300 text-sm animate-twinkle" style="animation-delay: 1s;">âœ¨</div>
    </div>
    {% elif governance_scores.stability < 4 %}
    <!-- Storm clouds for low stability -->
    <div class="absolute top-8 left-1/4 text-gray-600 text-3xl animate-pulse">â›ˆï¸</div>
    {% endif %}
</div>