{% extends 'base.html' %}
{% load static %}
{% load group_learning_extras %}

{% block title %}Mission Control - {{ session.session_code }}{% endblock %}

{% block description %}Facilitator dashboard for The Classroom Innovators Challenge. Control mission flow and monitor team progress.{% endblock %}

{% block extra_head %}
<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
<style>
/* Design System Typography Classes */
.text-display-1 {
    font-size: 3rem;      /* 48px */
    line-height: 1.16;
    font-weight: 800;
    letter-spacing: -0.025em;
}
.text-display-2 {
    font-size: 2.5rem;    /* 40px */
    line-height: 1.2;
    font-weight: 700;
    letter-spacing: -0.025em;
}
.text-heading-1 {
    font-size: 2rem;      /* 32px */
    line-height: 1.25;
    font-weight: 700;
}
.text-heading-2 {
    font-size: 1.5rem;    /* 24px */
    line-height: 1.33;
    font-weight: 600;
}
.text-heading-3 {
    font-size: 1.25rem;   /* 20px */
    line-height: 1.4;
    font-weight: 600;
}
.text-body {
    font-size: 1rem;      /* 16px */
    line-height: 1.5;
    font-weight: 400;
}
.text-body-sm {
    font-size: 0.875rem;  /* 14px */
    line-height: 1.43;
    font-weight: 400;
}
.text-caption {
    font-size: 0.75rem;   /* 12px */
    line-height: 1.33;
    font-weight: 500;
}

/* Design System Icon Classes */
.icon-lg {
    width: 2rem;
    height: 2rem;
}
.icon-md {
    width: 1.5rem;
    height: 1.5rem;
}
.icon-sm {
    width: 1rem;
    height: 1rem;
}

/* Mission Icons */
.mission-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    border-radius: 0.75rem;
    color: white;
}
.mission-icon.kickoff {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}
.mission-icon.empathy {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}
.mission-icon.define {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
}
.mission-icon.ideate {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}
.mission-icon.prototype {
    background: linear-gradient(135deg, #10b981, #059669);
}
.mission-icon.showcase {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

/* Enhanced Accessibility and Visual Design */
.mission-card {
    transition: all 0.3s ease;
    border-radius: 1rem;
    position: relative;
}
.mission-card:focus-within {
    outline: 3px solid #3B82F6;
    outline-offset: 2px;
}
.mission-card.active {
    transform: scale(1.02);
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    border: 2px solid #3B82F6;
}
.mission-card.completed {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
}

.team-card {
    transition: all 0.2s ease;
    border-radius: 0.75rem;
    min-height: 44px; /* Minimum touch target */
}
.team-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}
.team-card:focus-within {
    outline: 2px solid #6366F1;
    outline-offset: 2px;
}

/* Loading States */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-radius: 50%;
    border-top: 2px solid #3B82F6;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.pulse-animation {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Enhanced Button Styles */
.action-button {
    min-height: 44px;
    min-width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    border-radius: 0.75rem;
    position: relative;
}

.control-btn {
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    border-radius: 0.5rem;
    font-weight: 500;
    font-size: 0.875rem;
    padding: 0.75rem 1rem;
    border: none;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.control-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.control-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
}

.action-button:focus {
    outline: 3px solid #3B82F6;
    outline-offset: 2px;
}

.action-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.action-button:hover:not(:disabled) {
    transform: scale(1.02);
}

/* Collapsible Sections */
.collapsible-section {
    transition: max-height 0.3s ease-out;
    overflow: visible;
}

.collapsible-section.collapsed {
    max-height: 60px;
    overflow: hidden;
}

.collapsible-section.expanded {
    max-height: none;
    overflow: visible;
}

/* Status Indicators with Better Contrast */
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.status-waiting {
    background-color: #F59E0B;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3);
}

.status-in-progress {
    background-color: #10B981;
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
    animation: pulse 2s infinite;
}

.status-completed {
    background-color: #6B7280;
    box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.3);
}

/* Success/Error Message Styles */
.message-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
    color: white;
    font-weight: 500;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.message-toast.show {
    transform: translateX(0);
}

.message-toast.success {
    background-color: #10B981;
}

.message-toast.error {
    background-color: #EF4444;
}

/* Responsive Improvements */
@media (max-width: 768px) {
    .mission-card {
        padding: 1rem;
    }
    
    .team-card {
        padding: 0.75rem;
    }
    
    .action-button {
        min-height: 48px;
        min-width: 48px;
        padding: 0.75rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-indigo-50" data-session-code="{{ session.session_code }}">
    
    <!-- Modern Professional Header -->
    <header class="bg-gradient-to-r from-slate-900 via-purple-900 to-slate-900 relative overflow-hidden" role="banner">
        <!-- Background Pattern -->
        <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23ffffff" fill-opacity="0.05"%3E%3Ccircle cx="5" cy="5" r="3"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] opacity-20"></div>
        
        <div class="relative max-w-7xl mx-auto px-6 py-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <!-- Left: Mission Control Branding -->
                <div class="flex items-center space-x-4 mb-6 lg:mb-0">
                    <!-- Modern Mission Control Icon -->
                    <div class="relative">
                        <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-2xl">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <!-- Pulse indicator for live session -->
                        {% if session.status == 'in_progress' %}
                        <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full animate-pulse shadow-lg"></div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-1">
                            Mission Control
                            <span class="text-purple-300 font-normal text-xl ml-2">Dashboard</span>
                        </h1>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2 bg-white/10 backdrop-blur-sm rounded-full px-3 py-1">
                                <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
                                <span class="text-cyan-100 text-sm font-mono">{{ session.session_code }}</span>
                            </div>
                            <div class="text-white/60 text-sm">Design Thinking Challenge</div>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Live Stats -->
                <div class="flex items-center space-x-4">
                    <!-- Session Status Pill -->
                    <div class="flex items-center space-x-2 bg-white/10 backdrop-blur-sm rounded-full px-4 py-2 border border-white/20">
                        {% if session.status == 'waiting' %}
                            <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                            <span class="text-yellow-100 font-medium">Preparing</span>
                        {% elif session.status == 'in_progress' %}
                            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-green-100 font-medium">Live Session</span>
                        {% else %}
                            <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                            <span class="text-gray-300 font-medium">Completed</span>
                        {% endif %}
                    </div>
                    
                    <!-- Team Counter -->
                    <div class="bg-white/10 backdrop-blur-sm rounded-xl px-4 py-3 border border-white/20">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-white" id="team-count">{{ teams|length }}</div>
                            <div class="text-white/60 text-xs font-medium">Active Team{{ teams|length|pluralize }}</div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="flex space-x-2">
                        <button class="w-10 h-10 bg-white/10 backdrop-blur-sm rounded-lg border border-white/20 flex items-center justify-center text-white hover:bg-white/20 transition-all" title="Share Session">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                            </svg>
                        </button>
                        <button class="w-10 h-10 bg-white/10 backdrop-blur-sm rounded-lg border border-white/20 flex items-center justify-center text-white hover:bg-white/20 transition-all" title="Settings">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8" role="main">
        <!-- Modern Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Live Status Overview -->
            {% if session.status == 'in_progress' and current_mission %}
            <div class="lg:col-span-3 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white relative overflow-hidden">
                <!-- Background Pattern -->
                <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%23ffffff" fill-opacity="0.1"%3E%3Cpath d="M20 20c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10zm10 0c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10z"/%3E%3C/g%3E%3C/svg%3E')] opacity-20"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                {% if current_mission.mission_type == 'kickoff' %}üöÄ
                                {% elif current_mission.mission_type == 'empathy' %}üîç
                                {% elif current_mission.mission_type == 'define' %}üéØ
                                {% elif current_mission.mission_type == 'ideate' %}üí°
                                {% elif current_mission.mission_type == 'prototype' %}üîß
                                {% elif current_mission.mission_type == 'showcase' %}‚≠ê
                                {% else %}üìã{% endif %}
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">{{ current_mission.title }}</h2>
                                <p class="text-emerald-100">Currently Active ‚Ä¢ {{ current_mission.estimated_duration }} minutes</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="bg-white/20 backdrop-blur-sm rounded-lg px-3 py-1 text-sm font-medium">
                                Mission {{ current_mission.order }} of 6
                            </div>
                        </div>
                    </div>
                    <p class="text-emerald-50 text-lg leading-relaxed">{{ current_mission.description }}</p>
                </div>
            </div>
            {% else %}
            <div class="lg:col-span-3 bg-gradient-to-r from-slate-700 to-slate-800 rounded-2xl p-6 text-white relative overflow-hidden">
                <div class="relative">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                            ‚è≥
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">Session Preparation</h2>
                            <p class="text-slate-300">Ready to begin when you are</p>
                        </div>
                    </div>
                    <p class="text-slate-200 text-lg">Teams are connected and waiting for the first mission to start.</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Stats Panel -->
            <div class="space-y-4">
                <!-- Team Count -->
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Active Teams</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-teams">{{ teams|length }}</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Session Duration -->
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Session Time</p>
                            <p class="text-2xl font-bold text-gray-900" id="session-duration">
                                {% if session.started_at %}
                                    <span class="live-timer" data-start="{{ session.started_at|date:'c' }}">00:00</span>
                                {% else %}
                                    --:--
                                {% endif %}
                            </p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Professional Mission Control Panel -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
                    </svg>
                    Mission Control
                </h2>
            </div>
            
            {% if session.status == 'waiting' %}
            <div class="p-6">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.01M15 10h1.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Session Ready</h3>
                    {% if teams|length > 0 %}
                        <p class="text-gray-600 mb-6">{{ teams|length }} team{{ teams|length|pluralize }} connected and ready to begin</p>
                        
                        <!-- Modern Action Buttons -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-lg mx-auto">
                            <button onclick="startSession()" 
                                    id="start-session-btn"
                                    class="group relative bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200">
                                <div class="flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2 group-hover:animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.01M15 10h1.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Start Session
                                </div>
                            </button>
                            
                            <button onclick="advanceToFirstMission()" 
                                    id="advance-first-mission-btn"
                                    class="group relative bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200">
                                <div class="flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                    Begin First Mission
                                </div>
                            </button>
                        </div>
                    {% else %}
                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                            <div class="flex items-center justify-center text-yellow-800">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                                Waiting for teams to join
                            </div>
                        </div>
                        <button onclick="refreshTeamList()" 
                                class="inline-flex items-center px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-xl transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Refresh Teams
                        </button>
                    {% endif %}
                </div>
            </div>
            
            {% elif session.status == 'in_progress' %}
            <div class="p-6">
                <!-- Mission Progress Bar -->
                {% if current_mission %}
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-gray-900">Mission Progress</h3>
                        <span class="text-sm font-medium text-gray-600">{{ current_mission.order }} of 6</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 h-2 rounded-full transition-all duration-300" 
                             style="width: {{ current_mission.order|mul:16.67 }}%"></div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Action Controls -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    {% if current_mission and next_mission %}
                    <button onclick="advanceToMission({{ next_mission.id }})" 
                            id="advance-mission-btn"
                            class="group col-span-2 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200">
                        <div class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                            Advance to {{ next_mission.title }}
                        </div>
                    </button>
                    {% elif not current_mission %}
                    <button onclick="startFirstMission()" 
                            id="start-first-mission-btn"
                            class="group col-span-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200">
                        <div class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2 group-hover:animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.01M15 10h1.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Start First Mission
                        </div>
                    </button>
                    {% endif %}
                    
                    <!-- Secondary Controls -->
                    <button onclick="pauseSession()" 
                            id="pause-session-btn"
                            class="group bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-medium py-4 px-4 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200">
                        <div class="flex items-center justify-center">
                            <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"/>
                            </svg>
                        </div>
                    </button>
                    
                    <button onclick="endSession()" 
                            id="end-session-btn"
                            class="group bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-medium py-4 px-4 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200">
                        <div class="flex items-center justify-center">
                            <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                            </svg>
                        </div>
                    </button>
                </div>
            </div>
            
            {% else %}
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Mission Complete!</h3>
                <p class="text-gray-600">All teams have finished the Design Thinking Challenge</p>
            </div>
            {% endif %}

        <!-- Modern Teams Dashboard -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-cyan-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center justify-between">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Live Teams Monitor
                    </div>
                    <div class="flex items-center space-x-2 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-sm font-medium">{{ teams|length }} Active</span>
                    </div>
                </h2>
            </div>
            
            {% if teams|length > 0 %}
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="teams-list">
                    {% for team in teams %}
                    <div class="group bg-gradient-to-br from-gray-50 to-gray-100 hover:from-blue-50 hover:to-indigo-50 rounded-xl border border-gray-200 hover:border-blue-300 p-4 transition-all duration-200 hover:shadow-lg" data-team-id="{{ team.id }}">
                        <!-- Team Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-sm" 
                                     style="background: linear-gradient(135deg, {{ team.team_color }}22, {{ team.team_color }}44)">
                                    {{ team.team_emoji }}
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900 group-hover:text-blue-900 transition-colors">{{ team.team_name }}</h3>
                                    <p class="text-sm text-gray-600">{{ team.team_members|length }} member{{ team.team_members|length|pluralize }}</p>
                                </div>
                            </div>
                            
                            <!-- Progress Circle -->
                            <div class="relative w-14 h-14">
                                <svg class="w-14 h-14 transform -rotate-90" viewBox="0 0 36 36">
                                    <path class="text-gray-200" stroke="currentColor" stroke-width="2" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                                    <path class="text-emerald-500" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" 
                                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                          stroke-dasharray="{{ team.actual_progress_percentage|floatformat:0 }}, 100"></path>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-xs font-bold text-gray-900">{{ team.actual_progress_percentage|floatformat:0 }}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mission Activity -->
                        {% if session.current_mission %}
                        <div class="bg-white rounded-lg p-3 border border-gray-200 group-hover:border-blue-200 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-gradient-to-r 
                                        {% if session.current_mission.mission_type == 'kickoff' %}from-blue-500 to-blue-600
                                        {% elif session.current_mission.mission_type == 'empathy' %}from-purple-500 to-purple-600
                                        {% elif session.current_mission.mission_type == 'define' %}from-cyan-500 to-cyan-600
                                        {% elif session.current_mission.mission_type == 'ideate' %}from-amber-500 to-amber-600
                                        {% elif session.current_mission.mission_type == 'prototype' %}from-emerald-500 to-emerald-600
                                        {% elif session.current_mission.mission_type == 'showcase' %}from-pink-500 to-pink-600
                                        {% else %}from-gray-500 to-gray-600{% endif %}">
                                        <span class="text-white text-sm">
                                            {% if session.current_mission.mission_type == 'kickoff' %}üöÄ
                                            {% elif session.current_mission.mission_type == 'empathy' %}üîç
                                            {% elif session.current_mission.mission_type == 'define' %}üéØ
                                            {% elif session.current_mission.mission_type == 'ideate' %}üí°
                                            {% elif session.current_mission.mission_type == 'prototype' %}üîß
                                            {% elif session.current_mission.mission_type == 'showcase' %}‚≠ê
                                            {% else %}üìã{% endif %}
                                        </span>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ session.current_mission.title }}</div>
                                        {% if session.current_mission.mission_type == 'empathy' %}
                                        <div class="text-xs text-gray-500">
                                            <span class="empathy-observation-count" data-team-id="{{ team.id }}">{{ team.empathy_observations_count }}</span> observations
                                        </div>
                                        {% else %}
                                        <div class="text-xs text-gray-500">
                                            <span class="mission-submission-count" data-team-id="{{ team.id }}">{{ team.current_mission_submissions }}</span> submissions
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Live Activity Indicator -->
                                <div class="flex items-center space-x-2">
                                    {% if team.current_mission_submissions > 0 %}
                                    <div class="flex items-center space-x-1">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-xs font-medium text-green-600">Active</span>
                                    </div>
                                    {% else %}
                                    <div class="flex items-center space-x-1">
                                        <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                        <span class="text-xs font-medium text-gray-500">Waiting</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-3 gap-2 mt-3">
                            <div class="bg-white rounded-lg p-2 text-center border border-gray-200">
                                <div class="text-lg font-bold text-gray-900">{{ team.total_submissions }}</div>
                                <div class="text-xs text-gray-500">Total</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center border border-gray-200">
                                <div class="text-lg font-bold text-gray-900">{{ team.current_mission_submissions }}</div>
                                <div class="text-xs text-gray-500">Current</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center border border-gray-200">
                                <div class="text-lg font-bold text-blue-600">{{ team.missions_completed }}</div>
                                <div class="text-xs text-gray-500">Done</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="p-12 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 5.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Teams Yet</h3>
                <p class="text-gray-600 mb-4">Share the session code <strong>{{ session.session_code }}</strong> with students to get started</p>
                <button onclick="refreshTeamList()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Check for Teams
                </button>
            </div>
            {% endif %}
        </div>
    </div>

            <!-- Session Controls -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
                    </svg>
                    Mission Control
                </h3>
                
                <!-- Always Visible Session Controls -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                    {% if session.status == 'waiting' and teams|length > 0 %}
                    <button onclick="startSession()" 
                            class="control-btn bg-blue-600 hover:bg-blue-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.01M15 10h1.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Start Session
                    </button>
                    {% elif session.status == 'in_progress' %}
                    {% if not current_mission %}
                    <button onclick="startFirstMission()" 
                            class="control-btn bg-green-600 hover:bg-green-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.01M15 10h1.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Start Mission
                    </button>
                    {% elif next_mission %}
                    <button onclick="advanceToMission({{ next_mission.id }})" 
                            class="control-btn bg-green-600 hover:bg-green-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Next Mission
                    </button>
                    {% endif %}
                    
                    <button onclick="pauseSession()" 
                            class="control-btn bg-yellow-600 hover:bg-yellow-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"/>
                        </svg>
                        Pause
                    </button>
                    
                    <button onclick="endSession()" 
                            class="control-btn bg-red-600 hover:bg-red-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        End Session
                    </button>
                    {% endif %}
                    
                    <button onclick="refreshTeamList()" 
                            class="control-btn bg-gray-600 hover:bg-gray-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Session Tools -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    </svg>
                    Tools
                </h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- QR Code -->
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="w-20 h-20 bg-white rounded-lg mx-auto mb-3 flex items-center justify-center border" id="qr-code-container">
                            <div id="qr-code" class="w-full h-full flex items-center justify-center"></div>
                            <div id="qr-placeholder" class="text-center">
                                <svg class="w-6 h-6 text-gray-400 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h-1M6 16h-1m9-10v1M6 6h1M6 6v1M6 6H5v1"/>
                                </svg>
                                <div class="text-xs text-gray-500">QR Code</div>
                            </div>
                        </div>
                        <button onclick="generateQRCode()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                            Generate QR Code
                        </button>
                    </div>
                    
                    <!-- Session Link -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Share Link</h4>
                        <div class="flex space-x-2">
                            <input type="text" 
                                   value="{{ request.get_host }}/learn/design-thinking/?join={{ session.session_code }}"
                                   readonly
                                   id="share-link"
                                   class="flex-1 text-xs bg-white p-2 rounded border">
                            <button onclick="copyShareLink()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-xs font-medium transition-colors">
                                Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

<script>
// Enhanced Session management functions with accessibility and loading states
function startSession() {
    const button = document.getElementById('start-session-btn');
    if (showConfirmDialog('Start the session and begin the first mission?', 'This will activate the first mission for all teams.')) {
        setButtonLoading(button, 'Starting...');
        controlSession('start_session')
            .finally(() => {
                resetButtonLoading(button, 'üöÄ Start Session');
            });
    }
}

function advanceToMission(missionId) {
    const missionButton = event.target.closest('button');
    if (showConfirmDialog('Advance all teams to this mission?', 'This will move all teams to the selected mission phase.')) {
        setButtonLoading(missionButton, 'Advancing...');
        controlSession('advance_mission', missionId)
            .finally(() => {
                // Button will be updated by page refresh
            });
    }
}

function endSession() {
    const button = document.getElementById('end-session-btn');
    if (showConfirmDialog('End the session?', 'This will complete the innovation challenge and show final results.')) {
        setButtonLoading(button, 'Ending...');
        controlSession('end_session')
            .finally(() => {
                resetButtonLoading(button, 'üèÅ End Session');
            });
    }
}

function advanceToFirstMission() {
    const button = document.getElementById('advance-first-mission-btn');
    if (showConfirmDialog('Begin the first mission?', 'This will start the Empathy phase for all teams.')) {
        setButtonLoading(button, 'Starting...');
        controlSession('start_session')  // Use existing start_session action
            .finally(() => {
                resetButtonLoading(button, 'Begin First Mission');
            });
    }
}

function startFirstMission() {
    const button = document.getElementById('start-first-mission-btn');
    if (showConfirmDialog('Start the first mission?', 'This will activate the Empathy phase for all teams.')) {
        setButtonLoading(button, 'Starting...');
        controlSession('start_session')  // Use existing start_session action
            .finally(() => {
                resetButtonLoading(button, 'Start First Mission');
            });
    }
}

function pauseSession() {
    const button = document.getElementById('pause-session-btn');
    // For now, show a message that pause functionality will be added
    showSuccessMessage('‚è∏Ô∏è Pause feature coming soon!', 'Use End Session to stop the session completely.');
}

function refreshTeamList() {
    const button = event.target;
    setButtonLoading(button, 'Refreshing...');
    
    // Force a page refresh to get updated team data
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

function controlSession(action, missionId = null) {
    const sessionCode = document.querySelector('[data-session-code]').dataset.sessionCode;
    const formData = new FormData();
    formData.append('action', action);
    if (missionId) {
        formData.append('mission_id', missionId);
    }
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    return fetch(`/learn/api/design-thinking/${sessionCode}/control/`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSuccessMessage('Mission control successful!', 'The action has been completed successfully.');
            // Use a more accessible page update method
            setTimeout(() => {
                announceToScreenReader('Page content updated. Mission control action completed.');
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorMessage('Operation failed', error.message || 'A network error occurred. Please try again.');
        throw error; // Re-throw to be handled by caller
    });
}

// Enhanced UI Helper Functions
function setButtonLoading(button, loadingText) {
    if (!button) return;
    
    button.disabled = true;
    button.setAttribute('aria-busy', 'true');
    const originalContent = button.innerHTML;
    button.dataset.originalContent = originalContent;
    
    button.innerHTML = `
        <span class="loading-spinner mr-2" aria-hidden="true"></span>
        ${loadingText}
    `;
}

function resetButtonLoading(button, originalText) {
    if (!button) return;
    
    button.disabled = false;
    button.setAttribute('aria-busy', 'false');
    button.innerHTML = button.dataset.originalContent || originalText;
}

function showConfirmDialog(title, description) {
    // Enhanced confirmation with better accessibility
    return confirm(`${title}\n\n${description}\n\nPress OK to confirm or Cancel to abort.`);
}

function announceToScreenReader(message) {
    const announcement = document.createElement('div');
    announcement.setAttribute('aria-live', 'polite');
    announcement.setAttribute('aria-atomic', 'true');
    announcement.className = 'sr-only';
    announcement.textContent = message;
    
    document.body.appendChild(announcement);
    setTimeout(() => document.body.removeChild(announcement), 1000);
}

// Section Toggle Functions
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const button = section.querySelector('button[aria-expanded]');
    const content = section.querySelector('[id$="-content"]');
    
    if (!section || !button || !content) return;
    
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    const newState = !isExpanded;
    
    button.setAttribute('aria-expanded', newState);
    
    if (newState) {
        section.classList.remove('collapsed');
        section.classList.add('expanded');
        button.setAttribute('aria-label', button.getAttribute('aria-label').replace('Expand', 'Collapse'));
    } else {
        section.classList.remove('expanded');
        section.classList.add('collapsed');
        button.setAttribute('aria-label', button.getAttribute('aria-label').replace('Collapse', 'Expand'));
    }
}

// Keyboard Navigation Support
function initializeKeyboardNavigation() {
    // Add keyboard support for collapsible sections
    document.addEventListener('keydown', function(e) {
        if (e.target.matches('button[aria-expanded]')) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.target.click();
            }
        }
        
        // Escape key support for modals
        if (e.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal:not(.hidden)');
            openModals.forEach(modal => {
                const closeButton = modal.querySelector('[onclick*="close"]');
                if (closeButton) closeButton.click();
            });
        }
    });
}

function copyShareLink() {
    const shareLink = document.getElementById('share-link');
    shareLink.select();
    shareLink.setSelectionRange(0, 99999);
    document.execCommand('copy');
    showSuccessMessage('Share link copied to clipboard!');
}

// Auto-refresh session status (periodic API call)
function periodicStatusUpdate() {
    const sessionCode = document.querySelector('[data-session-code]')?.dataset.sessionCode;
    if (!sessionCode) return;
    
    console.log('üîÑ Periodic status update for session:', sessionCode);
    
    fetch(`/learn/api/design-thinking/${sessionCode}/status/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('üì° Periodic API response:', data);
            
            // Update team count elements
            const teamCountElements = document.querySelectorAll('#team-count, #total-teams');
            teamCountElements.forEach(element => {
                if (element && data.teams_count !== undefined) {
                    element.textContent = data.teams_count;
                }
            });
            
            // Update progress if mission is active
            if (data.current_mission && data.mission_progress) {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                if (progressBar && progressText) {
                    progressBar.style.width = data.mission_progress.percentage + '%';
                    progressText.textContent = `${data.mission_progress.completed}/${data.mission_progress.total} teams completed`;
                }
            }
            
            // Update mission timer
            if (data.mission_started) {
                updateMissionTimer(data.mission_started);
            }
        }
    })
    .catch(error => console.warn('üì° Periodic status update failed:', error));
}

function updateMissionTimer(startTime) {
    const timer = document.getElementById('mission-timer');
    if (!timer) return;
    
    const start = new Date(startTime);
    const now = new Date();
    const elapsed = Math.floor((now - start) / 1000);
    
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Enhanced Message System
function showSuccessMessage(title, description = '') {
    showMessage(title, description, 'success');
}

function showErrorMessage(title, description = '') {
    showMessage(title, description, 'error');
}

function showMessage(title, description, type = 'success') {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.message-toast');
    existingMessages.forEach(msg => msg.remove());
    
    // Create new message
    const message = document.createElement('div');
    message.className = `message-toast ${type}`;
    message.setAttribute('role', type === 'error' ? 'alert' : 'status');
    message.setAttribute('aria-live', 'assertive');
    message.setAttribute('aria-atomic', 'true');
    
    message.innerHTML = `
        <div class="flex items-start">
            <div class="flex-1">
                <div class="font-semibold">${title}</div>
                ${description ? `<div class="text-sm opacity-90 mt-1">${description}</div>` : ''}
            </div>
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="ml-3 text-white hover:text-gray-200"
                    aria-label="Close message">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(message);
    
    // Show with animation
    setTimeout(() => message.classList.add('show'), 100);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        message.classList.remove('show');
        setTimeout(() => message.remove(), 300);
    }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Initialize keyboard navigation
    initializeKeyboardNavigation();
    
    // Update status every 10 seconds (reduced frequency to avoid race conditions)
    setInterval(periodicStatusUpdate, 10000);
    
    // Initial status update after 2 seconds to let page load
    setTimeout(periodicStatusUpdate, 2000);
    
    // Add screen reader only class
    if (!document.querySelector('.sr-only')) {
        const srOnlyStyle = document.createElement('style');
        srOnlyStyle.textContent = `
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
        `;
        document.head.appendChild(srOnlyStyle);
    }
});
</script>

<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}

<!-- WebSocket Integration -->
<script>
// WebSocket connection for real-time updates
let designThinkingSocket = null;

function initializeWebSocket() {
    const sessionCode = document.querySelector('[data-session-code]').dataset.sessionCode;
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const socketUrl = `${protocol}//${window.location.host}/ws/design-thinking/${sessionCode}/`;
    
    console.log('üé® Connecting to Design Thinking WebSocket:', socketUrl);
    
    designThinkingSocket = new WebSocket(socketUrl);
    
    designThinkingSocket.onopen = function(e) {
        console.log('‚úÖ Design Thinking WebSocket connected');
        showSuccessMessage('Real-time updates connected');
    };
    
    designThinkingSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('üì® WebSocket message received:', data.type);
        
        switch(data.type) {
            case 'session_status':
                updateSessionStatus(data.data);
                break;
            case 'mission_advanced':
                handleMissionAdvanced(data.mission_data);
                break;
            case 'team_submission':
                handleTeamSubmission(data.team_data, data.submission_data);
                break;
            case 'team_joined':
                handleTeamJoined(data.team_data, data.session_data);
                break;
            case 'team_progress':
                handleTeamProgress(data.team_data, data.progress_data);
                break;
            case 'team_spotlight':
                handleTeamSpotlight(data.team_data, data.spotlight_reason);
                break;
            default:
                console.log('Unknown WebSocket message type:', data.type);
        }
    };
    
    designThinkingSocket.onclose = function(e) {
        console.log('üîå Design Thinking WebSocket disconnected:', e.code);
        if (e.code !== 1000) {
            showErrorMessage('Connection lost. Attempting to reconnect...');
            setTimeout(initializeWebSocket, 3000);
        }
    };
    
    designThinkingSocket.onerror = function(e) {
        console.error('üí• WebSocket error:', e);
        showErrorMessage('Connection error occurred');
    };
}

function handleTeamJoined(teamData, sessionData) {
    console.log('üéâ New team joined:', teamData.name);
    
    // Update session status with new team count
    updateSessionStatus(sessionData);
    
    // Add team to the teams list if it exists
    const teamsList = document.getElementById('teams-list');
    if (teamsList) {
        addTeamToList(teamData);
    }
    
    // Show success notification
    showSuccessMessage(`üéâ Team "${teamData.name}" ${teamData.emoji} joined the session!`);
}

function addTeamToList(teamData) {
    const teamsList = document.getElementById('teams-list');
    if (!teamsList) return;
    
    console.log('‚ûï Adding team to list:', teamData.name);
    
    // Remove "no teams" message if it exists (be more specific)
    const noTeamsContainer = teamsList.querySelector('.text-center.py-8');
    if (noTeamsContainer) {
        console.log('üóëÔ∏è Removing "No Teams" message');
        noTeamsContainer.remove();
    }
    
    // Check if team already exists to avoid duplicates
    const existingTeam = teamsList.querySelector(`[data-team-id="${teamData.id}"]`);
    if (existingTeam) {
        console.log('‚ö†Ô∏è Team already exists in list, skipping add');
        return;
    }
    
    // Create team card HTML with proper data
    const teamCard = document.createElement('div');
    teamCard.className = 'team-card p-4 bg-gray-50 rounded-xl border border-gray-200';
    teamCard.dataset.teamId = teamData.id;
    
    // Get actual progress data
    const progressPercentage = teamData.progress_percentage || 0;
    const submissionCount = teamData.total_submissions || 0;
    
    teamCard.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">${teamData.emoji}</span>
                <div>
                    <div class="font-semibold text-gray-900">${teamData.name}</div>
                    <div class="text-sm text-gray-500">Just joined</div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm font-medium text-indigo-600">${submissionCount} submission${submissionCount !== 1 ? 's' : ''}</div>
                <div class="text-xs text-gray-500">${progressPercentage.toFixed(0)}% complete</div>
            </div>
        </div>
    `;
    
    // Add to teams list
    teamsList.appendChild(teamCard);
    
    // Add spotlight functionality
    const spotlightBtn = document.createElement('button');
    spotlightBtn.className = 'mt-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded hover:bg-yellow-200 transition-colors';
    spotlightBtn.textContent = '‚≠ê Spotlight';
    spotlightBtn.onclick = () => spotlightTeam(teamData.id, teamData.name);
    teamCard.appendChild(spotlightBtn);
}

function updateSessionStatus(sessionData) {
    console.log('üìä Updating session status:', sessionData);
    
    // Update team count
    if (sessionData.teams_count !== undefined) {
        const teamCount = sessionData.teams_count;
        const teamCountElements = document.querySelectorAll('#team-count, #total-teams');
        teamCountElements.forEach(element => {
            if (element) {
                element.textContent = teamCount;
            }
        });
        
        console.log('üë• Updated team count to:', teamCount);
        
        // Only check for "No Teams" state if we have the specific no-teams structure
        const teamsList = document.getElementById('teams-list');
        if (teamsList) {
            const noTeamsContainer = teamsList.querySelector('.text-center.py-8');
            const existingTeamCards = teamsList.querySelectorAll('[data-team-id]');
            
            console.log('üîç Teams list check - No teams container:', !!noTeamsContainer, 'Existing cards:', existingTeamCards.length, 'Expected count:', teamCount);
            
            // Only reload if we have a real mismatch: teams should exist but "No Teams" message is shown
            if (teamCount > 0 && noTeamsContainer && existingTeamCards.length === 0) {
                console.log('üîÑ Detected team count mismatch, reloading page...');
                setTimeout(() => window.location.reload(), 1000);
            }
        }
    }
    
    // Update mission progress if available
    if (sessionData.mission_progress) {
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        if (progressBar && progressText) {
            progressBar.style.width = sessionData.mission_progress.percentage + '%';
            progressText.textContent = `${sessionData.mission_progress.completed}/${sessionData.mission_progress.total} teams completed`;
        }
    }
    
    // Update team-specific mission progress
    updateTeamMissionProgress();
}

function updateTeamMissionProgress() {
    const sessionCode = document.querySelector('[data-session-code]')?.dataset.sessionCode;
    if (!sessionCode) return;
    
    // Get detailed progress for all teams
    fetch(`/learn/api/design-thinking/${sessionCode}/status/`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.teams) {
            data.teams.forEach(team => {
                updateIndividualTeamProgress(team.id);
            });
        }
    })
    .catch(error => console.warn('Could not fetch team progress:', error));
}

function updateIndividualTeamProgress(teamId) {
    const sessionCode = document.querySelector('[data-session-code]')?.dataset.sessionCode;
    if (!sessionCode) return;
    
    // Get team-specific data by making a request with team context
    // Note: This would ideally be a team-specific endpoint, but we'll use the general one
    // and filter for now, or enhance the API to accept team parameters
    
    // For now, we'll use WebSocket data or enhance this when team joins
    const empathyCountElement = document.querySelector(`.empathy-observation-count[data-team-id="${teamId}"]`);
    const submissionCountElement = document.querySelector(`.mission-submission-count[data-team-id="${teamId}"]`);
    
    if (empathyCountElement) {
        empathyCountElement.textContent = '0';
    }
    if (submissionCountElement) {
        submissionCountElement.textContent = '0';
    }
}

function handleMissionAdvanced(missionData) {
    showSuccessMessage(`üéØ Mission advanced: ${missionData.title}`);
    
    // Update current mission display
    const missionTitle = document.getElementById('current-mission-title');
    const missionDescription = document.getElementById('current-mission-description');
    const missionEmoji = document.getElementById('mission-emoji');
    
    if (missionTitle) missionTitle.textContent = missionData.title;
    if (missionDescription) missionDescription.textContent = missionData.description;
    
    // Update mission emoji
    if (missionEmoji) {
        const emojiMap = {
            'kickoff': 'üöÄ',
            'empathy': 'üîç',
            'define': 'üéØ',
            'ideate': 'üí°',
            'prototype': 'üîß',
            'showcase': 'üèÜ'
        };
        missionEmoji.textContent = emojiMap[missionData.mission_type] || 'üìã';
    }
    
    // Refresh page after short delay to update UI
    setTimeout(() => window.location.reload(), 2000);
}

function handleTeamSubmission(teamData, submissionData) {
    // Add to recent submissions
    const recentSubmissions = document.getElementById('recent-submissions');
    if (recentSubmissions) {
        const submissionElement = document.createElement('div');
        submissionElement.className = 'flex items-center p-3 bg-green-50 rounded-xl border border-green-200';
        submissionElement.innerHTML = `
            <div class="text-2xl mr-3">${teamData.emoji}</div>
            <div class="flex-1">
                <div class="font-semibold text-gray-900">${teamData.name}</div>
                <div class="text-sm text-gray-600">${submissionData.type}</div>
                <div class="text-xs text-green-600">Just submitted</div>
            </div>
            ${submissionData.has_file ? '<div class="text-green-600">üìé</div>' : ''}
        `;
        
        // Add to top of submissions list
        recentSubmissions.insertBefore(submissionElement, recentSubmissions.firstChild);
        
        // Remove oldest if more than 10
        const submissions = recentSubmissions.children;
        if (submissions.length > 10) {
            recentSubmissions.removeChild(submissions[submissions.length - 1]);
        }
    }
    
    // Update real-time progress indicators
    updateTeamProgressIndicators(teamData.id, submissionData);
    
    // Flash team card to show activity
    const teamCard = document.querySelector(`[data-team-id="${teamData.id}"]`);
    if (teamCard) {
        teamCard.classList.add('ring-2', 'ring-green-400');
        setTimeout(() => {
            teamCard.classList.remove('ring-2', 'ring-green-400');
        }, 2000);
    }
    
    showSuccessMessage(`üìù ${teamData.name} made a submission!`);
}

function updateTeamProgressIndicators(teamId, submissionData) {
    const empathyCountElement = document.querySelector(`.empathy-observation-count[data-team-id="${teamId}"]`);
    const submissionCountElement = document.querySelector(`.mission-submission-count[data-team-id="${teamId}"]`);
    
    // Update empathy observation count if this is an empathy observation
    if (submissionData.submission_type === 'empathy_observation' && empathyCountElement) {
        const currentCount = parseInt(empathyCountElement.textContent) || 0;
        const newCount = currentCount + 1;
        empathyCountElement.textContent = newCount;
        
        // Add visual indicator for completion
        if (newCount >= 5) {
            empathyCountElement.classList.add('text-green-600', 'font-bold');
            const parentCard = empathyCountElement.closest('.bg-white');
            if (parentCard) {
                parentCard.classList.add('bg-green-50', 'border-green-300');
                parentCard.classList.remove('border');
            }
        }
    }
    
    // Update general submission count
    if (submissionCountElement) {
        const currentCount = parseInt(submissionCountElement.textContent) || 0;
        submissionCountElement.textContent = currentCount + 1;
    }
}

function handleTeamProgress(teamData, progressData) {
    showSuccessMessage(`üéØ ${teamData.name} completed their mission!`);
    
    // Update progress tracking
    updateSessionStatus({mission_progress: progressData});
}

function handleTeamSpotlight(teamData, reason) {
    showSuccessMessage(`üåü ${teamData.name} is being spotlighted: ${reason}`);
}

// Spotlight team function
function spotlightTeam(teamId, teamName) {
    if (designThinkingSocket && designThinkingSocket.readyState === WebSocket.OPEN) {
        designThinkingSocket.send(JSON.stringify({
            type: 'mission_control',
            action: 'spotlight_team',
            team_id: teamId
        }));
        showSuccessMessage(`üåü Spotlighting ${teamName}!`);
    }
}

// Enhanced Vani AI Functions
function vaniGuidance(type) {
    const messages = {
        'welcome': {
            title: 'üéâ Welcome to Design Thinking!',
            message: 'Hello innovators! I\'m Vani, your AI guide. Let\'s embark on this creative journey together and solve real-world problems!'
        },
        'encouragement': {
            title: 'üí™ Keep Going!',
            message: 'You\'re doing amazing work! Remember, every great innovation starts with curiosity and persistence. Trust the process!'
        },
        'mission_help': {
            title: 'üéØ Mission Guidance',
            message: 'Need help with the current mission? Take your time to understand the challenge, collaborate with your team, and don\'t be afraid to think outside the box!'
        }
    };
    
    const msg = messages[type];
    if (msg) {
        sendVaniNudge(msg.title, msg.message);
    }
}

function sendCustomVaniMessage() {
    const messageElement = document.getElementById('vani-custom-message');
    const message = messageElement.value.trim();
    
    if (message) {
        sendVaniNudge('üì¢ Message from your Teacher', message);
        messageElement.value = '';
    } else {
        alert('Please enter a message first!');
    }
}

function generateQRCode() {
    const qrContainer = document.getElementById('qr-code');
    const qrPlaceholder = document.getElementById('qr-placeholder');
    const sessionCode = '{{ session.session_code }}';
    const joinUrl = `${window.location.origin}/learn/design-thinking/?join=${sessionCode}`;
    
    try {
        // Clear any existing QR code
        qrContainer.innerHTML = '';
        
        // Generate QR code using qrcode-generator library
        if (typeof qrcode !== 'undefined') {
            const qr = qrcode(0, 'M');
            qr.addData(joinUrl);
            qr.make();
            
            // Create the QR code as HTML
            const qrHTML = qr.createImgTag(4, 8, 'QR Code for joining session');
            qrContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center">${qrHTML}</div>`;
            
            // Style the generated image
            const qrImg = qrContainer.querySelector('img');
            if (qrImg) {
                qrImg.className = 'w-full h-full object-contain rounded';
                qrImg.style.maxWidth = '100%';
                qrImg.style.maxHeight = '100%';
            }
        } else {
            throw new Error('QR code library not loaded');
        }
        
        // Hide placeholder and show QR code
        qrPlaceholder.classList.add('hidden');
        qrContainer.classList.remove('hidden');
        
        showSuccessMessage('‚úÖ QR Code generated successfully!');
    } catch (error) {
        console.error('QR Code generation failed:', error);
        // Fallback: Create a simple text-based QR alternative
        createTextQRFallback(qrContainer, qrPlaceholder, sessionCode);
    }
}

function createTextQRFallback(qrContainer, qrPlaceholder, sessionCode) {
    const joinUrl = `${window.location.origin}/learn/design-thinking/?join=${sessionCode}`;
    
    // Try API-based QR code generation first
    try {
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=112x112&data=${encodeURIComponent(joinUrl)}`;
        qrContainer.innerHTML = `
            <div class="w-full h-full flex items-center justify-center">
                <img src="${qrApiUrl}" 
                     alt="QR Code for joining session" 
                     class="w-full h-full object-contain rounded"
                     onerror="this.parentElement.innerHTML='<div class=\\"w-full h-full bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex flex-col items-center justify-center text-white text-center p-2\\"><div class=\\"text-xs font-bold mb-1\\">SCAN TO JOIN</div><div class=\\"text-lg font-mono font-bold\\">${sessionCode}</div><div class=\\"text-xs mt-1\\">decipherworld.com</div></div>';">
            </div>
        `;
        qrPlaceholder.classList.add('hidden');
        qrContainer.classList.remove('hidden');
        showSuccessMessage('‚úÖ QR Code generated via API!');
    } catch (error) {
        // Final fallback: Text-based display
        qrContainer.innerHTML = `
            <div class="w-full h-full bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex flex-col items-center justify-center text-white text-center p-2">
                <div class="text-xs font-bold mb-1">SCAN TO JOIN</div>
                <div class="text-lg font-mono font-bold">${sessionCode}</div>
                <div class="text-xs mt-1">decipherworld.com</div>
            </div>
        `;
        qrPlaceholder.classList.add('hidden');
        qrContainer.classList.remove('hidden');
        showSuccessMessage('üì± Join code displayed!');
    }
}

// Live Timer for Session Duration
function updateLiveTimer() {
    const timerElement = document.querySelector('.live-timer');
    if (!timerElement) return;
    
    const startTime = new Date(timerElement.dataset.start);
    const now = new Date();
    const diff = Math.floor((now - startTime) / 1000);
    
    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;
    
    if (hours > 0) {
        timerElement.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
}

// Enhanced team card animations
function enhanceTeamCards() {
    const teamCards = document.querySelectorAll('[data-team-id]');
    teamCards.forEach(card => {
        // Add smooth hover effects
        card.style.transition = 'all 0.2s ease';
        
        // Animate submission counters when they update
        const submissionCounters = card.querySelectorAll('.mission-submission-count, .empathy-observation-count');
        submissionCounters.forEach(counter => {
            const observer = new MutationObserver(() => {
                counter.style.color = '#10B981';
                counter.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    counter.style.color = '';
                    counter.style.transform = 'scale(1)';
                }, 600);
            });
            observer.observe(counter, { childList: true, subtree: true });
        });
    });
}

// Real-time connection status indicator
function updateConnectionStatus() {
    const statusIndicators = document.querySelectorAll('.animate-pulse');
    const isConnected = designThinkingSocket && designThinkingSocket.readyState === WebSocket.OPEN;
    
    statusIndicators.forEach(indicator => {
        if (indicator.classList.contains('bg-green-400') || indicator.classList.contains('bg-red-400')) {
            if (isConnected) {
                indicator.classList.remove('bg-red-400');
                indicator.classList.add('bg-green-400');
            } else {
                indicator.classList.remove('bg-green-400');
                indicator.classList.add('bg-red-400');
            }
        }
    });
}

// Add sparkle animation to progress circles
function animateProgressElements() {
    const progressCircles = document.querySelectorAll('svg path[stroke-dasharray]');
    progressCircles.forEach(circle => {
        const dashArray = circle.getAttribute('stroke-dasharray');
        if (dashArray && !dashArray.startsWith('0,')) {
            circle.style.filter = 'drop-shadow(0 0 4px rgba(16, 185, 129, 0.4))';
        }
    });
}

// Initialize all modern visual features
function initializeModernFeatures() {
    // Start live timer
    if (document.querySelector('.live-timer')) {
        setInterval(updateLiveTimer, 1000);
        updateLiveTimer();
    }
    
    // Enhance team cards
    enhanceTeamCards();
    
    // Monitor connection status
    setInterval(updateConnectionStatus, 3000);
    updateConnectionStatus();
    
    // Add progress animations
    animateProgressElements();
    
    // Add smooth scrolling
    document.documentElement.style.scrollBehavior = 'smooth';
    
    // Add loading states to buttons
    const actionButtons = document.querySelectorAll('button[onclick]');
    actionButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const originalText = this.innerHTML;
            this.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...';
            this.disabled = true;
            
            setTimeout(() => {
                this.innerHTML = originalText;
                this.disabled = false;
            }, 2000);
        });
    });
}

// Auto-generate QR code when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modern features
    initializeModernFeatures();
    
    // Delay to ensure page is fully loaded
    setTimeout(() => {
        if (typeof qrcode !== 'undefined') {
            generateQRCode();
        } else {
            // If QRCode library is not available, use fallback
            const qrContainer = document.getElementById('qr-code');
            const qrPlaceholder = document.getElementById('qr-placeholder');
            const sessionCode = '{{ session.session_code }}';
            createTextQRFallback(qrContainer, qrPlaceholder, sessionCode);
        }
    }, 1500);
});

function downloadSession() {
    // Implementation for session data export
    showSuccessMessage('üìä Session data exported! (Feature coming soon)');
}

function viewTeamDetails(teamId) {
    // Implementation for team details view
    showSuccessMessage(`üë• Viewing details for team ${teamId} (Feature coming soon)`);
}

function sendTeamMessage(teamId) {
    // Implementation for sending message to specific team
    const message = prompt('Enter message for the team:');
    if (message) {
        showSuccessMessage(`üí¨ Message sent to team ${teamId}!`);
    }
}

// Send Vani nudge
function sendVaniNudge(title, message) {
    if (designThinkingSocket && designThinkingSocket.readyState === WebSocket.OPEN) {
        designThinkingSocket.send(JSON.stringify({
            type: 'mission_control',
            action: 'send_nudge',
            nudge_data: {
                title: title,
                message: message,
                emoji: 'ü§ñ',
                background_color: '#10B981'
            }
        }));
        showSuccessMessage('üì¢ Vani nudge sent to all teams!');
    }
}

// Initialize WebSocket when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeWebSocket();
    
    // Add spotlight buttons to team cards
    const teamCards = document.querySelectorAll('.team-card');
    teamCards.forEach(card => {
        const teamId = card.dataset.teamId;
        const teamName = card.dataset.teamName;
        
        if (teamId && teamName) {
            const spotlightBtn = document.createElement('button');
            spotlightBtn.innerHTML = 'üåü';
            spotlightBtn.className = 'text-yellow-500 hover:text-yellow-600 p-1 rounded';
            spotlightBtn.title = 'Spotlight this team';
            spotlightBtn.onclick = () => spotlightTeam(teamId, teamName);
            
            card.appendChild(spotlightBtn);
        }
    });
});

// Close WebSocket when page unloads
window.addEventListener('beforeunload', function() {
    if (designThinkingSocket) {
        designThinkingSocket.close();
    }
});
</script>

</div> <!-- End of main content container -->
{% endblock content %}