{% extends 'games/base.html' %}
{% load static %}

{% block title %}{{ team.team_name }} - Design Challenge{% endblock %}
{% block description %}Simplified student interface for Design Thinking Challenge. Quick inputs and auto-progression.{% endblock %}

{% block extra_head %}
<script>
// Override DaisyUI theme configuration for classroom background
document.documentElement.style.setProperty('--fallback-b1', '240 248 255');
document.documentElement.style.setProperty('--fallback-b2', '230 243 255'); 
document.documentElement.style.setProperty('--fallback-b3', '255 248 220');
</script>
<style>
/* Simplified Student Dashboard Design System */
:root {
    --primary-color: #3b82f6;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-600: #4b5563;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    
    /* Classroom Theme Colors */
    --classroom-blue: #e0f2fe;
    --classroom-green: #f0fdf4;
    --classroom-yellow: #fffbeb;
    --classroom-purple: #faf5ff;
    --chalkboard-green: #065f46;
    --paper-white: #fefefe;
}

/* Override DaisyUI theme colors and set vibrant green classroom background */
[data-theme="games"] {
    --b1: 240 253 244; /* Light green background */
    --b2: 220 252 231; /* Medium green */  
    --b3: 187 247 208; /* Brighter green accent */
}

body {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 25%, #60a5fa 50%, #93c5fd 75%, #dbeafe 100%);
    min-height: 100vh;
    position: relative;
}

body::before {
    content: '' !important;
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        /* Interactive Chalkboard with Design Thinking Process */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200" viewBox="0 0 300 200"><rect x="20" y="20" width="260" height="160" fill="%23065f46" stroke="%23fbbf24" stroke-width="4" rx="8"/><text x="40" y="50" font-family="Arial" font-size="16" fill="%23ffffff" font-weight="bold">DESIGN THINKING</text><circle cx="60" cy="80" r="15" fill="%23ef4444"/><text x="52" y="88" font-family="Arial" font-size="14" fill="%23ffffff">üëÅÔ∏è</text><text x="85" y="88" font-family="Arial" font-size="12" fill="%23fbbf24">EMPATHY</text><circle cx="150" cy="80" r="15" fill="%23f59e0b"/><text x="142" y="88" font-family="Arial" font-size="14" fill="%23ffffff">üéØ</text><text x="175" y="88" font-family="Arial" font-size="12" fill="%23fbbf24">DEFINE</text><circle cx="240" cy="80" r="15" fill="%238b5cf6"/><text x="232" y="88" font-family="Arial" font-size="14" fill="%23ffffff">üí°</text><text x="40" y="130" font-family="Arial" font-size="12" fill="%23fbbf24">IDEATE</text><circle cx="120" cy="120" r="15" fill="%2316a34a"/><text x="112" y="128" font-family="Arial" font-size="14" fill="%23ffffff">üõ†Ô∏è</text><text x="145" y="128" font-family="Arial" font-size="12" fill="%23fbbf24">PROTOTYPE</text><path d="M 75 80 L 135 80 M 165 80 L 225 80 M 150 95 L 120 105" stroke="%23fbbf24" stroke-width="3" fill="none"/></svg>'),
        /* Modern Student Workstation */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="180" height="120" viewBox="0 0 180 120"><rect x="20" y="70" width="140" height="40" fill="%23d4b896" stroke="%23a0895c" stroke-width="3" rx="5"/><rect x="25" y="60" width="130" height="12" fill="%23f3e8d3" stroke="%23a0895c" stroke-width="2" rx="3"/><rect x="40" y="30" width="25" height="30" fill="%232563eb" rx="3"/><text x="47" y="50" font-family="Arial" font-size="8" fill="%23ffffff">üìö</text><rect x="75" y="35" width="20" height="25" fill="%23dc2626" rx="2"/><text x="80" y="52" font-family="Arial" font-size="8" fill="%23ffffff">üìñ</text><circle cx="110" cy="45" r="8" fill="%23fbbf24"/><text x="105" y="50" font-family="Arial" font-size="10" fill="%23ffffff">‚úèÔ∏è</text><rect x="130" y="40" width="15" height="20" fill="%2316a34a" rx="2"/><text x="133" y="55" font-family="Arial" font-size="8" fill="%23ffffff">üìù</text></svg>'),
        /* Creative Brain with Ideas */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="100" viewBox="0 0 120 100"><ellipse cx="60" cy="50" rx="35" ry="30" fill="%23f472b6" stroke="%23be185d" stroke-width="3"/><circle cx="45" cy="40" r="4" fill="%23fbbf24"/><circle cx="60" cy="35" r="3" fill="%2316a34a"/><circle cx="75" cy="42" r="4" fill="%232563eb"/><path d="M 40 55 Q 50 45 60 55 Q 70 45 80 55" stroke="%23ffffff" stroke-width="2" fill="none"/><circle cx="30" cy="25" r="6" fill="%23fbbf24" opacity="0.8"/><text x="26" y="30" font-family="Arial" font-size="8" fill="%23ffffff">üí°</text><circle cx="90" cy="20" r="5" fill="%23ef4444" opacity="0.8"/><text x="87" y="25" font-family="Arial" font-size="6" fill="%23ffffff">‚ù§Ô∏è</text><circle cx="100" cy="65" r="4" fill="%2316a34a" opacity="0.8"/><text x="97" y="69" font-family="Arial" font-size="6" fill="%23ffffff">‚öôÔ∏è</text></svg>'),
        /* Collaboration Zone */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="140" viewBox="0 0 160 140"><circle cx="50" cy="60" r="20" fill="%234f46e5" stroke="%23ffffff" stroke-width="3"/><text x="43" y="68" font-family="Arial" font-size="16" fill="%23ffffff">üë®</text><circle cx="110" cy="60" r="20" fill="%23ec4899" stroke="%23ffffff" stroke-width="3"/><text x="103" y="68" font-family="Arial" font-size="16" fill="%23ffffff">üë©</text><circle cx="80" cy="100" r="18" fill="%2316a34a" stroke="%23ffffff" stroke-width="3"/><text x="74" y="108" font-family="Arial" font-size="14" fill="%23ffffff">üë¶</text><path d="M 65 70 L 95 70 M 60 80 L 80 85 M 100 80 L 80 85" stroke="%23fbbf24" stroke-width="4" fill="none"/><circle cx="80" cy="30" r="12" fill="%23fbbf24"/><text x="74" y="37" font-family="Arial" font-size="12" fill="%23065f46">üí≠</text></svg>'),
        /* Innovation Laboratory */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="120" viewBox="0 0 200 120"><rect x="30" y="80" width="140" height="30" fill="%236b7280" stroke="%23374151" stroke-width="2" rx="4"/><circle cx="60" cy="60" r="15" fill="%23ef4444" opacity="0.8"/><circle cx="60" cy="45" r="8" fill="%23fbbf24"/><rect x="50" y="70" width="20" height="10" fill="%234b5563" rx="2"/><circle cx="100" cy="55" r="12" fill="%2316a34a" opacity="0.7"/><circle cx="100" cy="42" r="6" fill="%23065f46"/><rect x="92" y="67" width="16" height="8" fill="%234b5563" rx="1"/><circle cx="140" cy="58" r="14" fill="%238b5cf6" opacity="0.8"/><circle cx="140" cy="44" r="7" fill="%235b21b6"/><rect x="132" y="72" width="16" height="8" fill="%234b5563" rx="1"/><path d="M 75 50 Q 85 40 95 50 M 115 50 Q 125 40 135 50" stroke="%23fbbf24" stroke-width="2" fill="none"/></svg>'),
        /* Growth and Nature Elements */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="160" viewBox="0 0 140 160"><ellipse cx="70" cy="140" rx="40" ry="15" fill="%2322c55e" opacity="0.6"/><rect x="65" y="80" width="10" height="60" fill="%23065f46"/><ellipse cx="45" cy="70" rx="15" ry="20" fill="%2316a34a"/><ellipse cx="70" cy="65" rx="18" ry="25" fill="%2322c55e"/><ellipse cx="95" cy="70" rx="15" ry="20" fill="%2334d399"/><circle cx="35" cy="60" r="8" fill="%23fbbf24"/><circle cx="70" cy="50" r="6" fill="%23f59e0b"/><circle cx="105" cy="58" r="7" fill="%23ef4444"/><path d="M 35 52 Q 40 45 45 52 M 70 42 Q 75 35 80 42 M 105 50 Q 110 43 115 50" stroke="%23fbbf24" stroke-width="2" fill="none"/><text x="30" y="30" font-family="Arial" font-size="12" fill="%23065f46">üå±</text><text x="60" y="25" font-family="Arial" font-size="14" fill="%23065f46">üåø</text><text x="100" y="35" font-family="Arial" font-size="12" fill="%23065f46">üå≥</text></svg>') !important;
    background-size: 
        200px 150px,
        300px 180px,
        120px 90px,
        100px 120px,
        150px 100px,
        250px 150px !important;
    background-position: 
        5% 85%,
        85% 10%,
        25% 45%,
        75% 70%,
        50% 25%,
        10% 15% !important;
    background-repeat: no-repeat !important;
    opacity: 0.4;
    pointer-events: none;
    z-index: -1 !important;
    display: block !important;
}

/* Additional floating classroom elements */
body::after {
    content: '' !important;
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        /* Design Process Icons */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"><circle cx="30" cy="30" r="25" fill="%23fbbf24" opacity="0.9"/><text x="25" y="38" font-family="Arial" font-size="20" fill="%23065f46">üëÅÔ∏è</text><text x="20" y="52" font-family="Arial" font-size="8" fill="%23065f46" font-weight="bold">EMPATHY</text></svg>'),
        /* Innovation Sparks */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="%23ef4444" opacity="0.8"/><text x="20" y="32" font-family="Arial" font-size="16" fill="%23ffffff">üí°</text><circle cx="10" cy="10" r="3" fill="%23fbbf24"/><circle cx="40" cy="15" r="2" fill="%23f59e0b"/><circle cx="35" cy="40" r="3" fill="%23fbbf24"/><circle cx="15" cy="35" r="2" fill="%23f59e0b"/></svg>'),
        /* Collaboration Connections */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="70" height="50" viewBox="0 0 70 50"><circle cx="15" cy="25" r="12" fill="%2316a34a" opacity="0.8"/><text x="10" y="30" font-family="Arial" font-size="12" fill="%23ffffff">üë¶</text><circle cx="55" cy="25" r="12" fill="%238b5cf6" opacity="0.8"/><text x="50" y="30" font-family="Arial" font-size="12" fill="%23ffffff">üëß</text><path d="M 27 25 L 43 25" stroke="%23fbbf24" stroke-width="4"/><circle cx="35" cy="25" r="3" fill="%23fbbf24"/></svg>'),
        /* Growth Mindset Trees */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="80" viewBox="0 0 60 80"><ellipse cx="30" cy="70" rx="20" ry="8" fill="%2322c55e" opacity="0.6"/><rect x="28" y="45" width="4" height="25" fill="%23065f46"/><circle cx="30" cy="30" r="15" fill="%2316a34a" opacity="0.8"/><text x="25" y="36" font-family="Arial" font-size="12" fill="%23ffffff">üå≥</text><circle cx="20" cy="20" r="4" fill="%23fbbf24"/><circle cx="40" cy="25" r="3" fill="%23f59e0b"/><circle cx="35" cy="15" r="3" fill="%23ef4444"/></svg>'),
        /* Creative Tools */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="60" viewBox="0 0 80 60"><rect x="10" y="25" width="30" height="4" fill="%23fbbf24" rx="2"/><circle cx="50" cy="27" r="8" fill="%23ef4444" opacity="0.8"/><text x="46" y="32" font-family="Arial" font-size="8" fill="%23ffffff">‚úèÔ∏è</text><rect x="15" y="40" width="20" height="15" fill="%232563eb" opacity="0.7" rx="2"/><text x="20" y="50" font-family="Arial" font-size="8" fill="%23ffffff">üìê</text><circle cx="65" cy="45" r="6" fill="%2316a34a"/><text x="61" y="49" font-family="Arial" font-size="6" fill="%23ffffff">üìè</text></svg>'),
        /* Classroom Pencils and Pens */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="80" viewBox="0 0 100 80"><rect x="10" y="20" width="35" height="6" fill="%23fbbf24" rx="3"/><rect x="8" y="18" width="6" height="10" fill="%23f59e0b" rx="1"/><rect x="47" y="22" width="2" height="2" fill="%23374151"/><rect x="15" y="35" width="40" height="5" fill="%232563eb" rx="2"/><rect x="13" y="33" width="5" height="9" fill="%231d4ed8" rx="1"/><circle cx="57" cy="37" r="2" fill="%23374151"/><rect x="25" y="50" width="30" height="4" fill="%23dc2626" rx="2"/><rect x="23" y="48" width="4" height="8" fill="%23b91c1c" rx="1"/><rect x="57" y="51" width="2" height="2" fill="%23374151"/><rect x="70" y="15" width="25" height="3" fill="%2316a34a" rx="1"/><circle cx="96" cy="16" r="1" fill="%23374151"/></svg>'),
        /* Whiteboard with Markers */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 150 100"><rect x="10" y="15" width="120" height="70" fill="%23ffffff" stroke="%23374151" stroke-width="3" rx="4"/><rect x="20" y="25" width="100" height="50" fill="%23f9fafb" stroke="%23d1d5db" stroke-width="1" rx="2"/><text x="25" y="40" font-family="Arial" font-size="8" fill="%232563eb">DESIGN THINKING</text><text x="25" y="52" font-family="Arial" font-size="6" fill="%23ef4444">1. EMPATHY</text><text x="25" y="62" font-family="Arial" font-size="6" fill="%23f59e0b">2. DEFINE</text><text x="25" y="72" font-family="Arial" font-size="6" fill="%238b5cf6">3. IDEATE</text><rect x="135" y="20" width="3" height="15" fill="%23ef4444" rx="1"/><rect x="135" y="40" width="3" height="15" fill="%232563eb" rx="1"/><rect x="135" y="60" width="3" height="15" fill="%2316a34a" rx="1"/></svg>'),
        /* School Supplies Collection */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="90" viewBox="0 0 120 90"><circle cx="25" cy="25" r="12" fill="%23fbbf24" opacity="0.8"/><rect x="20" y="20" width="10" height="10" fill="%23ffffff" rx="1"/><text x="22" y="28" font-family="Arial" font-size="6" fill="%23374151">‚ö™</text><rect x="50" y="15" width="20" height="4" fill="%23ef4444" rx="2"/><rect x="52" y="12" width="16" height="2" fill="%23f59e0b" rx="1"/><rect x="48" y="20" width="24" height="8" fill="%23ffffff" stroke="%23d1d5db" stroke-width="1" rx="2"/><circle cx="90" cy="25" r="8" fill="%232563eb" opacity="0.7"/><rect x="85" y="30" width="10" height="3" fill="%231d4ed8"/><rect x="20" y="50" width="25" height="3" fill="%236b7280" rx="1"/><circle cx="22" cy="56" r="2" fill="%234b5563"/><circle cx="43" cy="56" r="2" fill="%234b5563"/><rect x="55" y="45" width="15" height="20" fill="%2316a34a" rx="2"/><text x="58" y="58" font-family="Arial" font-size="8" fill="%23ffffff">üìí</text><circle cx="90" cy="55" r="6" fill="%23f59e0b"/><rect x="88" y="50" width="4" height="2" fill="%23d97706"/></svg>'),
        /* Calculator and Tech Tools */
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="100" viewBox="0 0 80 100"><rect x="15" y="20" width="30" height="40" fill="%23374151" stroke="%23111827" stroke-width="2" rx="3"/><rect x="18" y="23" width="24" height="8" fill="%23065f46" rx="1"/><text x="25" y="29" font-family="Arial" font-size="6" fill="%23ffffff">123</text><circle cx="22" cy="35" r="2" fill="%23d1d5db"/><circle cx="30" cy="35" r="2" fill="%23d1d5db"/><circle cx="38" cy="35" r="2" fill="%23d1d5db"/><circle cx="22" cy="42" r="2" fill="%23d1d5db"/><circle cx="30" cy="42" r="2" fill="%23d1d5db"/><circle cx="38" cy="42" r="2" fill="%23d1d5db"/><circle cx="22" cy="49" r="2" fill="%23d1d5db"/><circle cx="30" cy="49" r="2" fill="%23d1d5db"/><circle cx="38" cy="49" r="2" fill="%23f59e0b"/><rect x="50" y="30" width="20" height="25" fill="%232563eb" rx="2"/><text x="55" y="45" font-family="Arial" font-size="8" fill="%23ffffff">üì±</text></svg>') !important;
    background-size: 
        60px 70px,
        45px 55px,
        70px 50px,
        60px 80px,
        80px 60px,
        100px 80px,
        150px 100px,
        120px 90px,
        80px 100px !important;
    background-position: 
        85% 20%,
        10% 65%,
        75% 75%,
        25% 15%,
        95% 60%,
        5% 25%,
        50% 5%,
        70% 40%,
        40% 85% !important;
    background-repeat: no-repeat !important;
    opacity: 0.3;
    pointer-events: none;
    z-index: -1 !important;
    display: block !important;
    animation: floatClassroom 20s ease-in-out infinite;
}

@keyframes floatClassroom {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    25% { transform: translateY(-10px) rotate(1deg); }
    50% { transform: translateY(-5px) rotate(-1deg); }
    75% { transform: translateY(-15px) rotate(0.5deg); }
}

/* CRITICAL FIX: Ensure main content doesn't block classroom background */
main {
    background: transparent !important;
    min-height: 100vh;
}

/* Mobile-first simplified layout - with transparent background to show classroom theme */
.student-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 16px;
    position: relative;
    z-index: 1;
    background: transparent; /* Allow classroom background to show through */
}

/* PROMINENT Step Progress Display */
#progress-text {
    background: linear-gradient(135deg, #ef4444 0%, #f97316 50%, #fbbf24 100%) !important;
    color: white !important;
    font-size: 18px !important;
    font-weight: 800 !important;
    padding: 12px 24px !important;
    border-radius: 25px !important;
    border: 3px solid #ffffff !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(239, 68, 68, 0.5) !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    animation: pulseStep 2s ease-in-out infinite !important;
    backdrop-filter: blur(10px) !important;
    position: relative !important;
    z-index: 100 !important;
}

#progress-text::before {
    content: 'üéØ ' !important;
    font-size: 20px !important;
    margin-right: 8px !important;
}

@keyframes pulseStep {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(239, 68, 68, 0.5);
    }
    50% { 
        transform: scale(1.05); 
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4), 0 0 0 5px rgba(239, 68, 68, 0.7);
    }
}

/* Phase progress bar - classroom themed */
.phase-progress {
    background: rgba(255, 255, 255, 0.8);
    height: 12px;
    border-radius: 8px;
    margin-bottom: 24px;
    overflow: hidden;
    border: 2px solid rgba(255, 255, 255, 0.9);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
}

.phase-progress-fill {
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
    height: 100%;
    transition: width 0.5s ease;
    position: relative;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3);
}

.phase-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: progressShimmer 2s infinite;
}

@keyframes progressShimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Current phase card - transparent to show classroom theme */
.phase-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--card-shadow);
    margin-bottom: 20px;
    border: 2px solid var(--primary-color);
    position: relative;
    overflow: hidden;
}

/* Classroom-themed backgrounds for each phase */
.empathy-card {
    background: linear-gradient(135deg, var(--classroom-blue) 0%, #f0f9ff 100%);
    background-image: 
        radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"><g fill="none" fill-rule="evenodd"><g fill="%23e0f2fe" fill-opacity="0.3"><circle cx="30" cy="30" r="2"/></g></g></svg>');
    border: 3px solid #0ea5e9;
}

.define-card {
    background: linear-gradient(135deg, var(--classroom-yellow) 0%, #fef3c7 100%);
    background-image: 
        radial-gradient(circle at 25% 75%, rgba(245, 158, 11, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 25%, rgba(217, 119, 6, 0.1) 0%, transparent 50%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><g fill="none" fill-rule="evenodd"><g fill="%23fbbf24" fill-opacity="0.2"><polygon points="20,1 40,40 1,40"/></g></g></svg>');
    border: 3px solid #f59e0b;
}

.ideate-card {
    background: linear-gradient(135deg, var(--classroom-purple) 0%, #f3e8ff 100%);
    background-image: 
        radial-gradient(circle at 30% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 70% 30%, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50"><g fill="none" fill-rule="evenodd"><g fill="%23a855f7" fill-opacity="0.2"><path d="M25,5 L35,20 L15,20 Z M25,45 L35,30 L15,30 Z"/></g></g></svg>');
    border: 3px solid #8b5cf6;
}

.prototype-card {
    background: linear-gradient(135deg, var(--classroom-green) 0%, #dcfce7 100%);
    background-image: 
        radial-gradient(circle at 35% 65%, rgba(34, 197, 94, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 65% 35%, rgba(22, 163, 74, 0.1) 0%, transparent 50%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30"><g fill="none" fill-rule="evenodd"><g fill="%2322c55e" fill-opacity="0.2"><rect width="6" height="6" x="12" y="12"/><rect width="4" height="4" x="2" y="2"/><rect width="4" height="4" x="24" y="24"/></g></g></svg>');
    border: 3px solid #16a34a;
}

.phase-card.completed {
    border-color: var(--success-color);
    background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
}

.phase-card.waiting {
    border-color: var(--warning-color);
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
}

/* Simple form inputs */
.simple-input-group {
    margin-bottom: 20px;
}

.simple-input-group label {
    display: block;
    font-weight: 600;
    color: var(--gray-600);
    margin-bottom: 8px;
    font-size: 16px;
}

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.radio-option {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: var(--gray-50);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.radio-option:hover {
    background: var(--gray-100);
    border-color: var(--primary-color);
}

.radio-option.selected {
    background: #dbeafe;
    border-color: var(--primary-color);
}

.radio-option input[type="radio"] {
    margin-right: 12px;
    transform: scale(1.2);
}

.dropdown-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 16px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    cursor: pointer;
    transition: border-color 0.2s ease;
}

.dropdown-select:focus {
    outline: none;
    border-color: var(--primary-color);
}

.text-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 16px;
    font-family: inherit;
    transition: border-color 0.2s ease;
}

.text-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* Submit button */
.submit-btn {
    background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
    color: white;
    padding: 16px 32px;
    border-radius: 12px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.submit-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Team status indicator */
.team-status {
    background: var(--gray-50);
    padding: 16px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 20px;
}

.team-status.completed {
    background: #f0fdf4;
    color: var(--success-color);
}

.team-status.waiting {
    background: #fffbeb;
    color: var(--warning-color);
}

/* Auto-advance notification */
.auto-advance-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success-color);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.auto-advance-notification.show {
    transform: translateX(0);
}

/* Loading states */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.loading-overlay.show {
    opacity: 1;
    visibility: visible;
}

.loading-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #ffffff33;
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Simplified inputs styling for themed cards */
.simplified-inputs-container {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 24px;
    margin: 20px 0;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.simplified-inputs-container .simple-input-group {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.simplified-inputs-container .simple-input-label {
    font-size: 16px;
    font-weight: 600;
    color: var(--chalkboard-green);
    margin-bottom: 12px;
    display: block;
}

.simplified-inputs-container .radio-group {
    display: grid;
    gap: 8px;
}

.simplified-inputs-container .radio-option {
    background: var(--paper-white);
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
}

.simplified-inputs-container .radio-option:hover {
    border-color: var(--primary-color);
    background: var(--classroom-blue);
    transform: translateY(-1px);
}

.simplified-inputs-container .radio-option.selected {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: white;
    font-weight: 600;
}

/* Simplified mode enhancements */
.phase-card.simplified-mode {
    transition: all 0.5s ease;
}

.phase-card.simplified-mode .phase-header {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.phase-card.simplified-mode .simplified-inputs-container {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Enhanced phase card animations */
.phase-card {
    animation: slideInFromRight 0.6s ease;
}

@keyframes slideInFromRight {
    from {
        opacity: 0;
        transform: translateX(50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .student-container {
        padding: 12px;
    }
    
    .phase-card {
        padding: 20px;
        margin-bottom: 16px;
    }
    
    .radio-group {
        gap: 8px;
    }
    
    .radio-option {
        padding: 10px 12px;
    }
    
    .submit-btn {
        padding: 14px 24px;
    }
}

/* Completion Screen Styles */
.completion-screen {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 16px;
    padding: 32px;
    text-align: center;
    border: 3px solid #06b6d4;
    box-shadow: 0 10px 25px rgba(6, 182, 212, 0.15);
}

.completion-header {
    margin-bottom: 32px;
}

.completion-title {
    font-size: 32px;
    font-weight: bold;
    color: #0f172a;
    margin-bottom: 8px;
}

.completion-subtitle {
    font-size: 18px;
    color: #64748b;
}

.completion-content {
    max-width: 500px;
    margin: 0 auto;
}

.team-info {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    border: 2px solid #e2e8f0;
}

.team-name {
    font-size: 24px;
    font-weight: bold;
    color: #0f172a;
    margin-bottom: 16px;
}

.completion-stats {
    display: flex;
    justify-content: space-around;
    gap: 16px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 14px;
    color: #64748b;
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-size: 20px;
    font-weight: bold;
    color: #0f172a;
}

.feedback-section {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    border: 2px solid #e2e8f0;
    text-align: left;
}

.feedback-title {
    font-size: 18px;
    font-weight: bold;
    color: #0f172a;
    margin-bottom: 12px;
    text-align: center;
}

.feedback-pending {
    text-align: center;
    padding: 16px;
    background: #fef3c7;
    border-radius: 8px;
    border: 1px solid #fbbf24;
}

.pending-icon {
    font-size: 24px;
    display: block;
    margin-bottom: 8px;
}

.pending-text {
    font-weight: 600;
    color: #92400e;
    display: block;
    margin-bottom: 4px;
}

.pending-description {
    font-size: 14px;
    color: #92400e;
    margin: 0;
}

.feedback-given {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 16px;
}

.feedback-text {
    font-size: 16px;
    color: #0f172a;
    line-height: 1.5;
    margin: 0;
}

.feedback-date {
    font-size: 12px;
    color: #64748b;
    margin-top: 8px;
    text-align: right;
}

/* Enhanced Feedback Styles */
.feedback-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #bbf7d0;
}

.teacher-name {
    font-weight: 600;
    color: #059669;
    font-size: 14px;
}

.feedback-time {
    font-size: 12px;
    color: #64748b;
}

.feedback-score {
    background: #dbeafe;
    color: #1e40af;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 8px;
    display: inline-block;
}

/* Score Level Styles */
.score-excellent {
    color: #059669 !important;
    font-weight: bold;
}

.score-good {
    color: #0891b2 !important;
    font-weight: bold;
}

.score-fair {
    color: #f59e0b !important;
    font-weight: bold;
}

.score-poor {
    color: #dc2626 !important;
    font-weight: bold;
}

/* Feedback Notification */
.feedback-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border: 2px solid #10b981;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    max-width: 350px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    animation: slideIn 0.3s ease-out;
}

.feedback-notification .notification-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.feedback-notification .notification-content {
    flex: 1;
}

.feedback-notification .notification-title {
    font-weight: 600;
    color: #0f172a;
    font-size: 14px;
    margin-bottom: 4px;
}

.feedback-notification .notification-preview {
    font-size: 12px;
    color: #64748b;
    line-height: 1.4;
}

.feedback-notification .notification-close {
    background: none;
    border: none;
    font-size: 18px;
    color: #64748b;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.feedback-notification .notification-close:hover {
    color: #dc2626;
}

/* Pulse highlight animation */
.pulse-highlight {
    animation: pulseHighlight 2s ease-in-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulseHighlight {
    0%, 100% { 
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); 
    }
    50% { 
        box-shadow: 0 0 0 10px rgba(16, 185, 129, 0.1); 
    }
}

.completion-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.action-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s ease;
}

.action-btn.primary {
    background: #06b6d4;
    color: white;
}

.action-btn.primary:hover {
    background: #0891b2;
    transform: translateY(-1px);
}

.action-btn.secondary {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #cbd5e1;
}

.action-btn.secondary:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
}

@media (max-width: 640px) {
    .completion-screen {
        padding: 20px;
    }
    
    .completion-title {
        font-size: 24px;
    }
    
    .completion-subtitle {
        font-size: 16px;
    }
    
    .completion-actions {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
    }
}

/* REMOVED: Game Introduction Styles - no longer needed since students skip intro */

/* Minimal Modern Empathy Phase Styles */
.minimal-header {
    text-align: center;
    margin-bottom: 32px;
    padding: 0 16px;
}

.minimal-title {
    font-size: 28px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
    line-height: 1.3;
}

.minimal-subtitle {
    font-size: 16px;
    color: #6b7280;
    margin: 0;
    font-weight: 400;
}

.selection-counter {
    text-align: center;
    margin-bottom: 24px;
    font-size: 16px;
    color: #374151;
    font-weight: 500;
}

.pain-points-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-bottom: 32px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}

.pain-point-item {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    font-size: 16px;
    color: #374151;
}

.pain-point-item:hover {
    border-color: #3b82f6;
    background: #f8faff;
    transform: translateY(-1px);
}

.pain-point-item.selected {
    border-color: #3b82f6;
    background: #3b82f6;
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
}

.custom-pain-points-section {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
}

.custom-title {
    font-size: 18px;
    color: #6b7280;
    margin-bottom: 16px;
    font-weight: 500;
}

.add-pain-point-btn {
    background: #f3f4f6;
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 16px 24px;
    color: #6b7280;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
}

.add-pain-point-btn:hover {
    border-color: #3b82f6;
    color: #3b82f6;
    background: #f8faff;
}

/* Clean empathy card */
.empathy-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 40px 32px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: none;
    max-width: 800px;
    margin: 0 auto;
}

/* Define Card Styles (keeping separate from minimal empathy) */
.define-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border-radius: 16px;
    padding: 24px;
    border: 3px solid #10b981;
    box-shadow: 0 10px 25px rgba(16, 185, 129, 0.15);
    margin-bottom: 24px;
}

.phase-header {
    text-align: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f1f5f9;
}

.phase-title {
    font-size: 24px;
    font-weight: bold;
    color: #0f172a;
    margin-bottom: 8px;
}

.phase-subtitle {
    font-size: 18px;
    color: #10b981;
    font-weight: 600;
    margin-bottom: 8px;
}

.phase-description {
    font-size: 16px;
    color: #64748b;
    margin-bottom: 12px;
}

.why-it-matters {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.insight-icon {
    font-size: 18px;
}

.insight-text {
    font-size: 14px;
    color: #166534;
    font-weight: 500;
}

.empathy-content {
    margin-bottom: 24px;
}

.section-title {
    font-size: 18px;
    font-weight: bold;
    color: #0f172a;
    margin-bottom: 12px;
}

.selection-requirement {
    font-size: 14px;
    color: #f59e0b;
    font-weight: 600;
    margin-bottom: 8px;
}

.selection-counter {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    color: #92400e;
    font-weight: 600;
    margin-bottom: 16px;
    display: inline-block;
}

.pain-points-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-bottom: 24px;
}

.pain-point-item {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
}

.pain-point-item:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
}

.pain-point-item.selected {
    border-color: #10b981;
    background: #f0fdf4;
}

.pain-point-checkbox {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 2px solid #d1d5db;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: white;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    transition: all 0.2s ease;
}

.pain-point-item.selected .pain-point-checkbox {
    background: #10b981;
    border-color: #10b981;
}

.pain-point-text {
    font-size: 14px;
    color: #374151;
    flex: 1;
}

.custom-pain-point {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    margin-top: 24px;
}

.custom-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    margin-top: 8px;
    transition: border-color 0.2s ease;
}

.custom-input:focus {
    outline: none;
    border-color: #3b82f6;
}

.char-counter {
    text-align: right;
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
}

/* Custom Pain Points Styles */
.custom-pain-points-section {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    margin-top: 24px;
}

.section-description {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 16px;
}

.add-pain-point-btn {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    margin-bottom: 12px;
}

.add-pain-point-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.add-pain-point-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.custom-pain-input-group {
    margin-bottom: 12px;
    position: relative;
}

.custom-pain-input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.custom-pain-input:focus {
    outline: none;
    border-color: #3b82f6;
}

.remove-pain-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: #ef4444;
    color: white;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.custom-counter {
    font-size: 12px;
    color: #6b7280;
    text-align: center;
}

/* Builder Input Styles */
.builder-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    margin-top: 8px;
    transition: border-color 0.2s ease;
}

.builder-input:focus {
    outline: none;
    border-color: #f59e0b;
}

/* Custom HMW Styles */
.hmw-choice-section {
    margin-bottom: 24px;
}

.hmw-toggle {
    margin-bottom: 16px;
}

.toggle-container {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.toggle-label {
    font-size: 14px;
    font-weight: 500;
    color: #374151;
}

.custom-hmw-section {
    background: #fffbeb;
    border: 2px solid #fbbf24;
    border-radius: 12px;
    padding: 16px;
}

.hmw-helper {
    font-size: 12px;
    color: #92400e;
    margin-bottom: 8px;
    font-style: italic;
}

.custom-hmw-textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    min-height: 80px;
    resize: vertical;
    font-family: inherit;
    transition: border-color 0.2s ease;
}

.custom-hmw-textarea:focus {
    outline: none;
    border-color: #f59e0b;
}

/* Ideas Section Enhancements */
.idea-progress {
    background: #faf5ff;
    border: 2px solid #d8b4fe;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    text-align: center;
}

.idea-counter {
    font-size: 18px;
    font-weight: bold;
    color: #7c3aed;
    margin-bottom: 8px;
}

.idea-encouragement {
    font-size: 14px;
    color: #6b46c1;
    font-weight: 500;
}

.add-idea-btn {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    margin-top: 16px;
    width: 100%;
}

.add-idea-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.add-idea-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Define Phase Styles */
.define-card {
    border-color: #f59e0b;
}

.define-card .phase-title {
    color: #0f172a;
}

.define-card .phase-subtitle {
    color: #f59e0b;
}

.define-card .why-it-matters {
    background: #fffbeb;
    border-color: #fbbf24;
}

.define-card .insight-text {
    color: #92400e;
}

.hmw-builder {
    margin-bottom: 24px;
}

.builder-step {
    margin-bottom: 20px;
}

.builder-label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 8px;
}

.builder-select {
    width: 100%;
    padding: 12px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    transition: border-color 0.2s ease;
}

.builder-select:focus {
    outline: none;
    border-color: #f59e0b;
}

.hmw-preview {
    background: #fffbeb;
    border: 2px solid #fbbf24;
    border-radius: 12px;
    padding: 20px;
    margin-top: 24px;
    text-align: center;
}

.hmw-title {
    font-size: 18px;
    font-weight: bold;
    color: #92400e;
    margin-bottom: 12px;
}

.hmw-question {
    font-size: 16px;
    color: #0f172a;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #fbbf24;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.phase-submit-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 16px 32px;
    border-radius: 12px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.phase-submit-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.phase-submit-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Step 3: Ideate Phase Styles */
.ideate-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border-radius: 16px;
    padding: 24px;
    border: 3px solid #8b5cf6; /* Purple theme for ideate */
    box-shadow: 0 10px 25px rgba(139, 92, 246, 0.15);
    margin-bottom: 24px;
}

.ideate-card .phase-subtitle {
    color: #8b5cf6;
}

.ideate-card .why-it-matters {
    background: #faf5ff;
    border-color: #c4b5fd;
}

.ideate-card .insight-text {
    color: #6b21a8;
}

.hmw-reminder {
    background: linear-gradient(135deg, #fef3c7, #fbbf24);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    border: 2px solid #f59e0b;
}

.reminder-title {
    font-size: 16px;
    font-weight: bold;
    color: #92400e;
    margin-bottom: 8px;
}

.hmw-display {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    color: #0f172a;
    border: 1px solid #fbbf24;
    font-style: italic;
}

.ideas-section {
    margin-bottom: 24px;
}

.idea-input-group {
    margin-bottom: 20px;
}

.idea-label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
}

.idea-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #d1d5db;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.2s ease;
}

.idea-input:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.favorite-selection {
    background: #faf5ff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    border: 2px solid #c4b5fd;
}

.selection-title {
    font-size: 18px;
    font-weight: bold;
    color: #6b21a8;
    margin-bottom: 8px;
}

.selection-description {
    font-size: 14px;
    color: #6b21a8;
    margin-bottom: 16px;
}

.favorite-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.favorite-option {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.favorite-option:hover {
    border-color: #8b5cf6;
    transform: translateY(-1px);
}

.favorite-option.selected {
    background: #f3f4f6;
    border-color: #8b5cf6;
}

/* Step 4: Prototype Phase Styles */
.prototype-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border-radius: 16px;
    padding: 24px;
    border: 3px solid #f97316; /* Orange theme for prototype */
    box-shadow: 0 10px 25px rgba(249, 115, 22, 0.15);
    margin-bottom: 24px;
}

.prototype-card .phase-subtitle {
    color: #f97316;
}

.prototype-card .why-it-matters {
    background: rgba(255, 247, 237, 0.9);
    backdrop-filter: blur(5px);
    border-color: #fed7aa;
}

.prototype-card .insight-text {
    color: #c2410c;
}

.selected-idea-display {
    background: linear-gradient(135deg, #fef3c7, #fbbf24);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    border: 2px solid #f59e0b;
}

.display-title {
    font-size: 16px;
    font-weight: bold;
    color: #92400e;
    margin-bottom: 8px;
}

.idea-showcase {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    padding: 16px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    color: #0f172a;
    border: 1px solid #fbbf24;
    min-height: 50px;
    display: flex;
    align-items: center;
}

.prototype-section {
    margin-bottom: 24px;
}

.section-title {
    font-size: 18px;
    font-weight: bold;
    color: #0f172a;
    margin-bottom: 8px;
}

.section-description {
    font-size: 14px;
    color: #64748b;
    margin-bottom: 12px;
}

.prototype-textarea {
    width: 100%;
    min-height: 120px;
    padding: 16px;
    border: 2px solid #d1d5db;
    border-radius: 12px;
    font-size: 16px;
    font-family: inherit;
    resize: vertical;
    transition: all 0.2s ease;
}

.prototype-textarea:focus {
    outline: none;
    border-color: #f97316;
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}

.prototype-tips {
    background: #f9fafb;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    border: 2px solid #e5e7eb;
}

.tips-title {
    font-size: 16px;
    font-weight: bold;
    color: #374151;
    margin-bottom: 12px;
}

.tips-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
}

.tip-item {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    color: #374151;
    border: 1px solid #e5e7eb;
    text-align: center;
}

.prototype-completion {
    background: #f0fdf4;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    border: 2px solid #bbf7d0;
}

.completion-check {
    display: flex;
    align-items: center;
    gap: 12px;
}

.completion-check input[type="checkbox"] {
    transform: scale(1.3);
    accent-color: #10b981;
}

.completion-check label {
    font-size: 16px;
    font-weight: 600;
    color: #065f46;
    cursor: pointer;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .empathy-card {
        padding: 24px 16px;
        margin: 0 8px;
    }
    
    .minimal-title {
        font-size: 24px;
    }
    
    .pain-points-grid {
        max-width: 100%;
        gap: 8px;
    }
    
    .pain-point-item {
        padding: 14px 16px;
        font-size: 15px;
    }
    
    .define-card, .ideate-card, .prototype-card {
        padding: 20px;
    }
    
    .phase-title {
        font-size: 20px;
    }
    
    .steps-overview {
        gap: 12px;
    }
    
    .step-item {
        padding: 12px;
    }
    
    .step-icon {
        font-size: 20px;
        margin-right: 12px;
    }
    
    .tips-grid {
        grid-template-columns: 1fr;
    }
    
    .favorite-options {
        gap: 8px;
    }
}

/* Teacher Review Report Styles */
.teacher-review-report {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-top: 16px;
    animation: slideIn 0.5s ease-out;
}

.report-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: 24px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.report-title h3 {
    margin: 0 0 8px 0;
    font-size: 24px;
    font-weight: 700;
}

.report-subtitle {
    font-size: 14px;
    opacity: 0.9;
}

.overall-score {
    text-align: center;
    display: flex;
    align-items: center;
    gap: 20px;
}

.score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.2);
    border: 3px solid rgba(255,255,255,0.3);
}

.score-circle.excellent {
    background: rgba(16, 185, 129, 0.2);
    border-color: #10b981;
}

.score-circle.good {
    background: rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
}

.score-circle.average {
    background: rgba(245, 158, 11, 0.2);
    border-color: #f59e0b;
}

.score-circle.needs-work {
    background: rgba(239, 68, 68, 0.2);
    border-color: #ef4444;
}

.score-number {
    font-size: 20px;
    font-weight: 700;
    line-height: 1;
}

.score-label {
    font-size: 10px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.score-details {
    text-align: left;
}

.percentage {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
}

.performance-level {
    font-size: 14px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 20px;
    background: rgba(255,255,255,0.2);
}

.review-summary {
    background: white;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    text-align: center;
}

.stat-item {
    padding: 16px;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.stat-number {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
}

.phases-breakdown {
    background: white;
    padding: 24px;
}

.breakdown-title {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 20px 0;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
}

.phase-review-section {
    margin-bottom: 24px;
    background: #f9fafb;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.phase-review-section:last-child {
    margin-bottom: 0;
}

.phase-header {
    background: #3b82f6;
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.phase-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
}

.phase-score-summary {
    display: flex;
    gap: 12px;
    font-size: 12px;
}

.phase-score-summary span {
    background: rgba(255,255,255,0.2);
    padding: 4px 8px;
    border-radius: 4px;
}

.phase-questions {
    padding: 0;
}

.review-question-item {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 16px;
    align-items: start;
}

.review-question-item:last-child {
    border-bottom: none;
}

.question-content {
    min-width: 0;
}

.review-question-item .question-text {
    font-weight: 500;
    color: #374151;
    margin-bottom: 8px;
    line-height: 1.4;
}

.your-answer {
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 10px 12px;
    color: #1f2937;
    font-size: 14px;
    line-height: 1.4;
}

.question-score {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
}

.score-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 12px;
    text-align: center;
    min-width: 50px;
}

.score-badge.excellent {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
}

.score-badge.good {
    background: #dbeafe;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
}

.score-badge.average {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde047;
}

.score-badge.needs-work {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.teacher-comment {
    font-size: 12px;
    color: #6b7280;
    font-style: italic;
    text-align: right;
    max-width: 200px;
    line-height: 1.3;
}

.report-footer {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    padding: 24px;
    text-align: center;
}

.completion-message {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 16px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid #bbf7d0;
    border-radius: 12px;
}

.completion-icon {
    font-size: 24px;
}

.completion-text {
    font-weight: 500;
    color: #065f46;
}

.next-steps {
    display: flex;
    gap: 12px;
    justify-content: center;
}

/* Enhanced feedback pending with progress */
.feedback-pending.enhanced {
    background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
    border: 1px solid #f59e0b;
    padding: 20px;
    border-radius: 12px;
}

.pending-header {
    text-align: center;
    margin-bottom: 16px;
}

.pending-header .pending-icon {
    font-size: 32px;
    display: block;
    margin-bottom: 8px;
}

.pending-header .pending-text {
    font-size: 18px;
    font-weight: 600;
    color: #92400e;
}

.review-progress {
    margin: 16px 0;
}

.progress-bar {
    background: rgba(146, 64, 14, 0.2);
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-fill {
    background: #f59e0b;
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 14px;
    color: #92400e;
    text-align: center;
    font-weight: 500;
}

/* Responsive design for mobile */
@media (max-width: 768px) {
    .overall-score {
        flex-direction: column;
        gap: 12px;
    }
    
    .score-circle {
        width: 60px;
        height: 60px;
    }
    
    .score-number {
        font-size: 16px;
    }
    
    .summary-stats {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .review-question-item {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .question-score {
        align-items: flex-start;
        flex-direction: row;
        justify-content: space-between;
    }
    
    .next-steps {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="student-container">
    <!-- Phase Progress Bar -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">{{ team.team_name }} üéØ</h2>
        <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>Progress</span>
            <span id="progress-text">Phase 1 of 5</span>
        </div>
        <div class="phase-progress">
            <div class="phase-progress-fill" id="progress-fill" style="width: 20%"></div>
        </div>
    </div>

    <!-- Team Status -->
    <div class="team-status" id="team-status">
        <p id="status-text">Active session - Let's solve classroom problems!</p>
    </div>

    <!-- REMOVED: Game Introduction Screen -->
    <!-- Students now go directly to mission phases - no intro screen needed -->

    <!-- Step 1: Empathy Phase -->
    <div class="phase-card empathy-card" id="empathy-phase" style="display: none;">
        <div class="minimal-header">
            <h2 class="minimal-title">What problems do you see in your classroom?</h2>
            <p class="minimal-subtitle">Choose the issues that bother you most</p>
        </div>

        <div class="empathy-content">
            <div class="pain-points-section">
                <div class="selection-counter">
                    <span id="selection-count">0</span> of 3 selected
                </div>
                
                <div class="pain-points-grid" id="pain-points-grid">
                    <!-- Pain points will be dynamically populated -->
                </div>
            </div>
            
            <div class="custom-pain-points-section">
                <h4 class="custom-title">Add your own (optional)</h4>
                <div id="custom-pain-points-container">
                    <!-- Custom pain point inputs will be added here -->
                </div>
                <button type="button" id="add-pain-point-btn" class="add-pain-point-btn" onclick="addCustomPainPoint()">
                    + Add custom issue
                </button>
            </div>
        </div>

        <!-- Simplified input container for empathy phase -->
        <div class="simplified-inputs-container" id="empathy-simplified-inputs" style="display: none;">
            <!-- Dynamic simplified inputs will be inserted here -->
        </div>
        
        <button class="phase-submit-btn" id="empathy-submit" onclick="submitEmpathy()" disabled>
            Complete Empathy
        </button>
    </div>

    <!-- Step 2: Define Phase -->
    <div class="phase-card define-card" id="define-phase" style="display: none;">
        <div class="minimal-header">
            <h2 class="minimal-title">Step 2: Define the Problem</h2>
            <p class="minimal-subtitle">Turn your observations into a clear challenge to solve</p>
            <div class="learning-tip">
                üí° Tip: Good problems start with "How might we help..."
            </div>
        </div>


        <!-- Simplified input container for define phase -->
        <div class="simplified-inputs-container" id="define-simplified-inputs" style="display: none;">
            <!-- Dynamic simplified inputs will be inserted here -->
        </div>
        
        <button class="phase-submit-btn" id="define-submit" onclick="submitDefine()" disabled>
            Finalize Design Question
        </button>
    </div>

    <!-- Step 3: Ideate Phase -->
    <div class="phase-card ideate-card" id="ideate-phase" style="display: none;">
        <div class="minimal-header">
            <h2 class="minimal-title">Step 3: Brainstorm Solutions</h2>
            <p class="minimal-subtitle">Think of creative ways to solve your problem</p>
            <div class="learning-tip">
                üí° Tip: Quantity over quality - the more ideas, the better!
            </div>
        </div>

        <!-- Simplified input container for ideate phase -->
        <div class="simplified-inputs-container" id="ideate-simplified-inputs" style="display: none;">
            <!-- Dynamic simplified inputs will be inserted here -->
        </div>
        
        <button class="phase-submit-btn" id="ideate-submit" onclick="submitIdeate()" disabled>
            Complete Ideation üí°
        </button>
    </div>

    <!-- Step 4: Prototype Phase -->
    <div class="phase-card prototype-card" id="prototype-phase" style="display: none;">
        <div class="minimal-header">
            <h2 class="minimal-title">Step 4: Build Your Solution</h2>
            <p class="minimal-subtitle">Describe how your idea will work in the real world</p>
            <div class="learning-tip">
                üí° Tip: Focus on how people will use your solution
            </div>
        </div>

        <!-- Simplified input container for prototype phase -->
        <div class="simplified-inputs-container" id="prototype-simplified-inputs" style="display: none;">
            <!-- Dynamic simplified inputs will be inserted here -->
        </div>
        
        <button class="phase-submit-btn" id="prototype-submit" onclick="submitPrototype()" disabled>
            Complete Prototype üéâ
        </button>
    </div>

    <!-- Current Phase Card (for later phases) -->
    <div class="phase-card" id="phase-card" style="display: none;">
        <div class="mb-4">
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="phase-title">Loading...</h3>
            <p class="text-gray-600" id="phase-description">Please wait while we load your current phase.</p>
        </div>

        <!-- Dynamic Input Forms (populated via JavaScript) -->
        <div id="input-forms-container">
            <!-- Forms will be dynamically inserted here -->
        </div>

        <!-- Submit Button -->
        <button class="submit-btn" id="submit-btn" onclick="submitPhaseInputs()" disabled>
            <span id="submit-text">Complete Phase</span>
        </button>
    </div>

    <!-- Game Completion Screen (initially hidden) -->
    <div class="completion-screen" id="completion-screen" style="display: none;">
        <div class="completion-header">
            <h2 class="completion-title">üéâ Challenge Completed! üéâ</h2>
            <p class="completion-subtitle">Congratulations on finishing the Design Thinking Innovation Challenge!</p>
        </div>
        
        <div class="completion-content">
            <div class="team-info">
                <h3 class="team-name">{{ team.team_name }} {{ team.team_emoji }}</h3>
                <div class="completion-stats">
                    <div class="stat-item">
                        <span class="stat-label">Phases Completed:</span>
                        <span class="stat-value">5/5</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Your Score:</span>
                        <span class="stat-value" id="final-score">Pending Review</span>
                    </div>
                </div>
            </div>
            
            <div class="feedback-section">
                <h4 class="feedback-title">Teacher Feedback</h4>
                <div class="feedback-content" id="feedback-content">
                    <div class="feedback-pending">
                        <span class="pending-icon">‚è≥</span>
                        <span class="pending-text">Feedback Pending</span>
                        <p class="pending-description">Your teacher is reviewing your work and will provide feedback soon.</p>
                    </div>
                </div>
            </div>
            
            <div class="completion-actions">
                <button class="action-btn secondary" onclick="location.href='/learn/simplified/create/'">
                    üöÄ Join Another Session
                </button>
                <button class="action-btn primary" onclick="checkForFeedback()">
                    üîÑ Check for Feedback
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Auto-Advance Notification -->
<div class="auto-advance-notification" id="auto-advance-notification">
    <p><strong>Phase Complete!</strong></p>
    <p>Moving to next phase in <span id="countdown">3</span> seconds...</p>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<script>
// Simplified Student Dashboard JavaScript
let websocket = null;
let currentSession = null;
let currentTeam = null;
let currentMission = null;
let phaseInputs = {};
let studentData = {
    name: 'Student', // Will be set from session
    session_id: generateSessionId()
};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeStudentDashboard();
    connectWebSocket();
});

function generateSessionId() {
    return 'student_' + Math.random().toString(36).substr(2, 9);
}

function initializeStudentDashboard() {
    // Get session data from Django template context
    currentSession = {
        code: '{{ session.session_code|default:"" }}',
        id: {{ session.id|default:"null" }},
        status: '{{ session.status|default:"" }}',
        is_facilitator_controlled: {{ session.is_facilitator_controlled|yesno:"true,false" }}
    };
    
    currentTeam = {
        id: {{ team.id|default:"null" }},
        name: '{{ team.team_name|default:"" }}',
        emoji: '{{ team.team_emoji|default:"üéØ" }}',
        members: [],
        current_mission: {{ team.current_mission.id|default:"null" }}
    };
    
    {% if current_mission %}
    currentMission = {
        id: {{ current_mission.id }},
        title: '{{ current_mission.title }}',
        type: '{{ current_mission.mission_type }}'
    };
    {% endif %}

    // Use team name as student identifier
    studentData.name = currentTeam.name || 'Student';

    console.log('üéØ Student Dashboard initialized', { currentSession, currentTeam, studentData });
    
    // Always auto-start the game immediately - no delays
    console.log('üöÄ Auto-starting simplified session game');
    
    // Inline game initialization to be 100% reliable
    try {
        // Hide team status
        const teamStatus = document.getElementById('team-status');
        if (teamStatus) {
            teamStatus.style.display = 'none';
            console.log('‚úÖ Team status hidden');
        }
        
        // Hide phase cards
        const phaseCard = document.getElementById('phase-card');
        const empathyPhase = document.getElementById('empathy-phase');
        const definePhase = document.getElementById('define-phase');
        if (phaseCard) phaseCard.style.display = 'none';
        if (empathyPhase) empathyPhase.style.display = 'none';
        if (definePhase) definePhase.style.display = 'none';
        
        // Show game introduction
        const gameIntro = document.getElementById('game-intro');
        if (gameIntro) {
            gameIntro.style.display = 'block';
            console.log('‚úÖ Game introduction shown');
        } else {
            console.error('‚ùå Game intro element not found!');
        }
        
        // Update progress
        const progressText = document.getElementById('progress-text');
        const progressFill = document.getElementById('progress-fill');
        if (progressText) progressText.textContent = 'Ready to Start';
        if (progressFill) progressFill.style.width = '0%';
        
        console.log('‚úÖ Game initialization complete');
    } catch (error) {
        console.error('‚ùå Game initialization error:', error);
    }
    
    // Check for existing teacher feedback after initialization
    setTimeout(() => {
        checkForComprehensiveFeedback();
    }, 2000);
}

function connectWebSocket() {
    // Validate session code before attempting WebSocket connection
    if (!currentSession || !currentSession.code || currentSession.code.trim() === '') {
        console.error('‚ùå Cannot connect WebSocket: Missing or empty session code');
        console.error('currentSession:', currentSession);
        return;
    }
    
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/design-thinking/${currentSession.code}/`;
    
    console.log('üîå Attempting WebSocket connection to:', wsUrl);
    websocket = new WebSocket(wsUrl);
    
    websocket.onopen = function(event) {
        console.log('‚úÖ WebSocket connected to Design Thinking session');
        // Join as student
        websocket.send(JSON.stringify({
            type: 'join_as_student',
            team_id: currentTeam.id,
            student_data: studentData
        }));
    };
    
    websocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };
    
    websocket.onclose = function(event) {
        console.log('‚ùå WebSocket disconnected:', event.code);
        // Attempt to reconnect after 3 seconds
        setTimeout(connectWebSocket, 3000);
    };
    
    websocket.onerror = function(error) {
        console.error('üí• WebSocket error:', error);
    };
}

function handleWebSocketMessage(data) {
    console.log('üì® Received message:', data.type, data);
    
    switch (data.type) {
        case 'session_status':
            updateSessionStatus(data.data);
            break;
        case 'mission_advanced':
            handleMissionAdvanced(data.mission_data);
            break;
        case 'phase_auto_advance':
            showAutoAdvanceNotification(data);
            break;
        case 'input_submission':
            handleInputSubmissionUpdate(data);
            break;
        case 'completion_status':
            updateCompletionStatus(data);
            break;
        case 'teacher_feedback':
            handleTeacherFeedback(data);
            break;
        case 'error':
            showError(data.message);
            break;
    }
}

function updateSessionStatus(sessionData) {
    if (sessionData.current_mission) {
        currentMission = sessionData.current_mission;
        loadCurrentPhase();
    }
    
    // Simplified sessions are always active - no status updates needed
    console.log('üìä Session status updated (simplified mode - always active)');
}

function loadCurrentPhase() {
    if (!currentMission) return;
    
    // FIXED: Skip kickoff/intro phases - students should never get stuck here
    if (currentMission.mission_type === 'kickoff') {
        console.log('üöÄ Skipping kickoff phase, advancing to empathy');
        showEmpathyPhase();
        return;
    }
    
    // Hide all phase cards first
    hideAllPhaseCards();
    
    // Update progress bar
    const phaseNumber = getPhaseNumber(currentMission.mission_type);
    const progressPercent = (phaseNumber / 5) * 100;
    document.getElementById('progress-fill').style.width = progressPercent + '%';
    document.getElementById('progress-text').textContent = `Phase ${phaseNumber} of 5`;
    
    // Show the appropriate themed phase card
    showThemedPhaseCard(currentMission.mission_type);
}

function hideAllPhaseCards() {
    // Hide generic card
    document.getElementById('phase-card').style.display = 'none';
    
    // Hide all themed cards
    document.getElementById('empathy-phase').style.display = 'none';
    document.getElementById('define-phase').style.display = 'none';
    document.getElementById('ideate-phase').style.display = 'none';
    document.getElementById('prototype-phase').style.display = 'none';
    document.getElementById('completion-screen').style.display = 'none';
}

function showThemedPhaseCard(missionType) {
    console.log('üé® Showing phase card for:', missionType);
    
    switch(missionType) {
        case 'empathy':
            document.getElementById('empathy-phase').style.display = 'block';
            // Populate the pain points grid
            populatePainPoints();
            // Set up custom input functionality  
            setupCustomPainPointInput();
            // Initialize counters and submit button
            updateSelectionCounter();
            updateEmpathySubmitButton();
            break;
        case 'define':
            document.getElementById('define-phase').style.display = 'block';
            loadSimplifiedInputs('define', 'define-simplified-inputs');
            break;
        case 'ideate':
            document.getElementById('ideate-phase').style.display = 'block';
            loadSimplifiedInputs('ideate', 'ideate-simplified-inputs');
            break;
        case 'prototype':
            document.getElementById('prototype-phase').style.display = 'block';
            loadSimplifiedInputs('prototype', 'prototype-simplified-inputs');
            break;
        default:
            // Fallback to generic card for other phases
            document.getElementById('phase-card').style.display = 'block';
            document.getElementById('phase-title').textContent = currentMission.title;
            document.getElementById('phase-description').textContent = currentMission.description;
            loadSimplifiedInputs(missionType, 'input-forms-container');
    }
}

function getPhaseNumber(missionType) {
    const phases = ['kickoff', 'empathy', 'define', 'ideate', 'prototype', 'showcase'];
    return phases.indexOf(missionType) + 1;
}

// REMOVED: Complex fallback functions - using unified simple approach

function updatePhaseSubmitButton() {
    // Determine current phase and get inputs
    let phase = '';
    let hasValidInput = false;
    
    // Check which phase is currently visible
    if (document.getElementById('define-phase').style.display === 'block') {
        phase = 'define';
        const input = document.getElementById('input_0');
        hasValidInput = input && input.value.trim().length > 0;
    } else if (document.getElementById('ideate-phase').style.display === 'block') {
        phase = 'ideate';
        // Check if at least one checkbox is checked
        const checkboxes = document.querySelectorAll('#ideate-simplified-inputs input[type="checkbox"]:checked');
        hasValidInput = checkboxes.length > 0;
    } else if (document.getElementById('prototype-phase').style.display === 'block') {
        phase = 'prototype';
        const input = document.getElementById('input_0');
        hasValidInput = input && input.value.trim().length > 0;
    }
    
    // Enable/disable the phase submit button
    const submitBtn = document.getElementById(phase + '-submit');
    if (submitBtn) {
        submitBtn.disabled = !hasValidInput;
    }
}

function loadSimplifiedInputs(missionType, containerId = 'input-forms-container') {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container ${containerId} not found`);
        return;
    }
    
    // Show the container and clear it
    container.style.display = 'block';
    container.innerHTML = '';
    
    // Clean, simplified inputs for each phase
    const phaseInputs = {
        define: [
            {
                type: 'text_short',
                label: 'Write a clear problem statement:',
                placeholder: 'How might we help students...'
            }
        ],
        ideate: [
            {
                type: 'checkbox',
                label: 'Select your top 3 solution ideas:',
                options: [
                    'Interactive learning tools',
                    'Peer collaboration system',
                    'Flexible classroom setup',
                    'Gamified activities',
                    'Better feedback methods',
                    'Creative project options'
                ],
                max_selections: 3
            }
        ],
        prototype: [
            {
                type: 'text_medium',
                label: 'Describe how your solution works:',
                placeholder: 'Our solution helps students by...'
            }
        ]
    };
    
    const inputs = phaseInputs[missionType] || [];
    
    inputs.forEach((input, index) => {
        const inputElement = createInputElement(input, index);
        container.appendChild(inputElement);
    });
    
    // Enable phase-specific submit button if there are inputs
    const submitBtnId = missionType + '-submit';
    const submitBtn = document.getElementById(submitBtnId);
    if (submitBtn) {
        submitBtn.disabled = inputs.length === 0;
    }
}

function createInputElement(input, index) {
    const div = document.createElement('div');
    div.className = 'simple-input-group';
    
    const label = document.createElement('label');
    label.textContent = input.label;
    div.appendChild(label);
    
    switch (input.type) {
        case 'radio':
            const radioGroup = document.createElement('div');
            radioGroup.className = 'radio-group';
            
            input.options.forEach((option, optionIndex) => {
                const radioDiv = document.createElement('div');
                radioDiv.className = 'radio-option';
                radioDiv.onclick = () => selectRadioOption(radioDiv, index, option);
                
                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.name = `input_${index}`;
                radioInput.value = option;
                
                const radioLabel = document.createElement('span');
                radioLabel.textContent = option;
                
                radioDiv.appendChild(radioInput);
                radioDiv.appendChild(radioLabel);
                radioGroup.appendChild(radioDiv);
            });
            
            div.appendChild(radioGroup);
            break;
            
        case 'dropdown':
            const select = document.createElement('select');
            select.className = 'dropdown-select';
            select.id = `input_${index}`;
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select an option...';
            select.appendChild(defaultOption);
            
            input.options.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option;
                optionEl.textContent = option;
                select.appendChild(optionEl);
            });
            
            div.appendChild(select);
            break;
            
        case 'text_short':
        case 'text_medium':
            const textInput = document.createElement(input.type === 'text_medium' ? 'textarea' : 'input');
            textInput.className = 'text-input';
            textInput.id = `input_${index}`;
            textInput.placeholder = input.placeholder || '';
            
            if (input.type === 'text_short') {
                textInput.type = 'text';
                textInput.maxLength = 50;
            } else {
                textInput.rows = 3;
                textInput.maxLength = 200;
            }
            
            // Add input validation to enable submit button
            textInput.addEventListener('input', function() {
                updatePhaseSubmitButton();
            });
            
            div.appendChild(textInput);
            break;
            
        case 'checkbox':
            const checkboxGroup = document.createElement('div');
            checkboxGroup.className = 'radio-group'; // Reuse styling
            
            input.options.forEach((option, optionIndex) => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'radio-option';
                checkboxDiv.onclick = () => selectCheckboxOption(checkboxDiv, index, option, input.max_selections);
                
                const checkboxInput = document.createElement('input');
                checkboxInput.type = 'checkbox';
                checkboxInput.name = `input_${index}`;
                checkboxInput.value = option;
                
                // Add change listener for checkbox validation
                checkboxInput.addEventListener('change', function() {
                    updatePhaseSubmitButton();
                });
                
                const checkboxLabel = document.createElement('span');
                checkboxLabel.textContent = option;
                
                checkboxDiv.appendChild(checkboxInput);
                checkboxDiv.appendChild(checkboxLabel);
                checkboxGroup.appendChild(checkboxDiv);
            });
            
            div.appendChild(checkboxGroup);
            break;
            
        case 'rating':
            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'radio-group';
            ratingDiv.style.flexDirection = 'row';
            ratingDiv.style.justifyContent = 'center';
            ratingDiv.style.gap = '8px';
            
            for (let i = 1; i <= input.max_rating; i++) {
                const starDiv = document.createElement('div');
                starDiv.className = 'radio-option';
                starDiv.style.width = '48px';
                starDiv.style.height = '48px';
                starDiv.style.display = 'flex';
                starDiv.style.alignItems = 'center';
                starDiv.style.justifyContent = 'center';
                starDiv.style.fontSize = '24px';
                starDiv.textContent = '‚≠ê';
                starDiv.onclick = () => selectRating(index, i, input.max_rating);
                starDiv.dataset.rating = i;
                
                ratingDiv.appendChild(starDiv);
            }
            
            div.appendChild(ratingDiv);
            break;
    }
    
    return div;
}

function selectRadioOption(optionDiv, inputIndex, value) {
    // Clear other selections in this group
    const group = optionDiv.parentNode;
    group.querySelectorAll('.radio-option').forEach(el => {
        el.classList.remove('selected');
        el.querySelector('input').checked = false;
    });
    
    // Select this option
    optionDiv.classList.add('selected');
    optionDiv.querySelector('input').checked = true;
    
    // Store value
    phaseInputs[inputIndex] = value;
    checkFormCompletion();
}

function selectCheckboxOption(optionDiv, inputIndex, value, maxSelections) {
    const checkbox = optionDiv.querySelector('input');
    const isSelected = checkbox.checked;
    
    if (!isSelected) {
        // Check if we've reached max selections
        const selectedCount = document.querySelectorAll(`input[name="input_${inputIndex}"]:checked`).length;
        if (selectedCount >= maxSelections) {
            return; // Don't allow more selections
        }
        
        // Select this option
        optionDiv.classList.add('selected');
        checkbox.checked = true;
    } else {
        // Deselect this option
        optionDiv.classList.remove('selected');
        checkbox.checked = false;
    }
    
    // Update stored values
    const selectedValues = Array.from(document.querySelectorAll(`input[name="input_${inputIndex}"]:checked`))
        .map(input => input.value);
    phaseInputs[inputIndex] = selectedValues;
    checkFormCompletion();
}

function selectRating(inputIndex, rating, maxRating) {
    // Update visual state
    const ratingContainer = document.querySelector(`#input-forms-container .simple-input-group:nth-child(${inputIndex + 1}) .radio-group`);
    const stars = ratingContainer.querySelectorAll('.radio-option');
    
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('selected');
        } else {
            star.classList.remove('selected');
        }
    });
    
    // Store value
    phaseInputs[inputIndex] = rating;
    checkFormCompletion();
}

function checkFormCompletion() {
    const inputs = document.querySelectorAll('#input-forms-container .simple-input-group');
    let allCompleted = true;
    
    inputs.forEach((inputGroup, index) => {
        const input = inputGroup.querySelector('input, select, textarea');
        if (input) {
            if (input.type === 'radio') {
                const checked = inputGroup.querySelector('input:checked');
                if (!checked) allCompleted = false;
            } else if (input.type === 'checkbox') {
                const checked = inputGroup.querySelectorAll('input:checked');
                if (checked.length === 0) allCompleted = false;
            } else if (input.tagName === 'SELECT') {
                if (!input.value) allCompleted = false;
            } else {
                if (!input.value.trim()) allCompleted = false;
            }
        } else {
            // Check for rating input
            if (!phaseInputs[index]) allCompleted = false;
        }
    });
    
    document.getElementById('submit-btn').disabled = !allCompleted;
}

function submitPhaseInputs() {
    // Collect all input values
    const inputs = [];
    const inputGroups = document.querySelectorAll('#input-forms-container .simple-input-group');
    
    inputGroups.forEach((inputGroup, index) => {
        const label = inputGroup.querySelector('label').textContent;
        let value = phaseInputs[index];
        
        if (!value) {
            // Try to get value from DOM elements
            const input = inputGroup.querySelector('input:checked, select, textarea, input[type="text"]');
            if (input) {
                value = input.value;
            }
        }
        
        if (value) {
            inputs.push({
                order: index + 1,
                type: getInputType(inputGroup),
                label: label,
                value: Array.isArray(value) ? value.join(', ') : value
            });
        }
    });
    
    if (inputs.length === 0) {
        showError('Please complete all inputs before submitting.');
        return;
    }
    
    // Show loading
    showLoading(true);
    
    // Send to WebSocket
    const messageData = {
        type: 'simplified_input_submit',
        team_id: currentTeam.id,
        mission_id: currentMission.id,
        student_data: studentData,
        input_data: inputs
    };
    
    console.log('üì§ Submitting inputs:', messageData);
    websocket.send(JSON.stringify(messageData));
    
    // Disable submit button and lock all form inputs
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-text').textContent = 'Submitted ‚úì';
    
    // Lock all form inputs to prevent changes after submission
    const allInputs = document.querySelectorAll('#input-forms-container input, #input-forms-container textarea, #input-forms-container select');
    allInputs.forEach(input => {
        input.disabled = true;
        input.style.opacity = '0.6';
        input.style.cursor = 'not-allowed';
    });
}

function getInputType(inputGroup) {
    if (inputGroup.querySelector('input[type="radio"]')) return 'radio';
    if (inputGroup.querySelector('input[type="checkbox"]')) return 'checkbox';
    if (inputGroup.querySelector('select')) return 'dropdown';
    if (inputGroup.querySelector('textarea')) return 'text_medium';
    if (inputGroup.querySelector('input[type="text"]')) return 'text_short';
    if (inputGroup.querySelector('.radio-option[data-rating]')) return 'rating';
    return 'unknown';
}

function handleMissionAdvanced(missionData) {
    currentMission = missionData;
    showLoading(false);
    
    // Reset form state
    phaseInputs = {};
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('submit-text').textContent = 'Complete Phase';
    
    loadCurrentPhase();
    
    console.log('üéØ Mission advanced to:', missionData.title);
}

function showAutoAdvanceNotification(data) {
    const notification = document.getElementById('auto-advance-notification');
    const countdownEl = document.getElementById('countdown');
    
    notification.classList.add('show');
    
    let countdown = data.countdown_seconds || 3;
    countdownEl.textContent = countdown;
    
    const countdownInterval = setInterval(() => {
        countdown--;
        countdownEl.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            notification.classList.remove('show');
        }
    }, 1000);
    
    // Hide notification after countdown + 1 second
    setTimeout(() => {
        notification.classList.remove('show');
    }, (data.countdown_seconds + 1) * 1000);
}

function handleInputSubmissionUpdate(data) {
    showLoading(false);
    
    if (data.auto_advance_result && data.auto_advance_result.should_advance) {
        showAutoAdvanceNotification(data.auto_advance_result);
    } else {
        // Simplified sessions don't wait for other team members
        console.log('üìä Submission response received (simplified mode)');
    }
}

function updateCompletionStatus(data) {
    // Simplified sessions don't show completion percentages - always ready to advance
    console.log('üìä Completion status updated (simplified mode)', data);
}

function showLoading(show) {
    const overlay = document.getElementById('loading-overlay');
    if (show) {
        overlay.classList.add('show');
    } else {
        overlay.classList.remove('show');
    }
}

function showError(message) {
    alert('Error: ' + message);
    showLoading(false);
}

// Completion screen functions
function showCompletionScreen(teamData) {
    // Hide the regular game interface
    document.getElementById('phase-card').style.display = 'none';
    document.querySelector('.phase-progress').style.display = 'none';
    
    // Show completion screen
    const completionScreen = document.getElementById('completion-screen');
    completionScreen.style.display = 'block';
    
    // Update progress to 100%
    document.getElementById('progress-text').textContent = 'Complete! üéâ';
    document.getElementById('progress-fill').style.width = '100%';
    
    // Update team status
    document.getElementById('team-status').innerHTML = '<p class="completed">üèÜ Challenge Completed Successfully!</p>';
    
    // Load feedback and score
    checkForFeedback();
}

function checkForFeedback() {
    const button = document.querySelector('.action-btn.primary');
    button.disabled = true;
    button.textContent = 'üîÑ Checking...';
    
    // Validate session code before making API call
    if (!currentSession || !currentSession.code || currentSession.code.trim() === '') {
        console.error('‚ùå Cannot check feedback: Missing or empty session code');
        button.disabled = false;
        button.textContent = 'Check Feedback';
        return;
    }
    
    fetch(`/learn/api/simplified/${currentSession.code}/feedback/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        updateFeedbackDisplay(data);
    })
    .catch(error => {
        console.error('Error checking feedback:', error);
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîÑ Check for Feedback';
    });
}

function updateFeedbackDisplay(data) {
    const feedbackContent = document.getElementById('feedback-content');
    const finalScore = document.getElementById('final-score');
    
    // Update score
    if (data.score) {
        finalScore.textContent = `${data.score} (${getScoreDescription(data.score)})`;
        finalScore.className = `stat-value score-${data.score.toLowerCase()}`;
    }
    
    // Update feedback
    if (data.feedback && data.feedback.trim()) {
        feedbackContent.innerHTML = `
            <div class="feedback-given">
                <p class="feedback-text">${data.feedback}</p>
                <div class="feedback-date">Given on ${formatDate(data.feedback_date)}</div>
            </div>
        `;
    } else {
        // Keep the pending message
        feedbackContent.innerHTML = `
            <div class="feedback-pending">
                <span class="pending-icon">‚è≥</span>
                <span class="pending-text">Feedback Pending</span>
                <p class="pending-description">Your teacher is reviewing your work and will provide feedback soon.</p>
            </div>
        `;
    }
}

function getScoreDescription(score) {
    const descriptions = {
        'A': 'Excellent Work!',
        'B': 'Good Job!',
        'C': 'Needs Improvement'
    };
    return descriptions[score] || 'Under Review';
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Handle real-time teacher feedback
function handleTeacherFeedback(data) {
    console.log('üìß Received teacher feedback:', data);
    
    const feedbackData = data.feedback;
    const feedbackContent = document.getElementById('feedback-content');
    const finalScore = document.getElementById('final-score');
    
    // Show notification for new feedback
    showFeedbackNotification(feedbackData);
    
    // Update score if provided
    if (feedbackData.score) {
        if (finalScore) {
            finalScore.textContent = `${feedbackData.score}/10`;
            finalScore.className = `stat-value score-${getScoreLevel(feedbackData.score)}`;
        }
    }
    
    // Check if we have comprehensive feedback data (all submissions scored)
    checkForComprehensiveFeedback();
}

// Check for comprehensive feedback and generate report
async function checkForComprehensiveFeedback() {
    try {
        // Validate session code before making API call
        if (!currentSession || !currentSession.code || currentSession.code.trim() === '') {
            console.error('‚ùå Cannot check feedback: Missing or empty session code');
            return;
        }
        
        const response = await fetch(`/learn/api/sessions/${currentSession.code}/submissions/`);
        const data = await response.json();
        
        if (data.success && data.submissions) {
            const mySubmissions = data.submissions.filter(sub => 
                sub.team.id === currentTeam.id && sub.student_name === studentData.name
            );
            
            const scoredSubmissions = mySubmissions.filter(sub => sub.teacher_score !== null);
            
            // If all submissions are scored, show comprehensive report
            if (mySubmissions.length > 0 && scoredSubmissions.length === mySubmissions.length) {
                generateTeacherReviewReport(mySubmissions);
            } else {
                showFeedbackPending(scoredSubmissions.length, mySubmissions.length);
            }
        }
    } catch (error) {
        console.error('Error checking feedback:', error);
    }
}

function generateTeacherReviewReport(submissions) {
    const feedbackContent = document.getElementById('feedback-content');
    
    // Group submissions by mission/phase
    const submissionsByPhase = submissions.reduce((groups, sub) => {
        const phaseKey = sub.mission.title || sub.mission.mission_type || 'Unknown Phase';
        if (!groups[phaseKey]) groups[phaseKey] = [];
        groups[phaseKey].push(sub);
        return groups;
    }, {});
    
    // Calculate overall statistics
    const totalScore = submissions.reduce((sum, sub) => sum + parseInt(sub.teacher_score), 0);
    const averageScore = (totalScore / submissions.length).toFixed(1);
    const maxScore = submissions.length * 10;
    const percentage = ((totalScore / maxScore) * 100).toFixed(0);
    
    // Determine performance level
    const performanceLevel = getPerformanceLevel(averageScore);
    
    let phasesHtml = '';
    Object.keys(submissionsByPhase).forEach(phaseTitle => {
        const phaseSubmissions = submissionsByPhase[phaseTitle];
        const phaseTotal = phaseSubmissions.reduce((sum, sub) => sum + parseInt(sub.teacher_score), 0);
        const phaseAvg = (phaseTotal / phaseSubmissions.length).toFixed(1);
        
        let questionsHtml = '';
        phaseSubmissions.forEach((sub, index) => {
            const scoreClass = getScoreClass(sub.teacher_score);
            questionsHtml += `
                <div class="review-question-item">
                    <div class="question-content">
                        <div class="question-text">${sub.input_label}</div>
                        <div class="your-answer">${sub.selected_value}</div>
                    </div>
                    <div class="question-score">
                        <div class="score-badge ${scoreClass}">${sub.teacher_score}/10</div>
                        ${sub.teacher_feedback ? `<div class="teacher-comment">${sub.teacher_feedback}</div>` : ''}
                    </div>
                </div>
            `;
        });
        
        phasesHtml += `
            <div class="phase-review-section">
                <div class="phase-header">
                    <h4 class="phase-title">${phaseTitle}</h4>
                    <div class="phase-score-summary">
                        <span class="phase-average">${phaseAvg}/10 avg</span>
                        <span class="questions-count">${phaseSubmissions.length} questions</span>
                    </div>
                </div>
                <div class="phase-questions">
                    ${questionsHtml}
                </div>
            </div>
        `;
    });
    
    feedbackContent.innerHTML = `
        <div class="teacher-review-report">
            <div class="report-header">
                <div class="report-title">
                    <h3>üìä Teacher Review Report</h3>
                    <div class="report-subtitle">Complete feedback on your submission</div>
                </div>
                <div class="overall-score">
                    <div class="score-circle ${getScoreClass(averageScore)}">
                        <div class="score-number">${averageScore}</div>
                        <div class="score-label">out of 10</div>
                    </div>
                    <div class="score-details">
                        <div class="percentage">${percentage}%</div>
                        <div class="performance-level ${performanceLevel.class}">${performanceLevel.text}</div>
                    </div>
                </div>
            </div>
            
            <div class="review-summary">
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-number">${submissions.length}</div>
                        <div class="stat-label">Questions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${totalScore}</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${Object.keys(submissionsByPhase).length}</div>
                        <div class="stat-label">Phases</div>
                    </div>
                </div>
            </div>
            
            <div class="phases-breakdown">
                <h4 class="breakdown-title">üìù Detailed Review by Phase</h4>
                ${phasesHtml}
            </div>
            
            <div class="report-footer">
                <div class="completion-message">
                    <span class="completion-icon">üéâ</span>
                    <span class="completion-text">Great job completing all phases! Your teacher has reviewed your work.</span>
                </div>
                <div class="next-steps">
                    <button class="action-btn primary" onclick="downloadReport()">
                        üì• Download Report
                    </button>
                    <button class="action-btn secondary" onclick="location.href='/learn/simplified/create/'">
                        üöÄ Join Another Session
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Scroll to feedback section with animation
    feedbackContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function showFeedbackPending(scoredCount, totalCount) {
    const feedbackContent = document.getElementById('feedback-content');
    const progress = totalCount > 0 ? (scoredCount / totalCount) * 100 : 0;
    
    feedbackContent.innerHTML = `
        <div class="feedback-pending enhanced">
            <div class="pending-header">
                <span class="pending-icon">‚è≥</span>
                <span class="pending-text">Teacher Review in Progress</span>
            </div>
            <div class="review-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="progress-text">${scoredCount} of ${totalCount} questions reviewed</div>
            </div>
            <p class="pending-description">Your teacher is reviewing your responses. You'll see your complete report once all questions are scored.</p>
        </div>
    `;
}

function getPerformanceLevel(averageScore) {
    const score = parseFloat(averageScore);
    if (score >= 9) return { text: 'Excellent', class: 'excellent' };
    if (score >= 7.5) return { text: 'Very Good', class: 'very-good' };
    if (score >= 6) return { text: 'Good', class: 'good' };
    if (score >= 4) return { text: 'Satisfactory', class: 'satisfactory' };
    return { text: 'Needs Improvement', class: 'needs-improvement' };
}

function getScoreClass(score) {
    const scoreNum = parseInt(score);
    if (scoreNum >= 9) return 'excellent';
    if (scoreNum >= 7) return 'good';
    if (scoreNum >= 5) return 'average';
    return 'needs-work';
}

function downloadReport() {
    // Generate and download a PDF report (placeholder)
    showNotification('üì• Report download feature coming soon!', 'info');
    // TODO: Implement PDF generation
}

// Show notification for new feedback
function showFeedbackNotification(feedbackData) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'feedback-notification';
    notification.innerHTML = `
        <div class="notification-icon">üì¨</div>
        <div class="notification-content">
            <div class="notification-title">New Feedback from Teacher</div>
            <div class="notification-preview">${feedbackData.message ? feedbackData.message.substring(0, 50) + '...' : 'Score: ' + feedbackData.score + '/10'}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 8000);
    
    // Add sound notification (optional)
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRhwBAABXQVZFZm10IBAAAAABAAEAIlYAAIhYAQACABAAZGF0YfoAAAGBhYqFbF1fdJivrJBhNjVgodPgNxZGh4H9dYlHkGKBaECHXo5l');
        audio.volume = 0.3;
        audio.play().catch(() => {}); // Ignore errors if sound can't play
    } catch(e) {}
}

// Get score level for styling
function getScoreLevel(score) {
    if (score >= 8) return 'excellent';
    if (score >= 6) return 'good';
    if (score >= 4) return 'fair';
    return 'poor';
}

// Check if game is completed on load
function checkGameCompletion() {
    // This will be called when we receive team progress updates
    if (currentTeam && currentTeam.completion_percentage >= 100) {
        showCompletionScreen(currentTeam);
    }
}

// New game flow variables
let selectedPainPoints = new Set();
let customPainPoint = '';
let empathyData = {};
let defineData = {};
let ideateData = {
    ideas: ['', '', ''],
    favoriteIdea: null
};

// Function to sync JavaScript state with visual state on page load
function syncPainPointsWithVisualState() {
    console.log('üîÑ Syncing pain points with visual state...');
    selectedPainPoints.clear(); // Clear the set first
    
    // Find all visually selected pain points
    const selectedElements = document.querySelectorAll('.pain-point-item.selected');
    selectedElements.forEach(element => {
        const painPointText = element.querySelector('.pain-point-text');
        if (painPointText) {
            const painPoint = painPointText.textContent.trim();
            selectedPainPoints.add(painPoint);
            console.log(`‚úÖ Added pain point to set: "${painPoint}"`);
        }
    });
    
    console.log(`üìä Total synced pain points: ${selectedPainPoints.size}`);
    console.log(`üìã Pain points in set:`, Array.from(selectedPainPoints));
    
    // Update the counter after syncing
    updateSelectionCounter();
}
let prototypeData = {
    description: '',
    isReady: false
};

// Pain points data
const painPointsData = [
    // Learning & Focus
    'Too noisy/distracting to concentrate',
    'Waiting too long for the teacher\'s help',
    'Lessons move too fast/slowly',
    'Material is boring or irrelevant',
    'Don\'t understand why the material matters',
    'Too much homework/busywork',
    'Too many long tests/exams',
    'Fear of asking questions or seeming wrong',
    
    // Physical Environment
    'Seats/desks are uncomfortable or stiff',
    'Room is too hot, cold, or stuffy',
    'Hard to find materials or tools (messy)',
    'Lighting is too dim or too bright',
    'No good spaces for group work',
    'Classroom feels too cramped/crowded',
    
    // Social & Emotional
    'Group members don\'t share the workload',
    'Feel stressed or anxious about grades',
    'Feel excluded or ignored by classmates',
    'Teacher doesn\'t notice when I\'m struggling',
    'Not enough time for creative projects',
    'Rules feel unfair or too strict',
    
    // Technology & Tools
    'The technology often doesn\'t work (e.g., projector, Wi-Fi)',
    'Don\'t know how to use the learning software',
    'Need access to better or different tools'
];

// Initialize game
function initializeGame() {
    console.log('üéØ Initializing new Design Thinking game');
    
    // FIXED: Always skip intro and go directly to current mission
    // Students should never get stuck on intro/kickoff phase
    if (currentMission && currentMission.id) {
        console.log('üéØ Loading current mission:', currentMission.title);
        loadCurrentPhase();
    } else {
        console.log('üö® No current mission found, showing empathy phase as fallback');
        showEmpathyPhase();
    }
}

// REMOVED: showGameIntroduction() and startGame() functions
// Students now go directly to current mission phase - no intro needed

// Show empathy phase
function showEmpathyPhase() {
    console.log('üëÄ Starting Empathy phase');
    
    // Check if this phase is already completed - prevent going back
    if (window.phaseCompleted?.empathy) {
        console.log('‚ö†Ô∏è Empathy phase already completed, cannot go back');
        return;
    }
    
    // Show empathy card
    document.getElementById('empathy-phase').style.display = 'block';
    
    // Update progress
    document.getElementById('progress-text').textContent = 'Step 1 of 5: Empathy';
    document.getElementById('progress-fill').style.width = '20%';
    
    // Populate pain points
    populatePainPoints();
    
    // Set up custom input listener
    setupCustomPainPointInput();
    
    // Initialize selection counter and submit button
    updateSelectionCounter();
    updateEmpathySubmitButton();
    
    // Sync JavaScript state with any visually selected pain points
    setTimeout(() => {
        syncPainPointsWithVisualState();
    }, 100); // Small delay to ensure DOM is fully rendered
}

// Populate pain points grid
function populatePainPoints() {
    const grid = document.getElementById('pain-points-grid');
    grid.innerHTML = '';
    
    painPointsData.forEach((painPoint, index) => {
        const item = document.createElement('div');
        item.className = 'pain-point-item';
        item.dataset.painPoint = painPoint;
        item.onclick = () => togglePainPoint(item, painPoint);
        
        item.innerHTML = `
            <div class="pain-point-checkbox">‚úì</div>
            <div class="pain-point-text">${painPoint}</div>
        `;
        
        grid.appendChild(item);
    });
}

// Toggle pain point selection
function togglePainPoint(element, painPoint) {
    if (element.classList.contains('selected')) {
        element.classList.remove('selected');
        selectedPainPoints.delete(painPoint);
    } else {
        element.classList.add('selected');
        selectedPainPoints.add(painPoint);
    }
    
    updateSelectionCounter();
}

// Update selection counter - Fixed to include both selected and custom pain points
function updateSelectionCounter() {
    const selectedCount = selectedPainPoints.size;
    const customCount = customPainPoints.filter(p => p.trim()).length;
    const totalPainPoints = selectedCount + customCount;
    
    // Debug logging to track the issue
    console.log(`üîç Counter update - Selected: ${selectedCount}, Custom: ${customCount}, Total: ${totalPainPoints}`);
    console.log(`üîç selectedPainPoints Set:`, Array.from(selectedPainPoints));
    
    const selectionCountElement = document.getElementById('selection-count');
    if (selectionCountElement) {
        selectionCountElement.textContent = totalPainPoints;
    }
    
    const counter = document.querySelector('.selection-counter');
    if (counter) {
        if (totalPainPoints >= 3) {
            counter.style.background = '#d1fae5';
            counter.style.borderColor = '#10b981';
            counter.style.color = '#065f46';
            counter.innerHTML = `‚úì ${totalPainPoints} pain points selected (minimum met)`;
        } else {
            counter.style.background = '#fef3c7';
            counter.style.borderColor = '#fbbf24';
            counter.style.color = '#92400e';
            counter.innerHTML = `${totalPainPoints} / 3 minimum selected`;
        }
    }
    
    // Update submit button state
    updateEmpathySubmitButton();
}

// Setup custom pain point functionality
function setupCustomPainPointInput() {
    // Initialize custom pain points management
    customPainPoints = [];
    setupCharacterCounters();
}

// Update empathy submit button - Fixed: Only require 3 selected pain points, custom are optional
function updateEmpathySubmitButton() {
    const submitBtn = document.getElementById('empathy-submit');
    if (submitBtn) {
        // Only count selected pain points for minimum requirement, custom are completely optional
        const selectedCount = selectedPainPoints.size;
        const customCount = customPainPoints.filter(p => p.trim()).length;
        const totalPainPoints = selectedCount + customCount;
        
        // Button enabled when 3+ selected pain points (custom pain points are optional)
        submitBtn.disabled = selectedCount < 3;
        
        // Debug logging
        console.log(`üìä Selected: ${selectedCount}, Custom: ${customCount}, Total: ${totalPainPoints}, Button disabled: ${submitBtn.disabled}`);
    }
}

// Submit empathy phase
function submitEmpathy() {
    console.log('‚úÖ Submitting empathy data');
    
    empathyData = {
        selectedPainPoints: Array.from(selectedPainPoints),
        customPainPoints: customPainPoints.filter(p => p.trim())
    };
    
    // Show success animation and lock inputs
    const submitBtn = document.getElementById('empathy-submit');
    submitBtn.textContent = 'Great Detective Work! üïµÔ∏è';
    submitBtn.disabled = true;
    
    // Lock empathy phase inputs to prevent changes after submission
    const empathyInputs = document.querySelectorAll('#empathy-phase input, #empathy-phase textarea, #empathy-phase select');
    empathyInputs.forEach(input => {
        input.disabled = true;
        input.style.opacity = '0.6';
        input.style.cursor = 'not-allowed';
    });
    
    // Mark this phase as completed to prevent going back
    window.phaseCompleted = window.phaseCompleted || {};
    window.phaseCompleted.empathy = true;
    
    // Move to define phase after delay
    setTimeout(() => {
        showDefinePhase();
    }, 1500);
}

// Enhanced Custom Pain Points Functions
let customPainPoints = [];

function addCustomPainPoint() {
    if (customPainPoints.length >= 3) return;
    
    const container = document.getElementById('custom-pain-points-container');
    const index = customPainPoints.length;
    
    const inputGroup = document.createElement('div');
    inputGroup.className = 'custom-pain-input-group';
    inputGroup.innerHTML = `
        <input type="text" id="custom-pain-${index}" class="custom-pain-input" 
               placeholder="Describe a pain point you notice..." maxlength="50"
               oninput="updateCustomPainPoint(${index})">
        <button type="button" class="remove-pain-btn" onclick="removeCustomPainPoint(${index})">√ó</button>
        <div class="char-counter"><span id="custom-char-${index}">0</span>/50</div>
    `;
    
    container.appendChild(inputGroup);
    customPainPoints.push('');
    updateCustomPainCounter();
    updateAddButtonState();
}

function removeCustomPainPoint(index) {
    const container = document.getElementById('custom-pain-points-container');
    const inputGroups = container.children;
    if (inputGroups[index]) {
        container.removeChild(inputGroups[index]);
        customPainPoints.splice(index, 1);
        
        // Re-index remaining inputs
        const remainingGroups = container.children;
        for (let i = 0; i < remainingGroups.length; i++) {
            const input = remainingGroups[i].querySelector('input');
            const charSpan = remainingGroups[i].querySelector('.char-counter span');
            const removeBtn = remainingGroups[i].querySelector('.remove-pain-btn');
            
            input.id = `custom-pain-${i}`;
            input.setAttribute('oninput', `updateCustomPainPoint(${i})`);
            charSpan.id = `custom-char-${i}`;
            removeBtn.setAttribute('onclick', `removeCustomPainPoint(${i})`);
        }
    }
    updateCustomPainCounter();
    updateAddButtonState();
    updateEmpathySubmitButton();
}

function updateCustomPainPoint(index) {
    const input = document.getElementById(`custom-pain-${index}`);
    const charSpan = document.getElementById(`custom-char-${index}`);
    
    customPainPoints[index] = input.value;
    charSpan.textContent = input.value.length;
    updateEmpathySubmitButton();
}

function updateCustomPainCounter() {
    const counter = document.getElementById('custom-pain-count');
    counter.textContent = customPainPoints.length;
}

function updateAddButtonState() {
    const addBtn = document.getElementById('add-pain-point-btn');
    addBtn.disabled = customPainPoints.length >= 3;
    
    if (customPainPoints.length >= 3) {
        addBtn.textContent = '‚úì Maximum reached (3/3)';
    } else {
        addBtn.textContent = '+ Add Pain Point';
    }
}

// Enhanced Define Step Functions
function handleCauseSelection() {
    const select = document.getElementById('cause-select');
    const customContainer = document.getElementById('custom-cause-container');
    
    if (select.value === 'Other') {
        customContainer.style.display = 'block';
        setupCustomCauseInput();
    } else {
        customContainer.style.display = 'none';
    }
    updateHMW();
}

function handleResultSelection() {
    const select = document.getElementById('result-select');
    const customContainer = document.getElementById('custom-result-container');
    
    if (select.value === 'other') {
        customContainer.style.display = 'block';
        setupCustomResultInput();
    } else {
        customContainer.style.display = 'none';
    }
    updateHMW();
}

function setupCustomCauseInput() {
    const input = document.getElementById('custom-cause-input');
    const charSpan = document.getElementById('cause-char-count');
    
    if (input && !input.hasAttribute('data-listener-added')) {
        input.addEventListener('input', function() {
            charSpan.textContent = this.value.length;
            updateHMW();
        });
        input.setAttribute('data-listener-added', 'true');
    }
}

function setupCustomResultInput() {
    const input = document.getElementById('custom-result-input');
    const charSpan = document.getElementById('result-char-count');
    
    if (input && !input.hasAttribute('data-listener-added')) {
        input.addEventListener('input', function() {
            charSpan.textContent = this.value.length;
            updateHMW();
        });
        input.setAttribute('data-listener-added', 'true');
    }
}

function toggleCustomHMW() {
    const toggle = document.getElementById('custom-hmw-toggle');
    const autoSection = document.getElementById('auto-hmw-section');
    const customSection = document.getElementById('custom-hmw-section');
    
    if (toggle.checked) {
        autoSection.style.display = 'none';
        customSection.style.display = 'block';
        setupCustomHMWInput();
    } else {
        autoSection.style.display = 'block';
        customSection.style.display = 'none';
    }
    updateDefineSubmitButton();
}

function setupCustomHMWInput() {
    const textarea = document.getElementById('custom-hmw-input');
    const charSpan = document.getElementById('hmw-char-count');
    
    if (textarea && !textarea.hasAttribute('data-listener-added')) {
        textarea.addEventListener('input', function() {
            charSpan.textContent = this.value.length;
            updateDefineSubmitButton();
        });
        textarea.setAttribute('data-listener-added', 'true');
    }
}

// Enhanced Ideas Functions
let ideaCount = 3; // Start with 3 ideas
const maxIdeas = 10;

function addIdeaInput() {
    if (ideaCount >= maxIdeas) return;
    
    ideaCount++;
    const container = document.getElementById('ideas-container');
    
    const ideaGroup = document.createElement('div');
    ideaGroup.className = 'idea-input-group';
    
    const encouragementTexts = [
        'üåü Bonus idea - What else could work?',
        'üöÄ Creative boost - Think differently!',
        'üíé Innovation mode - Keep them coming!',
        'üéØ Brilliant thinking - More ideas!',
        '‚ö° Supercharged creativity - Amazing!',
        'üåà Idea machine - You\'re on fire!',
        'üî• Unstoppable innovation - Incredible!'
    ];
    
    const encouragement = encouragementTexts[Math.min(ideaCount - 4, encouragementTexts.length - 1)];
    
    ideaGroup.innerHTML = `
        <label class="idea-label">${encouragement}</label>
        <input type="text" id="idea-${ideaCount}" class="idea-input" 
               placeholder="Another creative solution..." maxlength="100" 
               onchange="updateIdeaCount()">
        <div class="char-counter"><span id="idea${ideaCount}-count">0</span>/100</div>
    `;
    
    container.appendChild(ideaGroup);
    updateIdeaProgress();
    updateAddIdeaButtonState();
    setupIdeaCharCounter(ideaCount);
}

function updateIdeaCount() {
    const filledIdeas = [];
    for (let i = 1; i <= ideaCount; i++) {
        const input = document.getElementById(`idea-${i}`);
        if (input && input.value.trim()) {
            filledIdeas.push(input.value.trim());
        }
    }
    
    document.getElementById('idea-count').textContent = filledIdeas.length;
    updateIdeaEncouragement(filledIdeas.length);
    updateFavoriteOptions();
    updateIdeateSubmitButton();
}

function updateIdeaEncouragement(count) {
    const encouragement = document.getElementById('idea-encouragement');
    const messages = [
        'Start with your first idea and keep the creativity flowing!',
        'Great start! One idea down, more to go! üéØ',
        'Awesome! Two ideas brewing! üî•',
        'Fantastic! Three solid ideas! üåü',
        'Incredible! Four ideas and counting! üöÄ',
        'Outstanding! Five ideas - you\'re on a roll! üíé',
        'Amazing! Six ideas - creativity overload! ‚ö°',
        'Phenomenal! Seven ideas - pure genius! üåà',
        'Extraordinary! Eight ideas - unstoppable! üé®',
        'Legendary! Nine ideas - innovation master! üèÜ',
        'EPIC! Ten ideas - you\'ve maxed out creativity! üéâ'
    ];
    
    encouragement.textContent = messages[Math.min(count, messages.length - 1)];
}

function updateAddIdeaButtonState() {
    const addBtn = document.getElementById('add-idea-btn');
    addBtn.disabled = ideaCount >= maxIdeas;
    
    if (ideaCount >= maxIdeas) {
        addBtn.textContent = 'üéâ Maximum reached - 10 amazing ideas!';
    } else {
        addBtn.textContent = '+ Add Another Idea';
    }
}

function setupIdeaCharCounter(ideaNum) {
    const input = document.getElementById(`idea-${ideaNum}`);
    const charSpan = document.getElementById(`idea${ideaNum}-count`);
    
    input.addEventListener('input', function() {
        charSpan.textContent = this.value.length;
    });
}

function updateIdeaProgress() {
    // Visual feedback for progress
    const progressEl = document.querySelector('.idea-progress');
    if (ideaCount >= 6) {
        progressEl.style.background = 'linear-gradient(135deg, #fef3c7, #fed7aa)';
        progressEl.style.borderColor = '#f59e0b';
    }
}

function setupCharacterCounters() {
    // Setup all character counters for various inputs
    setTimeout(() => {
        // Setup existing counters
        const inputs = document.querySelectorAll('[maxlength]');
        inputs.forEach(input => {
            const counterId = input.id + '-count';
            const counter = document.getElementById(counterId);
            if (counter) {
                input.addEventListener('input', function() {
                    counter.textContent = this.value.length;
                });
            }
        });
    }, 100);
}

// Show define phase
function showDefinePhase() {
    console.log('üß© Starting Define phase');
    
    // Check if this phase is already completed - prevent going back
    if (window.phaseCompleted?.define) {
        console.log('‚ö†Ô∏è Define phase already completed, cannot go back');
        return;
    }
    
    // Hide empathy phase
    document.getElementById('empathy-phase').style.display = 'none';
    
    // Show define phase
    document.getElementById('define-phase').style.display = 'block';
    
    // Update progress
    document.getElementById('progress-text').textContent = 'Step 2 of 5: Define';
    document.getElementById('progress-fill').style.width = '40%';
    
    // Populate pain point dropdown
    populatePainPointDropdown();
    
    // Setup define phase listeners
    setupDefinePhaseListeners();
}

// Populate pain point dropdown from empathy selections
function populatePainPointDropdown() {
    const select = document.getElementById('pain-point-select');
    select.innerHTML = '<option value="">Choose a pain point...</option>';
    
    // Add selected pain points
    empathyData.selectedPainPoints.forEach(painPoint => {
        const option = document.createElement('option');
        option.value = painPoint;
        option.textContent = painPoint;
        select.appendChild(option);
    });
    
    // Add custom pain points if provided
    empathyData.customPainPoints.forEach(painPoint => {
        if (painPoint.trim()) {
            const option = document.createElement('option');
            option.value = painPoint;
            option.textContent = painPoint;
            select.appendChild(option);
        }
    });
}

function setupDefinePhaseListeners() {
    // Add listeners to all dropdowns
    const selects = ['pain-point-select', 'audience-select', 'cause-select', 'action-select', 'result-select'];
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select && !select.hasAttribute('data-listener-added')) {
            select.addEventListener('change', function() {
                if (selectId === 'cause-select') {
                    handleCauseSelection();
                } else if (selectId === 'result-select') {
                    handleResultSelection();
                } else {
                    updateHMW();
                }
            });
            select.setAttribute('data-listener-added', 'true');
        }
    });
    
    // Setup custom HMW toggle
    const toggle = document.getElementById('custom-hmw-toggle');
    if (toggle && !toggle.hasAttribute('data-listener-added')) {
        toggle.addEventListener('change', toggleCustomHMW);
        toggle.setAttribute('data-listener-added', 'true');
    }
}

// Update HMW question
function updateHMW() {
    const painPoint = document.getElementById('pain-point-select').value;
    const audience = document.getElementById('audience-select').value;
    let cause = document.getElementById('cause-select').value;
    const action = document.getElementById('action-select').value;
    let result = document.getElementById('result-select').value;
    
    // Handle custom cause input
    if (cause === 'Other') {
        const customCause = document.getElementById('custom-cause-input').value.trim();
        cause = customCause || '';
    }
    
    // Handle custom result input
    if (result === 'other') {
        const customResult = document.getElementById('custom-result-input').value.trim();
        result = customResult || '';
    }
    
    const hmwQuestion = document.getElementById('hmw-question');
    
    if (painPoint && action && result) {
        const question = `How might we ${action} "${painPoint}" so that ${result}?`;
        hmwQuestion.textContent = question;
        hmwQuestion.style.fontStyle = 'normal';
    } else {
        hmwQuestion.textContent = 'Complete the steps above to generate your "How Might We" question!';
        hmwQuestion.style.fontStyle = 'italic';
    }
    
    // Update submit button using enhanced function
    updateDefineSubmitButton();
}

function updateDefineSubmitButton() {
    const submitBtn = document.getElementById('define-submit');
    const customToggle = document.getElementById('custom-hmw-toggle');
    
    if (customToggle && customToggle.checked) {
        // Custom HMW mode
        const customHMW = document.getElementById('custom-hmw-input').value.trim();
        submitBtn.disabled = !customHMW || customHMW.length < 10;
    } else {
        // Auto-generated HMW mode
        const painPoint = document.getElementById('pain-point-select').value;
        const audience = document.getElementById('audience-select').value;
        let cause = document.getElementById('cause-select').value;
        const action = document.getElementById('action-select').value;
        let result = document.getElementById('result-select').value;
        
        // Check custom inputs
        if (cause === 'Other') {
            const customCauseInput = document.getElementById('custom-cause-input');
            cause = customCauseInput ? customCauseInput.value.trim() : '';
        }
        if (result === 'other') {
            const customResultInput = document.getElementById('custom-result-input');
            result = customResultInput ? customResultInput.value.trim() : '';
        }
        
        // All fields must be filled (including custom inputs when "Other" is selected)
        const allFieldsFilled = painPoint && audience && cause && action && result;
        submitBtn.disabled = !allFieldsFilled;
        
        console.log('Define validation:', {painPoint, audience, cause, action, result, allFieldsFilled});
    }
}

// Submit define phase
function submitDefine() {
    console.log('‚úÖ Submitting define data');
    
    // Get the problem statement from simplified input
    const problemStatement = document.getElementById('input_0')?.value.trim();
    
    if (!problemStatement) {
        console.error('No problem statement found');
        return;
    }
    
    // Use the problem statement as the HMW question
    const hmwQuestion = problemStatement;
    
    defineData = {
        hmwQuestion: hmwQuestion,
        problemStatement: problemStatement,
        isCustomHMW: false  // Using simplified input
    };
    
    // Show success animation
    const submitBtn = document.getElementById('define-submit');
    submitBtn.textContent = 'Perfect Challenge Created! üéØ';
    submitBtn.disabled = true;
    
    // Lock define phase inputs to prevent changes after submission
    const defineInputs = document.querySelectorAll('#define-phase input, #define-phase textarea, #define-phase select');
    defineInputs.forEach(input => {
        input.disabled = true;
        input.style.opacity = '0.6';
        input.style.cursor = 'not-allowed';
    });
    
    // Mark this phase as completed to prevent going back
    window.phaseCompleted = window.phaseCompleted || {};
    window.phaseCompleted.define = true;
    
    // Continue to next phase after delay
    setTimeout(() => {
        showIdeatePhase();
    }, 1500);
}

// Show Step 3: Ideate phase
function showIdeatePhase() {
    console.log('üí° Starting Ideate phase');
    
    // Hide define phase
    document.getElementById('define-phase').style.display = 'none';
    
    // Show ideate phase
    document.getElementById('ideate-phase').style.display = 'block';
    
    // Update progress
    document.getElementById('progress-text').textContent = 'Step 3 of 5: Ideate';
    document.getElementById('progress-fill').style.width = '60%';
    
    // Display HMW question from Step 2
    document.getElementById('hmw-reminder-text').textContent = defineData.hmwQuestion;
    
    // Set up input listeners
    setupIdeateInputs();
}

// Set up input listeners for ideate phase
function setupIdeateInputs() {
    // Initialize ideas array to accommodate up to 10 ideas
    ideateData.ideas = [];
    
    // Set up listeners for initial 3 ideas
    for (let i = 1; i <= 3; i++) {
        setupIdeaCharCounter(i);
    }
    
    // Initialize idea tracking
    updateIdeaCount();
}

// Update favorite options based on entered ideas
function updateFavoriteOptions() {
    const container = document.getElementById('favorite-options');
    container.innerHTML = '';
    
    const filledIdeas = [];
    for (let i = 1; i <= ideaCount; i++) {
        const input = document.getElementById(`idea-${i}`);
        if (input && input.value.trim()) {
            filledIdeas.push({text: input.value.trim(), index: i});
        }
    }
    
    filledIdeas.forEach((idea, arrayIndex) => {
        const option = document.createElement('div');
        option.className = 'favorite-option';
        option.onclick = () => selectFavoriteIdea(option, idea.index);
        
        option.innerHTML = `
            <input type="radio" name="favorite-idea" value="${idea.index}" style="margin-right: 12px;">
            <span>üí° ${idea.text}</span>
        `;
        
        container.appendChild(option);
    });
}

// Select favorite idea
function selectFavoriteIdea(element, index) {
    document.querySelectorAll('.favorite-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    element.querySelector('input').checked = true;
    ideateData.favoriteIdea = index;
    updateIdeateSubmitButton();
}

// Update ideate submit button state
function updateIdeateSubmitButton() {
    const submitBtn = document.getElementById('ideate-submit');
    const hasAllIdeas = ideateData.ideas.every(idea => idea.trim().length > 0);
    const hasFavorite = ideateData.favoriteIdea !== null;
    
    submitBtn.disabled = !(hasAllIdeas && hasFavorite);
}

// Submit ideate phase
function submitIdeate() {
    // Collect all ideas from all input fields
    const allIdeas = [];
    for (let i = 1; i <= ideaCount; i++) {
        const input = document.getElementById(`idea-${i}`);
        if (input && input.value.trim()) {
            allIdeas.push(input.value.trim());
        }
    }
    
    // Get selected favorite idea
    const favoriteRadio = document.querySelector('input[name="favorite-idea"]:checked');
    const favoriteIndex = favoriteRadio ? parseInt(favoriteRadio.value) : null;
    const favoriteIdea = favoriteIndex ? document.getElementById(`idea-${favoriteIndex}`).value.trim() : '';
    
    ideateData = {
        ideas: allIdeas,
        favoriteIdea: favoriteIdea,
        totalIdeasGenerated: allIdeas.length
    };
    
    console.log('‚úÖ Submitting ideate data', ideateData);
    
    // Show success animation and lock inputs
    const submitBtn = document.getElementById('ideate-submit');
    submitBtn.textContent = `Amazing ${allIdeas.length} Ideas Created! üåü`;
    submitBtn.disabled = true;
    
    // Lock ideate phase inputs to prevent changes after submission
    const ideateInputs = document.querySelectorAll('#ideate-phase input, #ideate-phase textarea, #ideate-phase select');
    ideateInputs.forEach(input => {
        input.disabled = true;
        input.style.opacity = '0.6';
        input.style.cursor = 'not-allowed';
    });
    
    // Move to prototype phase
    setTimeout(() => {
        showPrototypePhase();
    }, 1500);
}

// Show Step 4: Prototype phase
function showPrototypePhase() {
    console.log('üõ†Ô∏è Starting Prototype phase');
    
    // Hide ideate phase
    document.getElementById('ideate-phase').style.display = 'none';
    
    // Show prototype phase
    document.getElementById('prototype-phase').style.display = 'block';
    
    // Update progress
    document.getElementById('progress-text').textContent = 'Step 4 of 5: Prototype';
    document.getElementById('progress-fill').style.width = '80%';
    
    // Display chosen idea
    const chosenIdea = ideateData.ideas[ideateData.favoriteIdea];
    document.getElementById('chosen-idea-display').textContent = chosenIdea;
    
    // Set up input listeners
    setupPrototypeInputs();
}

// Set up input listeners for prototype phase
function setupPrototypeInputs() {
    const textarea = document.getElementById('prototype-description');
    const charCount = document.getElementById('prototype-char-count');
    
    textarea.addEventListener('input', function() {
        prototypeData.description = this.value;
        charCount.textContent = this.value.length;
        updatePrototypeSubmitButton();
    });
}

// Update prototype submit button state
function updatePrototypeSubmitButton() {
    const submitBtn = document.getElementById('prototype-submit');
    const checkbox = document.getElementById('prototype-ready');
    
    prototypeData.isReady = checkbox.checked;
    const hasDescription = prototypeData.description.trim().length >= 50; // Minimum 50 chars
    
    submitBtn.disabled = !(hasDescription && prototypeData.isReady);
}

// Submit prototype phase
function submitPrototype() {
    console.log('‚úÖ Submitting prototype data', prototypeData);
    
    // Show success animation and lock inputs
    const submitBtn = document.getElementById('prototype-submit');
    submitBtn.textContent = 'Prototype Complete! üèÜ';
    submitBtn.disabled = true;
    
    // Lock prototype phase inputs to prevent changes after submission
    const prototypeInputs = document.querySelectorAll('#prototype-phase input, #prototype-phase textarea, #prototype-phase select');
    prototypeInputs.forEach(input => {
        input.disabled = true;
        input.style.opacity = '0.6';
        input.style.cursor = 'not-allowed';
    });
    
    // Move to final phase (test/showcase)
    setTimeout(() => {
        continueToFinalPhase();
    }, 1500);
}

// Continue to final phase (test/showcase)
function continueToFinalPhase() {
    console.log('üéâ Moving to final phase...');
    
    // Hide prototype phase
    document.getElementById('prototype-phase').style.display = 'none';
    
    // Show completion screen (final phase)
    showCompletionScreen();
    
    // Update progress to show completion
    document.getElementById('progress-text').textContent = 'Challenge Complete! üéâ';
    document.getElementById('progress-fill').style.width = '100%';
}

// Ping WebSocket to keep connection alive
setInterval(() => {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({ type: 'ping' }));
    }
}, 30000);
</script>
{% endblock %}