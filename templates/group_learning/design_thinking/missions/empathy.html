{% load static %}
<style>
    .mission-phase {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
    }
    
    .phase-indicator {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2rem;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .empathy-toolkit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
        padding: 2rem;
    }
    
    .observation-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: transform 0.2s ease;
    }
    
    .observation-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.15);
    }
    
    .observation-input {
        background: rgba(255, 255, 255, 0.9);
        color: #374151;
        border: none;
        border-radius: 0.5rem;
        padding: 1rem;
        width: 100%;
        font-size: 1rem;
        transition: background 0.2s ease;
    }
    
    .observation-input:focus {
        background: white;
        outline: 2px solid #f59e0b;
        outline-offset: 2px;
    }
    
    .emotion-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .emotion-btn {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid transparent;
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .emotion-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .emotion-btn.selected {
        background: rgba(255, 255, 255, 0.3);
        border-color: #f59e0b;
    }
    
    .progress-ring {
        transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
        transition: stroke-dashoffset 0.35s;
        transform-origin: 50% 50%;
    }
    
    .observation-preview {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        color: #1f2937;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 1rem;
    }
</style>
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Mission Header -->
    <div class="mission-phase">
        <div class="phase-indicator">Phase 1: Empathy</div>
        <h1 class="text-3xl font-bold mb-4">üîç Understand Your Users</h1>
        <div class="text-lg opacity-90 flex items-center space-x-6">
            <div class="flex items-center space-x-2">
                <span class="text-2xl">üëÅÔ∏è</span>
                <span>Observe</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-2xl">‚ù§Ô∏è</span>
                <span>Feel</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-2xl">üß†</span>
                <span>Understand</span>
            </div>
        </div>
    </div>

    <!-- LEARN PHASE -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
        <div class="flex items-center mb-4">
            <span class="text-2xl mr-3">üìö</span>
            <h2 class="text-lg font-bold text-gray-900">Quick Empathy Guide</h2>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
            <div class="text-center bg-blue-50 p-3 rounded-lg">
                <div class="text-3xl mb-2">üëÅÔ∏è</div>
                <h3 class="font-bold text-sm text-blue-900 mb-2">Watch Behavior</h3>
                <p class="text-xs text-blue-800">Actions reveal real needs</p>
            </div>
            
            <div class="text-center bg-purple-50 p-3 rounded-lg">
                <div class="text-3xl mb-2">üí≠</div>
                <h3 class="font-bold text-sm text-purple-900 mb-2">Notice Emotions</h3>
                <p class="text-xs text-purple-800">Feelings show pain points</p>
            </div>
            
            <div class="text-center bg-green-50 p-3 rounded-lg">
                <div class="text-3xl mb-2">ü§î</div>
                <h3 class="font-bold text-sm text-green-900 mb-2">Ask "Why?"</h3>
                <p class="text-xs text-green-800">Find deeper motivations</p>
            </div>
        </div>

        <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded">
            <div class="flex items-start space-x-3">
                <span class="text-xl">üí°</span>
                <div>
                    <p class="text-sm font-medium text-yellow-900">Example:</p>
                    <p class="text-xs text-yellow-800">"Student squints at board ‚Üí feels frustrated ‚Üí can't follow lesson"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PRACTICE PHASE -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
        <div class="flex items-center mb-4">
            <span class="text-2xl mr-3">üõ†Ô∏è</span>
            <h2 class="text-lg font-bold text-gray-900">Choose Your Focus User</h2>
        </div>

        <!-- User Persona Builder Integration -->
        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-200 p-4 rounded-lg mb-4">
            <h3 class="text-sm font-bold text-orange-900 mb-3">üë§ Who will you observe?</h3>
            {% include 'group_learning/design_thinking/components/user_persona_builder.html' %}
        </div>

        <!-- Quick Practice Tips -->
        <div class="grid md:grid-cols-2 gap-3">
            <div class="bg-blue-50 p-3 rounded-lg">
                <div class="flex items-center mb-2">
                    <span class="text-lg mr-2">üè´</span>
                    <h4 class="font-bold text-sm text-blue-900">Cafeteria</h4>
                </div>
                <p class="text-xs text-blue-800">Watch: Who sits where? Body language? Stress signals?</p>
            </div>
            
            <div class="bg-green-50 p-3 rounded-lg">
                <div class="flex items-center mb-2">
                    <span class="text-lg mr-2">üë•</span>
                    <h4 class="font-bold text-sm text-green-900">Group Work</h4>
                </div>
                <p class="text-xs text-green-800">Watch: Who participates? Who's quiet? Frustration signs?</p>
            </div>
        </div>
    </div>

    <!-- APPLY PHASE -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center mb-6">
            <div class="bg-green-100 p-3 rounded-full mr-4">
                <span class="text-2xl">üöÄ</span>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Apply: Real-World Observation Mission</h2>
                <p class="text-gray-600">Conduct structured observations using your persona as a guide</p>
            </div>
        </div>

        <!-- Persona Reminder -->
        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6">
            <h4 class="font-semibold text-yellow-900 mb-2">üé≠ Your Focus User</h4>
            <div id="persona-display" class="text-yellow-800">
                <div id="persona-details" class="italic">Complete the persona builder above to see your focus user here...</div>
            </div>
        </div>

        <!-- Empathy Toolkit -->
        <div class="empathy-toolkit">
            <h3 class="text-2xl font-bold mb-6 text-center">üîß Empathy Research Toolkit</h3>
            
            <!-- Mission Goal -->
            <div class="observation-card">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-lg font-bold">üéØ Mission Goal</h4>
                        <p>Find 5+ specific problems your focus user faces</p>
                    </div>
                    <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-medium">
                        Goal: 5+ observations
                    </div>
                </div>
            </div>

            <!-- Observation Entry Form -->
            <div class="observation-card">
                <h4 class="text-lg font-bold mb-4">üìù Structured Observation Entry</h4>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-semibold mb-2">What did you observe? (Be specific!)</label>
                        <textarea id="observation-what" 
                                  class="observation-input"
                                  placeholder="e.g., Sarah squints and leans forward every time the teacher writes on the board"
                                  rows="3" maxlength="200"></textarea>
                        <div class="text-xs mt-1 opacity-80">
                            <span id="what-count">0</span>/200 characters
                        </div>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Why is this a problem for them?</label>
                        <textarea id="observation-why" 
                                  class="observation-input"
                                  placeholder="e.g., Because she gets headaches and misses important information"
                                  rows="3" maxlength="150"></textarea>
                        <div class="text-xs mt-1 opacity-80">
                            <span id="why-count">0</span>/150 characters
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2">How do they feel about it?</label>
                    <div class="emotion-selector" id="emotion-selector">
                        <button class="emotion-btn" data-emotion="frustrated">üò§ Frustrated</button>
                        <button class="emotion-btn" data-emotion="worried">üòü Worried</button>
                        <button class="emotion-btn" data-emotion="confused">üòï Confused</button>
                        <button class="emotion-btn" data-emotion="embarrassed">üò≥ Embarrassed</button>
                        <button class="emotion-btn" data-emotion="isolated">üòî Isolated</button>
                        <button class="emotion-btn" data-emotion="overwhelmed">üò∞ Overwhelmed</button>
                        <button class="emotion-btn" data-emotion="resigned">üòû Resigned</button>
                        <button class="emotion-btn" data-emotion="determined">üí™ Determined</button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2">Evidence/Proof you saw this</label>
                    <textarea id="observation-evidence" 
                              class="observation-input"
                              placeholder="e.g., She rubbed her temples and asked classmate what was written"
                              rows="2" maxlength="150"></textarea>
                    <div class="text-xs mt-1 opacity-80">
                        <span id="evidence-count">0</span>/150 characters
                    </div>
                </div>

                <!-- Live Preview -->
                <div class="observation-preview">
                    <h5 class="font-semibold mb-2">üëÅÔ∏è Observation Preview:</h5>
                    <div id="observation-preview" class="italic">
                        Fill in the fields above to see your observation summary
                    </div>
                </div>

                <div class="flex justify-between items-center mt-4">
                    <button onclick="clearObservationForm()" 
                            class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                        üîÑ Clear Form
                    </button>
                    <button onclick="addObservation()" 
                            id="add-observation-btn"
                            class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        ‚ûï Add Observation
                    </button>
                </div>
            </div>
        </div>

        <!-- Observations Collection -->
        <div id="observations-collection" class="hidden mt-6 bg-green-50 border-2 border-green-200 p-6 rounded-xl">
            <div class="flex items-center justify-between mb-4">
                <h4 class="text-xl font-bold text-green-900">‚úÖ Your Empathy Research</h4>
                <div class="text-sm text-green-600 font-medium">
                    <span id="observation-count">0</span> observations collected
                </div>
            </div>
            <div id="observations-list" class="space-y-3">
                <!-- Observations will appear here -->
            </div>
        </div>

        <!-- Progress Tracking -->
        <div class="mt-6 bg-blue-50 border border-blue-200 p-4 rounded-lg">
            <div class="flex items-center justify-between">
                <div class="font-semibold text-blue-900">Mission Progress</div>
                <div id="empathy-progress" class="text-blue-700">0 of 5+ observations complete</div>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-3 mt-2">
                <div id="empathy-progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Mission Completion Notification -->
        <div id="mission-completion-notification" class="hidden mt-6 bg-gradient-to-r from-green-500 to-emerald-600 p-6 rounded-xl text-white shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-3">üéâ</span>
                        <h3 class="text-xl font-bold">Empathy Mission Complete!</h3>
                    </div>
                    <p class="text-green-100 mb-4">Excellent work! You've completed the minimum 5 observations and are ready to move forward.</p>
                    <div class="space-y-2">
                        <button onclick="proceedToDefinePhase()" class="bg-white text-green-600 px-6 py-2 rounded-lg font-medium hover:bg-green-50 transition-colors mr-3">
                            Continue to Define Mission ‚Üí
                        </button>
                        <button onclick="continueObserving()" class="bg-green-400 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-300 transition-colors">
                            Add More Observations (Optional)
                        </button>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold" id="completion-count">5</div>
                    <div class="text-green-200 text-sm">observations</div>
                </div>
            </div>
        </div>
    </div>

    <!-- REFLECT PHASE -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center mb-6">
            <div class="bg-purple-100 p-3 rounded-full mr-4">
                <span class="text-2xl">ü§î</span>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Reflect: Understanding Your Empathy Journey</h2>
                <p class="text-gray-600">Think about what you discovered and how it applies beyond this exercise</p>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-purple-50 p-4 rounded-lg">
                <h3 class="font-semibold text-purple-900 mb-3">üéØ Reflection Questions</h3>
                <div class="space-y-3">
                    <div class="bg-white p-3 rounded">
                        <p class="text-purple-800 font-medium text-sm">What surprised you most about your focus user?</p>
                    </div>
                    <div class="bg-white p-3 rounded">
                        <p class="text-purple-800 font-medium text-sm">How did observing change your understanding of the problem?</p>
                    </div>
                    <div class="bg-white p-3 rounded">
                        <p class="text-purple-800 font-medium text-sm">What emotions did you notice most while observing?</p>
                    </div>
                    <div class="bg-white p-3 rounded">
                        <p class="text-purple-800 font-medium text-sm">How might these insights change your approach to solutions?</p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-semibold text-blue-900 mb-3">üåü Key Learnings</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-start">
                        <span class="text-blue-600 mr-2">‚Ä¢</span>
                        <span class="text-blue-800">Observation reveals hidden problems</span>
                    </div>
                    <div class="flex items-start">
                        <span class="text-blue-600 mr-2">‚Ä¢</span>
                        <span class="text-blue-800">Emotions are as important as actions</span>
                    </div>
                    <div class="flex items-start">
                        <span class="text-blue-600 mr-2">‚Ä¢</span>
                        <span class="text-blue-800">Assumptions can be wrong</span>
                    </div>
                    <div class="flex items-start">
                        <span class="text-blue-600 mr-2">‚Ä¢</span>
                        <span class="text-blue-800">Real empathy takes time and attention</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6 bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-900 mb-3">üöÄ Apply This Learning</h4>
            <p class="text-gray-700 text-sm mb-3">
                Empathy skills are valuable beyond design thinking. You can use observation and empathy when:
            </p>
            <div class="grid md:grid-cols-3 gap-3 text-sm">
                <div class="bg-white p-3 rounded">
                    <strong class="text-purple-700">Understanding Friends:</strong>
                    <p class="text-gray-600">Notice when friends are struggling, even when they don't say anything</p>
                </div>
                <div class="bg-white p-3 rounded">
                    <strong class="text-blue-700">Family Dynamics:</strong>
                    <p class="text-gray-600">Understand what family members really need beyond their words</p>
                </div>
                <div class="bg-white p-3 rounded">
                    <strong class="text-green-700">School Projects:</strong>
                    <p class="text-gray-600">Design anything for others by understanding their real needs</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Empathy Tips -->
    <div class="grid md:grid-cols-2 gap-6">
        <!-- Success Tips -->
        <div class="bg-green-50 border border-green-200 p-6 rounded-xl">
            <h3 class="text-lg font-bold text-green-900 mb-4">üéØ Empathy Success Tips</h3>
            <div class="space-y-3 text-sm">
                <div class="flex items-start">
                    <span class="text-green-600 mr-2 font-bold">‚úì</span>
                    <span class="text-green-800">Focus on one specific user type</span>
                </div>
                <div class="flex items-start">
                    <span class="text-green-600 mr-2 font-bold">‚úì</span>
                    <span class="text-green-800">Notice both physical and emotional responses</span>
                </div>
                <div class="flex items-start">
                    <span class="text-green-600 mr-2 font-bold">‚úì</span>
                    <span class="text-green-800">Look for workarounds and adaptations</span>
                </div>
                <div class="flex items-start">
                    <span class="text-green-600 mr-2 font-bold">‚úì</span>
                    <span class="text-green-800">Ask "why" to understand deeper motivations</span>
                </div>
            </div>
        </div>

        <!-- Common Mistakes -->
        <div class="bg-red-50 border border-red-200 p-6 rounded-xl">
            <h3 class="text-lg font-bold text-red-900 mb-4">‚ö†Ô∏è Avoid These Mistakes</h3>
            <div class="space-y-3 text-sm">
                <div class="flex items-start">
                    <span class="text-red-600 mr-2 font-bold">‚úó</span>
                    <span class="text-red-800">Making assumptions without observing</span>
                </div>
                <div class="flex items-start">
                    <span class="text-red-600 mr-2 font-bold">‚úó</span>
                    <span class="text-red-800">Focusing only on what people say</span>
                </div>
                <div class="flex items-start">
                    <span class="text-red-600 mr-2 font-bold">‚úó</span>
                    <span class="text-red-800">Ignoring emotions and only noting actions</span>
                </div>
                <div class="flex items-start">
                    <span class="text-red-600 mr-2 font-bold">‚úó</span>
                    <span class="text-red-800">Rushing the observation process</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Empathy Mission -->
<script>
let observations = [];
let selectedEmotion = '';

document.addEventListener('DOMContentLoaded', function() {
    initializeEmpathyMission();
    loadPersonaData();
});

function initializeEmpathyMission() {
    setupCharacterCounting();
    setupEmotionSelector();
    setupLivePreview();
    loadSavedObservations();
}

function setupCharacterCounting() {
    const inputs = [
        { id: 'observation-what', counterId: 'what-count' },
        { id: 'observation-why', counterId: 'why-count' },
        { id: 'observation-evidence', counterId: 'evidence-count' }
    ];
    
    inputs.forEach(input => {
        const element = document.getElementById(input.id);
        const counter = document.getElementById(input.counterId);
        
        if (element && counter) {
            element.addEventListener('input', function() {
                counter.textContent = this.value.length;
                updateLivePreview();
                validateObservationForm();
            });
        }
    });
}

function setupEmotionSelector() {
    const emotionButtons = document.querySelectorAll('.emotion-btn');
    emotionButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Clear previous selections
            emotionButtons.forEach(btn => btn.classList.remove('selected'));
            
            // Select current emotion
            this.classList.add('selected');
            selectedEmotion = this.dataset.emotion;
            
            updateLivePreview();
            validateObservationForm();
        });
    });
}

function setupLivePreview() {
    updateLivePreview();
}

function updateLivePreview() {
    const what = document.getElementById('observation-what').value.trim();
    const why = document.getElementById('observation-why').value.trim();
    const evidence = document.getElementById('observation-evidence').value.trim();
    
    const preview = document.getElementById('observation-preview');
    
    if (what && why && selectedEmotion && evidence) {
        const emotionText = selectedEmotion.charAt(0).toUpperCase() + selectedEmotion.slice(1);
        preview.innerHTML = `
            <strong>Observation:</strong> ${what}<br>
            <strong>Emotional Impact:</strong> They feel ${emotionText}<br>
            <strong>Why it matters:</strong> ${why}<br>
            <strong>Evidence:</strong> ${evidence}
        `;
    } else {
        preview.textContent = 'Fill in the fields above to see your observation summary';
    }
}

function validateObservationForm() {
    const what = document.getElementById('observation-what').value.trim();
    const why = document.getElementById('observation-why').value.trim();
    const evidence = document.getElementById('observation-evidence').value.trim();
    
    const isValid = what.length > 10 && why.length > 10 && selectedEmotion && evidence.length > 10;
    
    const addBtn = document.getElementById('add-observation-btn');
    if (addBtn) {
        addBtn.disabled = !isValid;
    }
    
    return isValid;
}

function addObservation() {
    if (!validateObservationForm()) {
        alert('Please complete all fields with meaningful details');
        return;
    }
    
    const what = document.getElementById('observation-what').value.trim();
    const why = document.getElementById('observation-why').value.trim();
    const evidence = document.getElementById('observation-evidence').value.trim();
    
    const observation = {
        what: what,
        emotion: selectedEmotion,
        why: why,
        evidence: evidence,
        timestamp: new Date().toISOString()
    };
    
    observations.push(observation);
    
    // Save to session storage
    sessionStorage.setItem('designThinking_observations', JSON.stringify(observations));
    
    // Update display
    updateObservationsDisplay();
    updateProgress();
    
    // Clear form
    clearObservationForm();
    
    // Save to backend
    saveObservationToBackend(observation);
    
    // Show success
    alert('Observation added successfully!');
}

function updateObservationsDisplay() {
    const container = document.getElementById('observations-collection');
    const list = document.getElementById('observations-list');
    const counter = document.getElementById('observation-count');
    
    if (observations.length > 0) {
        container.classList.remove('hidden');
        counter.textContent = observations.length;
        
        list.innerHTML = observations.map((obs, index) => `
            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                <div class="flex justify-between items-start mb-2">
                    <h5 class="font-semibold text-gray-900">Observation ${index + 1}</h5>
                    <button onclick="removeObservation(${index})" class="text-red-500 hover:text-red-700">
                        ‚úï
                    </button>
                </div>
                <p class="text-gray-700 mb-2"><strong>What:</strong> ${obs.what}</p>
                <p class="text-gray-700 mb-2"><strong>Emotion:</strong> ${obs.emotion}</p>
                <p class="text-gray-700 mb-2"><strong>Why:</strong> ${obs.why}</p>
                <p class="text-gray-600 text-sm"><strong>Evidence:</strong> ${obs.evidence}</p>
            </div>
        `).join('');
    }
}

function removeObservation(index) {
    observations.splice(index, 1);
    sessionStorage.setItem('designThinking_observations', JSON.stringify(observations));
    updateObservationsDisplay();
    updateProgress();
}

function updateProgress() {
    const count = observations.length;
    const percentage = Math.min((count / 5) * 100, 100);
    
    const progressText = document.getElementById('empathy-progress');
    const progressBar = document.getElementById('empathy-progress-bar');
    
    if (progressText) {
        progressText.textContent = `${count} of 5+ observations complete`;
    }
    
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        if (percentage >= 100) {
            progressBar.classList.remove('bg-blue-500');
            progressBar.classList.add('bg-green-500');
        }
    }
}

function clearObservationForm() {
    document.getElementById('observation-what').value = '';
    document.getElementById('observation-why').value = '';
    document.getElementById('observation-evidence').value = '';
    
    // Clear emotion selection
    document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));
    selectedEmotion = '';
    
    // Reset character counts
    ['what-count', 'why-count', 'evidence-count'].forEach(id => {
        const counter = document.getElementById(id);
        if (counter) counter.textContent = '0';
    });
    
    updateLivePreview();
    validateObservationForm();
}

function loadPersonaData() {
    const savedPersona = sessionStorage.getItem('designThinking_userPersona');
    if (savedPersona) {
        try {
            const persona = JSON.parse(savedPersona);
            const personaDisplay = document.getElementById('persona-details');
            if (personaDisplay) {
                personaDisplay.innerHTML = `
                    <strong>${persona.name}</strong> - ${persona.age} year old ${persona.role}<br>
                    <span class="text-sm">Focus area: ${persona.problemCategory}</span><br>
                    <span class="text-sm italic">${persona.description}</span>
                `;
            }
        } catch (e) {
            console.warn('Could not load persona data:', e);
        }
    }
}

function loadSavedObservations() {
    const savedObservations = sessionStorage.getItem('designThinking_observations');
    if (savedObservations) {
        try {
            observations = JSON.parse(savedObservations);
            updateObservationsDisplay();
            updateProgress();
        } catch (e) {
            console.warn('Could not load saved observations:', e);
        }
    }
}

function saveObservationToBackend(observation) {
    const sessionCode = document.querySelector('[data-session-code]')?.dataset.sessionCode;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    if (!sessionCode || !csrfToken) {
        console.warn('Missing session data for backend save');
        return;
    }
    
    const formData = new FormData();
    formData.append('submission_type', 'empathy_observation');
    formData.append('content', JSON.stringify(observation));
    formData.append('submitted_by', 'Team Member');
    
    fetch(`/learn/api/design-thinking/${sessionCode}/submit/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Observation saved successfully:', data);
            // Update progress tracking
            updateMissionProgress(data.empathy_observations_count, data.mission_completed, data.can_advance);
        } else {
            console.warn('Observation save failed:', data.error);
        }
    })
    .catch(error => console.warn('Observation save error:', error));
}

function updateMissionProgress(observationCount, isCompleted, canAdvance) {
    // Update progress display
    const progressText = document.getElementById('empathy-progress');
    const progressBar = document.getElementById('empathy-progress-bar');
    const completionNotification = document.getElementById('mission-completion-notification');
    const completionCount = document.getElementById('completion-count');
    
    if (progressText) {
        progressText.textContent = `${observationCount} of 5+ observations complete`;
    }
    
    // Update progress bar (max out at 100% when 5+ observations)
    if (progressBar) {
        const progressPercent = Math.min((observationCount / 5) * 100, 100);
        progressBar.style.width = `${progressPercent}%`;
        
        // Change color when complete
        if (observationCount >= 5) {
            progressBar.classList.remove('bg-blue-500');
            progressBar.classList.add('bg-green-500');
        }
    }
    
    // Show completion notification when mission is complete
    if (isCompleted && canAdvance && completionNotification) {
        completionNotification.classList.remove('hidden');
        if (completionCount) {
            completionCount.textContent = observationCount;
        }
    }
}

function proceedToDefinePhase() {
    // Navigate to next mission - Define phase
    const sessionCode = document.querySelector('[data-session-code]')?.dataset.sessionCode;
    if (sessionCode) {
        window.location.href = `/learn/design-thinking/${sessionCode}/play/?mission=define`;
    }
}

function continueObserving() {
    // Hide the completion notification and allow continued work
    const completionNotification = document.getElementById('mission-completion-notification');
    if (completionNotification) {
        completionNotification.classList.add('hidden');
    }
    
    // Optional: Add a subtle indicator that they can still add more
    alert('Feel free to add more observations to deepen your empathy research!');
}

// Check mission completion status on page load
function checkMissionStatus() {
    const sessionCode = document.querySelector('[data-session-code]')?.dataset.sessionCode;
    if (!sessionCode) return;
    
    // Check if team already has 5+ observations from backend
    fetch(`/learn/api/design-thinking/${sessionCode}/status/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.current_mission === 'empathy') {
                const observationCount = data.empathy_observations_count || 0;
                const isCompleted = data.mission_completed || false;
                const canAdvance = data.can_advance || false;
                
                // Update progress display
                updateMissionProgress(observationCount, isCompleted, canAdvance);
            }
        })
        .catch(error => console.warn('Could not check mission status:', error));
}

// Initialize mission status check when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSavedObservations();
    checkMissionStatus();
});

// Global function exports
window.clearObservationForm = clearObservationForm;
window.addObservation = addObservation;
window.removeObservation = removeObservation;
window.proceedToDefinePhase = proceedToDefinePhase;
window.continueObserving = continueObserving;
</script>