{% extends 'base.html' %}
{% load static %}

{% block title %}Join Design Thinking Session - DecipherWorld{% endblock %}

{% block extra_head %}
<style>
  /* Minimal CSS for gradient background only */
  main {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto py-8 px-4">
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">üéØ Join Design Thinking Challenge</h1>
    <p class="text-gray-600">Enter your session code to join an innovation session</p>
    <div class="mt-2">
      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
        üöÄ Auto-Progression Enabled
      </span>
    </div>
  </div>

  <!-- Instructions Card -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <div class="text-sm font-semibold text-blue-700 mb-2">üéØ How to Join the Innovation Challenge</div>
    <ol class="text-xs text-blue-700 pl-4 space-y-1">
      <li>Get the 6-digit session code from your teacher</li>
      <li>Enter it below and choose your team name</li>
      <li>Pick a fun emoji to represent your team</li>
      <li>Start the simplified Design Thinking challenge with auto-progression!</li>
    </ol>
  </div>

  <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
    <!-- Display Messages -->
    {% if messages %}
      {% for message in messages %}
        <div class="p-3 rounded-lg mb-4 text-sm {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}bg-red-100 border border-red-200 text-red-700{% else %}bg-green-100 border border-green-200 text-green-700{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- Session Joining Form -->
    <form method="post" id="join-form">
      {% csrf_token %}
      
      <div class="mb-6">
        <label for="session_code" class="block text-sm font-medium text-gray-700 mb-2">Session Code</label>
        <input type="text" 
               id="session_code" 
               name="session_code" 
               required
               maxlength="6"
               placeholder="ABC123"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-center text-xl font-semibold tracking-widest uppercase transition-all duration-200">
        <div class="text-xs text-gray-500 mt-1">Ask your teacher for the 6-digit code</div>
      </div>

      <div class="mb-6">
        <label for="team_name" class="block text-sm font-medium text-gray-700 mb-2">Team Name</label>
        <input type="text" 
               id="team_name" 
               name="team_name" 
               required
               maxlength="100"
               placeholder="The Problem Solvers"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200">
        <div class="text-xs text-gray-500 mt-1">Choose a creative name for your team</div>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Team Emoji</label>
        <input type="hidden" id="team_emoji" name="team_emoji" value="üí°">
        <div class="grid grid-cols-4 gap-2 mt-2">
          <div class="emoji-option p-3 border border-gray-300 rounded-lg bg-white hover:border-cyan-500 hover:bg-cyan-50 cursor-pointer transition-all duration-200 text-center text-xl border-cyan-500 bg-cyan-50" data-emoji="üí°">üí°</div>
          <div class="emoji-option p-3 border border-gray-300 rounded-lg bg-white hover:border-cyan-500 hover:bg-cyan-50 cursor-pointer transition-all duration-200 text-center text-xl" data-emoji="üöÄ">üöÄ</div>
          <div class="emoji-option p-3 border border-gray-300 rounded-lg bg-white hover:border-cyan-500 hover:bg-cyan-50 cursor-pointer transition-all duration-200 text-center text-xl" data-emoji="üéØ">üéØ</div>
          <div class="emoji-option p-3 border border-gray-300 rounded-lg bg-white hover:border-cyan-500 hover:bg-cyan-50 cursor-pointer transition-all duration-200 text-center text-xl" data-emoji="‚≠ê">‚≠ê</div>
          <div class="emoji-option p-3 border border-gray-300 rounded-lg bg-white hover:border-cyan-500 hover:bg-cyan-50 cursor-pointer transition-all duration-200 text-center text-xl" data-emoji="üî•">üî•</div>
          <div class="emoji-option p-3 border border-gray-300 rounded-lg bg-white hover:border-cyan-500 hover:bg-cyan-50 cursor-pointer transition-all duration-200 text-center text-xl" data-emoji="üåü">üåü</div>
          <div class="emoji-option p-3 border border-gray-300 rounded-lg bg-white hover:border-cyan-500 hover:bg-cyan-50 cursor-pointer transition-all duration-200 text-center text-xl" data-emoji="üèÜ">üèÜ</div>
          <div class="emoji-option p-3 border border-gray-300 rounded-lg bg-white hover:border-cyan-500 hover:bg-cyan-50 cursor-pointer transition-all duration-200 text-center text-xl" data-emoji="üíé">üíé</div>
        </div>
        <div class="text-xs text-gray-500 mt-1">Pick an emoji that represents your team spirit</div>
      </div>


      <!-- Action Buttons -->
      <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-cyan-600 text-white font-medium py-3 px-6 rounded-lg hover:from-cyan-600 hover:to-cyan-700 transition-all duration-200 mb-3" id="join-btn">
        üöÄ Join Session & Start Challenge
      </button>
      
      <a href="{% url 'group_learning:create_simplified_session' %}" class="block w-full text-center bg-gray-100 text-gray-700 font-medium py-3 px-6 rounded-lg hover:bg-gray-200 transition-all duration-200">
        ‚Üê Back to Start Page
      </a>
    </form>
  </div>
</div>

<script>
// Auto-uppercase session code input
document.getElementById('session_code').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});

// Emoji selection
document.querySelectorAll('.emoji-option').forEach(option => {
    option.addEventListener('click', function() {
        // Remove selected class from all options
        document.querySelectorAll('.emoji-option').forEach(opt => {
            opt.classList.remove('border-cyan-500', 'bg-cyan-50');
            opt.classList.add('border-gray-300', 'bg-white');
        });
        
        // Add selected class to clicked option
        this.classList.remove('border-gray-300', 'bg-white');
        this.classList.add('border-cyan-500', 'bg-cyan-50');
        
        // Update hidden input
        document.getElementById('team_emoji').value = this.dataset.emoji;
    });
});

// Form validation and AJAX submission
document.getElementById('join-form').addEventListener('submit', function(e) {
    e.preventDefault(); // Always prevent default form submission
    
    const sessionCode = document.getElementById('session_code').value.trim();
    const teamName = document.getElementById('team_name').value.trim();
    const button = document.getElementById('join-btn');
    
    // Clear any existing error messages
    clearErrorMessages();
    
    // Client-side validation with visual feedback
    if (!sessionCode) {
        showFieldError('session_code', 'Please enter a session code to continue.');
        return;
    }
    
    if (sessionCode.length !== 6) {
        showFieldError('session_code', 'Session code must be 6 characters long.');
        return;
    }
    
    if (!teamName) {
        showFieldError('team_name', 'Please enter a team name to continue.');
        return;
    }
    
    // Show loading state
    button.disabled = true;
    const originalText = button.textContent;
    button.innerHTML = '<span class="inline-flex items-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Joining Session...</span>';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('session_code', sessionCode);
    formData.append('team_name', teamName);
    formData.append('team_emoji', document.getElementById('team_emoji').value);
    
    // Submit via AJAX
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        // Reset button state
        button.disabled = false;
        button.textContent = originalText;
        
        if (response.redirected) {
            // Success - redirect to student dashboard
            window.location.href = response.url;
            return;
        }
        
        // Check if response is JSON (error response)
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json().then(data => {
                if (!data.success) {
                    // Show specific field error or general error
                    if (data.field) {
                        showFieldError(data.field, data.error);
                    } else {
                        showGeneralError(data.error);
                    }
                }
            });
        }
        
        // If not JSON and not redirected, there might be an unexpected error
        if (!response.ok) {
            showGeneralError('An unexpected error occurred. Please try again.');
        }
    })
    .catch(error => {
        // Reset button state
        button.disabled = false;
        button.textContent = originalText;
        
        console.error('Error:', error);
        showGeneralError('Unable to connect to the server. Please check your internet connection and try again.');
    });
});

// Helper functions for error display
function clearErrorMessages() {
    // Remove any existing error messages
    document.querySelectorAll('.error-message').forEach(el => el.remove());
    document.querySelectorAll('.border-red-500').forEach(el => {
        el.classList.remove('border-red-500');
        el.classList.add('border-gray-300');
    });
}

function showFieldError(fieldName, message) {
    const field = document.getElementById(fieldName);
    if (field) {
        // Add red border to field
        field.classList.remove('border-gray-300');
        field.classList.add('border-red-500');
        
        // Create error message element
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message text-red-600 text-sm mt-1';
        errorDiv.textContent = message;
        
        // Insert after the field
        field.parentNode.insertBefore(errorDiv, field.nextSibling);
        
        // Focus the field
        field.focus();
    }
}

function showGeneralError(message) {
    // Create general error message at top of form
    const form = document.getElementById('join-form');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message p-3 rounded-lg mb-4 text-sm bg-red-100 border border-red-200 text-red-700';
    errorDiv.textContent = message;
    
    // Insert at beginning of form
    form.insertBefore(errorDiv, form.firstChild);
}

// Auto-focus session code input
document.getElementById('session_code').focus();
</script>
{% endblock %}