{% extends 'base.html' %}
{% load static %}

{% block title %}Join Design Thinking Session - DecipherWorld{% endblock %}

{% block extra_head %}
<style>
  /* Professional classroom-style background */
  main {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #fef3c7 100%) !important;
    position: relative;
    overflow: hidden;
  }

  main::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image:
      url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.4;
    pointer-events: none;
  }

  .join-card {
    position: relative;
    background: linear-gradient(180deg, #ffffff 0%, #fefefe 100%);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .join-card::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(180deg, #e5e7eb 0%, transparent 100%);
    opacity: 0.5;
  }

  .emoji-option {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .emoji-option:hover {
    transform: scale(1.1);
  }

  .form-input:focus {
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto py-8 px-4">
  <div class="text-center mb-8">
    <div class="inline-block p-4 bg-gradient-to-br from-blue-100 to-green-100 rounded-full mb-4">
      <span class="text-6xl">üéØ</span>
    </div>
    <h1 class="text-4xl font-bold text-gray-900 mb-3">Join Design Thinking Challenge</h1>
    <p class="text-lg text-gray-600">Enter your session code to join an innovation session</p>
    <div class="mt-3 flex items-center justify-center gap-2">
      <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-md">
        <span class="mr-2">üöÄ</span> Auto-Progression Enabled
      </span>
    </div>
  </div>

  <!-- Instructions Card -->
  <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-xl p-5 mb-6 shadow-sm">
    <div class="flex items-start gap-3">
      <span class="text-3xl flex-shrink-0">üìò</span>
      <div>
        <div class="text-base font-bold text-blue-900 mb-3">üéØ How to Join the Innovation Challenge</div>
        <ol class="text-sm text-blue-800 space-y-2">
          <li class="flex items-start gap-2">
            <span class="font-bold text-blue-600">1.</span>
            <span>Get the 6-digit session code from your teacher</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="font-bold text-blue-600">2.</span>
            <span>Enter it below and choose your team name</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="font-bold text-blue-600">3.</span>
            <span>Pick a fun emoji to represent your team</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="font-bold text-blue-600">4.</span>
            <span>Start the simplified Design Thinking challenge with auto-progression!</span>
          </li>
        </ol>
      </div>
    </div>
  </div>

  <div class="join-card rounded-xl border border-gray-200 p-8">
    <!-- Display Messages -->
    {% if messages %}
      {% for message in messages %}
        <div class="p-4 rounded-xl mb-4 text-sm border-2 flex items-start gap-3 {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}bg-red-50 border-red-200 text-red-800{% else %}bg-green-50 border-green-200 text-green-800{% endif %} shadow-sm">
          <span class="text-xl">{% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}‚ö†Ô∏è{% else %}‚úÖ{% endif %}</span>
          <p class="flex-1">{{ message }}</p>
        </div>
      {% endfor %}
    {% endif %}

    <!-- Session Joining Form -->
    <form method="post" id="join-form">
      {% csrf_token %}
      
      <div class="mb-6">
        <label for="session_code" class="block text-base font-semibold text-gray-800 mb-2 flex items-center gap-2">
          <span>üîë</span> Session Code
        </label>
        <input type="text"
               id="session_code"
               name="session_code"
               required
               maxlength="6"
               placeholder="ABC123"
               class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-center text-2xl font-bold tracking-widest uppercase transition-all duration-200 bg-gray-50">
        <div class="text-xs text-gray-600 mt-2 flex items-center gap-1">
          <span>üí¨</span> Ask your teacher for the 6-digit code
        </div>
      </div>

      <div class="mb-6">
        <label for="team_name" class="block text-base font-semibold text-gray-800 mb-2 flex items-center gap-2">
          <span>üë•</span> Team Name
        </label>
        <input type="text"
               id="team_name"
               name="team_name"
               required
               maxlength="100"
               placeholder="The Problem Solvers"
               class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all duration-200 text-lg">
        <div class="text-xs text-gray-600 mt-2 flex items-center gap-1">
          <span>‚ú®</span> Choose a creative name for your team
        </div>
      </div>

      <div class="mb-6">
        <label class="block text-base font-semibold text-gray-800 mb-2 flex items-center gap-2">
          <span>üé®</span> Team Emoji
        </label>
        <input type="hidden" id="team_emoji" name="team_emoji" value="üí°">
        <div class="grid grid-cols-4 gap-3 mt-2">
          <div class="emoji-option p-4 border-2 border-gray-300 rounded-xl bg-white hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md cursor-pointer transition-all duration-200 text-center text-2xl border-cyan-500 bg-cyan-50 shadow-md" data-emoji="üí°">üí°</div>
          <div class="emoji-option p-4 border-2 border-gray-300 rounded-xl bg-white hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md cursor-pointer transition-all duration-200 text-center text-2xl" data-emoji="üöÄ">üöÄ</div>
          <div class="emoji-option p-4 border-2 border-gray-300 rounded-xl bg-white hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md cursor-pointer transition-all duration-200 text-center text-2xl" data-emoji="üéØ">üéØ</div>
          <div class="emoji-option p-4 border-2 border-gray-300 rounded-xl bg-white hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md cursor-pointer transition-all duration-200 text-center text-2xl" data-emoji="‚≠ê">‚≠ê</div>
          <div class="emoji-option p-4 border-2 border-gray-300 rounded-xl bg-white hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md cursor-pointer transition-all duration-200 text-center text-2xl" data-emoji="üî•">üî•</div>
          <div class="emoji-option p-4 border-2 border-gray-300 rounded-xl bg-white hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md cursor-pointer transition-all duration-200 text-center text-2xl" data-emoji="üåü">üåü</div>
          <div class="emoji-option p-4 border-2 border-gray-300 rounded-xl bg-white hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md cursor-pointer transition-all duration-200 text-center text-2xl" data-emoji="üèÜ">üèÜ</div>
          <div class="emoji-option p-4 border-2 border-gray-300 rounded-xl bg-white hover:border-cyan-500 hover:bg-cyan-50 hover:shadow-md cursor-pointer transition-all duration-200 text-center text-2xl" data-emoji="üíé">üíé</div>
        </div>
        <div class="text-xs text-gray-600 mt-2 flex items-center gap-1">
          <span>üé≠</span> Pick an emoji that represents your team spirit
        </div>
      </div>


      <!-- Action Buttons -->
      <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold text-lg py-4 px-6 rounded-xl hover:from-cyan-600 hover:to-blue-700 transition-all duration-200 mb-3 shadow-lg hover:shadow-xl transform hover:scale-[1.02]" id="join-btn">
        üöÄ Join Session & Start Challenge
      </button>

      <a href="{% url 'group_learning:create_simplified_session' %}" class="block w-full text-center bg-gray-100 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-200 transition-all duration-200">
        <span class="mr-2">‚Üê</span> Back to Start Page
      </a>
    </form>
  </div>
</div>

<script>
// Auto-uppercase session code input
document.getElementById('session_code').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});

// Emoji selection
document.querySelectorAll('.emoji-option').forEach(option => {
    option.addEventListener('click', function() {
        // Remove selected class from all options
        document.querySelectorAll('.emoji-option').forEach(opt => {
            opt.classList.remove('border-cyan-500', 'bg-cyan-50');
            opt.classList.add('border-gray-300', 'bg-white');
        });
        
        // Add selected class to clicked option
        this.classList.remove('border-gray-300', 'bg-white');
        this.classList.add('border-cyan-500', 'bg-cyan-50');
        
        // Update hidden input
        document.getElementById('team_emoji').value = this.dataset.emoji;
    });
});

// Form validation and AJAX submission
document.getElementById('join-form').addEventListener('submit', function(e) {
    e.preventDefault(); // Always prevent default form submission
    
    const sessionCode = document.getElementById('session_code').value.trim();
    const teamName = document.getElementById('team_name').value.trim();
    const button = document.getElementById('join-btn');
    
    // Clear any existing error messages
    clearErrorMessages();
    
    // Client-side validation with visual feedback
    if (!sessionCode) {
        showFieldError('session_code', 'Please enter a session code to continue.');
        return;
    }
    
    if (sessionCode.length !== 6) {
        showFieldError('session_code', 'Session code must be 6 characters long.');
        return;
    }
    
    if (!teamName) {
        showFieldError('team_name', 'Please enter a team name to continue.');
        return;
    }
    
    // Show loading state
    button.disabled = true;
    const originalText = button.textContent;
    button.innerHTML = '<span class="inline-flex items-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Joining Session...</span>';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('session_code', sessionCode);
    formData.append('team_name', teamName);
    formData.append('team_emoji', document.getElementById('team_emoji').value);
    
    // Submit via AJAX
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        // Reset button state
        button.disabled = false;
        button.textContent = originalText;
        
        if (response.redirected) {
            // Success - redirect to student dashboard
            window.location.href = response.url;
            return;
        }
        
        // Check if response is JSON (error response)
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json().then(data => {
                if (!data.success) {
                    // Show specific field error or general error
                    if (data.field) {
                        showFieldError(data.field, data.error);
                    } else {
                        showGeneralError(data.error);
                    }
                }
            });
        }
        
        // If not JSON and not redirected, there might be an unexpected error
        if (!response.ok) {
            showGeneralError('An unexpected error occurred. Please try again.');
        }
    })
    .catch(error => {
        // Reset button state
        button.disabled = false;
        button.textContent = originalText;
        
        console.error('Error:', error);
        showGeneralError('Unable to connect to the server. Please check your internet connection and try again.');
    });
});

// Helper functions for error display
function clearErrorMessages() {
    // Remove any existing error messages
    document.querySelectorAll('.error-message').forEach(el => el.remove());
    document.querySelectorAll('.border-red-500').forEach(el => {
        el.classList.remove('border-red-500');
        el.classList.add('border-gray-300');
    });
}

function showFieldError(fieldName, message) {
    const field = document.getElementById(fieldName);
    if (field) {
        // Add red border to field
        field.classList.remove('border-gray-300');
        field.classList.add('border-red-500');
        
        // Create error message element
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message text-red-600 text-sm mt-1';
        errorDiv.textContent = message;
        
        // Insert after the field
        field.parentNode.insertBefore(errorDiv, field.nextSibling);
        
        // Focus the field
        field.focus();
    }
}

function showGeneralError(message) {
    // Create general error message at top of form
    const form = document.getElementById('join-form');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message p-3 rounded-lg mb-4 text-sm bg-red-100 border border-red-200 text-red-700';
    errorDiv.textContent = message;
    
    // Insert at beginning of form
    form.insertBefore(errorDiv, form.firstChild);
}

// Auto-focus session code input
document.getElementById('session_code').focus();
</script>
{% endblock %}