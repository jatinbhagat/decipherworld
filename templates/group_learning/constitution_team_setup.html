{% extends 'group_learning/base.html' %}

{% block title %}Create Your Team - Build Your Country{% endblock %}

{% block description %}Create or join a team to start the Constitution Challenge. Build your country by making governance decisions together.{% endblock %}

{% block keywords %}constitution game, team creation, governance education, collaborative learning{% endblock %}

{% block nav_items %}
    <a href="{% url 'group_learning:session_detail' session.session_code %}" class="text-gray-600 hover:text-gray-900">← Session {{ session.session_code }}</a>
    <div class="text-sm text-gray-600">{{ team_count }} team{{ team_count|pluralize }} playing</div>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg shadow-xl p-8 mb-8 text-center">
        <div class="text-6xl mb-4">🏛️</div>
        <h1 class="text-4xl font-bold mb-4">Build Your Country</h1>
        <h2 class="text-2xl text-blue-100 mb-4">The Constitution Challenge</h2>
        <p class="text-blue-200 max-w-2xl mx-auto">
            Create your team and build a virtual country by answering questions about governance, 
            leadership, and citizen rights. Watch your country evolve based on your constitutional choices!
        </p>
        <div class="mt-6 text-sm text-blue-200">
            Session: {{ session.session_code }} • {{ session.game.title }}
        </div>
    </div>
    
    <div class="grid md:grid-cols-2 gap-8">
        
        <!-- Create New Team -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">🆕</div>
                <h3 class="text-2xl font-bold text-gray-800">Create New Team</h3>
                <p class="text-gray-600 mt-2">Start fresh and build your country from the ground up!</p>
            </div>
            
            <form id="create-team-form" class="space-y-6">
                {% csrf_token %}
                
                <!-- Team Name -->
                <div>
                    <label for="team_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Country Name *
                    </label>
                    <input type="text" id="team_name" name="team_name" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                           placeholder="e.g., United Republic, New Democracy, Freedom Land"
                           maxlength="100">
                    <p class="text-xs text-gray-500 mt-1">Choose a name that represents your ideal country</p>
                </div>
                
                <!-- Team Avatar -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Country Symbol
                    </label>
                    <div class="grid grid-cols-6 gap-3">
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="🏛️">🏛️</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="🏰">🏰</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="🌟">🌟</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="⚖️">⚖️</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="🦅">🦅</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="🌍">🌍</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="🗽">🗽</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="👑">👑</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="🎯">🎯</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="💎">💎</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="🔱">🔱</button>
                        <button type="button" class="avatar-option p-3 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-avatar="⭐">⭐</button>
                    </div>
                    <input type="hidden" id="team_avatar" name="team_avatar" value="🏛️">
                </div>
                
                <!-- Country Color -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Country Color Theme
                    </label>
                    <div class="grid grid-cols-6 gap-3">
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #3B82F6;" data-color="#3B82F6"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #10B981;" data-color="#10B981"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #F59E0B;" data-color="#F59E0B"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #EF4444;" data-color="#EF4444"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #8B5CF6;" data-color="#8B5CF6"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #EC4899;" data-color="#EC4899"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #06B6D4;" data-color="#06B6D4"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #84CC16;" data-color="#84CC16"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #F97316;" data-color="#F97316"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #6366F1;" data-color="#6366F1"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #14B8A6;" data-color="#14B8A6"></button>
                        <button type="button" class="color-option w-10 h-10 rounded-full border-2 border-gray-300 hover:border-gray-600 transition-colors"
                                style="background-color: #64748B;" data-color="#64748B"></button>
                    </div>
                    <input type="hidden" id="country_color" name="country_color" value="#3B82F6">
                </div>
                
                <!-- Flag Emoji -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Country Flag
                    </label>
                    <div class="grid grid-cols-8 gap-3">
                        <button type="button" class="flag-option p-2 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-flag="🏴">🏴</button>
                        <button type="button" class="flag-option p-2 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-flag="🏳️">🏳️</button>
                        <button type="button" class="flag-option p-2 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-flag="🎌">🎌</button>
                        <button type="button" class="flag-option p-2 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-flag="🏁">🏁</button>
                        <button type="button" class="flag-option p-2 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-flag="🚩">🚩</button>
                        <button type="button" class="flag-option p-2 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-flag="🏴‍☠️">🏴‍☠️</button>
                        <button type="button" class="flag-option p-2 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-flag="🏳️‍🌈">🏳️‍🌈</button>
                        <button type="button" class="flag-option p-2 text-2xl border border-gray-300 rounded-md hover:border-blue-500 hover:bg-blue-50 transition-colors"
                                data-flag="⛳">⛳</button>
                    </div>
                    <input type="hidden" id="flag_emoji" name="flag_emoji" value="🏴">
                </div>
                
                <!-- Preview -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-medium text-gray-700 mb-2">Preview:</h4>
                    <div class="flex items-center">
                        <span id="preview-avatar" class="text-2xl mr-3">🏛️</span>
                        <span id="preview-flag" class="text-2xl mr-3">🏴</span>
                        <span id="preview-name" class="font-bold" style="color: #3B82F6;">Your Country Name</span>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-md font-bold text-lg hover:bg-blue-700 transition-colors">
                    🚀 Create Team & Start Playing
                </button>
            </form>
        </div>
        
        <!-- Join Existing Team -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">👥</div>
                <h3 class="text-2xl font-bold text-gray-800">Existing Teams</h3>
                <p class="text-gray-600 mt-2">Join an existing team or view their progress</p>
            </div>
            
            {% if existing_teams %}
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    {% for team in existing_teams %}
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">{{ team.team_avatar }}</span>
                                    <span class="text-xl mr-3">{{ team.flag_emoji }}</span>
                                    <div>
                                        <div class="font-bold text-lg" style="color: {{ team.country_color }}">
                                            {{ team.team_name }}
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            {{ team.get_governance_level.emoji }} {{ team.get_governance_level.description }}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-lg" style="color: {{ team.country_color }}">
                                        {{ team.total_score }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ team.questions_completed }} questions
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3 flex space-x-2">
                                <a href="{% url 'group_learning:constitution_game' session.session_code %}?team_id={{ team.id }}"
                                   class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-md text-center text-sm hover:bg-gray-700 transition-colors">
                                    👁️ View Progress
                                </a>
                                {% if not team.is_completed %}
                                    <a href="{% url 'group_learning:constitution_game' session.session_code %}?team_id={{ team.id }}"
                                       class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md text-center text-sm hover:bg-green-700 transition-colors">
                                        ▶️ Join Game
                                    </a>
                                {% else %}
                                    <span class="flex-1 bg-gray-300 text-gray-600 py-2 px-4 rounded-md text-center text-sm">
                                        ✅ Completed
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="refreshTeamList()" class="text-blue-600 hover:text-blue-800 text-sm">
                        🔄 Refresh Team List
                    </button>
                </div>
            {% else %}
                <div class="text-center py-8">
                    <div class="text-4xl text-gray-300 mb-4">👻</div>
                    <p class="text-gray-500">No teams have been created yet.</p>
                    <p class="text-gray-400 text-sm mt-2">Be the first to start building a country!</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Game Instructions -->
    <div class="mt-8 bg-white rounded-lg shadow-lg p-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">🎯 How to Play</h3>
        <div class="grid md:grid-cols-3 gap-6 text-center">
            <div>
                <div class="text-4xl mb-3">❓</div>
                <h4 class="font-bold text-lg text-gray-800 mb-2">Answer Questions</h4>
                <p class="text-gray-600 text-sm">Make decisions about governance, leadership, and citizen rights for your country.</p>
            </div>
            <div>
                <div class="text-4xl mb-3">📊</div>
                <h4 class="font-bold text-lg text-gray-800 mb-2">Build Your Country</h4>
                <p class="text-gray-600 text-sm">Watch your country evolve based on your choices. Unlock buildings and features!</p>
            </div>
            <div>
                <div class="text-4xl mb-3">🏆</div>
                <h4 class="font-bold text-lg text-gray-800 mb-2">Compete & Learn</h4>
                <p class="text-gray-600 text-sm">Compare with other teams on the leaderboard while learning about democracy.</p>
            </div>
        </div>
    </div>
</div>

<script>
// Handle avatar selection
document.querySelectorAll('.avatar-option').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove selected class from all
        document.querySelectorAll('.avatar-option').forEach(b => {
            b.classList.remove('border-blue-500', 'bg-blue-100');
            b.classList.add('border-gray-300');
        });
        
        // Add selected class
        this.classList.remove('border-gray-300');
        this.classList.add('border-blue-500', 'bg-blue-100');
        
        // Update hidden input and preview
        const avatar = this.dataset.avatar;
        document.getElementById('team_avatar').value = avatar;
        document.getElementById('preview-avatar').textContent = avatar;
    });
});

// Handle color selection
document.querySelectorAll('.color-option').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove selected class from all
        document.querySelectorAll('.color-option').forEach(b => {
            b.classList.remove('border-gray-600');
            b.classList.add('border-gray-300');
        });
        
        // Add selected class
        this.classList.remove('border-gray-300');
        this.classList.add('border-gray-600');
        
        // Update hidden input and preview
        const color = this.dataset.color;
        document.getElementById('country_color').value = color;
        document.getElementById('preview-name').style.color = color;
    });
});

// Handle flag selection
document.querySelectorAll('.flag-option').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove selected class from all
        document.querySelectorAll('.flag-option').forEach(b => {
            b.classList.remove('border-blue-500', 'bg-blue-100');
            b.classList.add('border-gray-300');
        });
        
        // Add selected class
        this.classList.remove('border-gray-300');
        this.classList.add('border-blue-500', 'bg-blue-100');
        
        // Update hidden input and preview
        const flag = this.dataset.flag;
        document.getElementById('flag_emoji').value = flag;
        document.getElementById('preview-flag').textContent = flag;
    });
});

// Update preview when typing team name
document.getElementById('team_name').addEventListener('input', function() {
    const name = this.value || 'Your Country Name';
    document.getElementById('preview-name').textContent = name;
});

// Initialize first options as selected
document.querySelector('.avatar-option[data-avatar="🏛️"]').click();
document.querySelector('.color-option[data-color="#3B82F6"]').click();
document.querySelector('.flag-option[data-flag="🏴"]').click();

// Handle form submission
document.getElementById('create-team-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    
    // Show loading state
    submitButton.textContent = '⏳ Creating Team...';
    submitButton.disabled = true;
    
    const formData = new FormData(this);
    
    fetch(`{% url 'group_learning:constitution_create_team' session.session_code %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to game
            window.location.href = data.redirect_url;
        } else {
            alert('Error: ' + data.error);
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error creating team:', error);
        alert('Failed to create team. Please try again.');
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    });
});

// Refresh team list function
function refreshTeamList() {
    location.reload();
}
</script>

{% include 'core/csrf_token.html' %}
{% endblock %}