{% extends 'base.html' %}
{% load group_learning_extras %}

{% block title %}{{ team.team_name|default:"Constitution Challenge" }} - Build Your Country{% endblock %}

{% block description %}Build your country by answering constitution questions about governance, leadership, and citizen rights. Collaborative team-based learning game.{% endblock %}

{% block keywords %}constitution game, governance education, civics learning, team building, democracy, citizenship, educational games{% endblock %}

{% block nav_items %}
    <a href="{% url 'group_learning:session_detail' session.session_code %}" class="text-gray-600 hover:text-gray-900">‚Üê Session {{ session.session_code }}</a>
    {% if team %}
        <div class="flex items-center">
            <span class="mr-2">{{ team.flag_emoji }}</span>
            <span class="font-medium">{{ team.team_name }}</span>
            <span class="ml-2 text-sm text-gray-600">Score: {{ team.total_score }}</span>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Full-screen immersive game container -->
<div class="constitution-game h-screen overflow-hidden" 
     data-session-code="{{ session.session_code }}" 
     data-team-id="{{ team.id|default:'' }}" 
     data-csrf="{{ csrf_token }}">

    {% if not team %}
        <!-- Team Setup Required -->
        <div class="flex items-center justify-center h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
            <div class="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md mx-4">
                <div class="text-6xl mb-4 animate-bounce">üèõÔ∏è</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Team Setup Required</h2>
                <p class="text-gray-600 mb-6">You need to join or create a team to start building your constitutional democracy.</p>
                <a href="{% url 'group_learning:constitution_join' session.session_code %}" 
                   class="inline-block bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 font-medium">
                    Join Team ‚Üí
                </a>
            </div>
        </div>
    {% else %}
        <!-- Main Game Interface -->
        <div class="relative h-screen bg-gradient-to-b from-blue-400 via-blue-200 to-green-100 overflow-hidden" id="main-game">
            
            <!-- Floating Top Bar -->
            <div class="absolute top-0 left-0 right-0 z-40">
                <div class="flex items-center justify-between p-4">
                    <!-- Team Info & Progress -->
                    <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-2xl px-4 py-2 shadow-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">{{ team.flag_emoji }}</span>
                            <div class="text-lg font-bold text-blue-600">{{ team.total_score }}</div>
                            <div class="text-sm text-gray-600">{{ team.questions_completed|add:1 }}/{{ session.game.constitution_questions.count }}</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex items-center space-x-2">
                        <!-- Leaderboard Button (ONLY ONE) -->
                        <button onclick="toggleLeaderboard()" 
                                class="bg-white bg-opacity-90 backdrop-blur-sm rounded-2xl px-4 py-2 shadow-lg hover:bg-opacity-100 transition-all duration-200 transform hover:scale-105"
                                title="View Leaderboard">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="hidden lg:inline text-sm font-medium text-gray-700">Leaderboard</span>
                            </div>
                        </button>
                        
                        <!-- Help Button -->
                        <button onclick="toggleHelp()" 
                                class="bg-white bg-opacity-90 backdrop-blur-sm rounded-2xl px-3 py-2 shadow-lg hover:bg-opacity-100 transition-all duration-200 transform hover:scale-105"
                                title="Help">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- City Background (Simplified Inline) -->
            <div class="absolute inset-0 overflow-hidden">
                <!-- Sky with Clouds -->
                <div class="absolute inset-0 bg-gradient-to-b from-blue-400 via-blue-200 to-blue-50"></div>
                <div class="absolute top-8 left-20 w-16 h-8 bg-white rounded-full opacity-70 animate-pulse"></div>
                <div class="absolute top-16 right-32 w-12 h-6 bg-white rounded-full opacity-60 animate-pulse"></div>
                
                <!-- Ground -->
                <div class="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-green-500 via-green-400 to-green-300"></div>
                
                <!-- Buildings -->
                <div class="absolute bottom-32 left-8 w-18 h-24 bg-gradient-to-t from-orange-600 to-orange-400 rounded-t-lg shadow-lg">
                    <div class="absolute top-2 left-1 w-3 h-3 bg-yellow-300 rounded animate-pulse"></div>
                    <div class="absolute top-2 right-1 w-3 h-3 bg-yellow-300 rounded animate-pulse"></div>
                </div>
                
                <!-- Capitol Building -->
                <div class="absolute bottom-32 right-12 w-32 h-36 bg-gradient-to-t from-gray-100 to-white rounded-t-lg shadow-2xl border-2 border-gray-300">
                    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 w-16 h-12 bg-gradient-to-t from-yellow-500 to-yellow-300 rounded-full border-2 border-yellow-600"></div>
                    <div class="text-lg text-center text-gray-800 font-bold pt-20">üèõÔ∏è</div>
                    <div class="text-xs text-center text-gray-600 font-semibold">CAPITOL</div>
                </div>
                
                <!-- Country Status Panel -->
                <div class="absolute top-4 left-4 bg-white bg-opacity-95 rounded-xl p-4 shadow-xl backdrop-blur-sm border border-blue-200">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl animate-pulse">{{ team.flag_emoji|default:"üè¥" }}</div>
                        <div>
                            <div class="font-bold text-gray-800 text-lg">{{ team.team_data.country_name|default:"New Republic" }}</div>
                            <div class="text-blue-600 text-sm font-medium">üèóÔ∏è Building your constitutional democracy...</div>
                            <div class="text-xs text-gray-500 mt-1">Population: {{ team.total_score|mul:100|default:"2000" }} citizens</div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Indicator -->
                <div class="absolute top-4 right-4 bg-white bg-opacity-95 rounded-xl p-3 shadow-lg">
                    <div class="text-xs text-gray-600 mb-1">Nation Progress</div>
                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-green-400 to-blue-500 rounded-full animate-pulse" style="width: {{ team.total_score|mul:10 }}%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Question Section (Component) -->
            <div class="absolute inset-x-2 lg:inset-x-8 bottom-4 lg:bottom-8 top-16 lg:top-20 flex items-start justify-center pt-4">
                <div class="w-full max-w-4xl max-h-[calc(100vh-8rem)] lg:max-h-[calc(100vh-6rem)]">
                    <div id="question-card" class="bg-white bg-opacity-95 backdrop-blur-lg rounded-2xl shadow-2xl border border-white border-opacity-20 overflow-hidden overflow-y-auto transform transition-all duration-500 hover:scale-[1.02] max-h-full">
                        {% include 'group_learning/question_section.html' %}
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard Panel (Component) -->
            {% include 'group_learning/leaderboard_panel.html' %}
            
            <!-- Help Modal -->
            <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">How to Play</h3>
                            <button onclick="toggleHelp()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-600 space-y-3">
                            <p>üèõÔ∏è <strong>Build Your Democracy:</strong> Answer questions about constitutional principles to shape your virtual country.</p>
                            <p>üìà <strong>Earn Points:</strong> Each decision affects your governance scores and population growth.</p>
                            <p>üè° <strong>Watch Your City Grow:</strong> Your choices are reflected in the city visualization.</p>
                            <p>üéì <strong>Learn & Improve:</strong> Educational modules will help you understand constitutional concepts.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Learning Module Modal (Inline) -->
            <div id="learning-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
                <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-y-auto transform transition-transform duration-300 scale-95" id="learning-modal-container">
                    <!-- Header -->
                    <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-white bg-opacity-20 rounded-full p-2">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold" id="learning-modal-title">Constitutional Insight</h3>
                            </div>
                            <button onclick="closeLearningModule()" 
                                    class="text-white text-opacity-80 hover:text-opacity-100 transition-colors p-2 rounded-full hover:bg-white hover:bg-opacity-20"
                                    title="Close (or press ESC)">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6" id="learning-modal-content">
                        <!-- Loading state -->
                        <div id="learning-loading" class="animate-pulse space-y-4">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                            <div class="h-20 bg-gray-200 rounded"></div>
                        </div>
                        
                        <!-- Main content -->
                        <div id="learning-content" class="hidden space-y-6">
                            <div id="principle-section">
                                <div class="flex items-center mb-3">
                                    <div class="bg-blue-100 rounded-full p-2 mr-3">
                                        <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800">Understanding the Principle</h4>
                                </div>
                                <div id="principle-explanation" class="prose prose-blue max-w-none text-gray-700 leading-relaxed"></div>
                            </div>
                            
                            <div id="takeaways-section">
                                <div class="flex items-center mb-3">
                                    <div class="bg-green-100 rounded-full p-2 mr-3">
                                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800">Key Takeaways</h4>
                                </div>
                                <div id="key-takeaways" class="bg-green-50 rounded-lg p-4"></div>
                            </div>
                            
                            <div id="historical-section" class="hidden">
                                <div class="flex items-center mb-3">
                                    <div class="bg-amber-100 rounded-full p-2 mr-3">
                                        <svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800">Historical Context</h4>
                                </div>
                                <div id="historical-context" class="bg-amber-50 rounded-lg p-4 text-gray-700"></div>
                            </div>
                            
                            <div id="example-section" class="hidden">
                                <div class="flex items-center mb-3">
                                    <div class="bg-purple-100 rounded-full p-2 mr-3">
                                        <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800">Real-World Example</h4>
                                </div>
                                <div id="real-world-example" class="bg-purple-50 rounded-lg p-4 text-gray-700"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="border-t bg-gray-50 px-6 py-4 rounded-b-2xl">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600" id="learning-module-info">
                                Constitutional Learning Module
                            </div>
                            <div class="flex items-center space-x-3">
                                <button id="skip-learning-btn" 
                                        onclick="skipLearningModule()" 
                                        class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors">
                                    Skip
                                </button>
                                <button onclick="closeLearningModule()" 
                                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                    Continue Game
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    {% endif %}
</div>

<!-- Notification System -->
<div id="notification-container" class="fixed top-20 right-4 z-50 space-y-2"></div>

{% endblock %}

{% block styles %}
<style>
/* Game-specific styles */
.constitution-game {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

/* Animations */
@keyframes float-slow {
    0%, 100% { transform: translateY(0px) translateX(0px); }
    33% { transform: translateY(-10px) translateX(5px); }
    66% { transform: translateY(5px) translateX(-3px); }
}

@keyframes float-medium {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

.animate-float-slow { animation: float-slow 8s ease-in-out infinite; }
.animate-float-medium { animation: float-medium 6s ease-in-out infinite; }

/* Button styles */
.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    transition: all 0.2s ease;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.35);
}

/* Interactive elements */
.interactive-answer-btn {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.interactive-answer-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

/* Loading animations */
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .5; }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .constitution-game .hidden\lg\:inline {
        display: none;
    }
}
</style>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/constitution_challenge.js' %}"></script>
<script>
// Inline JavaScript for immediate functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('üèõÔ∏è Constitution Challenge - Hybrid Template Loaded');
    
    // Initialize game if JS file not loaded
    if (typeof initializeConstitutionChallenge !== 'function') {
        console.warn('Main JS file not loaded, using inline fallback');
        window.selectAnswer = selectAnswer;
        window.toggleLeaderboard = toggleLeaderboard;
        window.toggleHelp = toggleHelp;
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') {
            if (event.key.toLowerCase() === 'l') {
                event.preventDefault();
                toggleLeaderboard();
            } else if (event.key.toLowerCase() === 'h') {
                event.preventDefault();
                toggleHelp();
            }
        }
    });
});

// Essential functions (fallback if main JS fails)
function toggleHelp() {
    const modal = document.getElementById('help-modal');
    modal.classList.toggle('hidden');
}

function selectAnswer(optionId, optionLetter) {
    // Handled by main JS file or inline implementation
    if (typeof window.selectAnswer === 'function') {
        return window.selectAnswer(optionId, optionLetter);
    }
    console.log('Selecting answer:', optionId, optionLetter);
}
</script>
{% endblock %}