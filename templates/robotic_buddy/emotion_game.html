{% extends 'robotic_buddy/base.html' %}

{% block game_title %}Emotion Recognition Training{% endblock %}

{% block game_content %}
<div class="max-w-6xl mx-auto">
    <!-- Game Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">
            üòä Emotion Recognition Training
        </h1>
        <p class="text-lg text-gray-600 mb-4">
            Teach your AI buddy to understand human emotions and feelings!
        </p>
        
        <!-- Game Progress -->
        <div class="game-card bg-white p-4 max-w-md mx-auto">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Training Progress</span>
                <span class="text-sm text-gray-600"><span id="examples-count">0</span> / 8 examples</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="bg-gradient-to-r from-pink-400 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <!-- Game Instructions -->
    <div class="game-card bg-gradient-to-r from-pink-100 to-purple-100 p-6 mb-8">
        <div class="flex items-start space-x-4">
            <div class="w-16 h-16 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center text-white text-xl">
                ü§ñ
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-gray-800 mb-2">Your AI Buddy Says:</h3>
                <p id="buddy-instruction" class="text-gray-700">
                    Hi! I want to learn about human emotions! Read each scenario and help me understand what emotion the person is feeling.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Training Interface -->
    <div class="grid lg:grid-cols-4 gap-6">
        <!-- Emotion Options -->
        <div class="lg:col-span-1">
            <div class="game-card bg-white p-4 sticky top-32">
                <h3 class="font-semibold text-gray-800 mb-4 text-center">üòä Emotions</h3>
                <div id="emotion-pool" class="space-y-3 min-h-[300px]">
                    <div class="draggable-item bg-yellow-50 border-2 border-yellow-200 rounded-lg p-3 text-center cursor-grab hover:bg-yellow-100 transition-colors shadow-sm" draggable="true" data-item="happy" data-emotion="happy">
                        <div class="text-3xl mb-1">üòä</div>
                        <div class="text-sm font-medium text-gray-800">Happy</div>
                    </div>
                    <div class="draggable-item bg-blue-50 border-2 border-blue-200 rounded-lg p-3 text-center cursor-grab hover:bg-blue-100 transition-colors shadow-sm" draggable="true" data-item="sad" data-emotion="sad">
                        <div class="text-3xl mb-1">üò¢</div>
                        <div class="text-sm font-medium text-gray-800">Sad</div>
                    </div>
                    <div class="draggable-item bg-red-50 border-2 border-red-200 rounded-lg p-3 text-center cursor-grab hover:bg-red-100 transition-colors shadow-sm" draggable="true" data-item="angry" data-emotion="angry">
                        <div class="text-3xl mb-1">üò†</div>
                        <div class="text-sm font-medium text-gray-800">Angry</div>
                    </div>
                    <div class="draggable-item bg-orange-50 border-2 border-orange-200 rounded-lg p-3 text-center cursor-grab hover:bg-orange-100 transition-colors shadow-sm" draggable="true" data-item="surprised" data-emotion="surprised">
                        <div class="text-3xl mb-1">üòÆ</div>
                        <div class="text-sm font-medium text-gray-800">Surprised</div>
                    </div>
                    <div class="draggable-item bg-purple-50 border-2 border-purple-200 rounded-lg p-3 text-center cursor-grab hover:bg-purple-100 transition-colors shadow-sm" draggable="true" data-item="scared" data-emotion="scared">
                        <div class="text-3xl mb-1">üò®</div>
                        <div class="text-sm font-medium text-gray-800">Scared</div>
                    </div>
                    <div class="draggable-item bg-gray-50 border-2 border-gray-200 rounded-lg p-3 text-center cursor-grab hover:bg-gray-100 transition-colors shadow-sm" draggable="true" data-item="neutral" data-emotion="neutral">
                        <div class="text-3xl mb-1">üòê</div>
                        <div class="text-sm font-medium text-gray-800">Neutral</div>
                    </div>
                </div>
                <button id="new-scenario-btn" class="btn btn-sm btn-outline btn-primary w-full mt-4">
                    Get New Scenario
                </button>
            </div>
        </div>
        
        <!-- Current Scenario -->
        <div class="lg:col-span-3">
            <div class="grid gap-6 mb-6">
                <!-- Scenario Card -->
                <div class="game-card bg-white p-6">
                    <div class="text-center mb-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìñ Emotion Scenario</h3>
                    </div>
                    <div class="drop-zone min-h-[150px] border-3 border-dashed border-gray-300 rounded-lg p-6 text-center" 
                         id="scenario-zone">
                        <div id="scenario-content" class="mb-4">
                            <div class="text-gray-400 text-sm">Loading scenario...</div>
                        </div>
                        <div class="text-gray-400 text-sm">Drag the emotion that matches this scenario here</div>
                    </div>
                    <div id="scenario-result" class="mt-3 text-center">
                        <!-- Results will appear here -->
                    </div>
                </div>
            </div>
            
            <!-- Buddy Response Area -->
            <div id="buddy-response" class="game-card bg-white p-6 mb-6" style="display: none;">
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white text-xl">
                        ü§ñ
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-purple-800 mb-2">Your AI Buddy Says:</h4>
                        <p id="buddy-message" class="text-purple-700"></p>
                    </div>
                </div>
            </div>
            
            <!-- AI Emotion Brain Visualization -->
            <div id="ai-visualization" class="game-card bg-gradient-to-r from-purple-50 to-pink-50 p-6 mb-6 border-2 border-purple-200 transition-all duration-500" style="display: none;">
                <div class="text-center mb-4">
                    <h3 class="text-xl font-bold text-purple-800 mb-2">üß† Inside My Emotion Brain</h3>
                    <p class="text-sm text-purple-600 font-medium">Watch how I learn to understand emotions!</p>
                    <div class="mt-2 animate-pulse text-xs text-purple-500">‚ú® Real emotion learning happening here! ‚ú®</div>
                </div>
                
                <!-- Emotion Memory Palace -->
                <div class="mb-6">
                    <h4 class="font-bold text-purple-700 mb-3 text-center">üè∞ My Emotion Memory Palace:</h4>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <div class="bg-gradient-to-b from-yellow-100 to-yellow-50 p-2 rounded-lg text-center border-2 border-yellow-200 shadow-sm">
                            <div class="text-xl mb-1">üòä</div>
                            <div class="font-bold text-yellow-800">Happy</div>
                            <div id="happy-memory" class="text-yellow-600 mt-1 font-medium">Empty</div>
                        </div>
                        <div class="bg-gradient-to-b from-blue-100 to-blue-50 p-2 rounded-lg text-center border-2 border-blue-200 shadow-sm">
                            <div class="text-xl mb-1">üò¢</div>
                            <div class="font-bold text-blue-800">Sad</div>
                            <div id="sad-memory" class="text-blue-600 mt-1 font-medium">Empty</div>
                        </div>
                        <div class="bg-gradient-to-b from-red-100 to-red-50 p-2 rounded-lg text-center border-2 border-red-200 shadow-sm">
                            <div class="text-xl mb-1">üò†</div>
                            <div class="font-bold text-red-800">Angry</div>
                            <div id="angry-memory" class="text-red-600 mt-1 font-medium">Empty</div>
                        </div>
                        <div class="bg-gradient-to-b from-orange-100 to-orange-50 p-2 rounded-lg text-center border-2 border-orange-200 shadow-sm">
                            <div class="text-xl mb-1">üòÆ</div>
                            <div class="font-bold text-orange-800">Surprised</div>
                            <div id="surprised-memory" class="text-orange-600 mt-1 font-medium">Empty</div>
                        </div>
                        <div class="bg-gradient-to-b from-purple-100 to-purple-50 p-2 rounded-lg text-center border-2 border-purple-200 shadow-sm">
                            <div class="text-xl mb-1">üò®</div>
                            <div class="font-bold text-purple-800">Scared</div>
                            <div id="scared-memory" class="text-purple-600 mt-1 font-medium">Empty</div>
                        </div>
                        <div class="bg-gradient-to-b from-gray-100 to-gray-50 p-2 rounded-lg text-center border-2 border-gray-200 shadow-sm">
                            <div class="text-xl mb-1">üòê</div>
                            <div class="font-bold text-gray-800">Neutral</div>
                            <div id="neutral-memory" class="text-gray-600 mt-1 font-medium">Empty</div>
                        </div>
                    </div>
                </div>
                
                <!-- Emotion Confidence Thermometer -->
                <div class="mb-6">
                    <h4 class="font-bold text-purple-700 mb-3 text-center">üå°Ô∏è My Emotion Confidence:</h4>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <span class="w-16 text-xs text-gray-600">Happy:</span>
                            <div class="flex-1 mx-2 bg-gray-200 rounded-full h-2">
                                <div id="happy-confidence" class="bg-yellow-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <span id="happy-percent" class="text-xs text-gray-600">0%</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-16 text-xs text-gray-600">Sad:</span>
                            <div class="flex-1 mx-2 bg-gray-200 rounded-full h-2">
                                <div id="sad-confidence" class="bg-blue-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <span id="sad-percent" class="text-xs text-gray-600">0%</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-16 text-xs text-gray-600">Angry:</span>
                            <div class="flex-1 mx-2 bg-gray-200 rounded-full h-2">
                                <div id="angry-confidence" class="bg-red-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <span id="angry-percent" class="text-xs text-gray-600">0%</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-16 text-xs text-gray-600">Surprised:</span>
                            <div class="flex-1 mx-2 bg-gray-200 rounded-full h-2">
                                <div id="surprised-confidence" class="bg-orange-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <span id="surprised-percent" class="text-xs text-gray-600">0%</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-16 text-xs text-gray-600">Scared:</span>
                            <div class="flex-1 mx-2 bg-gray-200 rounded-full h-2">
                                <div id="scared-confidence" class="bg-purple-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <span id="scared-percent" class="text-xs text-gray-600">0%</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-16 text-xs text-gray-600">Neutral:</span>
                            <div class="flex-1 mx-2 bg-gray-200 rounded-full h-2">
                                <div id="neutral-confidence" class="bg-gray-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <span id="neutral-percent" class="text-xs text-gray-600">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Learning Insights -->
                <div class="mt-4 p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
                    <h5 class="font-bold text-orange-700 text-xs mb-1">üí° Did You Know?</h5>
                    <p class="text-xs text-orange-600">
                        I learn emotions by understanding the context and situation! Each scenario you teach me helps me recognize similar emotional patterns in the future.
                    </p>
                </div>
            </div>
            
            <!-- Game Actions -->
            <div class="text-center">
                <button id="test-buddy-btn" class="btn btn-primary btn-lg mr-3" style="display: none;">
                    üß† Test My Emotion Understanding!
                </button>
                <button id="complete-session-btn" class="btn btn-success btn-lg" style="display: none;">
                    üéâ Complete Emotion Training
                </button>
            </div>
        </div>
    </div>
    
    <!-- Phase 2: Camera Integration Section -->
    <div class="mt-12 game-card bg-gradient-to-br from-blue-50 to-purple-50 p-8" id="camera-section">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-3">üìπ Live Emotion Recognition</h2>
            <p class="text-gray-600">Use your camera to practice real emotion recognition with your AI buddy!</p>
        </div>
        
        <!-- Camera Mode Toggle -->
        <div class="flex justify-center mb-6">
            <div class="btn-group">
                <button id="scenario-mode-btn" class="btn btn-primary">üìñ Scenario Mode</button>
                <button id="camera-mode-btn" class="btn btn-outline btn-primary">üìπ Camera Mode</button>
            </div>
        </div>
        
        <!-- Camera Training Interface -->
        <div id="camera-interface" class="hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Camera Feed -->
                <div class="space-y-4">
                    <div class="bg-white rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Camera Feed</h3>
                        <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="aspect-ratio: 4/3;">
                            <video id="emotion-camera" class="w-full h-full object-cover" autoplay muted></video>
                            <canvas id="emotion-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                            
                            <!-- Camera Controls -->
                            <div class="absolute bottom-4 left-4 right-4 flex justify-center space-x-2">
                                <button id="start-camera-btn" class="btn btn-sm btn-primary">
                                    üì∑ Start Camera
                                </button>
                                <button id="stop-camera-btn" class="btn btn-sm btn-secondary hidden">
                                    ‚èπÔ∏è Stop Camera
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Camera Instructions -->
                    <div class="bg-white rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">üìã Instructions</h4>
                        <div id="camera-instructions" class="text-sm text-gray-600">
                            <p>1. Click "Start Camera" to begin</p>
                            <p>2. Make facial expressions for different emotions</p>
                            <p>3. Watch as your AI buddy learns to recognize your emotions!</p>
                        </div>
                    </div>
                </div>
                
                <!-- Emotion Detection Results -->
                <div class="space-y-4">
                    <div class="bg-white rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Live Emotion Detection</h3>
                        <div id="camera-emotion-results" class="space-y-2">
                            <div class="text-center text-gray-500 py-8">
                                Start camera to see emotion detection results
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buddy Camera Feedback -->
                    <div class="bg-white rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">ü§ñ Buddy's Analysis</h3>
                        <div id="buddy-camera-feedback" class="text-gray-600">
                            I'm ready to learn from your expressions! Start the camera and show me different emotions.
                        </div>
                    </div>
                    
                    <!-- Emotion Practice Game -->
                    <div id="emotion-practice-game" class="bg-white rounded-lg p-4 hidden">
                        <h3 class="font-semibold text-gray-800 mb-3">üé≠ Emotion Challenge</h3>
                        <div class="text-center">
                            <div id="emotion-challenge" class="text-2xl mb-3">üòä</div>
                            <p id="challenge-text" class="text-gray-700 mb-3">Show me a happy expression!</p>
                            <div class="flex justify-center space-x-2">
                                <button id="next-challenge-btn" class="btn btn-sm btn-primary">Next Challenge</button>
                                <button id="end-practice-btn" class="btn btn-sm btn-secondary">End Practice</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Face-API.js for emotion detection -->
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/dist/face-api.min.js"></script>

<script>
// Enhanced Emotion Learning System
let emotionGameState = {
    currentScenarioIndex: 0,
    examplesGiven: 0,
    maxExamples: 8,
    correctPredictions: 0,
    totalPredictions: 0,
    
    // Emotion learning data
    emotionData: {
        happy: { correct: 0, total: 0, examples: [] },
        sad: { correct: 0, total: 0, examples: [] },
        angry: { correct: 0, total: 0, examples: [] },
        surprised: { correct: 0, total: 0, examples: [] },
        scared: { correct: 0, total: 0, examples: [] },
        neutral: { correct: 0, total: 0, examples: [] }
    },
    
    // Emotion scenarios for training
    scenarios: [
        { text: "Sarah just found out she won first place in the science fair! She's jumping up and down.", emotion: "happy" },
        { text: "Tom's favorite pet dog passed away yesterday. He's been sitting quietly in his room.", emotion: "sad" },
        { text: "Lisa's little brother broke her favorite toy on purpose. Her face is red and her fists are clenched.", emotion: "angry" },
        { text: "Mike opened his locker and found a surprise birthday cake from his friends!", emotion: "surprised" },
        { text: "Emma heard a loud thunder during the storm and quickly hid under her blanket.", emotion: "scared" },
        { text: "Alex is sitting calmly, reading a book while waiting for the bus.", emotion: "neutral" },
        { text: "When Jenny saw her report card with all A's, she couldn't stop smiling!", emotion: "happy" },
        { text: "David looked down when he realized he forgot his lunch money at home.", emotion: "sad" },
        { text: "When someone cut in line in front of Maria, she crossed her arms and frowned.", emotion: "angry" },
        { text: "Ben's eyes went wide when he saw snow falling for the first time!", emotion: "surprised" },
        { text: "Amy heard footsteps behind her in the dark hallway and started walking faster.", emotion: "scared" },
        { text: "James sat quietly during the meeting, listening to what everyone had to say.", emotion: "neutral" }
    ],
    
    usedScenarios: []
};

function showBuddyMessage(message, isCorrect = true) {
    const responseDiv = document.getElementById('buddy-response');
    const messageEl = document.getElementById('buddy-message');
    
    messageEl.textContent = message;
    responseDiv.style.display = 'block';
    
    if (isCorrect) {
        responseDiv.className = 'game-card bg-gradient-to-r from-green-100 to-blue-100 p-6 mb-6';
    } else {
        responseDiv.className = 'game-card bg-gradient-to-r from-orange-100 to-red-100 p-6 mb-6';
    }
    
    setTimeout(() => {
        responseDiv.style.display = 'none';
    }, 4000);
}

function updateBuddyMessage(message) {
    document.getElementById('buddy-instruction').textContent = message;
}

function updateProgress() {
    const progress = (emotionGameState.examplesGiven / emotionGameState.maxExamples) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    document.getElementById('examples-count').textContent = emotionGameState.examplesGiven;
    
    // Show test button after 3 examples
    if (emotionGameState.examplesGiven >= 3) {
        document.getElementById('test-buddy-btn').style.display = 'inline-block';
    }
    
    // Show complete button after max examples
    if (emotionGameState.examplesGiven >= emotionGameState.maxExamples) {
        document.getElementById('complete-session-btn').style.display = 'inline-block';
        document.getElementById('new-scenario-btn').style.display = 'none';
        updateBuddyMessage("Wow! I think I understand emotions much better now! You can test my knowledge or complete our training!");
    }
}

function loadNewScenario() {
    // Get unused scenarios
    const availableScenarios = emotionGameState.scenarios.filter(scenario => 
        !emotionGameState.usedScenarios.includes(scenario.text)
    );
    
    if (availableScenarios.length === 0) {
        // Reset if we've used all scenarios
        emotionGameState.usedScenarios = [];
    }
    
    const currentScenario = availableScenarios.length > 0 ? 
        availableScenarios[Math.floor(Math.random() * availableScenarios.length)] :
        emotionGameState.scenarios[Math.floor(Math.random() * emotionGameState.scenarios.length)];
    
    emotionGameState.currentScenario = currentScenario;
    emotionGameState.usedScenarios.push(currentScenario.text);
    
    // Display the scenario
    const scenarioContent = document.getElementById('scenario-content');
    scenarioContent.innerHTML = `
        <div class="text-lg font-medium text-gray-800 mb-2">üìñ Read this scenario:</div>
        <div class="text-gray-700 italic bg-gray-50 p-4 rounded-lg">"${currentScenario.text}"</div>
        <div class="text-sm text-gray-600 mt-3">What emotion is this person feeling?</div>
    `;
    
    updateBuddyMessage(`Here's a new scenario! Read it carefully and drag the emotion that best matches what the person is feeling.`);
}

function recordEmotionExample(emotion, correctEmotion, wasCorrect) {
    // Update emotion data
    emotionGameState.emotionData[correctEmotion].total++;
    if (wasCorrect) {
        emotionGameState.emotionData[correctEmotion].correct++;
    }
    
    // Store example
    const example = {
        scenario: emotionGameState.currentScenario.text,
        correct: wasCorrect,
        guessed: emotion
    };
    emotionGameState.emotionData[correctEmotion].examples.push(example);
    
    // Limit examples stored
    if (emotionGameState.emotionData[correctEmotion].examples.length > 2) {
        emotionGameState.emotionData[correctEmotion].examples.shift();
    }
}

function updateEmotionVisualization() {
    // Update Memory Palace
    ['happy', 'sad', 'angry', 'surprised', 'scared', 'neutral'].forEach(emotion => {
        const memoryEl = document.getElementById(emotion + '-memory');
        const examples = emotionGameState.emotionData[emotion].examples;
        
        if (examples.length === 0) {
            memoryEl.textContent = 'Empty';
        } else {
            const recent = examples.slice(-1).map(ex => 
                ex.correct ? '‚úì' : '‚úó'
            ).join(' ');
            memoryEl.textContent = recent + ` (${examples.length})`;
        }
        
        // Update confidence levels
        const data = emotionGameState.emotionData[emotion];
        const confidence = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
        
        document.getElementById(emotion + '-confidence').style.width = confidence + '%';
        document.getElementById(emotion + '-percent').textContent = confidence + '%';
    });
}

// Set up drag and drop
function setupEmotionDropZone() {
    const dropZone = document.getElementById('scenario-zone');
    
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('border-purple-400', 'bg-purple-50');
    });
    
    dropZone.addEventListener('dragleave', function() {
        this.classList.remove('border-purple-400', 'bg-purple-50');
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('border-purple-400', 'bg-purple-50');
        
        const draggedEmotion = e.dataTransfer.getData('text/plain');
        const correctEmotion = emotionGameState.currentScenario.emotion;
        const isCorrect = draggedEmotion === correctEmotion;
        
        // Show result
        const resultEl = document.getElementById('scenario-result');
        const emotionEmojis = {
            happy: 'üòä', sad: 'üò¢', angry: 'üò†', 
            surprised: 'üòÆ', scared: 'üò®', neutral: 'üòê'
        };
        
        resultEl.innerHTML = `
            <div class="p-4 rounded-lg ${isCorrect ? 'bg-green-100 border border-green-300' : 'bg-orange-100 border border-orange-300'}">
                <div class="text-2xl mb-2">${emotionEmojis[draggedEmotion]}</div>
                <div class="font-medium ${isCorrect ? 'text-green-800' : 'text-orange-800'}">
                    You chose: ${draggedEmotion.charAt(0).toUpperCase() + draggedEmotion.slice(1)}
                </div>
                ${!isCorrect ? `<div class="text-sm text-orange-600 mt-1">Correct answer: ${correctEmotion.charAt(0).toUpperCase() + correctEmotion.slice(1)} ${emotionEmojis[correctEmotion]}</div>` : ''}
            </div>
        `;
        
        // Record the example
        recordEmotionExample(draggedEmotion, correctEmotion, isCorrect);
        
        // Show feedback
        if (isCorrect) {
            showBuddyMessage(`Perfect! That person is indeed feeling ${correctEmotion}! I'm learning to understand emotions better! üåü`);
        } else {
            showBuddyMessage(`I see! That person is actually feeling ${correctEmotion}, not ${draggedEmotion}. Thank you for teaching me the difference! ü§î`, false);
        }
        
        emotionGameState.examplesGiven++;
        updateProgress();
        updateEmotionVisualization();
        
        // Show AI brain after 2 examples
        if (emotionGameState.examplesGiven >= 2) {
            document.getElementById('ai-visualization').style.display = 'block';
        }
        
        // Load new scenario after delay
        setTimeout(() => {
            if (emotionGameState.examplesGiven < emotionGameState.maxExamples) {
                loadNewScenario();
                resultEl.innerHTML = '';
            }
        }, 3000);
    });
}

// Set up drag items
function setupDragItems() {
    document.querySelectorAll('.draggable-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
            console.log('Drag started for:', this.dataset.item);
            this.classList.add('opacity-50');
            e.dataTransfer.setData('text/plain', this.dataset.emotion);
            e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', function() {
            this.classList.remove('opacity-50');
        });
    });
}

// Test buddy function
function testBuddyEmotionKnowledge() {
    const testScenario = emotionGameState.scenarios[Math.floor(Math.random() * emotionGameState.scenarios.length)];
    const correctEmotion = testScenario.emotion;
    
    // Use actual learning data to determine accuracy
    const emotionAccuracy = emotionGameState.emotionData[correctEmotion].total > 0 ? 
        emotionGameState.emotionData[correctEmotion].correct / emotionGameState.emotionData[correctEmotion].total : 0.33;
    
    const isCorrect = Math.random() < emotionAccuracy;
    
    let prediction, reasoning;
    if (isCorrect) {
        prediction = correctEmotion;
        reasoning = `I remember learning about situations like this - they usually involve ${correctEmotion} feelings!`;
    } else {
        const wrongEmotions = ['happy', 'sad', 'angry', 'surprised', 'scared', 'neutral'].filter(e => e !== correctEmotion);
        prediction = wrongEmotions[Math.floor(Math.random() * wrongEmotions.length)];
        reasoning = `This situation reminds me of ${prediction} examples I've seen before.`;
    }
    
    const confidence = Math.round(emotionAccuracy * 100);
    
    setTimeout(() => {
        showBuddyMessage(
            `Let me test my emotion understanding! In this situation: "${testScenario.text}" - I think the person feels ${prediction}. I'm ${confidence}% confident! ${isCorrect ? 'Did I get it right? üéâ' : 'Was I correct? ü§î'}`,
            isCorrect
        );
    }, 1000);
    
    if (isCorrect) {
        emotionGameState.correctPredictions++;
    }
    emotionGameState.totalPredictions++;
}

// Initialize game
document.addEventListener('DOMContentLoaded', function() {
    setupEmotionDropZone();
    setupDragItems();
    loadNewScenario();
    
    // Event listeners
    document.getElementById('new-scenario-btn').addEventListener('click', loadNewScenario);
    document.getElementById('test-buddy-btn').addEventListener('click', testBuddyEmotionKnowledge);
    
    document.getElementById('complete-session-btn').addEventListener('click', function() {
        const overallAccuracy = emotionGameState.totalPredictions > 0 ? 
            Math.round((emotionGameState.correctPredictions / emotionGameState.totalPredictions) * 100) : 0;
            
        showBuddyMessage(
            `Amazing emotion training! You taught me ${emotionGameState.examplesGiven} emotional scenarios and I achieved ${overallAccuracy}% accuracy on my tests! Now I understand human feelings much better! üéìüíù`
        );
        
        setTimeout(() => {
            alert('üéâ Congratulations! Your AI buddy now understands emotions better and can recognize feelings in different situations!');
            window.location.href = '{% url "robotic_buddy:activities" %}';
        }, 4000);
    });
    
    // Camera Mode Toggle Event Listeners
    document.getElementById('scenario-mode-btn').addEventListener('click', function() {
        document.getElementById('camera-interface').classList.add('hidden');
        this.classList.remove('btn-outline');
        this.classList.add('btn-primary');
        document.getElementById('camera-mode-btn').classList.add('btn-outline');
        document.getElementById('camera-mode-btn').classList.remove('btn-primary');
        stopCameraStream();
    });
    
    document.getElementById('camera-mode-btn').addEventListener('click', function() {
        document.getElementById('camera-interface').classList.remove('hidden');
        this.classList.remove('btn-outline');
        this.classList.add('btn-primary');
        document.getElementById('scenario-mode-btn').classList.add('btn-outline');
        document.getElementById('scenario-mode-btn').classList.remove('btn-primary');
    });
    
    // Camera functionality event listeners
    document.getElementById('start-camera-btn').addEventListener('click', startCamera);
    document.getElementById('stop-camera-btn').addEventListener('click', stopCameraStream);
    document.getElementById('next-challenge-btn').addEventListener('click', startEmotionChallenge);
    document.getElementById('end-practice-btn').addEventListener('click', endEmotionPractice);
});

// Camera and Face-API functionality
let videoStream = null;
let isModelLoaded = false;
let emotionDetectionInterval = null;
let currentChallenge = null;

// Emotion challenges for the practice game
const emotionChallenges = [
    { emotion: 'happy', text: 'Show me a happy expression! üòä', emoji: 'üòä' },
    { emotion: 'sad', text: 'Show me a sad expression! üò¢', emoji: 'üò¢' },
    { emotion: 'angry', text: 'Show me an angry expression! üò†', emoji: 'üò†' },
    { emotion: 'surprised', text: 'Show me a surprised expression! üòÆ', emoji: 'üòÆ' },
    { emotion: 'neutral', text: 'Show me a neutral expression! üòê', emoji: 'üòê' }
];

async function loadFaceApiModels() {
    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/model';
    
    try {
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
        isModelLoaded = true;
        console.log('Face-API models loaded successfully');
        
        document.getElementById('buddy-camera-feedback').textContent = 
            "Great! I've loaded my emotion recognition models. Start the camera and I'll analyze your expressions!";
            
    } catch (error) {
        console.error('Error loading Face-API models:', error);
        document.getElementById('buddy-camera-feedback').textContent = 
            "I had trouble loading my emotion recognition models. The camera feature might not work perfectly, but you can still try!";
    }
}

async function startCamera() {
    try {
        // Load models if not already loaded
        if (!isModelLoaded) {
            document.getElementById('buddy-camera-feedback').textContent = "Loading emotion recognition models...";
            await loadFaceApiModels();
        }
        
        const video = document.getElementById('emotion-camera');
        const constraints = {
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            }
        };
        
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = videoStream;
        
        // Update UI
        document.getElementById('start-camera-btn').classList.add('hidden');
        document.getElementById('stop-camera-btn').classList.remove('hidden');
        
        // Start emotion detection
        video.addEventListener('loadeddata', () => {
            startEmotionDetection();
            document.getElementById('emotion-practice-game').classList.remove('hidden');
            startEmotionChallenge();
        });
        
        document.getElementById('buddy-camera-feedback').textContent = 
            "Camera started! I'm now analyzing your facial expressions in real-time. Try making different faces!";
            
    } catch (error) {
        console.error('Camera access error:', error);
        alert('Unable to access camera. Please make sure you have granted camera permissions.');
        document.getElementById('buddy-camera-feedback').textContent = 
            "I couldn't access your camera. Please check your browser permissions and try again.";
    }
}

async function startEmotionDetection() {
    const video = document.getElementById('emotion-camera');
    const canvas = document.getElementById('emotion-canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size to match video
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    
    emotionDetectionInterval = setInterval(async () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA && isModelLoaded) {
            try {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceExpressions();
                
                // Clear previous drawings
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (detections.length > 0) {
                    const detection = detections[0];
                    const expressions = detection.expressions;
                    
                    // Draw face detection box
                    const box = detection.detection.box;
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);
                    
                    // Update emotion results
                    updateEmotionResults(expressions);
                    
                    // Check challenge completion
                    if (currentChallenge) {
                        checkChallengeCompletion(expressions);
                    }
                } else {
                    // No face detected
                    document.getElementById('camera-emotion-results').innerHTML = 
                        '<div class="text-center text-gray-500 py-4">No face detected - make sure you\'re in view!</div>';
                }
            } catch (error) {
                console.error('Emotion detection error:', error);
            }
        }
    }, 100); // Check 10 times per second
}

function updateEmotionResults(expressions) {
    const emotionMapping = {
        happy: 'happy',
        sad: 'sad',
        angry: 'angry',
        surprised: 'surprised',
        neutral: 'neutral',
        fearful: 'scared'
    };
    
    // Convert to our emotion format and sort by confidence
    const emotions = Object.keys(expressions)
        .map(emotion => ({
            name: emotionMapping[emotion] || emotion,
            confidence: Math.round(expressions[emotion] * 100),
            original: emotion
        }))
        .filter(emotion => emotion.name) // Only include mapped emotions
        .sort((a, b) => b.confidence - a.confidence);
    
    const topEmotion = emotions[0];
    const emotionEmojis = {
        happy: 'üòä', sad: 'üò¢', angry: 'üò†', 
        surprised: 'üòÆ', scared: 'üò®', neutral: 'üòê'
    };
    
    // Update results display
    const resultsHTML = emotions.map((emotion, index) => `
        <div class="flex items-center justify-between p-2 rounded ${index === 0 ? 'bg-blue-50' : 'bg-gray-50'}">
            <div class="flex items-center space-x-2">
                <span class="text-lg">${emotionEmojis[emotion.name] || 'üòä'}</span>
                <span class="font-medium text-gray-800">${emotion.name.charAt(0).toUpperCase() + emotion.name.slice(1)}</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${emotion.confidence}%"></div>
                </div>
                <span class="text-sm font-mono text-gray-600">${emotion.confidence}%</span>
            </div>
        </div>
    `).join('');
    
    document.getElementById('camera-emotion-results').innerHTML = resultsHTML;
    
    // Update buddy feedback
    if (topEmotion && topEmotion.confidence > 30) {
        document.getElementById('buddy-camera-feedback').textContent = 
            `I see you're feeling ${topEmotion.name}! I'm ${topEmotion.confidence}% confident about this. ${emotionEmojis[topEmotion.name]} Your expression helps me learn!`;
    }
}

function startEmotionChallenge() {
    if (emotionChallenges.length === 0) return;
    
    currentChallenge = emotionChallenges[Math.floor(Math.random() * emotionChallenges.length)];
    
    document.getElementById('emotion-challenge').textContent = currentChallenge.emoji;
    document.getElementById('challenge-text').textContent = currentChallenge.text;
    
    document.getElementById('buddy-camera-feedback').textContent = 
        `Challenge time! ${currentChallenge.text} I'll watch and see if I can recognize it!`;
}

function checkChallengeCompletion(expressions) {
    if (!currentChallenge) return;
    
    const emotionMapping = {
        happy: 'happy',
        sad: 'sad', 
        angry: 'angry',
        surprised: 'surprised',
        neutral: 'neutral',
        fearful: 'scared'
    };
    
    const targetEmotion = currentChallenge.emotion;
    let detectedConfidence = 0;
    
    // Find the confidence for our target emotion
    Object.keys(expressions).forEach(emotion => {
        if (emotionMapping[emotion] === targetEmotion) {
            detectedConfidence = expressions[emotion];
        }
    });
    
    // Check if confidence is high enough (threshold: 0.6)
    if (detectedConfidence > 0.6) {
        document.getElementById('buddy-camera-feedback').textContent = 
            `Perfect! I detected ${targetEmotion} with ${Math.round(detectedConfidence * 100)}% confidence! You're great at expressing emotions! üéâ`;
        
        // Auto-advance to next challenge after 2 seconds
        setTimeout(() => {
            startEmotionChallenge();
        }, 2000);
    }
}

function endEmotionPractice() {
    document.getElementById('emotion-practice-game').classList.add('hidden');
    currentChallenge = null;
    
    document.getElementById('buddy-camera-feedback').textContent = 
        "Great emotion practice session! I learned so much from watching your expressions. You can continue using the camera or go back to scenario training!";
}

function stopCameraStream() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    
    if (emotionDetectionInterval) {
        clearInterval(emotionDetectionInterval);
        emotionDetectionInterval = null;
    }
    
    // Reset UI
    document.getElementById('start-camera-btn').classList.remove('hidden');
    document.getElementById('stop-camera-btn').classList.add('hidden');
    document.getElementById('emotion-practice-game').classList.add('hidden');
    
    // Clear canvas and results
    const canvas = document.getElementById('emotion-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    document.getElementById('camera-emotion-results').innerHTML = 
        '<div class="text-center text-gray-500 py-8">Camera stopped</div>';
        
    document.getElementById('buddy-camera-feedback').textContent = 
        "Camera stopped. Thanks for the emotion training session!";
        
    currentChallenge = null;
}

// Load Face-API models when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Delay model loading to not interfere with main game
    setTimeout(() => {
        loadFaceApiModels();
    }, 1000);
});
</script>
{% endblock %}