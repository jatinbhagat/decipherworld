{% extends 'robotic_buddy/base.html' %}

{% block game_title %}Emotion Recognition Training{% endblock %}

{% block game_content %}
<div class="max-w-4xl mx-auto px-4">
    <!-- Compact Header with Status -->
    <div class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 border-b border-gray-100 -mx-4 px-4 py-3 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-500 rounded-full flex items-center justify-center text-white">
                    😊
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800">Emotion Training</h1>
                    <p class="text-xs text-gray-600 hidden sm:block">Match emotions to scenarios</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800">
                        <span id="examples-count">0</span>/16
                    </div>
                    <div class="text-xs text-gray-500">examples</div>
                </div>
                <div class="w-16 h-2 bg-gray-200 rounded-full">
                    <div id="progress-bar" class="bg-gradient-to-r from-pink-400 to-purple-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Game Interface -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <!-- Emotion Selection Section -->
        <div class="bg-gradient-to-br from-pink-50 to-purple-50 p-6 border-b border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800 text-sm">Choose Emotion</h3>
                <button id="new-scenario-btn" class="px-3 py-1 bg-purple-500 text-white rounded-md text-xs hover:bg-purple-600 transition-colors">
                    Next
                </button>
            </div>
            <div id="emotion-pool" class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-4">
                <div class="emotion-btn bg-yellow-50 border-2 border-yellow-200 rounded-lg p-3 text-center cursor-pointer hover:bg-yellow-100 transition-all duration-200 touch-manipulation hover:scale-105 active:scale-95" 
                     data-emotion="happy">
                    <div class="text-3xl sm:text-2xl mb-1">😊</div>
                    <div class="text-xs font-medium text-gray-800">Happy</div>
                </div>
                <div class="emotion-btn bg-blue-50 border-2 border-blue-200 rounded-lg p-3 text-center cursor-pointer hover:bg-blue-100 transition-all duration-200 touch-manipulation hover:scale-105 active:scale-95" 
                     data-emotion="sad">
                    <div class="text-3xl sm:text-2xl mb-1">😢</div>
                    <div class="text-xs font-medium text-gray-800">Sad</div>
                </div>
                <div class="emotion-btn bg-red-50 border-2 border-red-200 rounded-lg p-3 text-center cursor-pointer hover:bg-red-100 transition-all duration-200 touch-manipulation hover:scale-105 active:scale-95" 
                     data-emotion="angry">
                    <div class="text-3xl sm:text-2xl mb-1">😠</div>
                    <div class="text-xs font-medium text-gray-800">Angry</div>
                </div>
                <div class="emotion-btn bg-orange-50 border-2 border-orange-200 rounded-lg p-3 text-center cursor-pointer hover:bg-orange-100 transition-all duration-200 touch-manipulation hover:scale-105 active:scale-95" 
                     data-emotion="surprised">
                    <div class="text-3xl sm:text-2xl mb-1">😮</div>
                    <div class="text-xs font-medium text-gray-800">Surprised</div>
                </div>
                <div class="emotion-btn bg-purple-50 border-2 border-purple-200 rounded-lg p-3 text-center cursor-pointer hover:bg-purple-100 transition-all duration-200 touch-manipulation hover:scale-105 active:scale-95" 
                     data-emotion="scared">
                    <div class="text-3xl sm:text-2xl mb-1">😨</div>
                    <div class="text-xs font-medium text-gray-800">Scared</div>
                </div>
                <div class="emotion-btn bg-gray-50 border-2 border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:bg-gray-100 transition-all duration-200 touch-manipulation hover:scale-105 active:scale-95" 
                     data-emotion="neutral">
                    <div class="text-3xl sm:text-2xl mb-1">😐</div>
                    <div class="text-xs font-medium text-gray-800">Neutral</div>
                </div>
            </div>
            <div class="text-center text-xs text-gray-600 mt-3">
                <span class="md:hidden">👆 Tap emotion, then tap scenario below</span>
                <span class="hidden md:inline">🖱️ Click emotion, then click scenario</span>
            </div>
        </div>
        
        <!-- Scenario Section -->
        <div class="p-6">
            <div class="text-center mb-4">
                <h3 class="font-semibold text-gray-800 text-sm">Scenario</h3>
            </div>
            <div id="scenario-zone" class="min-h-[140px] border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-purple-400 hover:bg-purple-50 transition-colors duration-200 touch-manipulation">
                <div id="scenario-content" class="mb-3">
                    <div class="text-gray-400 text-sm">Loading scenario...</div>
                </div>
                <div class="text-gray-400 text-xs">
                    <span class="md:hidden">👆 Tap after selecting emotion above</span>
                    <span class="hidden md:inline">🖱️ Click after selecting emotion</span>
                </div>
            </div>
            <div id="scenario-result" class="mt-3 text-center">
                <!-- Results will appear here -->
            </div>
        </div>
    </div>
    
    <!-- Compact Response & Actions -->
    <div class="mt-4 space-y-3">
        <!-- Buddy Response (Compact) -->
        <div id="buddy-response" class="bg-gradient-to-r from-pink-100 to-purple-100 rounded-lg p-3 text-center" style="display: none;">
            <p id="buddy-message" class="text-sm text-gray-700 font-medium"></p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center space-x-3">
            <button id="complete-btn" class="px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg shadow-md hover:shadow-lg transition-all text-sm font-medium" style="display: none;">
                🎉 Complete Training
            </button>
        </div>
    </div>
</div>

<script>
// Emotion Game State
let emotionGameState = {
    currentScenarioIndex: 0,
    examplesGiven: 0,
    maxExamples: 16,
    selectedEmotion: null,
    currentScenario: null,
    scenarios: [
        { text: "Sarah just found out she won first place in the science fair! She's jumping up and down.", emotion: "happy" },
        { text: "Tom's favorite pet dog passed away yesterday. He's been sitting quietly in his room.", emotion: "sad" },
        { text: "Lisa's little brother broke her favorite toy on purpose. Her face is red and her fists are clenched.", emotion: "angry" },
        { text: "Mike opened his locker and found a surprise birthday cake from his friends!", emotion: "surprised" },
        { text: "Emma heard a loud thunder during the storm and quickly hid under her blanket.", emotion: "scared" },
        { text: "Alex is sitting calmly, reading a book while waiting for the bus.", emotion: "neutral" },
        { text: "When Jenny saw her report card with all A's, she couldn't stop smiling!", emotion: "happy" },
        { text: "David looked down when he realized he forgot his lunch money at home.", emotion: "sad" },
        { text: "When someone cut in line in front of Maria, she crossed her arms and frowned.", emotion: "angry" },
        { text: "Ben's eyes went wide when he saw snow falling for the first time!", emotion: "surprised" },
        { text: "Amy heard footsteps behind her in the dark hallway and started walking faster.", emotion: "scared" },
        { text: "James sat quietly during the meeting, listening to what everyone had to say.", emotion: "neutral" }
    ],
    usedScenarios: [],
    emotionData: {
        happy: { correct: 0, total: 0 },
        sad: { correct: 0, total: 0 },
        angry: { correct: 0, total: 0 },
        surprised: { correct: 0, total: 0 },
        scared: { correct: 0, total: 0 },
        neutral: { correct: 0, total: 0 }
    }
};

function showBuddyMessage(message, isCorrect = true) {
    const responseDiv = document.getElementById('buddy-response');
    const messageEl = document.getElementById('buddy-message');
    
    messageEl.textContent = message;
    responseDiv.style.display = 'block';
    
    if (isCorrect) {
        responseDiv.className = 'bg-gradient-to-r from-pink-100 to-purple-100 rounded-lg p-3 text-center';
    } else {
        responseDiv.className = 'bg-gradient-to-r from-orange-100 to-red-100 rounded-lg p-3 text-center';
    }
    
    setTimeout(() => {
        responseDiv.style.display = 'none';
    }, 3000);
}

function updateProgress() {
    const progress = (emotionGameState.examplesGiven / emotionGameState.maxExamples) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    document.getElementById('examples-count').textContent = emotionGameState.examplesGiven;
    
    // Show complete button after max examples
    if (emotionGameState.examplesGiven >= emotionGameState.maxExamples) {
        document.getElementById('complete-btn').style.display = 'block';
        document.getElementById('new-scenario-btn').style.display = 'none';
    }
}

function loadNewScenario() {
    // Get unused scenarios
    const availableScenarios = emotionGameState.scenarios.filter(scenario => 
        !emotionGameState.usedScenarios.includes(scenario.text)
    );
    
    if (availableScenarios.length === 0) {
        // Reset if we've used all scenarios
        emotionGameState.usedScenarios = [];
    }
    
    const currentScenario = availableScenarios.length > 0 ? 
        availableScenarios[Math.floor(Math.random() * availableScenarios.length)] :
        emotionGameState.scenarios[Math.floor(Math.random() * emotionGameState.scenarios.length)];
    
    emotionGameState.currentScenario = currentScenario;
    emotionGameState.usedScenarios.push(currentScenario.text);
    
    // Display the scenario
    const scenarioContent = document.getElementById('scenario-content');
    scenarioContent.innerHTML = `
        <div class="text-sm font-medium text-gray-800 mb-2">📖 Read this scenario:</div>
        <div class="text-gray-700 italic bg-gray-50 p-3 rounded-lg text-sm">"${currentScenario.text}"</div>
        <div class="text-xs text-gray-600 mt-2">What emotion is this person feeling?</div>
    `;
    
    // Clear previous results
    document.getElementById('scenario-result').innerHTML = '';
    
    // Reset emotion selection
    emotionGameState.selectedEmotion = null;
    document.querySelectorAll('.emotion-btn').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-purple-400', 'ring-opacity-50');
    });
}

function setupEmotionButtons() {
    document.querySelectorAll('.emotion-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Clear previous selection
            document.querySelectorAll('.emotion-btn').forEach(el => {
                el.classList.remove('ring-4', 'ring-purple-400', 'ring-opacity-50');
            });
            
            // Select this emotion
            this.classList.add('ring-4', 'ring-purple-400', 'ring-opacity-50');
            emotionGameState.selectedEmotion = this.dataset.emotion;
            
            // Highlight the scenario zone
            const scenarioZone = document.getElementById('scenario-zone');
            scenarioZone.classList.add('border-purple-400', 'bg-purple-50');
            scenarioZone.classList.remove('border-gray-300');
        });
    });
}

function setupScenarioZone() {
    const scenarioZone = document.getElementById('scenario-zone');
    
    scenarioZone.addEventListener('click', function(e) {
        if (emotionGameState.selectedEmotion && emotionGameState.currentScenario) {
            e.preventDefault();
            
            const selectedEmotion = emotionGameState.selectedEmotion;
            const correctEmotion = emotionGameState.currentScenario.emotion;
            const isCorrect = selectedEmotion === correctEmotion;
            
            // Show result
            const resultEl = document.getElementById('scenario-result');
            const emotionEmojis = {
                happy: '😊', sad: '😢', angry: '😠', 
                surprised: '😮', scared: '😨', neutral: '😐'
            };
            
            resultEl.innerHTML = `
                <div class="p-3 rounded-lg ${isCorrect ? 'bg-green-100 border border-green-300' : 'bg-orange-100 border border-orange-300'} transition-all duration-300">
                    <div class="text-2xl mb-1">${emotionEmojis[selectedEmotion]}</div>
                    <div class="font-medium ${isCorrect ? 'text-green-800' : 'text-orange-800'} text-sm">
                        You chose: ${selectedEmotion.charAt(0).toUpperCase() + selectedEmotion.slice(1)}
                    </div>
                    ${!isCorrect ? `<div class="text-xs text-orange-600 mt-1">Correct answer: ${correctEmotion.charAt(0).toUpperCase() + correctEmotion.slice(1)} ${emotionEmojis[correctEmotion]}</div>` : ''}
                    ${isCorrect ? '<div class="text-xs text-green-600 mt-1">🎉 Perfect! Great emotional understanding!</div>' : '<div class="text-xs text-orange-600 mt-1">💡 Keep practicing to get better!</div>'}
                </div>
            `;
            
            // Record the example
            emotionGameState.emotionData[correctEmotion].total++;
            if (isCorrect) {
                emotionGameState.emotionData[correctEmotion].correct++;
            }
            
            // Show feedback
            showBuddyMessage(`Thank you! I'll remember that this expression shows ${selectedEmotion}! I'm learning to understand emotions better! 🌟`);
            
            emotionGameState.examplesGiven++;
            updateProgress();
            
            // Reset selection
            emotionGameState.selectedEmotion = null;
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-purple-400', 'ring-opacity-50');
            });
            
            // Reset zone style
            this.classList.remove('border-purple-400', 'bg-purple-50');
            this.classList.add('border-gray-300');
            
            // Load new scenario after delay
            setTimeout(() => {
                if (emotionGameState.examplesGiven < emotionGameState.maxExamples) {
                    loadNewScenario();
                }
            }, 2000);
        } else if (!emotionGameState.selectedEmotion) {
            // Guide user to select an emotion first
            const emotionPool = document.getElementById('emotion-pool');
            emotionPool.classList.add('ring-2', 'ring-yellow-400', 'ring-opacity-75');
            setTimeout(() => {
                emotionPool.classList.remove('ring-2', 'ring-yellow-400', 'ring-opacity-75');
            }, 1500);
        }
    });
}

// Initialize game
document.addEventListener('DOMContentLoaded', function() {
    setupEmotionButtons();
    setupScenarioZone();
    loadNewScenario();
    
    // Event listeners
    document.getElementById('new-scenario-btn').addEventListener('click', loadNewScenario);
    
    document.getElementById('complete-btn').addEventListener('click', function() {
        // Calculate basic learning statistics
        const overallAccuracy = emotionGameState.examplesGiven > 0 ? 
            Math.round(((emotionGameState.emotionData.happy.correct + 
                        emotionGameState.emotionData.sad.correct + 
                        emotionGameState.emotionData.angry.correct +
                        emotionGameState.emotionData.surprised.correct +
                        emotionGameState.emotionData.scared.correct +
                        emotionGameState.emotionData.neutral.correct) / 
                       emotionGameState.examplesGiven) * 100) : 0;
        
        let personalizedMessage = `Amazing emotion training! You taught me ${emotionGameState.examplesGiven} emotional scenarios! Now I understand human feelings much better! 🎓💝`;
        
        showBuddyMessage(personalizedMessage);
        
        // Store training data for result page
        localStorage.setItem('aiTrainingData', JSON.stringify({
            emotionData: emotionGameState.emotionData,
            examples: emotionGameState.examplesGiven,
            accuracy: overallAccuracy,
            gameType: 'emotion_game'
        }));
        
        setTimeout(() => {
            // Navigate directly to learning explanation
            window.location.href = '{% url "robotic_buddy:learning_explanation" %}';
        }, 4000);
    });
});
</script>
{% endblock %}