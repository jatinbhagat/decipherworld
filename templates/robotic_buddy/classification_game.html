{% extends 'robotic_buddy/base.html' %}

{% block game_title %}{{ buddy.name }} Learns Animals{% endblock %}

{% block game_content %}
<div class="max-w-6xl mx-auto">
    <!-- Game Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">
            🐾 Animal Classification Training
        </h1>
        <p class="text-lg text-gray-600 mb-4">
            Help {{ buddy.name }} learn to classify animals into different categories!
        </p>
        
        <!-- Game Progress -->
        <div class="game-card bg-white p-4 max-w-md mx-auto">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Training Progress</span>
                <span class="text-sm text-gray-600"><span id="examples-count">0</span> / {{ activity.max_examples }} examples</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="progress-bar h-3" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <!-- Game Instructions -->
    <div class="game-card bg-gradient-to-r from-blue-100 to-purple-100 p-6 mb-8">
        <div class="flex items-start space-x-4">
            <div class="buddy-avatar w-16 h-16 buddy-{{ buddy.personality }} flex items-center justify-center text-white text-xl">
                {% if buddy.personality == 'cheerful' %}😊
                {% elif buddy.personality == 'curious' %}🤔
                {% elif buddy.personality == 'patient' %}😌
                {% elif buddy.personality == 'playful' %}😄
                {% else %}🦉{% endif %}
            </div>
            <div class="buddy-speech flex-1">
                <p id="buddy-instruction">
                    Hi! I'm ready to learn about animals! Show me examples by dragging each animal to the right category. 
                    I'll watch and learn, then try to guess where new animals belong!
                </p>
            </div>
        </div>
    </div>
    
    <!-- Training Interface -->
    <div class="grid lg:grid-cols-4 gap-6">
        <!-- Animal Pool -->
        <div class="lg:col-span-1">
            <div class="game-card bg-white p-4 sticky top-32">
                <h3 class="font-semibold text-gray-800 mb-4 text-center">🎲 Animals to Classify</h3>
                <div id="animal-pool" class="space-y-2 min-h-[300px]">
                    <!-- Animals will be populated here -->
                </div>
                <button id="new-animal-btn" class="btn btn-sm btn-outline btn-primary w-full mt-4">
                    Get New Animal
                </button>
            </div>
        </div>
        
        <!-- Classification Categories -->
        <div class="lg:col-span-3">
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <!-- Mammals -->
                <div class="game-card bg-white p-4">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">🦁</div>
                        <h3 class="font-semibold text-gray-800">Mammals</h3>
                        <p class="text-sm text-gray-600">Warm-blooded, have hair or fur</p>
                    </div>
                    <div class="drop-zone" data-category="mammals" id="mammals-zone">
                        <div class="text-gray-400 text-sm">Drop mammals here</div>
                    </div>
                    <div id="mammals-items" class="mt-3 flex flex-wrap gap-2">
                        <!-- Classified mammals will appear here -->
                    </div>
                </div>
                
                <!-- Birds -->
                <div class="game-card bg-white p-4">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">🦅</div>
                        <h3 class="font-semibold text-gray-800">Birds</h3>
                        <p class="text-sm text-gray-600">Have feathers and wings</p>
                    </div>
                    <div class="drop-zone" data-category="birds" id="birds-zone">
                        <div class="text-gray-400 text-sm">Drop birds here</div>
                    </div>
                    <div id="birds-items" class="mt-3 flex flex-wrap gap-2">
                        <!-- Classified birds will appear here -->
                    </div>
                </div>
                
                <!-- Fish -->
                <div class="game-card bg-white p-4">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">🐟</div>
                        <h3 class="font-semibold text-gray-800">Fish</h3>
                        <p class="text-sm text-gray-600">Live in water, have gills</p>
                    </div>
                    <div class="drop-zone" data-category="fish" id="fish-zone">
                        <div class="text-gray-400 text-sm">Drop fish here</div>
                    </div>
                    <div id="fish-items" class="mt-3 flex flex-wrap gap-2">
                        <!-- Classified fish will appear here -->
                    </div>
                </div>
            </div>
            
            <!-- Buddy Prediction Area -->
            <div class="game-card bg-white p-6" id="prediction-area" style="display: none;">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">🤖 {{ buddy.name }}'s Turn!</h3>
                    <p class="text-gray-600">Watch me try to classify this animal based on what I've learned!</p>
                </div>
                
                <div class="flex items-center justify-center space-x-8 mb-6">
                    <div id="prediction-animal" class="text-center">
                        <!-- Current animal being predicted -->
                    </div>
                    <div class="text-2xl">→</div>
                    <div id="prediction-result" class="text-center">
                        <!-- Buddy's prediction -->
                    </div>
                </div>
                
                <div class="flex justify-center space-x-3">
                    <button id="correct-btn" class="btn btn-success">✅ Correct!</button>
                    <button id="wrong-btn" class="btn btn-error">❌ Wrong</button>
                </div>
            </div>
            
            <!-- Game Actions -->
            <div class="text-center mt-6">
                <button id="test-buddy-btn" class="btn btn-primary btn-lg" style="display: none;">
                    🧠 Test {{ buddy.name }}'s Learning!
                </button>
                <button id="complete-session-btn" class="btn btn-success btn-lg" style="display: none;">
                    🎉 Complete Training Session
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Game State -->
<input type="hidden" id="session-id" value="">
<input type="hidden" id="current-animal" value="">
<input type="hidden" id="examples-given" value="0">
<input type="hidden" id="predictions-made" value="0">
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
// Game State for Classification Game
let classificationGameState = {
    sessionId: null,
    currentAnimal: null,
    examplesGiven: 0,
    predictionsMode: false,
    animals: {{ animals|safe }},
    usedAnimals: [],
    correctPredictions: 0,
    totalPredictions: 0
};

// Animal emojis for visual display
const animalEmojis = {
    // Mammals
    'dog': '🐕', 'cat': '🐱', 'elephant': '🐘', 'lion': '🦁', 'bear': '🐻', 'monkey': '🐵',
    // Birds  
    'eagle': '🦅', 'parrot': '🦜', 'penguin': '🐧', 'owl': '🦉', 'robin': '🐦', 'flamingo': '🦩',
    // Fish
    'goldfish': '🐠', 'shark': '🦈', 'tuna': '🐟', 'salmon': '🐟', 'clownfish': '🐠', 'whale': '🐋'
};

// Initialize drag and drop functionality for a single element
function initializeDragAndDrop(element) {
    if (!element.classList.contains('draggable-item')) return;
    
    element.draggable = true;
    
    // Remove existing listeners to prevent duplicates
    element.removeEventListener('dragstart', handleDragStart);
    element.removeEventListener('dragend', handleDragEnd);
    
    // Add drag event listeners
    element.addEventListener('dragstart', handleDragStart);
    element.addEventListener('dragend', handleDragEnd);
}

// Drag event handlers
function handleDragStart(e) {
    this.classList.add('dragging');
    e.dataTransfer.setData('text/plain', this.dataset.item || this.textContent.trim());
    console.log('Drag started:', this.dataset.item);
}

function handleDragEnd() {
    this.classList.remove('dragging');
    console.log('Drag ended');
}

document.addEventListener('DOMContentLoaded', function() {
    initializeGame();
});

function initializeGame(retryCount = 0) {
    // Ensure GameUtils is available
    if (!window.GameUtils) {
        if (retryCount < 50) { // Max 5 seconds of retries
            console.error(`GameUtils not available, retrying in 100ms... (attempt ${retryCount + 1}/50)`);
            setTimeout(() => initializeGame(retryCount + 1), 100);
            return;
        } else {
            console.error('❌ CRITICAL: GameUtils never loaded after 50 attempts. Check base template.');
            alert('Game initialization failed. Please refresh the page.');
            return;
        }
    }
    
    console.log('✅ GameUtils loaded successfully, initializing game...');
    
    // Create a new training session
    window.GameUtils.gameAjax('{% url "robotic_buddy:submit_example" %}', {
        'action': 'create_session',
        'activity_id': {{ activity.id }}
    }, function(response) {
        if (response.session_id) {
            classificationGameState.sessionId = response.session_id;
            document.getElementById('session-id').value = response.session_id;
            addNewAnimal();
        }
    });
}

function addNewAnimal() {
    // Get random animal that hasn't been used recently
    const availableAnimals = [];
    
    Object.entries(classificationGameState.animals).forEach(([category, animals]) => {
        animals.forEach(animal => {
            if (!classificationGameState.usedAnimals.includes(animal)) {
                availableAnimals.push({name: animal, category: category});
            }
        });
    });
    
    if (availableAnimals.length === 0) {
        // Reset used animals if we've used them all
        classificationGameState.usedAnimals = [];
        Object.entries(classificationGameState.animals).forEach(([category, animals]) => {
            animals.forEach(animal => {
                availableAnimals.push({name: animal, category: category});
            });
        });
    }
    
    const randomAnimal = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
    classificationGameState.currentAnimal = randomAnimal;
    classificationGameState.usedAnimals.push(randomAnimal.name);
    
    // Add animal to the pool
    const animalPool = document.getElementById('animal-pool');
    const animalElement = document.createElement('div');
    animalElement.className = 'draggable-item bg-blue-50 border border-blue-200 rounded-lg p-3 text-center cursor-grab hover:bg-blue-100 transition-colors';
    animalElement.draggable = true;
    animalElement.dataset.item = randomAnimal.name;
    animalElement.dataset.category = randomAnimal.category;
    animalElement.innerHTML = `
        <div class="text-3xl mb-1">${animalEmojis[randomAnimal.name] || '🐾'}</div>
        <div class="text-sm font-medium text-gray-800">${randomAnimal.name}</div>
    `;
    
    animalPool.appendChild(animalElement);
    
    // Initialize drag and drop for the new element
    initializeDragAndDrop(animalElement);
    
    // Update instructions
    updateBuddyMessage(`I see a ${randomAnimal.name}! Can you show me which category it belongs to?`);
}

function updateBuddyMessage(message) {
    document.getElementById('buddy-instruction').textContent = message;
}

function updateProgress() {
    const progress = (classificationGameState.examplesGiven / {{ activity.max_examples }}) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    document.getElementById('examples-count').textContent = classificationGameState.examplesGiven;
    
    // Show test button after minimum examples
    if (classificationGameState.examplesGiven >= {{ activity.min_examples_needed }}) {
        document.getElementById('test-buddy-btn').style.display = 'block';
    }
    
    // Show complete button after max examples
    if (classificationGameState.examplesGiven >= {{ activity.max_examples }}) {
        document.getElementById('complete-session-btn').style.display = 'block';
        document.getElementById('new-animal-btn').style.display = 'none';
        updateBuddyMessage("Wow! I think I've learned a lot! You can test my knowledge or complete our session.");
    }
}

// Enhanced drop handling
window.handleDrop = function(dropZone, animalName) {
    console.log('Drop detected:', animalName, 'into', dropZone.dataset.category);
    
    const category = dropZone.dataset.category;
    const animalData = classificationGameState.currentAnimal;
    
    console.log('Current animal data:', animalData);
    console.log('Dropped animal name:', animalName);
    
    if (animalData && animalData.name === animalName) {
        const isCorrect = animalData.category === category;
        
        // Move animal to the category
        const animalElement = document.querySelector(`[data-item="${animalName}"]`);
        if (animalElement) {
            animalElement.remove();
            
            // Add to category display
            const categoryItems = document.getElementById(category + '-items');
            const itemElement = document.createElement('span');
            itemElement.className = `inline-block bg-${isCorrect ? 'green' : 'red'}-100 text-${isCorrect ? 'green' : 'red'}-800 px-2 py-1 rounded text-sm`;
            itemElement.innerHTML = `${animalEmojis[animalName] || '🐾'} ${animalName}`;
            categoryItems.appendChild(itemElement);
            
            // Submit training example
            window.GameUtils.gameAjax('{% url "robotic_buddy:submit_example" %}', {
                'session_id': classificationGameState.sessionId,
                'example_type': 'classification_item',
                'label': animalName,
                'data': {
                    'category': category,
                    'correct_category': animalData.category
                },
                'was_correct': isCorrect,
                'confidence': 1.0
            }, function(response) {
                if (response.success) {
                    classificationGameState.examplesGiven++;
                    updateProgress();
                    
                    // Show feedback
                    if (isCorrect) {
                        window.GameUtils.showBuddyMessage(`Great job! A ${animalName} is indeed a ${category.slice(0, -1)}! I'm learning! 🌟`, 'success');
                    } else {
                        window.GameUtils.showBuddyMessage(`Oops! A ${animalName} is actually a ${animalData.category.slice(0, -1)}, not a ${category.slice(0, -1)}. I'll remember that! 🤔`);
                    }
                    
                    // Add new animal after a delay
                    setTimeout(() => {
                        if (classificationGameState.examplesGiven < {{ activity.max_examples }}) {
                            addNewAnimal();
                        }
                    }, 2000);
                }
            });
        }
    }
};

// New animal button handler
document.getElementById('new-animal-btn').addEventListener('click', function() {
    // Clear current animal if exists
    const currentAnimalEl = document.querySelector('[data-item]');
    if (currentAnimalEl) {
        currentAnimalEl.remove();
    }
    addNewAnimal();
});

// Test buddy button handler  
document.getElementById('test-buddy-btn').addEventListener('click', function() {
    testBuddyKnowledge();
});

function testBuddyKnowledge() {
    // Get a random animal for testing
    const allAnimals = [];
    Object.entries(classificationGameState.animals).forEach(([category, animals]) => {
        animals.forEach(animal => {
            allAnimals.push({name: animal, category: category});
        });
    });
    
    const testAnimal = allAnimals[Math.floor(Math.random() * allAnimals.length)];
    
    // Get buddy's prediction
    window.GameUtils.gameAjax('{% url "robotic_buddy:buddy_prediction" %}', {
        'type': 'classification',
        'item': testAnimal.name + ' animal'
    }, function(response) {
        showPredictionInterface(testAnimal, response);
    });
}

function showPredictionInterface(animal, prediction) {
    const predictionArea = document.getElementById('prediction-area');
    const animalDiv = document.getElementById('prediction-animal');
    const resultDiv = document.getElementById('prediction-result');
    
    animalDiv.innerHTML = `
        <div class="text-4xl mb-2">${animalEmojis[animal.name] || '🐾'}</div>
        <div class="font-medium">${animal.name}</div>
    `;
    
    resultDiv.innerHTML = `
        <div class="text-4xl mb-2">${prediction.prediction === 'mammals' ? '🦁' : prediction.prediction === 'birds' ? '🦅' : '🐟'}</div>
        <div class="font-medium">${prediction.prediction}</div>
        <div class="text-sm text-gray-600">Confidence: ${Math.round(prediction.confidence * 100)}%</div>
    `;
    
    predictionArea.style.display = 'block';
    
    // Set up feedback buttons
    document.getElementById('correct-btn').onclick = function() {
        handlePredictionFeedback(animal, prediction, true);
    };
    
    document.getElementById('wrong-btn').onclick = function() {
        handlePredictionFeedback(animal, prediction, false);
    };
    
    updateBuddyMessage(prediction.explanation);
}

function handlePredictionFeedback(animal, prediction, wasCorrect) {
    classificationGameState.totalPredictions++;
    if (wasCorrect) {
        classificationGameState.correctPredictions++;
    }
    
    // Submit the prediction result
    window.GameUtils.gameAjax('{% url "robotic_buddy:submit_example" %}', {
        'session_id': classificationGameState.sessionId,
        'example_type': 'classification_item',
        'label': animal.name,
        'data': {
            'prediction': prediction.prediction,
            'correct_category': animal.category,
            'test_mode': true
        },
        'prediction': prediction.prediction,
        'was_correct': wasCorrect,
        'confidence': prediction.confidence
    }, function(response) {
        // Hide prediction interface
        document.getElementById('prediction-area').style.display = 'none';
        
        // Show feedback message
        if (wasCorrect) {
            window.GameUtils.showBuddyMessage("Yay! I got it right! I'm getting better at this! 🎉", 'success');
        } else {
            window.GameUtils.showBuddyMessage("Oops, I was wrong! But that's how I learn - thank you for teaching me! 🤗");
        }
        
        // Continue testing or allow completion
        setTimeout(() => {
            if (classificationGameState.totalPredictions < 3) {
                testBuddyKnowledge();
            } else {
                updateBuddyMessage(`I've made ${classificationGameState.totalPredictions} predictions and got ${classificationGameState.correctPredictions} right! Ready to complete our session?`);
                document.getElementById('complete-session-btn').style.display = 'block';
            }
        }, 2000);
    });
}

// Complete session handler
document.getElementById('complete-session-btn').addEventListener('click', function() {
    window.GameUtils.gameAjax('{% url "robotic_buddy:complete_session" %}', {
        'session_id': classificationGameState.sessionId
    }, function(response) {
        if (response.success) {
            // Show brief completion message
            window.GameUtils.showBuddyMessage(
                `Training complete! Let's see how I learned! 🧠`,
                'success'
            );
            
            // Redirect to result page immediately
            setTimeout(() => {
                if (response.redirect_url) {
                    window.location.href = response.redirect_url;
                } else {
                    // Fallback to buddy dashboard
                    window.location.href = '{% url "robotic_buddy:my_buddy" %}';
                }
            }, 1500);
        }
    });
});
</script>
{% endblock %}