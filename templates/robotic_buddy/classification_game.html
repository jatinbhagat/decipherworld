{% extends 'robotic_buddy/base.html' %}

{% block game_title %}{{ buddy.name }} Learns Animals{% endblock %}

{% block game_content %}
<div class="max-w-4xl mx-auto px-4">
    <!-- Compact Header with Status -->
    <div class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 border-b border-gray-100 -mx-4 px-4 py-3 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-green-500 rounded-full flex items-center justify-center text-white buddy-{{ buddy.personality }}">
                    {% if buddy.personality == 'cheerful' %}😊
                    {% elif buddy.personality == 'curious' %}🤔
                    {% elif buddy.personality == 'patient' %}😌
                    {% elif buddy.personality == 'playful' %}😄
                    {% else %}🦉{% endif %}
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800">Animal Classification</h1>
                    <p class="text-xs text-gray-600 hidden sm:block">Drag animals to categories</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800">
                        <span id="examples-count">0</span>/{{ activity.max_examples }}
                    </div>
                    <div class="text-xs text-gray-500">examples</div>
                </div>
                <div class="w-16 h-2 bg-gray-200 rounded-full">
                    <div id="progress-bar" class="bg-gradient-to-r from-blue-400 to-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Game Interface -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <!-- Animal Pool Section -->
        <div class="bg-gradient-to-br from-blue-50 to-green-50 p-6 border-b border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800 text-sm">Current Animal</h3>
                <button id="new-animal-btn" class="px-3 py-1 bg-blue-500 text-white rounded-md text-xs hover:bg-blue-600 transition-colors">
                    Next
                </button>
            </div>
            <div id="animal-pool" class="text-center min-h-[120px] flex items-center justify-center">
                <!-- Current animal will be displayed here -->
            </div>
            <div class="text-center text-xs text-gray-600 mt-3">
                <span class="md:hidden">👆 Tap animal, then tap category below</span>
                <span class="hidden md:inline">🖱️ Drag to the correct category below</span>
            </div>
        </div>
        
        <!-- Classification Categories -->
        <div class="p-4">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <!-- Mammals -->
                <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-3">
                    <div class="text-center mb-2">
                        <div class="text-2xl">🦁</div>
                        <h3 class="font-semibold text-orange-800 text-sm">Mammals</h3>
                        <p class="text-xs text-orange-600">Warm-blooded, have hair</p>
                    </div>
                    <div class="drop-zone min-h-[80px] border-2 border-dashed border-orange-300 rounded-md p-2 text-center flex items-center justify-center touch-manipulation hover:border-orange-400 hover:bg-orange-100 transition-colors duration-200" 
                         data-category="mammals" id="mammals-zone">
                        <div class="text-orange-400 text-xs">
                            <span class="md:hidden">Tap for mammals</span>
                            <span class="hidden md:inline">Drop here</span>
                        </div>
                    </div>
                    <div id="mammals-items" class="mt-2 flex flex-wrap gap-1">
                        <!-- Classified mammals will appear here -->
                    </div>
                </div>
                
                <!-- Birds -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                    <div class="text-center mb-2">
                        <div class="text-2xl">🦅</div>
                        <h3 class="font-semibold text-blue-800 text-sm">Birds</h3>
                        <p class="text-xs text-blue-600">Have feathers and wings</p>
                    </div>
                    <div class="drop-zone min-h-[80px] border-2 border-dashed border-blue-300 rounded-md p-2 text-center flex items-center justify-center touch-manipulation hover:border-blue-400 hover:bg-blue-100 transition-colors duration-200" 
                         data-category="birds" id="birds-zone">
                        <div class="text-blue-400 text-xs">
                            <span class="md:hidden">Tap for birds</span>
                            <span class="hidden md:inline">Drop here</span>
                        </div>
                    </div>
                    <div id="birds-items" class="mt-2 flex flex-wrap gap-1">
                        <!-- Classified birds will appear here -->
                    </div>
                </div>
                
                <!-- Fish -->
                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-3">
                    <div class="text-center mb-2">
                        <div class="text-2xl">🐟</div>
                        <h3 class="font-semibold text-green-800 text-sm">Fish</h3>
                        <p class="text-xs text-green-600">Live in water, have gills</p>
                    </div>
                    <div class="drop-zone min-h-[80px] border-2 border-dashed border-green-300 rounded-md p-2 text-center flex items-center justify-center touch-manipulation hover:border-green-400 hover:bg-green-100 transition-colors duration-200" 
                         data-category="fish" id="fish-zone">
                        <div class="text-green-400 text-xs">
                            <span class="md:hidden">Tap for fish</span>
                            <span class="hidden md:inline">Drop here</span>
                        </div>
                    </div>
                    <div id="fish-items" class="mt-2 flex flex-wrap gap-1">
                        <!-- Classified fish will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Buddy Prediction Area (Compact) -->
    <div id="prediction-area" class="mt-4 bg-white rounded-xl shadow-lg border border-gray-200 p-4" style="display: none;">
        <div class="text-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">🤖 {{ buddy.name }}'s Turn!</h3>
            <p class="text-gray-600 text-sm">Watch me try to classify this animal!</p>
        </div>
        
        <div class="flex items-center justify-center space-x-6 mb-4">
            <div id="prediction-animal" class="text-center">
                <!-- Current animal being predicted -->
            </div>
            <div class="text-xl">→</div>
            <div id="prediction-result" class="text-center">
                <!-- Buddy's prediction -->
            </div>
        </div>
        
        <div class="flex justify-center space-x-3">
            <button id="correct-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-colors">✅ Correct!</button>
            <button id="wrong-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition-colors">❌ Wrong</button>
        </div>
    </div>
    
    <!-- Compact Response & Actions -->
    <div class="mt-4 space-y-3">
        <!-- Buddy Response (Compact) -->
        <div id="buddy-response" class="bg-gradient-to-r from-blue-100 to-green-100 rounded-lg p-3 text-center" style="display: none;">
            <p id="buddy-message" class="text-sm text-gray-700 font-medium"></p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center space-x-3">
            <button id="test-buddy-btn" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg shadow-md hover:shadow-lg transition-all text-sm font-medium" style="display: none;">
                🧠 Test {{ buddy.name }}!
            </button>
            <button id="complete-session-btn" class="px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg shadow-md hover:shadow-lg transition-all text-sm font-medium" style="display: none;">
                🎉 Complete Training
            </button>
        </div>
    </div>
</div>

<!-- Game State -->
<input type="hidden" id="session-id" value="">
<input type="hidden" id="current-animal" value="">
<input type="hidden" id="examples-given" value="0">
<input type="hidden" id="predictions-made" value="0">
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
// Game State for Classification Game
let classificationGameState = {
    sessionId: null,
    currentAnimal: null,
    examplesGiven: 0,
    predictionsMode: false,
    animals: {{ animals|safe }},
    usedAnimals: [],
    correctPredictions: 0,
    totalPredictions: 0
};

// Animal emojis for visual display
const animalEmojis = {
    // Mammals
    'dog': '🐕', 'cat': '🐱', 'elephant': '🐘', 'lion': '🦁', 'bear': '🐻', 'monkey': '🐵',
    // Birds  
    'eagle': '🦅', 'parrot': '🦜', 'penguin': '🐧', 'owl': '🦉', 'robin': '🐦', 'flamingo': '🦩',
    // Fish
    'goldfish': '🐠', 'shark': '🦈', 'tuna': '🐟', 'salmon': '🐟', 'clownfish': '🐠', 'whale': '🐋'
};

// Initialize drag and drop functionality for a single element
function initializeDragAndDrop(element) {
    if (!element.classList.contains('draggable-item')) return;
    
    element.draggable = true;
    
    // Remove existing listeners to prevent duplicates
    element.removeEventListener('dragstart', handleDragStart);
    element.removeEventListener('dragend', handleDragEnd);
    
    // Add drag event listeners
    element.addEventListener('dragstart', handleDragStart);
    element.addEventListener('dragend', handleDragEnd);
}

// Drag event handlers
function handleDragStart(e) {
    this.classList.add('dragging');
    e.dataTransfer.setData('text/plain', this.dataset.item || this.textContent.trim());
    console.log('Drag started:', this.dataset.item);
}

function handleDragEnd() {
    this.classList.remove('dragging');
    console.log('Drag ended');
}

document.addEventListener('DOMContentLoaded', function() {
    initializeGame();
});

function initializeGame(retryCount = 0) {
    // Ensure GameUtils is available
    if (!window.GameUtils) {
        if (retryCount < 50) { // Max 5 seconds of retries
            console.error(`GameUtils not available, retrying in 100ms... (attempt ${retryCount + 1}/50)`);
            setTimeout(() => initializeGame(retryCount + 1), 100);
            return;
        } else {
            console.error('❌ CRITICAL: GameUtils never loaded after 50 attempts. Check base template.');
            alert('Game initialization failed. Please refresh the page.');
            return;
        }
    }
    
    console.log('✅ GameUtils loaded successfully, initializing game...');
    
    // Create a new training session
    window.GameUtils.gameAjax('{% url "robotic_buddy:submit_example" %}', {
        'action': 'create_session',
        'activity_id': {{ activity.id }}
    }, function(response) {
        if (response.session_id) {
            classificationGameState.sessionId = response.session_id;
            document.getElementById('session-id').value = response.session_id;
            addNewAnimal();
        }
    });
}

function addNewAnimal() {
    // Get random animal that hasn't been used recently
    const availableAnimals = [];
    
    Object.entries(classificationGameState.animals).forEach(([category, animals]) => {
        animals.forEach(animal => {
            if (!classificationGameState.usedAnimals.includes(animal)) {
                availableAnimals.push({name: animal, category: category});
            }
        });
    });
    
    if (availableAnimals.length === 0) {
        // Reset used animals if we've used them all
        classificationGameState.usedAnimals = [];
        Object.entries(classificationGameState.animals).forEach(([category, animals]) => {
            animals.forEach(animal => {
                availableAnimals.push({name: animal, category: category});
            });
        });
    }
    
    const randomAnimal = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
    classificationGameState.currentAnimal = randomAnimal;
    classificationGameState.usedAnimals.push(randomAnimal.name);
    
    // Clear previous animals and add new one
    const animalPool = document.getElementById('animal-pool');
    animalPool.innerHTML = '';
    
    const animalElement = document.createElement('div');
    animalElement.className = 'draggable-item bg-blue-50 border-2 border-blue-200 rounded-lg p-4 text-center cursor-grab hover:bg-blue-100 transition-colors shadow-sm';
    animalElement.draggable = true;
    animalElement.dataset.item = randomAnimal.name;
    animalElement.dataset.category = randomAnimal.category;
    animalElement.innerHTML = `
        <div class="text-4xl mb-2">${animalEmojis[randomAnimal.name] || '🐾'}</div>
        <div class="text-sm font-medium text-gray-800">${randomAnimal.name}</div>
    `;
    
    animalPool.appendChild(animalElement);
    
    // Initialize drag and drop for the new element
    initializeDragAndDrop(animalElement);
}

function updateProgress() {
    const progress = (classificationGameState.examplesGiven / {{ activity.max_examples }}) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    document.getElementById('examples-count').textContent = classificationGameState.examplesGiven;
    
    // Show test button after minimum examples
    if (classificationGameState.examplesGiven >= {{ activity.min_examples_needed }}) {
        document.getElementById('test-buddy-btn').style.display = 'block';
    }
    
    // Show complete button after max examples
    if (classificationGameState.examplesGiven >= {{ activity.max_examples }}) {
        document.getElementById('complete-session-btn').style.display = 'block';
        document.getElementById('new-animal-btn').style.display = 'none';
    }
}

function showBuddyMessage(message, type = 'success') {
    const responseDiv = document.getElementById('buddy-response');
    const messageEl = document.getElementById('buddy-message');
    
    messageEl.textContent = message;
    responseDiv.style.display = 'block';
    
    if (type === 'success') {
        responseDiv.className = 'bg-gradient-to-r from-blue-100 to-green-100 rounded-lg p-3 text-center';
    } else {
        responseDiv.className = 'bg-gradient-to-r from-orange-100 to-red-100 rounded-lg p-3 text-center';
    }
    
    setTimeout(() => {
        responseDiv.style.display = 'none';
    }, 3000);
}

// Enhanced drop handling
window.handleDrop = function(dropZone, animalName) {
    console.log('Drop detected:', animalName, 'into', dropZone.dataset.category);
    
    const category = dropZone.dataset.category;
    const animalData = classificationGameState.currentAnimal;
    
    console.log('Current animal data:', animalData);
    console.log('Dropped animal name:', animalName);
    
    if (animalData && animalData.name === animalName) {
        const isCorrect = animalData.category === category;
        
        // Move animal to the category
        const animalElement = document.querySelector(`[data-item="${animalName}"]`);
        if (animalElement) {
            animalElement.remove();
            
            // Add to category display
            const categoryItems = document.getElementById(category + '-items');
            const itemElement = document.createElement('span');
            itemElement.className = `inline-block ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-3 py-1 rounded-full text-sm font-medium m-1`;
            itemElement.innerHTML = `${animalEmojis[animalName] || '🐾'} ${animalName}`;
            categoryItems.appendChild(itemElement);
            
            // Submit training example
            window.GameUtils.gameAjax('{% url "robotic_buddy:submit_example" %}', {
                'session_id': classificationGameState.sessionId,
                'example_type': 'classification_item',
                'label': animalName,
                'data': {
                    'category': category,
                    'correct_category': animalData.category
                },
                'was_correct': isCorrect,
                'confidence': 1.0
            }, function(response) {
                if (response.success) {
                    classificationGameState.examplesGiven++;
                    updateProgress();
                    
                    // Show feedback
                    showBuddyMessage(`Thank you! I'll remember that ${animalName} is a ${category.slice(0, -1)}! I'm learning from your teaching! 🌟`);
                    
                    // Add new animal after a delay
                    setTimeout(() => {
                        if (classificationGameState.examplesGiven < {{ activity.max_examples }}) {
                            addNewAnimal();
                        }
                    }, 2000);
                }
            });
        }
    }
};

// New animal button handler
document.getElementById('new-animal-btn').addEventListener('click', function() {
    addNewAnimal();
});

// Test buddy button handler  
document.getElementById('test-buddy-btn').addEventListener('click', function() {
    testBuddyKnowledge();
});

function testBuddyKnowledge() {
    // Get a random animal for testing
    const allAnimals = [];
    Object.entries(classificationGameState.animals).forEach(([category, animals]) => {
        animals.forEach(animal => {
            allAnimals.push({name: animal, category: category});
        });
    });
    
    const testAnimal = allAnimals[Math.floor(Math.random() * allAnimals.length)];
    
    // Get buddy's prediction
    window.GameUtils.gameAjax('{% url "robotic_buddy:buddy_prediction" %}', {
        'type': 'classification',
        'item': testAnimal.name + ' animal'
    }, function(response) {
        showPredictionInterface(testAnimal, response);
    });
}

function showPredictionInterface(animal, prediction) {
    const predictionArea = document.getElementById('prediction-area');
    const animalDiv = document.getElementById('prediction-animal');
    const resultDiv = document.getElementById('prediction-result');
    
    animalDiv.innerHTML = `
        <div class="text-3xl mb-1">${animalEmojis[animal.name] || '🐾'}</div>
        <div class="font-medium text-sm">${animal.name}</div>
    `;
    
    resultDiv.innerHTML = `
        <div class="text-3xl mb-1">${prediction.prediction === 'mammals' ? '🦁' : prediction.prediction === 'birds' ? '🦅' : '🐟'}</div>
        <div class="font-medium text-sm">${prediction.prediction}</div>
        <div class="text-xs text-gray-600">${Math.round(prediction.confidence * 100)}% sure</div>
    `;
    
    predictionArea.style.display = 'block';
    
    // Set up feedback buttons
    document.getElementById('correct-btn').onclick = function() {
        handlePredictionFeedback(animal, prediction, true);
    };
    
    document.getElementById('wrong-btn').onclick = function() {
        handlePredictionFeedback(animal, prediction, false);
    };
    
    showBuddyMessage(prediction.explanation);
}

function handlePredictionFeedback(animal, prediction, wasCorrect) {
    classificationGameState.totalPredictions++;
    if (wasCorrect) {
        classificationGameState.correctPredictions++;
    }
    
    // Submit the prediction result
    window.GameUtils.gameAjax('{% url "robotic_buddy:submit_example" %}', {
        'session_id': classificationGameState.sessionId,
        'example_type': 'classification_item',
        'label': animal.name,
        'data': {
            'prediction': prediction.prediction,
            'correct_category': animal.category,
            'test_mode': true
        },
        'prediction': prediction.prediction,
        'was_correct': wasCorrect,
        'confidence': prediction.confidence
    }, function(response) {
        // Hide prediction interface
        document.getElementById('prediction-area').style.display = 'none';
        
        // Show feedback message
        if (wasCorrect) {
            showBuddyMessage("Yay! I got it right! I'm getting better at this! 🎉");
        } else {
            showBuddyMessage("Oops, I was wrong! But that's how I learn - thank you for teaching me! 🤗");
        }
        
        // Continue testing or allow completion
        setTimeout(() => {
            if (classificationGameState.totalPredictions < 3) {
                testBuddyKnowledge();
            } else {
                showBuddyMessage(`I've made ${classificationGameState.totalPredictions} predictions and got ${classificationGameState.correctPredictions} right! Ready to complete our session?`);
                document.getElementById('complete-session-btn').style.display = 'block';
            }
        }, 2000);
    });
}

// Complete session handler
document.getElementById('complete-session-btn').addEventListener('click', function() {
    window.GameUtils.gameAjax('{% url "robotic_buddy:complete_session" %}', {
        'session_id': classificationGameState.sessionId
    }, function(response) {
        if (response.success) {
            // Show brief completion message
            showBuddyMessage('Training complete! Let\'s see how I learned! 🧠');
            
            // Redirect to result page immediately
            setTimeout(() => {
                if (response.redirect_url) {
                    window.location.href = response.redirect_url;
                } else {
                    // Fallback to buddy dashboard
                    window.location.href = '{% url "robotic_buddy:my_buddy" %}';
                }
            }, 1500);
        }
    });
});
</script>
{% endblock %}