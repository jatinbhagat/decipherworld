{% extends 'robotic_buddy/base.html' %}

{% block game_title %}{{ buddy.name }} - Training Results{% endblock %}

{% block game_content %}
<div class="max-w-6xl mx-auto">
    <!-- Header Section -->
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">
            üß† {{ buddy.name }}'s Learning Results
        </h1>
        <p class="text-lg text-gray-600 mb-4">
            See how your AI buddy learned and understand the reasoning behind predictions!
        </p>
    </div>

    <!-- Training Quality Overview -->
    <div class="game-card bg-white p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-gray-800">üìä Training Quality Analysis</h2>
            {% if retrain_recommended %}
                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                    Retrain Recommended
                </span>
            {% else %}
                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                    Good Training
                </span>
            {% endif %}
        </div>
        
        <div class="grid md:grid-cols-3 gap-4 mb-6">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="text-3xl font-bold text-blue-600">{{ training_quality.total_examples }}</div>
                <div class="text-sm text-gray-600">Total Examples</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-3xl font-bold text-green-600">{{ training_quality.correct_examples }}</div>
                <div class="text-sm text-gray-600">Correct Labels</div>
            </div>
            <div class="text-center p-4 {% if training_quality.overall_score >= 0.8 %}bg-green-50{% elif training_quality.overall_score >= 0.6 %}bg-yellow-50{% else %}bg-red-50{% endif %} rounded-lg">
                <div class="text-3xl font-bold {% if training_quality.overall_score >= 0.8 %}text-green-600{% elif training_quality.overall_score >= 0.6 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {{ training_quality.overall_score|floatformat:1 }}%
                </div>
                <div class="text-sm text-gray-600">Training Accuracy</div>
            </div>
        </div>
        
        <!-- Training Quality Bar -->
        <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Training Quality Impact</span>
                <span class="text-sm text-gray-600">{{ training_quality.overall_score|floatformat:1 }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="{% if training_quality.overall_score >= 0.8 %}bg-green-500{% elif training_quality.overall_score >= 0.6 %}bg-yellow-500{% else %}bg-red-500{% endif %} h-3 rounded-full" 
                     style="width: {{ training_quality.overall_score|floatformat:0 }}%"></div>
            </div>
        </div>
        
        {% if retrain_recommended %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="text-red-500 text-xl mr-3">‚ö†Ô∏è</div>
                    <div>
                        <h3 class="font-semibold text-red-800 mb-1">Poor Training Quality Detected</h3>
                        <p class="text-red-700 text-sm mb-3">
                            Your training data had many incorrect labels ({{ training_quality.overall_score|floatformat:1 }}% accuracy). 
                            This means {{ buddy.name }} learned incorrect patterns and will make wrong predictions.
                        </p>
                        <a href="{% url 'robotic_buddy:classification_game' %}" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            üîÑ Retrain {{ buddy.name }}
                        </a>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="text-green-500 text-xl mr-3">‚úÖ</div>
                    <div>
                        <h3 class="font-semibold text-green-800 mb-1">Excellent Training Quality!</h3>
                        <p class="text-green-700 text-sm">
                            Your training data was {{ training_quality.overall_score|floatformat:1 }}% accurate. 
                            {{ buddy.name }} learned good patterns and should make reliable predictions!
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Detailed AI Reasoning -->
    {% if detailed_reasoning %}
        <div class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ü§ñ How {{ buddy.name }} Made Predictions</h2>
            
            {% for item in detailed_reasoning %}
                <div class="game-card bg-white p-6">
                    <!-- Prediction Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">
                                {% if item.example.label == 'dog' %}üêï
                                {% elif item.example.label == 'cat' %}üê±
                                {% elif item.example.label == 'elephant' %}üêò
                                {% elif item.example.label == 'lion' %}ü¶Å
                                {% elif item.example.label == 'bear' %}üêª
                                {% elif item.example.label == 'monkey' %}üêµ
                                {% elif item.example.label == 'eagle' %}ü¶Ö
                                {% elif item.example.label == 'parrot' %}ü¶ú
                                {% elif item.example.label == 'penguin' %}üêß
                                {% elif item.example.label == 'owl' %}ü¶â
                                {% elif item.example.label == 'robin' %}üê¶
                                {% elif item.example.label == 'flamingo' %}ü¶©
                                {% elif item.example.label == 'goldfish' %}üê†
                                {% elif item.example.label == 'shark' %}ü¶à
                                {% elif item.example.label == 'whale' %}üêã
                                {% else %}üêæ{% endif %}
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">{{ item.example.label|title }}</h3>
                                <p class="text-sm text-gray-600">
                                    Predicted: <span class="font-medium">{{ item.example.buddy_prediction|title }}</span>
                                    {% if item.example.was_correct %}
                                        <span class="text-green-600">‚úÖ Correct</span>
                                    {% else %}
                                        <span class="text-red-600">‚ùå Wrong</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold {% if item.reasoning.confidence_score >= 0.8 %}text-green-600{% elif item.reasoning.confidence_score >= 0.6 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                {{ item.reasoning.confidence_score|floatformat:0 }}%
                            </div>
                            <div class="text-xs text-gray-500">Confidence</div>
                        </div>
                    </div>
                    
                    <!-- Step-by-Step Reasoning -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-700">üß† Step-by-Step AI Reasoning:</h4>
                        
                        {% for step in item.reasoning.reasoning_steps %}
                            <div class="flex">
                                <div class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-4 flex-shrink-0">
                                    {{ step.step }}
                                </div>
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-800 mb-1">{{ step.title }}</h5>
                                    <p class="text-gray-600 text-sm">{{ step.description }}</p>
                                    
                                    {% if step.examples %}
                                        <div class="mt-2 flex flex-wrap gap-1">
                                            <span class="text-xs text-gray-500">Examples:</span>
                                            {% for example in step.examples %}
                                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">
                                                    {{ example.animal }} ‚Üí {{ example.category }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Confidence Explanation -->
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <h5 class="font-semibold text-gray-700 mb-2">üìà Why This Confidence Level?</h5>
                        <p class="text-gray-600 text-sm">{{ item.reasoning.confidence_explanation }}</p>
                    </div>
                    
                    <!-- Visual Patterns (if available) -->
                    {% if item.reasoning.visual_patterns %}
                        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                            <h5 class="font-semibold text-blue-800 mb-2">üëÅÔ∏è Visual Patterns I Noticed:</h5>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                {% if item.reasoning.visual_patterns.size %}
                                    <div class="text-blue-700">
                                        <strong>Size:</strong> {{ item.reasoning.visual_patterns.size|title }}
                                    </div>
                                {% endif %}
                                {% if item.reasoning.visual_patterns.habitat %}
                                    <div class="text-blue-700">
                                        <strong>Habitat:</strong> {{ item.reasoning.visual_patterns.habitat|title }}
                                    </div>
                                {% endif %}
                                {% if item.reasoning.visual_patterns.features %}
                                    <div class="text-blue-700 col-span-1">
                                        <strong>Features:</strong> 
                                        {% for feature in item.reasoning.visual_patterns.features %}
                                            {{ feature }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Session Summary -->
    <div class="game-card bg-gradient-to-r from-blue-100 to-purple-100 p-6 mt-8">
        <div class="flex items-start space-x-4">
            <div class="buddy-avatar w-16 h-16 buddy-{{ buddy.personality }} flex items-center justify-center text-white text-xl">
                {% if buddy.personality == 'cheerful' %}üòä
                {% elif buddy.personality == 'curious' %}ü§î
                {% elif buddy.personality == 'patient' %}üòå
                {% elif buddy.personality == 'playful' %}üòÑ
                {% else %}ü¶â{% endif %}
            </div>
            <div class="buddy-speech flex-1">
                <h3 class="font-semibold text-gray-800 mb-2">{{ buddy.name }} Says:</h3>
                {% if retrain_recommended %}
                    <p class="text-gray-700">
                        "I tried my best, but some of the training examples were confusing! 
                        My trainer put some animals in the wrong categories, so I learned incorrect patterns. 
                        Could you please train me again with the correct labels? I want to learn properly! ü§ó"
                    </p>
                {% else %}
                    <p class="text-gray-700">
                        "Thanks for the excellent training! You taught me really well and I learned good patterns. 
                        I feel confident about classifying animals now! My accuracy should be much better in the future. 
                        I earned {{ session.experience_earned }} experience points! üåü"
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="text-center mt-8 space-x-4">
        {% if retrain_recommended %}
            <a href="{% url 'robotic_buddy:classification_game' %}" class="btn btn-primary btn-lg">
                üîÑ Retrain {{ buddy.name }}
            </a>
        {% endif %}
        <a href="{% url 'robotic_buddy:my_buddy' %}" class="btn btn-secondary btn-lg">
            üè† Back to Dashboard
        </a>
        <a href="{% url 'robotic_buddy:activities' %}" class="btn btn-outline btn-lg">
            üéÆ Try Other Activities
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Add any interactive elements for the result page
document.addEventListener('DOMContentLoaded', function() {
    // Animate progress bars
    const progressBars = document.querySelectorAll('[style*="width:"]');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-in-out';
            bar.style.width = width;
        }, 100);
    });
});
</script>
{% endblock %}