{% extends 'robotic_buddy/base.html' %}

{% block game_title %}Drag & Drop Animal Training{% endblock %}

{% block game_content %}
<div class="max-w-4xl mx-auto px-4">
    <!-- Compact Header with Status -->
    <div class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 border-b border-gray-100 -mx-4 px-4 py-3 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white">
                    üêæ
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800">Drag & Drop Training</h1>
                    <p class="text-xs text-gray-600 hidden sm:block">Drag animals to the correct category</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800">
                        <span id="examples-count">0</span>/16
                    </div>
                    <div class="text-xs text-gray-500">examples</div>
                </div>
                <div class="w-16 h-2 bg-gray-200 rounded-full">
                    <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Game Interface -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <!-- Animal Pool Section -->
        <div class="bg-gradient-to-br from-green-50 to-blue-50 p-6 border-b border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800 text-sm">Current Animal</h3>
                <button id="new-animal-btn" class="px-3 py-1 bg-blue-500 text-white rounded-md text-xs hover:bg-blue-600 transition-colors">
                    Next
                </button>
            </div>
            <div id="animal-pool" class="text-center min-h-[120px] flex items-center justify-center">
                <!-- Current animal will be displayed here -->
            </div>
            <div class="text-center text-xs text-gray-600 mt-3">
                <span class="md:hidden">üëÜ Tap animal, then tap category below</span>
                <span class="hidden md:inline">üñ±Ô∏è Drag to the correct category below</span>
            </div>
        </div>
        
        <!-- Drop Categories -->
        <div class="p-4">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <!-- Mammals -->
                <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-3">
                    <div class="text-center mb-2">
                        <div class="text-2xl">ü¶Å</div>
                        <h3 class="font-semibold text-orange-800 text-sm">Mammals</h3>
                    </div>
                    <div class="drop-zone min-h-[80px] border-2 border-dashed border-orange-300 rounded-md p-2 text-center flex items-center justify-center touch-manipulation hover:border-orange-400 hover:bg-orange-100 transition-colors duration-200" 
                         data-category="mammals" id="mammals-zone">
                        <div class="text-orange-400 text-xs">
                            <span class="md:hidden">Tap for mammals</span>
                            <span class="hidden md:inline">Drop here</span>
                        </div>
                    </div>
                    <div id="mammals-items" class="mt-2 flex flex-wrap gap-1">
                        <!-- Classified mammals will appear here -->
                    </div>
                </div>
                
                <!-- Birds -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                    <div class="text-center mb-2">
                        <div class="text-2xl">ü¶Ö</div>
                        <h3 class="font-semibold text-blue-800 text-sm">Birds</h3>
                    </div>
                    <div class="drop-zone min-h-[80px] border-2 border-dashed border-blue-300 rounded-md p-2 text-center flex items-center justify-center touch-manipulation hover:border-blue-400 hover:bg-blue-100 transition-colors duration-200" 
                         data-category="birds" id="birds-zone">
                        <div class="text-blue-400 text-xs">
                            <span class="md:hidden">Tap for birds</span>
                            <span class="hidden md:inline">Drop here</span>
                        </div>
                    </div>
                    <div id="birds-items" class="mt-2 flex flex-wrap gap-1">
                        <!-- Classified birds will appear here -->
                    </div>
                </div>
                
                <!-- Fish -->
                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-3">
                    <div class="text-center mb-2">
                        <div class="text-2xl">üêü</div>
                        <h3 class="font-semibold text-green-800 text-sm">Fish</h3>
                    </div>
                    <div class="drop-zone min-h-[80px] border-2 border-dashed border-green-300 rounded-md p-2 text-center flex items-center justify-center touch-manipulation hover:border-green-400 hover:bg-green-100 transition-colors duration-200" 
                         data-category="fish" id="fish-zone">
                        <div class="text-green-400 text-xs">
                            <span class="md:hidden">Tap for fish</span>
                            <span class="hidden md:inline">Drop here</span>
                        </div>
                    </div>
                    <div id="fish-items" class="mt-2 flex flex-wrap gap-1">
                        <!-- Classified fish will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Compact Response & Actions -->
    <div class="mt-4 space-y-3">
        <!-- Buddy Response (Compact) -->
        <div id="buddy-response" class="bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-3 text-center" style="display: none;">
            <p id="buddy-message" class="text-sm text-gray-700 font-medium"></p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center space-x-3">
            <button id="complete-btn" class="px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg shadow-md hover:shadow-lg transition-all text-sm font-medium" style="display: none;">
                üéâ Complete Training
            </button>
        </div>
    </div>
</div>

<script>
// Drag & Drop Game State
let dragDropGameState = {
    currentAnimalIndex: 0,
    examplesGiven: 0,
    maxExamples: 16,
    animals: [
        { name: 'Dog', emoji: 'üêï', category: 'mammals' },
        { name: 'Cat', emoji: 'üê±', category: 'mammals' },
        { name: 'Eagle', emoji: 'ü¶Ö', category: 'birds' },
        { name: 'Goldfish', emoji: 'üê†', category: 'fish' },
        { name: 'Lion', emoji: 'ü¶Å', category: 'mammals' },
        { name: 'Parrot', emoji: 'ü¶ú', category: 'birds' },
        { name: 'Shark', emoji: 'ü¶à', category: 'fish' },
        { name: 'Elephant', emoji: 'üêò', category: 'mammals' }
    ],
    usedAnimals: [],
    learningData: {
        mammals: { correct: 0, total: 0 },
        birds: { correct: 0, total: 0 },
        fish: { correct: 0, total: 0 }
    }
};

function showBuddyMessage(message, isCorrect = true) {
    const responseDiv = document.getElementById('buddy-response');
    const messageEl = document.getElementById('buddy-message');
    
    messageEl.textContent = message;
    responseDiv.style.display = 'block';
    
    if (isCorrect) {
        responseDiv.className = 'bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-3 text-center';
    } else {
        responseDiv.className = 'bg-gradient-to-r from-orange-100 to-red-100 rounded-lg p-3 text-center';
    }
    
    setTimeout(() => {
        responseDiv.style.display = 'none';
    }, 3000);
}

function updateProgress() {
    const progress = (dragDropGameState.examplesGiven / dragDropGameState.maxExamples) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    document.getElementById('examples-count').textContent = dragDropGameState.examplesGiven;
    
    // Show complete button after max examples
    if (dragDropGameState.examplesGiven >= dragDropGameState.maxExamples) {
        document.getElementById('complete-btn').style.display = 'block';
        document.getElementById('new-animal-btn').style.display = 'none';
    }
}

function addNewAnimal() {
    // Get random animal that hasn't been used recently
    const availableAnimals = dragDropGameState.animals.filter(animal => 
        !dragDropGameState.usedAnimals.includes(animal.name)
    );
    
    if (availableAnimals.length === 0) {
        // Reset used animals if we've used them all
        dragDropGameState.usedAnimals = [];
        dragDropGameState.currentAnimalIndex = 0;
    }
    
    const currentAnimal = availableAnimals.length > 0 ? 
        availableAnimals[Math.floor(Math.random() * availableAnimals.length)] :
        dragDropGameState.animals[dragDropGameState.currentAnimalIndex % dragDropGameState.animals.length];
    
    dragDropGameState.usedAnimals.push(currentAnimal.name);
    
    // Add animal to the pool
    const animalPool = document.getElementById('animal-pool');
    animalPool.innerHTML = ''; // Clear previous animals
    
    const animalElement = document.createElement('div');
    animalElement.className = 'draggable-item bg-blue-50 border-2 border-blue-200 rounded-lg p-4 text-center cursor-grab hover:bg-blue-100 transition-colors shadow-sm';
    animalElement.draggable = true;
    animalElement.dataset.item = currentAnimal.name;
    animalElement.dataset.category = currentAnimal.category;
    animalElement.innerHTML = `
        <div class="text-4xl mb-2">${currentAnimal.emoji}</div>
        <div class="text-sm font-medium text-gray-800">${currentAnimal.name}</div>
    `;
    
    // Add drag event listeners
    animalElement.addEventListener('dragstart', function(e) {
        console.log('Drag started for:', this.dataset.item);
        this.classList.add('opacity-50');
        e.dataTransfer.setData('text/plain', this.dataset.item);
        e.dataTransfer.effectAllowed = 'move';
    });
    
    animalElement.addEventListener('dragend', function() {
        this.classList.remove('opacity-50');
    });
    
    animalPool.appendChild(animalElement);
}

// Set up drop zones
function setupDropZones() {
    console.log('Setting up drop zones...');
    const dropZones = document.querySelectorAll('.drop-zone');
    console.log('Found', dropZones.length, 'drop zones');
    
    dropZones.forEach(zone => {
        console.log('Setting up zone:', zone.dataset.category);
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('border-blue-400', 'bg-blue-50');
        });
        
        zone.addEventListener('dragleave', function() {
            this.classList.remove('border-blue-400', 'bg-blue-50');
        });
        
        zone.addEventListener('drop', function(e) {
            console.log('Drop event triggered!');
            e.preventDefault();
            this.classList.remove('border-blue-400', 'bg-blue-50');
            
            const animalName = e.dataTransfer.getData('text/plain');
            const category = this.dataset.category;
            
            console.log('Animal:', animalName, 'Category:', category);
            
            // Find the dragged animal element
            const animalElement = document.querySelector(`[data-item="${animalName}"]`);
            if (animalElement) {
                const correctCategory = animalElement.dataset.category;
                const isCorrect = correctCategory === category;
                
                console.log('Correct category:', correctCategory, 'Is correct:', isCorrect);
                
                // Move animal to category display
                const categoryItems = document.getElementById(category + '-items');
                const itemElement = document.createElement('span');
                itemElement.className = `inline-block ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-3 py-1 rounded-full text-sm font-medium m-1`;
                itemElement.innerHTML = `${animalElement.querySelector('.text-4xl').textContent} ${animalName}`;
                categoryItems.appendChild(itemElement);
                
                // Remove the draggable animal
                animalElement.remove();
                
                // Update drop zone text
                if (this.children.length === 1 && this.children[0].classList.contains('text-gray-400')) {
                    this.innerHTML = '';
                }
                
                // Record training data
                dragDropGameState.learningData[correctCategory].total++;
                if (isCorrect) {
                    dragDropGameState.learningData[correctCategory].correct++;
                }
                
                // Show feedback
                showBuddyMessage(`Thank you! I'll remember that ${animalName} is a ${category.slice(0, -1)}! I'm learning from your teaching! üåü`);
                
                dragDropGameState.examplesGiven++;
                updateProgress();
                
                // Add new animal after delay
                setTimeout(() => {
                    if (dragDropGameState.examplesGiven < dragDropGameState.maxExamples) {
                        addNewAnimal();
                    }
                }, 2000);
            } else {
                console.log('Animal element not found!');
            }
        });
    });
}

// Initialize game
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing game...');
    
    // Add a slight delay to ensure all elements are ready
    setTimeout(() => {
        setupDropZones();
        addNewAnimal();
    }, 100);
    
    // Event listeners
    document.getElementById('new-animal-btn').addEventListener('click', addNewAnimal);
    
    document.getElementById('complete-btn').addEventListener('click', function() {
        // Calculate basic learning statistics
        const overallAccuracy = dragDropGameState.examplesGiven > 0 ? 
            Math.round(((dragDropGameState.learningData.mammals.correct + 
                        dragDropGameState.learningData.birds.correct + 
                        dragDropGameState.learningData.fish.correct) / 
                       dragDropGameState.examplesGiven) * 100) : 0;
        
        let personalizedMessage = `Amazing training session! You taught me ${dragDropGameState.examplesGiven} examples! Thank you for making me smarter! üéì‚ú®`;
        
        showBuddyMessage(personalizedMessage);
        
        // Store training data for result page
        localStorage.setItem('aiTrainingData', JSON.stringify({
            categories: dragDropGameState.learningData,
            examples: dragDropGameState.examplesGiven,
            accuracy: overallAccuracy,
            gameType: 'drag_drop_game'
        }));
        
        setTimeout(() => {
            // Navigate directly to learning explanation
            window.location.href = '{% url "robotic_buddy:learning_explanation" %}';
        }, 4000);
    });
});
</script>
{% endblock %}