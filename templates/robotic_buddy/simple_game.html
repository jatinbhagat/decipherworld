{% extends 'robotic_buddy/base.html' %}

{% block game_title %}Train Your AI Buddy{% endblock %}

{% block game_content %}
<div class="max-w-4xl mx-auto px-4">
    <!-- Compact Header with Status -->
    <div class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 border-b border-gray-100 -mx-4 px-4 py-3 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white">
                    ğŸ¤–
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800">Train Your AI Buddy</h1>
                    <p class="text-xs text-gray-600 hidden sm:block">Tap the correct category for each animal</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800">
                        <span id="examples-count">0</span>/16
                    </div>
                    <div class="text-xs text-gray-500">examples</div>
                </div>
                <div class="w-16 h-2 bg-gray-200 rounded-full">
                    <div id="progress-bar" class="bg-gradient-to-r from-blue-400 to-purple-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Game Interface -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <!-- Animal Display -->
        <div class="bg-gradient-to-br from-gray-50 to-gray-100 px-6 py-8 text-center border-b border-gray-200">
            <div id="current-animal" class="space-y-3">
                <div class="text-7xl md:text-8xl">ğŸ•</div>
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">Dog</h2>
            </div>
        </div>
        
        <!-- Category Selection -->
        <div class="p-4">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 max-w-lg mx-auto">
                <button class="category-btn bg-orange-100 hover:bg-orange-200 active:bg-orange-300 border-2 border-orange-300 rounded-lg p-4 transition-all duration-200 transform hover:scale-105 active:scale-95 touch-manipulation min-h-[60px] flex flex-col items-center justify-center" data-category="mammals">
                    <div class="text-2xl mb-1">ğŸ¦</div>
                    <div class="font-bold text-orange-800 text-sm">Mammals</div>
                </button>
                
                <button class="category-btn bg-blue-100 hover:bg-blue-200 active:bg-blue-300 border-2 border-blue-300 rounded-lg p-4 transition-all duration-200 transform hover:scale-105 active:scale-95 touch-manipulation min-h-[60px] flex flex-col items-center justify-center" data-category="birds">
                    <div class="text-2xl mb-1">ğŸ¦…</div>
                    <div class="font-bold text-blue-800 text-sm">Birds</div>
                </button>
                
                <button class="category-btn bg-green-100 hover:bg-green-200 active:bg-green-300 border-2 border-green-300 rounded-lg p-4 transition-all duration-200 transform hover:scale-105 active:scale-95 touch-manipulation min-h-[60px] flex flex-col items-center justify-center" data-category="fish">
                    <div class="text-2xl mb-1">ğŸŸ</div>
                    <div class="font-bold text-green-800 text-sm">Fish</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Compact Response & Actions -->
    <div class="mt-4 space-y-3">
        <!-- Buddy Response (Compact) -->
        <div id="buddy-response" class="bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-3 text-center" style="display: none;">
            <p id="buddy-message" class="text-sm text-gray-700 font-medium"></p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center space-x-3">
            <button id="test-buddy-btn" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg shadow-md hover:shadow-lg transition-all text-sm font-medium" style="display: none;">
                ğŸ§  Test Knowledge
            </button>
            
            <button id="complete-btn" class="px-6 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg shadow-md hover:shadow-lg transition-all text-sm font-medium" style="display: none;">
                ğŸ‰ Complete Training
            </button>
        </div>
    </div>
</div>

<script>
// Simple game state
let currentAnimalIndex = 0;
let examplesGiven = 0;
let maxExamples = 16;
let isTestMode = false;

// Training data tracking
let categoryTrainingData = {
    mammals: { correct: 0, total: 0, examples: [] },
    birds: { correct: 0, total: 0, examples: [] },
    fish: { correct: 0, total: 0, examples: [] }
};

// Training thresholds
const MIN_EXAMPLES_FOR_AI = 16;
const MIN_EXAMPLES_PER_CATEGORY = 2;

// Simple animal dataset
const animals = [
    { name: 'Dog', emoji: 'ğŸ•', category: 'mammals' },
    { name: 'Cat', emoji: 'ğŸ±', category: 'mammals' },
    { name: 'Eagle', emoji: 'ğŸ¦…', category: 'birds' },
    { name: 'Fish', emoji: 'ğŸŸ', category: 'fish' },
    { name: 'Lion', emoji: 'ğŸ¦', category: 'mammals' },
    { name: 'Parrot', emoji: 'ğŸ¦œ', category: 'birds' },
    { name: 'Shark', emoji: 'ğŸ¦ˆ', category: 'fish' },
    { name: 'Elephant', emoji: 'ğŸ˜', category: 'mammals' }
];

function showAnimal(animal) {
    document.getElementById('current-animal').innerHTML = `
        <div class="text-8xl mb-4">${animal.emoji}</div>
        <h2 class="text-2xl font-bold text-gray-800">${animal.name}</h2>
    `;
}

function recordTrainingExample(selectedCategory, correctCategory, animalName) {
    const isCorrect = selectedCategory === correctCategory;
    
    // Record the training data based on what the USER taught (pure learning)
    categoryTrainingData[selectedCategory].total++;
    categoryTrainingData[selectedCategory].examples.push({
        animal: animalName,
        userGuess: selectedCategory,
        correct: isCorrect
    });
    
    // In pure learning, we always count it as "correct" since we're learning what the user teaches
    categoryTrainingData[selectedCategory].correct++;
}

function hasEnoughTrainingForAI() {
    return examplesGiven >= MIN_EXAMPLES_FOR_AI;
}

function getTrainingAccuracyForCategory(category) {
    const data = categoryTrainingData[category];
    if (data.total === 0) return 0.33; // Random guess if no training
    return data.correct / data.total;
}

function updateProgress() {
    const percent = (examplesGiven / maxExamples) * 100;
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('examples-count').textContent = examplesGiven;
    
    // Only show test button after sufficient training
    if (hasEnoughTrainingForAI()) {
        document.getElementById('test-buddy-btn').style.display = 'block';
    }
    
    if (examplesGiven >= maxExamples) {
        document.getElementById('complete-btn').style.display = 'block';
    }
}

function showBuddyMessage(message, isCorrect = true) {
    const responseDiv = document.getElementById('buddy-response');
    const messageEl = document.getElementById('buddy-message');
    
    messageEl.textContent = message;
    responseDiv.style.display = 'block';
    
    if (isCorrect) {
        responseDiv.className = 'bg-gradient-to-r from-green-100 to-blue-100 rounded-xl p-6 mb-8';
    } else {
        responseDiv.className = 'bg-gradient-to-r from-orange-100 to-red-100 rounded-xl p-6 mb-8';
    }
    
    setTimeout(() => {
        responseDiv.style.display = 'none';
    }, 3000);
}

function nextAnimal() {
    if (currentAnimalIndex < animals.length - 1) {
        currentAnimalIndex++;
        showAnimal(animals[currentAnimalIndex]);
    } else {
        // Restart from beginning
        currentAnimalIndex = 0;
        showAnimal(animals[currentAnimalIndex]);
    }
}

// Category button handlers
document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const selectedCategory = this.dataset.category;
        const currentAnimal = animals[currentAnimalIndex];
        const isCorrect = selectedCategory === currentAnimal.category;
        
        // Visual feedback
        if (isCorrect) {
            this.classList.add('bg-green-200', 'border-green-400');
            showBuddyMessage(`Thank you! I'll remember that ${currentAnimal.name} is a ${selectedCategory.slice(0, -1)}! I'm learning from your teaching! ğŸŒŸ`);
        } else {
            this.classList.add('bg-red-200', 'border-red-400');
            const correctCategory = currentAnimal.category;
            showBuddyMessage(`Thank you! I'll remember that ${currentAnimal.name} is a ${selectedCategory.slice(0, -1)}! I'm learning from your teaching! ğŸŒŸ`, true);
        }
        
        // Record training data
        recordTrainingExample(selectedCategory, currentAnimal.category, currentAnimal.name);
        
        // Disable buttons temporarily
        document.querySelectorAll('.category-btn').forEach(b => b.disabled = true);
        
        examplesGiven++;
        updateProgress();
        
        // Next animal after delay
        setTimeout(() => {
            // Reset button colors
            document.querySelectorAll('.category-btn').forEach(b => {
                b.classList.remove('bg-green-200', 'border-green-400', 'bg-red-200', 'border-red-400');
                b.disabled = false;
            });
            
            if (examplesGiven < maxExamples) {
                nextAnimal();
            }
        }, 2000);
    });
});

// Test buddy button
document.getElementById('test-buddy-btn').addEventListener('click', function() {
    // Check if AI has enough training
    if (!hasEnoughTrainingForAI()) {
        showBuddyMessage(
            `I need more training before I can make predictions! Please teach me at least ${MIN_EXAMPLES_FOR_AI} examples first. I've only learned from ${examplesGiven} examples so far. ğŸ“š`,
            false
        );
        return;
    }
    
    alert('ğŸ§  Testing mode! Now I\'ll try to guess the next animal myself based on what you\'ve taught me!');
    
    nextAnimal();
    const currentAnimal = animals[currentAnimalIndex];
    
    // AI prediction based on pure learning - what the user has taught
    let prediction;
    let confidence = 0;
    let reasoning = "";
    
    // Find the category the AI thinks this animal belongs to based on user training
    const trainedCategories = Object.keys(categoryTrainingData).filter(cat => 
        categoryTrainingData[cat].total > 0
    );
    
    if (trainedCategories.length === 0) {
        prediction = 'mammals'; // Default fallback
        confidence = 25;
        reasoning = "I haven't been trained on any categories yet, so I'm just guessing.";
    } else {
        // Check if the AI has seen this exact animal before
        let hasSeenAnimal = false;
        let learnedCategory = null;
        
        for (const category of trainedCategories) {
            const animalExample = categoryTrainingData[category].examples.find(ex => 
                ex.animal.toLowerCase() === currentAnimal.name.toLowerCase()
            );
            if (animalExample) {
                hasSeenAnimal = true;
                learnedCategory = category;
                break;
            }
        }
        
        if (hasSeenAnimal) {
            // AI has seen this exact animal before - high confidence
            prediction = learnedCategory;
            confidence = 95;
            reasoning = `I remember you taught me that ${currentAnimal.name} is a ${learnedCategory}!`;
        } else {
            // AI hasn't seen this animal - makes prediction based on most trained category
            prediction = trainedCategories.reduce((maxCat, cat) => 
                categoryTrainingData[cat].total > categoryTrainingData[maxCat].total ? cat : maxCat
            );
            confidence = Math.min(70, categoryTrainingData[prediction].total * 5);
            reasoning = `I haven't seen ${currentAnimal.name} before, but based on my training, I think it's probably a ${prediction}.`;
        }
    }
    
    // In pure learning, "correct" means matching what the user taught
    const correctCategory = currentAnimal.category; // Still needed for display
    const isCorrect = prediction === correctCategory;
    
    setTimeout(() => {
        showBuddyMessage(
            `I think this ${currentAnimal.name} is a ${prediction.slice(0, -1)}! I'm ${confidence}% confident. ${reasoning} ${isCorrect ? 'Did I get it right? ğŸ‰' : 'Was I correct? ğŸ¤”'}`,
            isCorrect
        );
    }, 1000);
});

// Complete button
document.getElementById('complete-btn').addEventListener('click', function() {
    // Store training data for result page
    const trainingData = {
        categories: categoryTrainingData,
        examples: examplesGiven,
        gameType: 'simple_game'
    };
    localStorage.setItem('aiTrainingData', JSON.stringify(trainingData));
    console.log('ğŸ¯ DEBUG: Saved training data to localStorage:', trainingData);
    
    // Navigate directly to learning explanation
    console.log('ğŸ¯ DEBUG: Redirecting to learning explanation...');
    window.location.href = '{% url "robotic_buddy:learning_explanation" %}';
});

// Initialize
showAnimal(animals[0]);
</script>
{% endblock %}