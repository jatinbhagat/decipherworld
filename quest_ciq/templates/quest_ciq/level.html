{% extends "quest_ciq/base.html" %}
{% load static %}

{% block title %}Level {{ level_order }}: {{ level_config.name }} - CIQ{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Progress Bar -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-semibold">Quest Progress</span>
            <span class="text-sm">{{ level_order }}/5</span>
        </div>
        <progress class="progress progress-primary w-full" value="{{ level_order }}" max="5"></progress>

        <!-- Progress Milestones -->
        <div class="flex justify-between mt-2 text-xs">
            <span class="{% if level_order >= 1 %}text-primary font-bold{% endif %}">üëÄ</span>
            <span class="{% if level_order >= 2 %}text-primary font-bold{% endif %}">üéØ</span>
            <span class="{% if level_order >= 3 %}text-primary font-bold{% endif %}">üí°</span>
            <span class="{% if level_order >= 4 %}text-primary font-bold{% endif %}">üõ†Ô∏è</span>
            <span class="{% if level_order >= 5 %}text-primary font-bold{% endif %}">üß™</span>
        </div>
    </div>

    <!-- Level Card -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <!-- Level Header -->
            <div class="flex items-center justify-between mb-4">
                <h2 class="card-title text-4xl">
                    {{ level_config.emoji }} Level {{ level_order }}: {{ level_config.name }}
                </h2>

                <!-- Tooltip -->
                {% if level_config.tooltip %}
                <div class="tooltip tooltip-left" data-tip="{{ level_config.tooltip }}">
                    <button class="btn btn-circle btn-sm btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-6 h-6 stroke-current">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>

            <div class="divider"></div>

            <!-- Already Completed Notice -->
            {% if already_completed %}
            <div class="alert alert-info mb-4">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>You've already completed this level. Submitting again will update your answer.</span>
                </div>
            </div>
            {% endif %}

            <!-- Level Form -->
            <form method="post" enctype="multipart/form-data" id="level-form">
                {% csrf_token %}

                <!-- Level 1: Empathy -->
                {% if level_order == 1 %}
                {% include "quest_ciq/levels/level1_empathy.html" %}

                <!-- Level 2: Define -->
                {% elif level_order == 2 %}
                {% include "quest_ciq/levels/level2_define.html" %}

                <!-- Level 3: Ideate -->
                {% elif level_order == 3 %}
                {% include "quest_ciq/levels/level3_ideate.html" %}

                <!-- Level 4: Prototype -->
                {% elif level_order == 4 %}
                {% include "quest_ciq/levels/level4_prototype.html" %}

                <!-- Level 5: Test -->
                {% elif level_order == 5 %}
                {% include "quest_ciq/levels/level5_test.html" %}

                {% endif %}

                <!-- Submit Button -->
                <div class="form-control mt-6">
                    <button type="submit" class="btn btn-primary btn-lg btn-block">
                        {% if level_order < 5 %}
                        Complete & Continue ‚Üí
                        {% else %}
                        üéâ Complete Quest!
                        {% endif %}
                    </button>
                </div>
            </form>

            <!-- Navigation -->
            <div class="divider"></div>
            <div class="flex justify-between">
                {% if level_order > 1 %}
                <a href="{% url 'quest_ciq:level' session_code=session.session_code level_order=level_order|add:'-1' %}"
                   class="btn btn-ghost">
                    ‚Üê Previous Level
                </a>
                {% else %}
                <div></div>
                {% endif %}

                <a href="{% url 'quest_ciq:progress' session_code=session.session_code %}"
                   class="btn btn-ghost">
                    View Progress
                </a>
            </div>
        </div>
    </div>

    <!-- Student Info -->
    <div class="text-center mt-4 text-sm text-base-content/70">
        Student: <strong>{{ session.student_name }}</strong> | Session: <strong>{{ session.session_code }}</strong> | Score: <strong>{{ session.total_score }}</strong> points
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'quest_ciq/js/level-forms.js' %}"></script>

{% if level_order == 1 %}
<script src="{% static 'quest_ciq/js/level1-priority.js' %}"></script>
{% endif %}
{% endblock %}
