{% extends 'quest_ciq/base.html' %}

{% block title %}{{ quest.title }} - Level {{ order }}: {{ level.name }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <!-- Progress Bar -->
    <div class="mb-8">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>Level {{ order }} of 5</span>
            <span>{{ progress_percent|floatformat:0 }}% Complete</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div class="progress-bar bg-blue-600 h-3 rounded-full" style="width: {{ progress_percent }}%"></div>
        </div>
    </div>

    <!-- Level Card -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <!-- Level Header -->
        <div class="mb-6">
            <div class="flex items-center mb-4">
                <div class="w-16 h-16 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-2xl mr-4">
                    {{ order }}
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">{{ level.name }}</h1>
                    <p class="text-gray-600 text-lg">{{ level.short_help }}</p>
                </div>
            </div>
        </div>

        {% if is_frozen %}
        <!-- Frozen Session Warning -->
        <div class="bg-red-100 border-2 border-red-500 rounded-lg p-6 text-center">
            <h3 class="text-xl font-bold text-red-700 mb-2">Session Frozen</h3>
            <p class="text-red-600">This session is frozen. You cannot make changes at this time.</p>
            <a href="{% url 'quest_ciq:quest_home_slug' slug=quest.slug %}"
               class="inline-block mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                Back to Home
            </a>
        </div>
        {% else %}
        <!-- Form -->
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded mb-4">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            {% for field in form %}
            <div>
                <label for="{{ field.id_for_label }}" class="block text-sm font-bold text-gray-700 mb-2">
                    {{ field.label }}
                    {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                </label>

                {{ field }}

                {% if field.help_text %}
                <p class="mt-1 text-sm text-gray-500">{{ field.help_text|safe }}</p>
                {% endif %}

                {% if field.errors %}
                <p class="mt-1 text-sm text-red-600">{{ field.errors.0 }}</p>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Scoring Info -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                <h4 class="font-bold text-blue-800 mb-2">Scoring</h4>
                <p class="text-sm text-blue-700">
                    <strong>Base:</strong> +10 points for completing this level
                    {% if order == 3 %}
                    <br><strong>Bonus:</strong> +10 points if you provide at least 2 ideas or write 120+ characters
                    {% elif order == 4 %}
                    <br><strong>Bonus:</strong> +10 points if you provide a prototype link or upload an image
                    {% elif order == 5 %}
                    <br><strong>Bonus:</strong> +10 points if peer rating is 4 or higher
                    {% endif %}
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-between items-center pt-4">
                <a href="{% url 'quest_ciq:quest_home_slug' slug=quest.slug %}"
                   class="text-gray-600 hover:text-gray-800 font-medium">
                    ‚Üê Back to Home
                </a>

                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200">
                    {% if existing_response %}
                        Update & Continue
                    {% else %}
                        Submit & Continue
                    {% endif %}
                </button>
            </div>
        </form>
        {% endif %}
    </div>

    <!-- Helper Tips -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
        <h4 class="font-bold text-yellow-800 mb-2">Tips for Level {{ order }}: {{ level.name }}</h4>
        <ul class="list-disc list-inside text-sm text-yellow-700 space-y-1">
            {% if order == 1 %}
            <li>Observe your classroom or community carefully</li>
            <li>Think about what makes learning difficult or uncomfortable</li>
            <li>Focus on problems that affect real people</li>
            {% elif order == 2 %}
            <li>Be clear and specific in your problem statement</li>
            <li>Ask "why" multiple times to find root causes</li>
            <li>Think about the underlying factors, not just symptoms</li>
            {% elif order == 3 %}
            <li>Aim for quantity over quality - the more ideas, the better!</li>
            <li>Think outside the box - wild ideas are welcome</li>
            <li>Build on your observations from previous levels</li>
            {% elif order == 4 %}
            <li>Start simple - sketches, drawings, or digital mockups all work</li>
            <li>Focus on showing your key idea, not perfection</li>
            <li>You can use free tools like Figma, Canva, or Google Slides</li>
            {% elif order == 5 %}
            <li>Get honest feedback from a classmate or friend</li>
            <li>Ask specific questions about your prototype</li>
            <li>Use feedback to improve your solution</li>
            {% endif %}
        </ul>
    </div>
</div>
{% endblock %}
