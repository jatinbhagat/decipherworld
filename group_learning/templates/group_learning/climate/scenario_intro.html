{% extends "base.html" %}
{% load static %}

{% block title %}Climate Crisis: {{ scenario.title }} - Round {{ session.current_round }}{% endblock %}

{% block description %}Climate Crisis India simulation - experiencing {{ scenario.title }} from the perspective of {{ role_display }}.{% endblock %}

{% block content %}
<!-- Climate Game Scenario Introduction with Animated Background -->
<div class="relative min-h-screen overflow-hidden">
    <!-- Round-Specific CSS Background -->
    <div class="absolute inset-0 w-full h-full z-10" id="scenario-background">
        {% if session.current_round == 1 %}
            <!-- Delhi Air Pollution: Smoggy brown/orange gradients -->
            <div class="w-full h-full" style="background: linear-gradient(135deg, #8B4513 0%, #CD853F 25%, #DEB887 50%, #F4A460 75%, #D2691E 100%);"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-amber-900/40 via-orange-800/20 to-yellow-700/30"></div>
        {% elif session.current_round == 2 %}
            <!-- Mumbai Floods: Blue/grey rain gradients -->
            <div class="w-full h-full" style="background: linear-gradient(135deg, #2C3E50 0%, #3498DB 25%, #5DADE2 50%, #85C1E9 75%, #AED6F1 100%);"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-blue-900/40 via-blue-700/20 to-slate-600/30"></div>
        {% elif session.current_round == 3 %}
            <!-- Chennai Drought: Yellow/brown drought gradients -->
            <div class="w-full h-full" style="background: linear-gradient(135deg, #B7950B 0%, #D4AC0D 25%, #F1C40F 50%, #F7DC6F 75%, #FCF3CF 100%);"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-yellow-800/40 via-amber-600/20 to-orange-500/30"></div>
        {% elif session.current_round == 4 %}
            <!-- Heatwave: Red/orange heat gradients -->
            <div class="w-full h-full" style="background: linear-gradient(135deg, #922B21 0%, #CB4335 25%, #E74C3C 50%, #F1948A 75%, #FADBD8 100%);"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-red-900/40 via-orange-700/20 to-yellow-600/30"></div>
        {% elif session.current_round == 5 %}
            <!-- Election: Blue/white political gradients -->
            <div class="w-full h-full" style="background: linear-gradient(135deg, #1B4F72 0%, #2874A6 25%, #3498DB 50%, #AED6F1 75%, #EBF5FB 100%);"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-blue-800/40 via-indigo-600/20 to-blue-400/30"></div>
        {% endif %}
        
        <!-- Floating particles animation for all rounds -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute w-2 h-2 bg-white/20 rounded-full animate-pulse" style="left: 12%; top: 15%; animation-delay: 0.5s; animation-duration: 4s;"></div>
            <div class="absolute w-2 h-2 bg-white/20 rounded-full animate-pulse" style="left: 24%; top: 30%; animation-delay: 1s; animation-duration: 5s;"></div>
            <div class="absolute w-2 h-2 bg-white/20 rounded-full animate-pulse" style="left: 36%; top: 45%; animation-delay: 1.5s; animation-duration: 6s;"></div>
            <div class="absolute w-2 h-2 bg-white/20 rounded-full animate-pulse" style="left: 48%; top: 60%; animation-delay: 2s; animation-duration: 7s;"></div>
            <div class="absolute w-2 h-2 bg-white/20 rounded-full animate-pulse" style="left: 60%; top: 75%; animation-delay: 2.5s; animation-duration: 8s;"></div>
            <div class="absolute w-2 h-2 bg-white/20 rounded-full animate-pulse" style="left: 72%; top: 20%; animation-delay: 3s; animation-duration: 9s;"></div>
            <div class="absolute w-2 h-2 bg-white/20 rounded-full animate-pulse" style="left: 84%; top: 35%; animation-delay: 3.5s; animation-duration: 10s;"></div>
            <div class="absolute w-2 h-2 bg-white/20 rounded-full animate-pulse" style="left: 16%; top: 80%; animation-delay: 4s; animation-duration: 11s;"></div>
        </div>
    </div>
    
    <!-- Round-Specific Status Indicator -->
    <div class="absolute top-4 right-4 z-30 rounded-lg border-2 shadow-lg px-4 py-2 text-white" id="status-indicator">
        {% if session.current_round == 1 %}
            <div class="bg-red-900/90 border-red-500 p-1 rounded">
                <div class="text-xs font-bold text-center">AQI DELHI</div>
                <div class="text-2xl font-bold text-red-300 text-center">450+</div>
                <div class="text-xs font-bold text-red-300 text-center">SEVERE</div>
            </div>
        {% elif session.current_round == 2 %}
            <div class="bg-blue-900/90 border-blue-500 p-1 rounded">
                <div class="text-xs font-bold text-center">MUMBAI RAIN</div>
                <div class="text-2xl font-bold text-blue-300 text-center">300mm</div>
                <div class="text-xs font-bold text-blue-300 text-center">FLOOD ALERT</div>
            </div>
        {% elif session.current_round == 3 %}
            <div class="bg-yellow-900/90 border-yellow-500 p-1 rounded">
                <div class="text-xs font-bold text-center">CHENNAI WATER</div>
                <div class="text-2xl font-bold text-yellow-300 text-center">15%</div>
                <div class="text-xs font-bold text-yellow-300 text-center">CRITICAL</div>
            </div>
        {% elif session.current_round == 4 %}
            <div class="bg-orange-900/90 border-orange-500 p-1 rounded">
                <div class="text-xs font-bold text-center">TEMPERATURE</div>
                <div class="text-2xl font-bold text-orange-300 text-center">48¬∞C</div>
                <div class="text-xs font-bold text-orange-300 text-center">EXTREME</div>
            </div>
        {% elif session.current_round == 5 %}
            <div class="bg-purple-900/90 border-purple-500 p-1 rounded">
                <div class="text-xs font-bold text-center">ELECTION</div>
                <div class="text-2xl font-bold text-purple-300 text-center">72%</div>
                <div class="text-xs font-bold text-purple-300 text-center">TURNOUT</div>
            </div>
        {% endif %}
    </div>
    
    <!-- Simplified Content Overlay - Remove backdrop-blur that conflicts with animation -->
    <div class="relative z-30 min-h-screen px-2 py-4">
        <div class="bg-black/30 rounded-lg p-2 max-w-md mx-auto border border-white/10 shadow-lg">
        
            <!-- Minimal Header -->
            <div class="text-center mb-2">
                <div class="flex items-center justify-center mb-1">
                    <span class="bg-red-500/80 text-white px-1 py-0.5 rounded text-xs font-medium mr-1">
                        CRISIS
                    </span>
                    <span class="bg-orange-500/80 text-white px-1 py-0.5 rounded text-xs font-medium">
                        R{{ session.current_round }}/5
                    </span>
                </div>
                <h1 class="text-lg font-bold mb-1 text-white drop-shadow-lg">
                    {{ scenario.emoji }} {{ scenario.title }}
                </h1>
                <p class="text-xs text-white/95 mb-1 drop-shadow">
                    Playing as: <strong>{{ role_display }}</strong>
                </p>
            </div>

            <!-- Minimal Scenario Description -->
            <div class="bg-white/85 rounded p-1 mb-1">
                <h2 class="text-xs font-bold text-gray-900 mb-0.5 text-center">üì∞ Breaking News</h2>
                <div class="text-gray-700 text-xs leading-tight">
                    {{ scenario.description|linebreaks }}
                </div>
            </div>

            <!-- Minimal Role Context -->
            <div class="bg-black/20 rounded p-1 border border-white/10 mb-1">
                <div class="text-center">
                    <div class="text-sm mb-0.5">
                        {% if assigned_role == 'government' %}üèõÔ∏è
                        {% elif assigned_role == 'business' %}üè¢
                        {% elif assigned_role == 'farmer' %}üåæ
                        {% elif assigned_role == 'urban_citizen' %}üèôÔ∏è
                        {% elif assigned_role == 'ngo_worker' %}ü§ù
                        {% endif %}
                    </div>
                    <h3 class="text-xs font-bold mb-0.5 text-white drop-shadow">{{ role_display }}</h3>
                    <p class="text-xs text-white/90 leading-tight">
                        {% if assigned_role == 'government' %}
                            Balance interests, budget, pressure.
                        {% elif assigned_role == 'business' %}
                            Focus on profitability vs regulations.
                        {% elif assigned_role == 'farmer' %}
                            Climate impacts crops directly.
                        {% elif assigned_role == 'urban_citizen' %}
                            Deal with air quality and heat.
                        {% elif assigned_role == 'ngo_worker' %}
                            Advocate for environment.
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Minimal Society Meters -->
            <div class="bg-white/80 rounded p-1 mb-1">
                <h2 class="text-xs font-bold text-gray-900 mb-0.5 text-center">üìä Status</h2>
                <div class="grid grid-cols-4 gap-0.5">
                    <div class="text-center">
                        <div class="bg-green-100 rounded p-0.5">
                            <div class="text-xs mb-0">üå±</div>
                            <div class="text-xs font-medium text-green-900">Climate</div>
                            <div class="text-xs font-bold text-green-700">{{ meter_status.climate_resilience }}%</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="bg-blue-100 rounded p-0.5">
                            <div class="text-xs mb-0">üí∞</div>
                            <div class="text-xs font-medium text-blue-900">GDP</div>
                            <div class="text-xs font-bold text-blue-700">{{ meter_status.gdp }}%</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="bg-purple-100 rounded p-0.5">
                            <div class="text-xs mb-0">üòä</div>
                            <div class="text-xs font-medium text-purple-900">Morale</div>
                            <div class="text-xs font-bold text-purple-700">{{ meter_status.public_morale }}%</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="bg-emerald-100 rounded p-0.5">
                            <div class="text-xs mb-0">üåç</div>
                            <div class="text-xs font-medium text-emerald-900">Environment</div>
                            <div class="text-xs font-bold text-emerald-700">{{ meter_status.environmental_health }}%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Minimal Ready Section -->
            <div class="bg-black/25 rounded p-1 border border-white/10 text-center">
                <h2 class="text-xs font-bold mb-0.5 text-white drop-shadow">‚è≥ Ready</h2>
                <p class="text-xs text-white/95 mb-0.5">
                    60 seconds to respond.
                </p>
                <p class="text-xs text-white/95 mb-1">
                    Decisions affect India's future.
                </p>
                <div class="mt-1">
                    <div class="animate-pulse text-yellow-300" id="waiting-status">
                        <svg class="w-3 h-3 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                        <p class="mt-0.5 text-xs text-white/80">Waiting...</p>
                    </div>
                    <!-- Minimal Connection Status -->
                    <div class="mt-0.5 text-xs text-white/60" id="connection-status">
                        <span id="ws-status" class="inline-block w-1.5 h-1.5 bg-yellow-400 rounded-full mr-1"></span>
                        <span id="status-text">Connecting...</span>
                    </div>
                    <!-- Minimal Emergency Refresh -->
                    <div class="mt-0.5 hidden" id="emergency-refresh">
                        <button onclick="window.location.reload()" class="bg-red-500/80 hover:bg-red-600/80 text-white px-1 py-0.5 rounded text-xs">
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Realistic Delhi India Gate CSS Animation - Round 1 -->
<style>
/* Delhi Animation Styles */
.delhi-animation-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    z-index: 10;
}

.delhi-svg {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Floating Particles Animation */
@keyframes floatParticles {
    0% { transform: translateX(-30px) translateY(0px); opacity: 0.3; }
    25% { transform: translateX(20px) translateY(-15px); opacity: 0.6; }
    50% { transform: translateX(50px) translateY(-5px); opacity: 0.4; }
    75% { transform: translateX(80px) translateY(-20px); opacity: 0.5; }
    100% { transform: translateX(120px) translateY(-10px); opacity: 0.2; }
}

/* People Walking Animation */
@keyframes walkLeftToRight {
    0% { transform: translateX(-100px); }
    100% { transform: translateX(1200px); }
}

/* Exhaust Puffing Animation */
@keyframes exhaustPuff {
    0% { transform: scale(0) translateX(0); opacity: 0; }
    20% { transform: scale(1) translateX(-10px); opacity: 0.6; }
    60% { transform: scale(1.5) translateX(-30px); opacity: 0.4; }
    100% { transform: scale(2) translateX(-60px); opacity: 0; }
}

/* Smog Layer Drift */
@keyframes smogDrift {
    0% { transform: translateX(0px); }
    50% { transform: translateX(30px); }
    100% { transform: translateX(0px); }
}

/* Apply animations to SVG elements */
#pollutionParticles circle:nth-child(1) { animation: floatParticles 12s infinite linear; animation-delay: 0s; }
#pollutionParticles circle:nth-child(2) { animation: floatParticles 15s infinite linear; animation-delay: 2s; }
#pollutionParticles circle:nth-child(3) { animation: floatParticles 18s infinite linear; animation-delay: 4s; }
#pollutionParticles circle:nth-child(4) { animation: floatParticles 14s infinite linear; animation-delay: 6s; }
#pollutionParticles circle:nth-child(5) { animation: floatParticles 16s infinite linear; animation-delay: 1s; }
#pollutionParticles circle:nth-child(6) { animation: floatParticles 13s infinite linear; animation-delay: 3s; }
#pollutionParticles circle:nth-child(7) { animation: floatParticles 17s infinite linear; animation-delay: 5s; }
#pollutionParticles circle:nth-child(8) { animation: floatParticles 11s infinite linear; animation-delay: 7s; }

#person1 { animation: walkLeftToRight 25s infinite linear; animation-delay: 0s; }
#person2 { animation: walkLeftToRight 30s infinite linear; animation-delay: 5s; }
#person3 { animation: walkLeftToRight 20s infinite linear; animation-delay: 10s; }
#person4 { animation: walkLeftToRight 35s infinite linear; animation-delay: 15s; }

#exhaust1 { animation: exhaustPuff 3s infinite ease-out; animation-delay: 0s; }
#exhaust2 { animation: exhaustPuff 4s infinite ease-out; animation-delay: 1s; }
#exhaust3 { animation: exhaustPuff 2.5s infinite ease-out; animation-delay: 2s; }

.delhi-svg ellipse[fill*="smogLayer"] { animation: smogDrift 20s infinite ease-in-out; }
</style>

<script>
// Simple floating particles animation for enhanced visual appeal
function initializeParticleAnimation() {
    const backgroundDiv = document.getElementById('scenario-background');
    if (!backgroundDiv) return;
    
    // Add some gentle movement to particles
    const particles = backgroundDiv.querySelectorAll('.animate-pulse');
    particles.forEach((particle, index) => {
        // Add gentle floating movement
        setInterval(() => {
            const randomX = Math.sin(Date.now() / (1000 + index * 100)) * 10;
            const randomY = Math.cos(Date.now() / (1500 + index * 150)) * 5;
            particle.style.transform = `translate(${randomX}px, ${randomY}px)`;
        }, 50);
    });
}

document.addEventListener('DOMContentLoaded', initializeParticleAnimation);
</script>

<script>
// BULLETPROOF PHASE TRANSITION SYSTEM
// Combines WebSocket + aggressive HTTP polling to eliminate stuck students
const SESSION_CODE = '{{ session.session_code }}';
let socket = null;
let pollingInterval = null;
let wsConnected = false;
let reconnectAttempts = 0;
let maxReconnectAttempts = 10;

// Connection status management
function updateConnectionStatus(status, text) {
    const wsStatusEl = document.getElementById('ws-status');
    const statusTextEl = document.getElementById('status-text');
    const emergencyRefreshEl = document.getElementById('emergency-refresh');
    
    if (wsStatusEl && statusTextEl) {
        wsStatusEl.className = `inline-block w-2 h-2 rounded-full mr-1 ${status}`;
        statusTextEl.textContent = text;
        
        // Show emergency refresh if connection problems persist
        if (emergencyRefreshEl) {
            if (text.includes('Issues') || reconnectAttempts > 3) {
                emergencyRefreshEl.classList.remove('hidden');
            }
        }
    }
}

// HTTP Polling fallback - checks session phase every 2 seconds
function startAggressivePolling() {
    if (pollingInterval) return; // Already polling
    
    console.log('üîÑ Starting aggressive HTTP polling fallback');
    pollingInterval = setInterval(async () => {
        try {
            const response = await fetch(`/learn/api/climate/${SESSION_CODE}/status/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('üìä Polling check - Current phase:', data.current_phase);
                
                // CRITICAL: Force redirect if phase changed to question_phase
                if (data.current_phase === 'question_phase') {
                    console.log('üéØ POLLING DETECTED PHASE CHANGE -> Redirecting to question phase');
                    clearInterval(pollingInterval);
                    window.location.href = `/learn/climate/${SESSION_CODE}/play/`;
                    return;
                }
            } else {
                console.warn('‚ö†Ô∏è Polling request failed:', response.status);
            }
        } catch (error) {
            console.error('‚ùå Polling error:', error);
        }
    }, 2000); // Poll every 2 seconds
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('üõë Stopped HTTP polling');
    }
}

// WebSocket connection with exponential backoff
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/climate/${SESSION_CODE}/`;
    
    console.log(`üîå Attempting WebSocket connection (attempt ${reconnectAttempts + 1})`);
    updateConnectionStatus('bg-yellow-400', 'Connecting...');
    
    socket = new WebSocket(wsUrl);
    
    socket.onopen = function() {
        console.log('‚úÖ WebSocket connected successfully');
        wsConnected = true;
        reconnectAttempts = 0;
        updateConnectionStatus('bg-green-400', 'Connected');
        
        // Join as player
        socket.send(JSON.stringify({
            type: 'join_as_player',
            player_name: '{{ player_name }}'
        }));
        
        // WebSocket working, but keep polling as backup
        startAggressivePolling();
    };
    
    socket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® WebSocket received:', data);
            
            if (data.type === 'phase_changed') {
                if (data.new_phase === 'question_phase') {
                    console.log('üéØ WEBSOCKET DETECTED PHASE CHANGE -> Redirecting to question phase');
                    stopPolling();
                    window.location.href = `/learn/climate/${SESSION_CODE}/play/`;
                    return;
                }
            }
        } catch (error) {
            console.error('‚ùå Error parsing WebSocket message:', error);
        }
    };
    
    socket.onerror = function(error) {
        console.error('‚ùå WebSocket error:', error);
        wsConnected = false;
        updateConnectionStatus('bg-red-400', 'Connection Issues');
    };
    
    socket.onclose = function(event) {
        console.log(`üîå WebSocket closed (code: ${event.code}, reason: ${event.reason})`);
        wsConnected = false;
        
        // Start polling immediately when WebSocket fails
        if (!pollingInterval) {
            startAggressivePolling();
        }
        
        // Attempt reconnection with exponential backoff
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
            console.log(`üîÑ Reconnecting in ${delay}ms...`);
            updateConnectionStatus('bg-orange-400', `Reconnecting (${reconnectAttempts}/${maxReconnectAttempts})...`);
            setTimeout(connectWebSocket, delay);
        } else {
            console.warn('‚ö†Ô∏è Max reconnection attempts reached');
            updateConnectionStatus('bg-red-400', 'Connection Failed - Using Backup');
        }
    };
}

// Get CSRF token for API requests
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

// Initialize the bulletproof system
function initializeBulletproofSystem() {
    console.log('üöÄ Initializing bulletproof phase transition system');
    
    // Start WebSocket connection
    connectWebSocket();
    
    // Start polling as immediate backup (will be redundant but ensures reliability)
    startAggressivePolling();
    
    // Health check every 10 seconds
    setInterval(() => {
        if (!wsConnected && !pollingInterval) {
            console.log('ü©∫ Health check: Both WebSocket and polling failed, restarting...');
            connectWebSocket();
            startAggressivePolling();
        }
    }, 10000);
}

// Start the bulletproof system when page loads
document.addEventListener('DOMContentLoaded', initializeBulletproofSystem);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    stopPolling();
    if (socket) {
        socket.close();
    }
});
</script>
{% endblock %}
