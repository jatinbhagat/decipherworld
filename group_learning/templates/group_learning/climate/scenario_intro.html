{% extends "base.html" %}
{% load static %}

{% block title %}Climate Crisis: {{ scenario.title }} - Round {{ session.current_round }}{% endblock %}

{% block description %}Climate Crisis India simulation - experiencing {{ scenario.title }} from the perspective of {{ role_display }}.{% endblock %}

{% block content %}
<!-- Climate Game Scenario Introduction -->
<div class="bg-gradient-to-br from-green-600 via-emerald-700 to-teal-800 text-white overflow-hidden relative min-h-screen">
    <div class="absolute inset-0 bg-black/20"></div>
    <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="flex items-center justify-center mb-6">
                <span class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-medium mr-3">
                    CLIMATE CRISIS SIMULATION
                </span>
                <span class="bg-orange-500 text-white px-4 py-2 rounded-full text-sm font-medium">
                    ROUND {{ session.current_round }} of 5
                </span>
            </div>
            <h1 class="text-4xl sm:text-5xl font-bold mb-6">
                {{ scenario.emoji }} {{ scenario.title }}
            </h1>
            <p class="text-xl opacity-90 mb-8">
                Playing as: <strong>{{ role_display }}</strong>
            </p>
        </div>

        <!-- Scenario Description Card -->
        <div class="bg-white rounded-2xl p-8 shadow-xl mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">📰 Breaking News</h2>
            <div class="text-gray-700 text-lg leading-relaxed">
                {{ scenario.description|linebreaks }}
            </div>
        </div>

        <!-- Role Context Card -->
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-8 border border-white/20 mb-8">
            <h2 class="text-2xl font-bold mb-6 text-center">🎭 Your Perspective</h2>
            <div class="text-center">
                <div class="text-4xl mb-4">
                    {% if assigned_role == 'government' %}🏛️
                    {% elif assigned_role == 'business' %}🏢
                    {% elif assigned_role == 'farmer' %}🌾
                    {% elif assigned_role == 'urban_citizen' %}🏙️
                    {% elif assigned_role == 'ngo_worker' %}🤝
                    {% endif %}
                </div>
                <h3 class="text-xl font-bold mb-4">{{ role_display }}</h3>
                <p class="text-lg opacity-90">
                    {% if assigned_role == 'government' %}
                        As a government official, you must balance national interests, budget constraints, and public pressure while making policy decisions that affect millions of people.
                    {% elif assigned_role == 'business' %}
                        As a business owner, you focus on profitability, job creation, and competitiveness while managing environmental regulations and market pressures.
                    {% elif assigned_role == 'farmer' %}
                        As a farmer, you experience climate impacts directly through changing weather patterns, crop yields, and traditional farming practices.
                    {% elif assigned_role == 'urban_citizen' %}
                        As an urban citizen, you deal with daily impacts like air quality, flooding, heat waves, and the cost of living in India's growing cities.
                    {% elif assigned_role == 'ngo_worker' %}
                        As an NGO worker, you advocate for environmental protection, community welfare, and hold stakeholders accountable for climate action.
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Society Meters -->
        <div class="bg-white rounded-2xl p-8 shadow-xl mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">📊 Current Society Status</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="bg-green-100 rounded-lg p-4">
                        <div class="text-2xl mb-2">🌱</div>
                        <div class="text-sm font-medium text-green-900">Climate Resilience</div>
                        <div class="text-lg font-bold text-green-700">{{ meter_status.climate_resilience }}%</div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-blue-100 rounded-lg p-4">
                        <div class="text-2xl mb-2">💰</div>
                        <div class="text-sm font-medium text-blue-900">GDP Growth</div>
                        <div class="text-lg font-bold text-blue-700">{{ meter_status.gdp }}%</div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-purple-100 rounded-lg p-4">
                        <div class="text-2xl mb-2">😊</div>
                        <div class="text-sm font-medium text-purple-900">Public Morale</div>
                        <div class="text-lg font-bold text-purple-700">{{ meter_status.public_morale }}%</div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-emerald-100 rounded-lg p-4">
                        <div class="text-2xl mb-2">🌍</div>
                        <div class="text-sm font-medium text-emerald-900">Environment</div>
                        <div class="text-lg font-bold text-emerald-700">{{ meter_status.environmental_health }}%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ready to Continue -->
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-8 border border-white/20 text-center">
            <h2 class="text-2xl font-bold mb-6">⏳ Get Ready to Decide</h2>
            <p class="text-lg opacity-90 mb-6">
                In a moment, you'll see a question specific to your role. You'll have 60 seconds to choose your response.
            </p>
            <p class="text-lg opacity-90">
                Remember: Think from your role's perspective. Every decision has consequences for India's future.
            </p>
            <div class="mt-8">
                <div class="animate-pulse text-yellow-300" id="waiting-status">
                    <svg class="w-8 h-8 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                    </svg>
                    <p class="mt-2 text-sm">Waiting for your teacher to start the question...</p>
                </div>
                <!-- Connection Status Indicator -->
                <div class="mt-4 text-xs opacity-75" id="connection-status">
                    <span id="ws-status" class="inline-block w-2 h-2 bg-yellow-400 rounded-full mr-1"></span>
                    <span id="status-text">Connecting...</span>
                </div>
                <!-- Emergency Refresh Option -->
                <div class="mt-4 hidden" id="emergency-refresh">
                    <button onclick="window.location.reload()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                        Connection Issues? Click to Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// BULLETPROOF PHASE TRANSITION SYSTEM
// Combines WebSocket + aggressive HTTP polling to eliminate stuck students
const SESSION_CODE = '{{ session.session_code }}';
let socket = null;
let pollingInterval = null;
let wsConnected = false;
let reconnectAttempts = 0;
let maxReconnectAttempts = 10;

// Connection status management
function updateConnectionStatus(status, text) {
    const wsStatusEl = document.getElementById('ws-status');
    const statusTextEl = document.getElementById('status-text');
    const emergencyRefreshEl = document.getElementById('emergency-refresh');
    
    if (wsStatusEl && statusTextEl) {
        wsStatusEl.className = `inline-block w-2 h-2 rounded-full mr-1 ${status}`;
        statusTextEl.textContent = text;
        
        // Show emergency refresh if connection problems persist
        if (emergencyRefreshEl) {
            if (text.includes('Issues') || reconnectAttempts > 3) {
                emergencyRefreshEl.classList.remove('hidden');
            }
        }
    }
}

// HTTP Polling fallback - checks session phase every 2 seconds
function startAggressivePolling() {
    if (pollingInterval) return; // Already polling
    
    console.log('🔄 Starting aggressive HTTP polling fallback');
    pollingInterval = setInterval(async () => {
        try {
            const response = await fetch(`/learn/api/climate/${SESSION_CODE}/status/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('📊 Polling check - Current phase:', data.current_phase);
                
                // CRITICAL: Force redirect if phase changed to question_phase
                if (data.current_phase === 'question_phase') {
                    console.log('🎯 POLLING DETECTED PHASE CHANGE -> Redirecting to question phase');
                    clearInterval(pollingInterval);
                    window.location.href = `/learn/climate/${SESSION_CODE}/play/`;
                    return;
                }
            } else {
                console.warn('⚠️ Polling request failed:', response.status);
            }
        } catch (error) {
            console.error('❌ Polling error:', error);
        }
    }, 2000); // Poll every 2 seconds
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('🛑 Stopped HTTP polling');
    }
}

// WebSocket connection with exponential backoff
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/climate/${SESSION_CODE}/`;
    
    console.log(`🔌 Attempting WebSocket connection (attempt ${reconnectAttempts + 1})`);
    updateConnectionStatus('bg-yellow-400', 'Connecting...');
    
    socket = new WebSocket(wsUrl);
    
    socket.onopen = function() {
        console.log('✅ WebSocket connected successfully');
        wsConnected = true;
        reconnectAttempts = 0;
        updateConnectionStatus('bg-green-400', 'Connected');
        
        // Join as player
        socket.send(JSON.stringify({
            type: 'join_as_player',
            player_name: '{{ player_name }}'
        }));
        
        // WebSocket working, but keep polling as backup
        startAggressivePolling();
    };
    
    socket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('📨 WebSocket received:', data);
            
            if (data.type === 'phase_changed') {
                if (data.new_phase === 'question_phase') {
                    console.log('🎯 WEBSOCKET DETECTED PHASE CHANGE -> Redirecting to question phase');
                    stopPolling();
                    window.location.href = `/learn/climate/${SESSION_CODE}/play/`;
                    return;
                }
            }
        } catch (error) {
            console.error('❌ Error parsing WebSocket message:', error);
        }
    };
    
    socket.onerror = function(error) {
        console.error('❌ WebSocket error:', error);
        wsConnected = false;
        updateConnectionStatus('bg-red-400', 'Connection Issues');
    };
    
    socket.onclose = function(event) {
        console.log(`🔌 WebSocket closed (code: ${event.code}, reason: ${event.reason})`);
        wsConnected = false;
        
        // Start polling immediately when WebSocket fails
        if (!pollingInterval) {
            startAggressivePolling();
        }
        
        // Attempt reconnection with exponential backoff
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
            console.log(`🔄 Reconnecting in ${delay}ms...`);
            updateConnectionStatus('bg-orange-400', `Reconnecting (${reconnectAttempts}/${maxReconnectAttempts})...`);
            setTimeout(connectWebSocket, delay);
        } else {
            console.warn('⚠️ Max reconnection attempts reached');
            updateConnectionStatus('bg-red-400', 'Connection Failed - Using Backup');
        }
    };
}

// Get CSRF token for API requests
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

// Initialize the bulletproof system
function initializeBulletproofSystem() {
    console.log('🚀 Initializing bulletproof phase transition system');
    
    // Start WebSocket connection
    connectWebSocket();
    
    // Start polling as immediate backup (will be redundant but ensures reliability)
    startAggressivePolling();
    
    // Health check every 10 seconds
    setInterval(() => {
        if (!wsConnected && !pollingInterval) {
            console.log('🩺 Health check: Both WebSocket and polling failed, restarting...');
            connectWebSocket();
            startAggressivePolling();
        }
    }, 10000);
}

// Start the bulletproof system when page loads
document.addEventListener('DOMContentLoaded', initializeBulletproofSystem);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    stopPolling();
    if (socket) {
        socket.close();
    }
});
</script>
{% endblock %}